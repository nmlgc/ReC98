;
; +-------------------------------------------------------------------------+
; |   This file has been generated by The Interactive Disassembler (IDA)    |
; |        Copyright (c) 2009 by Hex-Rays, <support@hex-rays.com>           |
; +-------------------------------------------------------------------------+
;
; Input	MD5   :	96CEE07713A8E6460AE72276F3A9F909

; File Name   :	th02/MAIN.EXE
; Format      :	MS-DOS executable (EXE)
; Base Address:	0h Range: 0h-26EB0h Loaded length: 1F466h
; Entry	Point :	0:0
; OS type	  :  MS	DOS
; Application type:  Executable	16bit

		.386
		.model use16 large _TEXT

BINARY = 'M'

include ReC98.inc
include th01/math/subpixel.inc
include th02/th02.inc
include th02/main/entity.inc
include th02/main/playfld.inc
include th02/main/sparks.inc
include th02/main/hud/hud.inc
include th02/main/tile/tile.inc
include th02/main/player/player.inc
include th02/sprites/main_pat.inc

	extern SCOPY@:proc
	extern _execl:proc
	extern _getdate:proc
	extern _memcpy:proc

playperf_min = -6

SP_STAGE = 0
SP_BOSS = 1
SP_CLEAR = 2

MAP_ROWS_PER_SECTION = 8
MAP_BITS_PER_SECTION = 3
MAP_SECTION_COUNT = 16
MAP_LENGTH_MAX = 320
LIVES_MAX = 5
BOMBS_MAX = 5

DIALOG_LINE_LENGTH = 36
DIALOG_LINE_SIZE = (DIALOG_LINE_LENGTH + 4)
DIALOG_BOX_LINES = 2

FACE_REIMU_NEUTRAL = 0
FACE_REIMU_HUSHED = 3
FACE_REIMU_ANGRY = 6
FACE_REIMU_JOY = 9
FACE_REIMU_FROWN = 12
FACE_REIMU_FALL = 48
FACE_REIMU_CRY = 51
FACE_REIMU_QUESTION = 54
FACE_REIMU_SWEAT = 57
FACE_REIMU_FLIRTY = 60
FACE_GENJII = 96
FACE_RIKA = 99
FACE_MEIRA_NEUTRAL = 102
FACE_MIMA_SMILE = 105
FACE_MIMA_FROWN = 108
FACE_MARISA_SMILE = 144
FACE_MARISA_FROWN = 147
FACE_MEIRA_SWEAT = 150
FACE_EXRIKA_SMILE = 153
FACE_EXRIKA_FROWN = 156
FACE_COL_0 = 255

main_01 group main_01_TEXT, POINTNUM_TEXT, main_01__TEXT, ITEM_TEXT, HUD_TEXT, main_01___TEXT, PLAYER_B_TEXT, main_01____TEXT
main_03 group main_03_TEXT, BULLET_TEXT, DIALOG_TEXT, BOSS_5_TEXT, main_03__TEXT
main_06 group REGIST_M_TEXT, main_06_TEXT

; ===========================================================================

; Segment type:	Pure code
_TEXT		segment	word public 'CODE' use16
		assume cs:_TEXT
		assume es:nothing, ds:_DATA, fs:nothing, gs:nothing

include libs/master.lib/bfnt_entry_pat.asm
include libs/master.lib/bfnt_extend_header_skip.asm
include libs/master.lib/bfnt_header_read.asm
include libs/master.lib/bfnt_header_analysis.asm
include libs/master.lib/bcloser.asm
include libs/master.lib/bfill.asm
include libs/master.lib/bfnt_palette_set.asm
include libs/master.lib/bgetc.asm
include libs/master.lib/palette_black_out.asm
include libs/master.lib/bopenr.asm
include libs/master.lib/bread.asm
include libs/master.lib/bseek.asm
include libs/master.lib/bseek_.asm
include libs/master.lib/cutline.asm
include libs/master.lib/dos_axdx.asm
include libs/master.lib/dos_filesize.asm
include libs/master.lib/dos_setvect.asm
include libs/master.lib/egc.asm
include libs/master.lib/file_append.asm
include libs/master.lib/file_close.asm
include libs/master.lib/file_exist.asm
include libs/master.lib/file_read.asm
include libs/master.lib/file_ropen.asm
include libs/master.lib/file_seek.asm
include libs/master.lib/file_size.asm
include libs/master.lib/file_write.asm
include libs/master.lib/dos_close.asm
include libs/master.lib/dos_ropen.asm
include libs/master.lib/grcg_boxfill.asm
include libs/master.lib/grcg_byteboxfill_x.asm
include libs/master.lib/grcg_circlefill.asm
include libs/master.lib/grcg_circle.asm
include libs/master.lib/grcg_circle_x.asm
include libs/master.lib/grc_setclip.asm
include libs/master.lib/grcg_fill.asm
include libs/master.lib/grcg_hline.asm
include libs/master.lib/grcg_line.asm
include libs/master.lib/grcg_pset.asm
include libs/master.lib/grcg_setcolor.asm
include libs/master.lib/grcg_vline.asm
include libs/master.lib/gdc_outpw.asm
		db 0
include libs/master.lib/gaiji_backup.asm
include libs/master.lib/gaiji_entry_bfnt.asm
include libs/master.lib/gaiji_putca.asm
include libs/master.lib/gaiji_putsa.asm
include libs/master.lib/gaiji_read.asm
include libs/master.lib/gaiji_write.asm
include libs/master.lib/graph_400line.asm
include libs/master.lib/graph_clear.asm
include libs/master.lib/graph_copy_page.asm
include libs/master.lib/graph_extmode.asm
include libs/master.lib/graph_pi_free.asm
include libs/master.lib/graph_pi_load_pack.asm
include libs/master.lib/graph_pack_put_8.asm
include libs/master.lib/graph_scrollup.asm
include libs/master.lib/graph_scroll.asm
include libs/master.lib/iatan2.asm
include libs/master.lib/key_sense.asm
include libs/master.lib/palette_show.asm
include libs/master.lib/pfclose.asm
include libs/master.lib/pfgetc.asm
include libs/master.lib/pfread.asm
include libs/master.lib/pfrewind.asm
include libs/master.lib/pfseek.asm
include libs/master.lib/random.asm
include libs/master.lib/rottbl.asm
include libs/master.lib/smem_release.asm
include libs/master.lib/smem_wget.asm
include libs/master.lib/text_boxfilla.asm
include libs/master.lib/text_clear.asm
include libs/master.lib/text_fillca.asm
include libs/master.lib/text_putca.asm
include libs/master.lib/text_putsa.asm
include libs/master.lib/vsync.asm
include libs/master.lib/vsync_wait.asm
include libs/master.lib/palette_white_in.asm
include libs/master.lib/palette_white_out.asm
include libs/master.lib/hmem_lallocate.asm
include libs/master.lib/mem_assign_dos.asm
include libs/master.lib/mem_assign.asm
include libs/master.lib/memheap.asm
include libs/master.lib/mem_unassign.asm
include libs/master.lib/super_free.asm
include libs/master.lib/super_entry_pat.asm
include libs/master.lib/super_put_1plane.asm
include libs/master.lib/super_entry_at.asm
include libs/master.lib/super_entry_bfnt.asm
include libs/master.lib/super_cancel_pat.asm
include libs/master.lib/super_clean.asm
include libs/master.lib/super_roll_put_1plane.asm
include libs/master.lib/super_roll_put.asm
include libs/master.lib/super_put_rect.asm
include libs/master.lib/super_put.asm
include libs/master.lib/super_roll_put_tiny.asm
include libs/master.lib/super_convert_tiny.asm
include libs/master.lib/super_zoom.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @MPN_PUT_8$QIII
@mpn_put_8$qiii	proc far

@@image	= word ptr  6
@@top  	= word ptr  8
@@left 	= word ptr  0Ah

		push	bp
		mov	bp, sp
		push	si
		push	di
		push	ds
		mov	di, [bp+@@top]
		mov	ax, [bp+@@left]
		sar	ax, 3
		mov	dx, di
		shl	dx, 6
		add	ax, dx
		shr	dx, 2
		add	ax, dx
		mov	di, ax
		mov	ax, [bp+@@image]
		shl	ax, 7
		mov	dx, word ptr _mpn_images+2
		mov	bx, word ptr _mpn_images
		add	bx, ax
		mov	ds, dx
		mov	si, bx
		mov	cx, TILE_H

loc_39CC:
		mov	ax, SEG_PLANE_B
		mov	es, ax
		assume es:nothing
		mov	ax, [si]
		mov	es:[di], ax
		mov	ax, SEG_PLANE_R
		mov	es, ax
		assume es:nothing
		mov	ax, [si+20h]
		mov	es:[di], ax
		mov	ax, SEG_PLANE_G
		mov	es, ax
		assume es:nothing
		mov	ax, [si+40h]
		mov	es:[di], ax
		mov	ax, SEG_PLANE_E
		mov	es, ax
		assume es:nothing
		mov	ax, [si+60h]
		mov	es:[di], ax
		add	di, ROW_SIZE
		add	si, (TILE_W / 8)
		loop	loc_39CC
		pop	ds
		pop	di
		pop	si
		pop	bp
		retf	6
@mpn_put_8$qiii	endp

include libs/master.lib/pfint21.asm
		db 0
include th02/formats/pfopen.asm
include libs/master.lib/pf_str_ieq.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3DDE	proc far
		push	bp
		mov	bp, sp
		xor	bx, bx
		jmp	short loc_3DED
; ---------------------------------------------------------------------------

loc_3DE5:
		mov	byte ptr [bx+258Ch], 0
		add	bx, 0Ch

loc_3DED:
		cmp	bx, 168h
		jl	short loc_3DE5
		mov	word_1FFF0, 20h	; ' '
		mov	word_1FFF2, 1
		mov	word_1FFF4, 0
		mov	byte_1FFF8, V_WHITE
		mov	byte_1FFF9, 0
		mov	byte_1FFFA, -1
		mov	word_1FFF6, 20h	; ' '
		pop	bp
		retf
sub_3DDE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3E1C	proc far

arg_0		= byte ptr  6
arg_2		= word ptr  8
arg_4		= word ptr  0Ah

		push	bp
		mov	bp, sp
		push	si
		mov	cx, [bp+arg_4]
		mov	bx, [bp+arg_2]
		shl	cx, 4
		shl	bx, 4
		mov	ax, 258Ch
		mov	si, ax
		xor	dx, dx
		jmp	short loc_3E5F
; ---------------------------------------------------------------------------

loc_3E35:
		cmp	byte ptr [si], 0
		jnz	short loc_3E5B
		mov	byte ptr [si], 1
		mov	al, [bp+arg_0]
		mov	[si+1],	al
		mov	[si+2],	cx
		mov	[si+6],	cx
		mov	[si+4],	bx
		mov	[si+8],	bx
		mov	byte ptr [si+0Ah], 1
		mov	al, byte ptr word_1FFF0
		mov	[si+0Bh], al
		jmp	short loc_3E64
; ---------------------------------------------------------------------------

loc_3E5B:
		inc	dx
		add	si, 0Ch

loc_3E5F:
		cmp	dx, 1Eh
		jl	short loc_3E35

loc_3E64:
		pop	si
		pop	bp
		retf	6
sub_3E1C	endp

; ---------------------------------------------------------------------------
		nop

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3E6A	proc far

var_2		= word ptr -2
arg_0		= word ptr  6

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	ax, 0A800h
		mov	es, ax
		assume es:nothing
		mov	si, [bp+arg_0]
		mov	ax, word_20164
		sar	ax, 3
		mov	dx, word_20166
		shl	dx, 6
		add	ax, dx
		shr	dx, 2
		add	ax, dx
		mov	di, ax
		mov	bx, word_20164
		and	bx, 7
		mov	al, [si+8EEh]
		mov	ah, 0
		mov	[bp+var_2], ax
		mov	cl, bl
		shr	ax, cl
		mov	cl, 10h
		sub	cl, bl
		mov	dx, [bp+var_2]
		shl	dx, cl
		or	ax, dx
		jmp	short loc_3EB8
; ---------------------------------------------------------------------------

loc_3EB1:
		mov	es:[di], ax
		add	di, 50h	; 'P'
		dec	si

loc_3EB8:
		or	si, si
		jg	short loc_3EB1
		pop	di
		pop	si
		leave
		retf	2
sub_3E6A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3EC2	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+arg_0]
		mov	ax, word_20164
		sar	ax, 3
		mov	dx, word_20166
		shl	dx, 6
		add	ax, dx
		shr	dx, 2
		add	ax, dx
		mov	bx, ax
		jmp	short loc_3EEA
; ---------------------------------------------------------------------------

loc_3EE1:
		mov	word ptr es:[bx], 0FFFFh
		add	bx, 50h	; 'P'
		dec	si

loc_3EEA:
		or	si, si
		jg	short loc_3EE1
		pop	si
		pop	bp
		retn	2
sub_3EC2	endp

; ---------------------------------------------------------------------------
		nop

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3EF4	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	ax, 0A800h
		mov	es, ax
		push	GC_RMW
		mov	al, byte_1FFF9
		mov	ah, 0
		push	ax
		nopcall	grcg_setcolor
		mov	ax, 258Ch
		mov	si, ax
		xor	di, di
		jmp	short loc_3F7B
; ---------------------------------------------------------------------------

loc_3F15:
		cmp	byte ptr [si], 0
		jz	short loc_3F77
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+2]
		sar	ax, 4
		mov	word_20164, ax
		mov	ax, [bx+si+4]
		sar	ax, 4
		mov	word_20166, ax
		cmp	_reduce_effects, 0
		jz	short loc_3F4B
		mov	al, _page_back
		mov	ah, 0
		mov	dx, di
		and	dx, 1
		cmp	ax, dx
		jnz	short loc_3F54

loc_3F4B:
		mov	al, [si+0Ah]
		mov	ah, 0
		push	ax
		call	sub_3EC2

loc_3F54:
		cmp	byte ptr [si], 2
		jnz	short loc_3F5E
		mov	byte ptr [si], 0
		jmp	short loc_3F77
; ---------------------------------------------------------------------------

loc_3F5E:
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+2]
		mov	cx, [bx+si+4]
		xor	bx, 4
		mov	[bx+si+2], ax
		mov	[bx+si+4], cx

loc_3F77:
		inc	di
		add	si, 0Ch

loc_3F7B:
		cmp	di, 1Eh
		jl	short loc_3F15
		nopcall	grcg_off
		pop	di
		pop	si
		pop	bp
		retf
sub_3EF4	endp

; ---------------------------------------------------------------------------
		nop

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_3F8A	proc far

var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		push	GC_RMW
		mov	al, byte_1FFF8
		mov	ah, 0
		push	ax
		nopcall	grcg_setcolor
		mov	al, byte_1FFFA
		mov	byte_20168, al
		mov	al, byte_1FFF8
		mov	byte_20169, al
		mov	ax, 258Ch
		mov	si, ax
		mov	[bp+var_2], 0
		jmp	loc_407E
; ---------------------------------------------------------------------------

loc_3FB9:
		cmp	byte ptr [si], 1
		jz	short loc_3FC1
		jmp	loc_4078
; ---------------------------------------------------------------------------

loc_3FC1:
		mov	al, [si+0Bh]
		add	al, byte ptr word_1FFF2
		mov	[si+0Bh], al
		mov	al, [si+1]
		add	al, byte ptr word_1FFF4
		mov	[si+1],	al
		push	ss
		lea	ax, [bp+var_4]
		push	ax
		push	ss
		lea	ax, [bp+var_6]
		push	ax
		push	word ptr [si+1]
		mov	al, [si+0Bh]
		mov	ah, 0
		push	ax
		nop
		push	cs
		; Hack (what is this I don't even)
		db 0e8h
		db 075h
		db 0b5h
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	dx, [bp+var_4]
		add	[bx+si+2], dx
		mov	dx, [bp+var_6]
		add	[bx+si+4], dx
		mov	dx, [bx+si+2]
		sar	dx, 4
		mov	word_20164, dx
		mov	ax, [bx+si+4]
		sar	ax, 4
		mov	word_20166, ax
		cmp	dx, 1A0h
		jge	short loc_402B
		cmp	dx, 18h
		jle	short loc_402B
		cmp	ax, 8
		jle	short loc_402B
		cmp	ax, 180h
		jl	short loc_4030

loc_402B:
		mov	byte ptr [si], 2
		jmp	short loc_4078
; ---------------------------------------------------------------------------

loc_4030:
		mov	ax, word_1FFF6
		shl	ax, 2
		add	ax, word_1FFF6
		mov	di, ax
		mov	bl, 5
		jmp	short loc_404F
; ---------------------------------------------------------------------------

loc_4040:
		mov	al, [si+0Bh]
		mov	ah, 0
		cmp	ax, di
		jg	short loc_4055
		sub	di, word_1FFF6
		dec	bl

loc_404F:
		cmp	di, word_1FFF6
		jg	short loc_4040

loc_4055:
		mov	[si+0Ah], bl
		cmp	_reduce_effects, 0
		jz	short loc_406E
		mov	al, _page_back
		mov	ah, 0
		mov	dx, [bp+var_2]
		and	dx, 1
		cmp	ax, dx
		jnz	short loc_4078

loc_406E:
		mov	al, [si+0Ah]
		mov	ah, 0
		push	ax
		call	sub_3E6A

loc_4078:
		inc	[bp+var_2]
		add	si, 0Ch

loc_407E:
		cmp	[bp+var_2], 1Eh
		jge	short loc_4087
		jmp	loc_3FB9
; ---------------------------------------------------------------------------

loc_4087:
		nopcall	grcg_off
		pop	di
		pop	si
		leave
		retf
sub_3F8A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_4090	proc far

@@i		= word ptr -8
@@page_offset		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2
@@as_circle_sprite		= word ptr  6
@@count		= word ptr  8
@@speed		= word ptr  0Ah
@@top		= word ptr  0Ch
@@left		= word ptr  0Eh

		enter	8, 0
		push	si
		push	di
		mov	ax, [bp+@@top]
		cmp	ax, RES_Y
		jb	short loc_40A1
		sub	ax, RES_Y

loc_40A1:
		mov	[bp+@@top], ax
		shl	[bp+@@left], SUBPIXEL_BITS
		shl	[bp+@@top], SUBPIXEL_BITS
		mov	ax, offset _sparks
		mov	si, ax
		mov	ax, _spark_ring_i
		mov	[bp+@@i], ax
		mov	cl, size spark_t
		imul	cl
		add	si, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	[bp+@@page_offset], ax
		xor	di, di
		jmp	short loc_4142
; ---------------------------------------------------------------------------

loc_40CC:
		mov	[si+spark_t.SPARK_flag], F_ALIVE
		mov	[si+spark_t.SPARK_age], 0
		mov	bx, [bp+@@page_offset]
		mov	dx, [bp+@@left]
		mov	[bx+si+spark_t.SPARK_screen_topleft+Point.x], dx
		mov	dx, [bp+@@top]
		mov	[bx+si+spark_t.SPARK_screen_topleft+Point.y], dx
		cmp	[bp+@@as_circle_sprite], 0
		jnz	short loc_4100
		mov	al, [si+spark_t.SPARK_default_render_as]
		mov	[si+spark_t.SPARK_render_as], al
		mov	al, [si+spark_t.SPARK_speed_base]
		mov	ah, 0
		add	ax, [bp+@@speed]
		mov	[bp+var_2], ax
		mov	al, [si+spark_t.SPARK_angle]
		mov	ah, 0
		jmp	short loc_4114
; ---------------------------------------------------------------------------

loc_4100:
		mov	[si+spark_t.SPARK_render_as], SRA_SPRITE
		mov	ax, [bp+@@speed]
		mov	[bp+var_2], ax
		mov	ax, di
		mov	cl, 8
		shl	ax, cl
		cwd
		idiv	[bp+@@count]

loc_4114:
		mov	[bp+var_4], ax
		push	ds
		lea	ax, [si+spark_t.SPARK_velocity+Point.x]
		push	ax
		push	ds
		lea	ax, [si+spark_t.SPARK_velocity+Point.y]
		push	ax
		push	[bp+var_4]
		push	[bp+var_2]
		nop
		push	cs
		; Hack (what is this I don't even)
		db 0e8h
		db 036h
		db 0b4h
		inc	di
		add	si, size spark_t
		inc	[bp+@@i]
		cmp	[bp+@@i], SPARK_COUNT
		jl	short loc_4142
		mov	[bp+@@i], 0
		sub	si, (SPARK_COUNT * size spark_t)

loc_4142:
		cmp	di, [bp+@@count]
		jl	short loc_40CC
		mov	ax, [bp+@@count]
		add	byte ptr _spark_ring_i, al
		and	byte ptr _spark_ring_i, (SPARK_COUNT - 1)
		pop	di
		pop	si
		leave
		retf	0Ah
sub_4090	endp

; ---------------------------------------------------------------------------
		nop

include th02/main/spark_render.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_41AA	proc far

@@screen_top 	= word ptr -0Eh
@@screen_left	= word ptr -0Ch
@@top_p      	= word ptr -0Ah
@@left_p     	= word ptr -6
@@i          	= word ptr -2

		enter	0Eh, 0
		push	si
		push	di
		push	GC_RMW
		push	14
		nopcall	grcg_setcolor
		mov	ax, offset _sparks
		mov	si, ax
		mov	[bp+@@i], 0
		jmp	loc_4276
; ---------------------------------------------------------------------------

loc_41C7:
		cmp	[si+spark_t.SPARK_flag], F_ALIVE
		jz	short loc_41CF
		jmp	loc_4270
; ---------------------------------------------------------------------------

loc_41CF:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, si
		add	ax, SPARK_screen_topleft
		mov	[bp+@@left_p], ax
		add	ax, Point.y
		mov	[bp+@@top_p], ax
		mov	ax, [si+spark_t.SPARK_velocity+Point.x]
		mov	bx, [bp+@@left_p]
		add	[bx], ax
		mov	ax, _spark_accel_x
		add	[si+spark_t.SPARK_velocity+Point.x], ax
		mov	ax, [si+spark_t.SPARK_velocity+Point.y]
		mov	bx, [bp+@@top_p]
		add	[bx], ax
		mov	ax, [bx]
		mov	[bp+@@screen_top], ax
		mov	bx, [bp+@@left_p]
		mov	ax, [bx]
		sar	ax, 4
		mov	[bp+@@screen_left], ax
		mov	bx, [bp+@@top_p]
		mov	ax, [bx]
		sar	ax, 4
		mov	[bp+@@screen_top], ax
		mov	di, [bp+@@screen_top]
		inc	word ptr [si+spark_t.SPARK_velocity+Point.y]
		inc	[si+spark_t.SPARK_age]
		cmp	[bp+@@screen_left], PLAYFIELD_LEFT
		jl	short loc_4240
		cmp	[bp+@@screen_left], (PLAYFIELD_RIGHT - SPARK_W)
		jge	short loc_4240
		mov	al, [si+spark_t.SPARK_age]
		cmp	al, _spark_age_max
		ja	short loc_4240
		cmp	di, PLAYFIELD_BOTTOM
		jge	short loc_4240
		cmp	di, (PLAYFIELD_TOP - SPARK_H)
		jg	short loc_4245

loc_4240:
		mov	[si+spark_t.SPARK_flag], F_REMOVE
		jmp	short loc_4270
; ---------------------------------------------------------------------------

loc_4245:
		add	di, _scroll_line
		cmp	di, RES_Y
		jb	short loc_4253
		sub	di, RES_Y

loc_4253:
		push	[bp+@@screen_left]
		push	di
		cmp	[si+spark_t.SPARK_render_as], SRA_DOT
		jnz	short loc_4264
		nopcall	grcg_pset
		jmp	short loc_4270
; ---------------------------------------------------------------------------

loc_4264:
		mov	al, [si+spark_t.SPARK_age]
		mov	ah, 0
		and	ax, (SPARK_CELS - 1)
		push	ax
		call	spark_render

loc_4270:
		inc	[bp+@@i]
		add	si, size spark_t

loc_4276:
		cmp	[bp+@@i], SPARK_COUNT
		jge	short loc_427F
		jmp	loc_41C7
; ---------------------------------------------------------------------------

loc_427F:
		nopcall	grcg_off
		pop	di
		pop	si
		leave
		retf
sub_41AA	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_4288	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	ax, offset _sparks
		mov	si, ax
		xor	di, di
		jmp	short loc_42EF
; ---------------------------------------------------------------------------

loc_4296:
		cmp	[si+spark_t.SPARK_flag], F_FREE
		jz	short loc_42EB
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+spark_t.SPARK_screen_topleft+Point.x]
		sar	ax, SUBPIXEL_BITS
		push	ax	; left
		mov	ax, [bx+si+spark_t.SPARK_screen_topleft+Point.y]
		sar	ax, SUBPIXEL_BITS
		push	ax	; top
		cmp	[si+spark_t.SPARK_render_as], SRA_DOT
		jnz	short loc_42BF
		push	1	; w
		push	1	; h
		jmp	short loc_42C3
; ---------------------------------------------------------------------------

loc_42BF:
		push	SPARK_W	; w
		push	SPARK_H	; h

loc_42C3:
		nopcall	@tiles_invalidate_rect$qiiii
		cmp	[si+spark_t.SPARK_flag], F_REMOVE
		jnz	short loc_42D2
		mov	[si+spark_t.SPARK_flag], F_FREE
		jmp	short loc_42EB
; ---------------------------------------------------------------------------

loc_42D2:
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+spark_t.SPARK_screen_topleft+Point.x]
		mov	dx, [bx+si+spark_t.SPARK_screen_topleft+Point.y]
		xor	bx, size Point
		mov	[bx+si+spark_t.SPARK_screen_topleft+Point.x], ax
		mov	[bx+si+spark_t.SPARK_screen_topleft+Point.y], dx

loc_42EB:
		inc	di
		add	si, size spark_t

loc_42EF:
		cmp	di, SPARK_COUNT
		jl	short loc_4296
		pop	di
		pop	si
		leave
		retf
sub_4288	endp

	extern @tiles_stuff_reset$qv:proc
	extern @MAP_LOAD$QNXC:proc
	extern @tile_area_init_and_put_both$qv:proc
	extern @egc_start_copy_noframe$qv:proc
	extern @TILES_SCROLL_AND_EGC_RENDER_BOTH$QI:proc
	extern @tiles_fill_and_put_initial$qv:proc
	extern @TILES_INVALIDATE_RECT$QIIII:proc
	extern @tiles_egc_render$qv:proc
	extern @tiles_render_all$qv:proc
	extern @TILE_RING_SET_AND_PUT_BOTH_8$QIII:proc
	extern @TILE_EGC_ROLL_COPY_8$QIII:proc
_TEXT		ends

; ===========================================================================

; Segment type:	Pure code
main_01_TEXT	segment	word public 'CODE' use16
		assume cs:main_01
		;org 3
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

; int __cdecl main(int _argc, const char **_argv, const	char **_envp)
public _main
_main		proc far

_argc		= word ptr  6
_argv		= dword	ptr  8
_envp		= dword	ptr  0Ch

		push	bp
		mov	bp, sp
		call	cfg_load
		or	ax, ax
		jz	short @@cfg_load_is_1
		call	@game_init_main$qv
		or	ax, ax
		jz	short @@game_init_main_is_0
		call	@zun_error$q11zun_error_t pascal, 3

@@cfg_load_is_1:
		mov	ax, 1
		pop	bp
		retf
; ---------------------------------------------------------------------------

@@game_init_main_is_0:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.bgm_mode], 1
		jnz	short loc_B19A
		call	_snd_pmd_resident
		mov	_snd_midi_active, 0
		jmp	short loc_B1B5
; ---------------------------------------------------------------------------

loc_B19A:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.bgm_mode], 2
		jnz	short loc_B1BA
		call	_snd_pmd_resident
		call	_snd_mmd_resident
		mov	al, _snd_midi_possible
		mov	_snd_midi_active, al

loc_B1B5:
		call	_snd_determine_mode

loc_B1BA:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jz	short loc_B1CA
		nopcall	demo_load

loc_B1CA:
		call	sub_B2AB

loc_B1CD:
		les	bx, _resident
		mov	eax, es:[bx+mikoconfig_t.frame]
		mov	random_seed, eax
		call	sub_B3DA
		nopcall	@overlay_stage_enter_animate$qv
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_B237
		mov	al, _stage_id
		cbw
		cmp	ax, 5
		jnz	short loc_B202
		push	(16 shl 16) + 12
		push	ds
		push	offset gEXTRA_STAGE
		jmp	short loc_B213
; ---------------------------------------------------------------------------

loc_B202:
		mov	al, stage1_gaiji_halflen
		mov	ah, 0
		mov	dx, 1Ch
		sub	dx, ax
		push	dx
		push	12
		push	ds
		push	offset gStage1

loc_B213:
		push	TX_YELLOW
		call	gaiji_putsa
		mov	al, _stage_title_halflen
		mov	ah, 0
		mov	dx, 1Ch
		sub	dx, ax
		call	text_putsa pascal, dx, 13, ds, _stage_title, TX_WHITE
		jmp	short loc_B249
; ---------------------------------------------------------------------------

loc_B237:
		call	gaiji_putsa pascal, (18 shl 16) + 12, ds, offset gDEMO_PLAY, TX_YELLOW + TX_BLINK

loc_B249:
		mov	_key_det, 0

loc_B24F:
		call	farfp_1F4A4
		or	ax, ax
		jz	short loc_B263
		kajacall	KAJA_SONG_FADE, 40
		pop	cx
		jmp	loc_B1CD
; ---------------------------------------------------------------------------

loc_B263:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_B287
		call	sub_C31F
		or	ax, ax
		jz	short loc_B27A
		call	sub_B98E
		jmp	short loc_B24F
; ---------------------------------------------------------------------------

loc_B27A:
		les	bx, _resident
		mov	al, _stage_id
		mov	es:[bx+mikoconfig_t.stage], al
		jmp	short loc_B290
; ---------------------------------------------------------------------------

loc_B287:
		push	word ptr _DemoBuf+2
		call	hmem_free

loc_B290:
		mov	PaletteTone, 0
		call	far ptr	palette_show
		push	ds
		push	offset arg0	; "op"
		nopcall	@GameExecl$qnxc
		add	sp, 4
		xor	ax, ax
		pop	bp
		retf
_main		endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B2AB	proc near
		push	bp
		mov	bp, sp
		push	si
		call	_snd_load stdcall, offset aHuuma_efc, ds, SND_LOAD_SE
		call	sub_1CD36
		call	@pi_load$qinxc stdcall, 0, offset aEye_pi, ds
		add	sp, 0Ch
		call	super_entry_bfnt pascal, ds, offset aMiko_bft ; "miko.bft"
		call	super_entry_bfnt pascal, ds, offset aMiko32_bft ; "miko32.bft"
		call	super_entry_bfnt pascal, ds, offset aMiko16_bft ; "miko16.bft"
		mov	si, 48
		jmp	short loc_B2F5
; ---------------------------------------------------------------------------

loc_B2EE:
		call	super_convert_tiny pascal, si
		inc	si

loc_B2F5:
		cmp	si, 128
		jl	short loc_B2EE
		call	@gaiji_load$qv
		call	sub_E178
		les	bx, _resident
		mov	al, es:[bx+mikoconfig_t.reduce_effects]
		mov	_reduce_effects, al
		setfarfp	farfp_1F4A4, sub_BCB1
		cmp	es:[bx+mikoconfig_t.continues_used], 0
		jz	short loc_B34C
		cmp	es:[bx+mikoconfig_t.continues_used], 9
		jb	short loc_B32B
		mov	ax, 9
		jmp	short loc_B333
; ---------------------------------------------------------------------------

loc_B32B:
		les	bx, _resident
		mov	ax, es:[bx+mikoconfig_t.continues_used]

loc_B333:
		movzx	eax, ax
		mov	_score, eax
		mov	al, _stage_id
		cbw
		mov	bx, 5
		cwd
		idiv	bx
		add	dx, 2
		mov	_item_bigpower_override, dx

loc_B34C:
		cmp	_rank, RANK_EASY
		jnz	short loc_B35A
		mov	_playperf_max, 4
		jmp	short loc_B35F
; ---------------------------------------------------------------------------

loc_B35A:
		mov	_playperf_max, 16

loc_B35F:
		pop	si
		pop	bp
		retn
sub_B2AB	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B362	proc near

arg_0		= dword	ptr  4
arg_4		= dword	ptr  8

		push	bp
		mov	bp, sp
		push	si
		les	bx, [bp+arg_4]
		push	es
		les	si, [bp+arg_0]
		mov	al, es:[si]
		pop	es
		mov	es:[bx+7], al
		les	bx, [bp+arg_0]
		mov	al, es:[bx+1]
		les	bx, [bp+arg_4]
		mov	es:[bx+8], al
		les	bx, [bp+arg_0]
		mov	al, es:[bx+2]
		les	bx, [bp+arg_4]
		mov	es:[bx+9], al
		pop	si
		pop	bp
		retn	8
sub_B362	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B396	proc near

arg_0		= dword	ptr  4

		push	bp
		mov	bp, sp
		les	bx, [bp+arg_0]
		mov	byte ptr es:[bx], 's'
		mov	byte ptr es:[bx+1], 't'
		mov	byte ptr es:[bx+2], 'a'
		mov	byte ptr es:[bx+3], 'g'
		mov	byte ptr es:[bx+4], 'e'
		mov	al, _stage_id
		add	al, '0'
		mov	es:[bx+5], al
		mov	byte ptr es:[bx+6], '.'
		mov	byte ptr es:[bx+7], 'b'
		mov	byte ptr es:[bx+8], 'f'
		mov	byte ptr es:[bx+9], 't'
		mov	byte ptr es:[bx+0Ah], 0
		pop	bp
		retn	4
sub_B396	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B3DA	proc near

var_C		= byte ptr -0Ch

		enter	0Ch, 0
		push	si
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	sub_B396
		mov	vsync_Count1, 0
		call	text_wipe
		call	graph_scrollup pascal, 0
		graph_accesspage 1
		call	graph_clear
		graph_accesspage 0
		call	graph_clear
		graph_showpage 0
		call	@hud_put$qv
		call	@overlay_wipe$qv
		call	@pi_palette_apply$qi stdcall, 0
		call	@pi_palette_apply$qi stdcall, 0
		call	@pi_put_8$qiii stdcall, 96, large 144
		add	sp, 0Ah
		call	@bullets_and_sparks_init$qv
		call	sub_16A6B
		call	sub_3DDE
		call	sub_129DD
		call	sub_E271
		call	_snd_se_reset
		call	sub_1028C
		nopcall	sub_CA1C
		call	@randring_fill$qv
		mov	PaletteTone, 100
		call	far ptr	palette_show
		mov	ax, PLAYER_LEFT_START
		mov	_player_left_on_page[0 * word], ax
		mov	_player_left_on_page[1 * word], ax
		mov	ax, PLAYER_TOP_START
		mov	_player_top_on_page[0 * word], ax
		mov	_player_top_on_page[1 * word], ax
		mov	_stage_frame, 0
		mov	_midboss_active, 0
		mov	_stage_progression, SP_STAGE
		mov	_slowdown_factor, 1
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_B4BB
		mov	bgm_show_timer, 1
		mov	al, _stage_id
		add	al, al
		mov	_bgm_title_id, al
		mov	al, _stage_id
		add	al, al
		inc	al
		mov	byte_1F46E, al
		jmp	short loc_B4C0
; ---------------------------------------------------------------------------

loc_B4BB:
		mov	bgm_show_timer, 0

loc_B4C0:
		mov	si, 0C0h
		jmp	short loc_B4D7
; ---------------------------------------------------------------------------

loc_B4C5:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+1EDAh], 0
		jz	short loc_B4D6
		call	super_cancel_pat pascal, si

loc_B4D6:
		dec	si

loc_B4D7:
		cmp	si, 80h
		jge	short loc_B4C5
		mov	stage1_gaiji_halflen, 6
		mov	al, _stage_id
		cbw
		mov	bx, 5
		cwd
		idiv	bx
		add	dl, gb_1_
		mov	gStage1+5, dl
		mov	al, _stage_id
		cbw
		add	ax, ax
		mov	bx, ax
		mov	ax, _STAGE_TITLES[bx]
		mov	_stage_title, ax
		mov	al, _stage_id
		cbw
		mov	bx, ax
		mov	al, _STAGE_TITLE_HALFLENGTHS[bx]
		mov	_stage_title_halflen, al
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	super_entry_bfnt
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		push	ds
		push	offset aBmt	; "bmt"
		call	sub_B362
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	super_entry_bfnt
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		push	ds
		push	offset aBbt	; "bbt"
		call	sub_B362
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	super_entry_bfnt
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		push	ds
		push	offset aMap	; "map"
		call	sub_B362
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	@map_load$qnxc
		call	@tiles_stuff_reset$qv
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		push	ds
		push	offset aMpn	; "mpn"
		call	sub_B362
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	mpn_load
		push	size palette_t	; n
		push	ds
		push	offset _mpn_palette ; src
		push	ds
		push	offset unk_1F4AD ; dest
		call	_memcpy
		add	sp, 0Ah
		call	sub_1C608
		call	sub_1C3DF
		call	@dialog_load_and_init$qv
		setfarfp	_boss_bg_render, @nullfunc_void$qv
		setfarfp	_boss_update, @nullfunc_false$qv
		setfarfp	farfp_1F490, @nullfunc_void$qv
		setfarfp	farfp_1F4A0, @nullfunc_void$qv
		setfarfp	farfp_23A72, @nullfunc_void$qv
		setfarfp	farfp_23A76, @nullfunc_void$qv
		setfarfp	farfp_26C3C, sub_17979
		setfarfp	farfp_26C40, sub_1766E
		setfarfp	farfp_1F494, sub_BFD0
		setfarfp	farfp_1F498, sub_C05D
		setfarfp	farfp_1F48C, @nullfunc_false$qv
		call	sub_C5B0
		mov	_scroll_speed, 1
		mov	_scroll_interval, 4
		mov	al, _stage_id
		cbw
		mov	bx, ax
		cmp	bx, 5
		ja	loc_B88A
		add	bx, bx
		jmp	cs:off_B982[bx]

loc_B63C:
		mov	word_20616, 74h	; 't'
		setfarfp	_midboss_invalidate, @midboss1_invalidate$qv
		setfarfp	_midboss_update_and_render, @midboss1_update_and_render$qv
		setfarfp	_boss_init, rika_init
		setfarfp	_boss_end, rika_end
		setfarfp	_boss_bg_render_func, rika_bg_render
		setfarfp	_boss_update_func, rika_update
		setfarfp	farfp_1F490, sub_13671
		jmp	short loc_B6F2
; ---------------------------------------------------------------------------

loc_B698:
		mov	word_20616, 50h	; 'P'
		setfarfp	_midboss_invalidate, @midboss2_invalidate$qv
		setfarfp	_midboss_update_and_render, @midboss2_update_and_render$qv
		setfarfp	_boss_init, meira_init
		setfarfp	_boss_end, meira_end
		setfarfp	_boss_bg_render_func, meira_bg_render
		setfarfp	_boss_update_func, meira_update
		setfarfp	farfp_1F490, sub_140AE

loc_B6F2:
		setfarfp	farfp_1F4A0, sub_13513
		jmp	loc_B88A
; ---------------------------------------------------------------------------

loc_B701:
		mov	word_20616, 67h	; 'g'
		setfarfp	_midboss_invalidate, @midboss3_invalidate$qv
		setfarfp	_midboss_update_and_render, @midboss3_update_and_render$qv
		setfarfp	_boss_init, stones_init
		setfarfp	_boss_end, stones_end
		setfarfp	_boss_bg_render_func, stones_bg_render
		setfarfp	_boss_update_func, stones_update
		setfarfp	farfp_1F490, sub_10E95
		setfarfp	farfp_1F4A0, sub_10E4F
		jmp	loc_B88A
; ---------------------------------------------------------------------------

loc_B76A:
		mov	word_20616, 3B0h
		setfarfp	_midboss_invalidate, @midboss4_invalidate$qv
		setfarfp	_midboss_update_and_render, @midboss4_update_and_render$qv
		setfarfp	_boss_init, marisa_init
		setfarfp	_boss_end, marisa_end
		setfarfp	_boss_bg_render_func, marisa_bg_render
		setfarfp	_boss_update_func, marisa_update
		cmp	_reduce_effects, 0
		jnz	short loc_B7CB
		setfarfp	farfp_1F490, sub_19E2F

loc_B7CB:
		call	sub_129FC
		mov	_scroll_speed, 2
		mov	_scroll_interval, 1
		jmp	loc_B88A
; ---------------------------------------------------------------------------

loc_B7DD:
		mov	word_20616, 0FFFFh
		setfarfp	_midboss_invalidate, @nullfunc_false$qv
		setfarfp	_midboss_update_and_render, @nullfunc_void$qv
		setfarfp	_boss_init, mima_init
		setfarfp	_boss_end, mima_end
		setfarfp	_boss_bg_render_func, mima_bg_render
		setfarfp	_boss_update_func, mima_update
		mov	_scroll_interval, 1
		jmp	short loc_B88A
; ---------------------------------------------------------------------------

loc_B832:
		mov	word_20616, 0C8h
		setfarfp	_midboss_invalidate, @midbossx_invalidate$qv
		setfarfp	_midboss_update_and_render, @midbossx_update_and_render$qv
		setfarfp	_boss_init, sigma_init
		setfarfp	_boss_end, sigma_end
		setfarfp	_boss_bg_render_func, sigma_bg_render
		setfarfp	_boss_update_func, sigma_update
		call	sub_129FC
		mov	_scroll_interval, 2

loc_B88A:
		call	@tile_area_init_and_put_both$qv
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_B8AF
		call	_snd_delay_until_volume stdcall, 255
		pop	cx
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		push	ds
		push	offset aM	; "m"
		call	sub_B362

loc_B8AF:
		call	@items_init_and_reset$qv
		call	@score_extend_init$qv

loc_B8B5:
		cmp	vsync_Count1, 64h	; 'd'
		jb	short loc_B8B5
		call	text_boxfilla pascal, (4 shl 16) + 1, (51 shl 16) + 23, TX_BLACK + TX_REVERSE
		push	size palette_t
		push	ds
		push	offset unk_1F4AD ; src
		push	ds
		push	offset Palettes ; dest
		call	_memcpy
		add	sp, 0Ah
		call	far ptr	palette_show
		graph_accesspage 1
		call	@tiles_fill_and_put_initial$qv
		graph_accesspage 0
		call	@tiles_render_all$qv
		call	_mpn_free
		call	mpn_load pascal, ds, offset aMiko_k_mpn ; "miko_k.mpn"
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_B922
		push	ss
		lea	ax, [bp+var_C]
		push	ax
		call	sub_13ABB
		add	sp, 4

loc_B922:
		call	grc_setclip pascal, large 0, ((RES_X - 1) shl 16) or (RES_Y - 1)
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 11
		graph_accesspage 0
		call	grcg_boxfill pascal, (PLAYFIELD_RIGHT shl 16) or 0, (575 shl 16) or (RES_Y - 1)
		graph_accesspage 1
		call	grcg_boxfill pascal, (PLAYFIELD_RIGHT shl 16) or 0, (575 shl 16) or (RES_Y - 1)
		call	grcg_off
		mov	_page_front, 1
		mov	al, _page_front
		out	0A4h, al
		xor	al, al
		out	0A6h, al
		mov	_page_back, al
		pop	si
		leave
		retn
sub_B3DA	endp

; ---------------------------------------------------------------------------
off_B982	dw offset loc_B63C
		dw offset loc_B698
		dw offset loc_B701
		dw offset loc_B76A
		dw offset loc_B7DD
		dw offset loc_B832

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B98E	proc near
		push	bp
		mov	bp, sp
		call	@hud_put$qv
		nopcall	@overlay_stage_leave_animate$qv
		mov	ax, PLAYER_LEFT_START
		mov	_player_left_on_page[1 * word], ax
		mov	_player_left_on_page[0 * word], ax
		mov	ax, PLAYER_TOP_START
		mov	_player_top_on_page[1 * word], ax
		mov	_player_top_on_page[0 * word], ax
		call	sub_C5B0
		mov	_player_invincibility_time, CONTINUE_INVINCIBILITY_FRAMES
		graph_accesspage _page_front
		call	@tiles_render_all$qv
		graph_accesspage _page_back
		call	@tiles_render_all$qv
		call	sub_10E0A
		mov	PaletteTone, 100
		call	far ptr	palette_show
		nopcall	@overlay_stage_enter_animate$qv
		pop	bp
		retn
sub_B98E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B9E2	proc near

var_1		= byte ptr -1

		enter	2, 0
		push	si
		xor	si, si
		mov	[bp+var_1], 0
		call	text_putsa pascal, (23 shl 16) + 15, off_1DB70, TX_WHITE + TX_UNDERLINE
		call	text_putsa pascal, (23 shl 16) + 16, off_1DB6C, TX_MAGENTA
		mov	PaletteTone, 70
		call	far ptr	palette_show

loc_BA1D:
		mov	ax, si
		and	ax, 3Fh
		cmp	ax, 32h	; '2'
		jnb	short loc_BA33
		push	(18 shl 16) + 12
		push	ds
		push	offset gPAUSE_MENU
		jmp	short loc_BA3D
; ---------------------------------------------------------------------------

loc_BA33:
		push	(18 shl 16) + 12
		push	ds
		push	offset g11SPACES

loc_BA3D:
		push	TX_WHITE
		call	gaiji_putsa
		call	@input_reset_sense$qv
		inc	si
		cmp	[bp+var_1], 0
		jnz	short loc_BA5C
		cmp	_key_det, 0
		jnz	short loc_BA5C
		mov	[bp+var_1], 1

loc_BA5C:
		cmp	[bp+var_1], 1
		jnz	loc_BB30
		test	byte ptr _key_det, INPUT_UP
		jnz	short loc_BA72
		test	byte ptr _key_det, INPUT_DOWN
		jz	short loc_BAC8

loc_BA72:
		mov	al, 1
		sub	al, byte_1DB74
		mov	byte_1DB74, al
		cmp	byte_1DB74, 0
		jnz	short loc_BA8E
		mov	byte_1F4DD, TX_WHITE + TX_UNDERLINE
		mov	byte_1F4DE, TX_MAGENTA
		jmp	short loc_BA98
; ---------------------------------------------------------------------------

loc_BA8E:
		mov	byte_1F4DD, TX_MAGENTA
		mov	byte_1F4DE, TX_WHITE + TX_UNDERLINE

loc_BA98:
		push	(23 shl 16) + 15
		pushd	[off_1DB70]
		mov	al, byte_1F4DD
		mov	ah, 0
		push	ax
		call	text_putsa
		push	(23 shl 16) + 16
		pushd	[off_1DB6C]
		mov	al, byte_1F4DE
		mov	ah, 0
		push	ax
		call	text_putsa
		mov	[bp+var_1], 0

loc_BAC8:
		test	byte ptr _key_det, INPUT_OK
		jnz	short loc_BAD6
		test	byte ptr _key_det, INPUT_SHOT
		jz	short loc_BB24

loc_BAD6:
		cmp	byte_1DB74, 0
		jnz	short loc_BAE3
		mov	[bp+var_1], 2
		jmp	short loc_BB24
; ---------------------------------------------------------------------------

loc_BAE3:
		call	text_putsa pascal, (17 shl 16) + 14, off_1DB76, TX_WHITE + TX_BLINK
		call	text_putsa pascal, (17 shl 16) + 15, off_1DB7A, TX_WHITE
		call	text_putsa pascal, (17 shl 16) + 16, off_1DB7E, TX_MAGENTA
		mov	[bp+var_1], 3
		mov	byte_1DB74, 0

loc_BB24:
		test	byte ptr _key_det, INPUT_CANCEL
		jz	loc_BCA4
		jmp	loc_BCA0
; ---------------------------------------------------------------------------

loc_BB30:
		cmp	[bp+var_1], 2
		jnz	short loc_BB9D
		cmp	_key_det, 0
		jnz	loc_BCA4
		mov	PaletteTone, 100
		call	far ptr	palette_show
		mov	_key_det, 0
		call	gaiji_putsa pascal, (18 shl 16) + 12, ds, offset g11SPACES, TX_WHITE
		call	gaiji_putsa pascal, (17 shl 16) + 14, ds, offset g11SPACES, TX_WHITE
		call	gaiji_putsa pascal, (17 shl 16) + 15, ds, offset g11SPACES, TX_WHITE
		call	gaiji_putsa pascal, (17 shl 16) + 16, ds, offset g11SPACES, TX_WHITE
		xor	ax, ax
		jmp	loc_BCAE
; ---------------------------------------------------------------------------

loc_BB9D:
		cmp	[bp+var_1], 3
		jnz	short loc_BBB2
		cmp	_key_det, 0
		jnz	loc_BCA4
		inc	[bp+var_1]
		jmp	loc_BCA4
; ---------------------------------------------------------------------------

loc_BBB2:
		cmp	[bp+var_1], 4
		jnz	loc_BCA4
		test	byte ptr _key_det, INPUT_UP
		jnz	short loc_BBC8
		test	byte ptr _key_det, INPUT_DOWN
		jz	short loc_BC1E

loc_BBC8:
		mov	al, 1
		sub	al, byte_1DB74
		mov	byte_1DB74, al
		cmp	byte_1DB74, 0
		jnz	short loc_BBE4
		mov	byte_1F4DD, TX_WHITE + TX_UNDERLINE
		mov	byte_1F4DE, TX_MAGENTA
		jmp	short loc_BBEE
; ---------------------------------------------------------------------------

loc_BBE4:
		mov	byte_1F4DD, TX_MAGENTA
		mov	byte_1F4DE, TX_WHITE + TX_UNDERLINE

loc_BBEE:
		push	(17 shl 16) + 15
		pushd	[off_1DB7A]
		mov	al, byte_1F4DD
		mov	ah, 0
		push	ax
		call	text_putsa
		push	(17 shl 16) + 16
		pushd	[off_1DB7E]
		mov	al, byte_1F4DE
		mov	ah, 0
		push	ax
		call	text_putsa
		mov	[bp+var_1], 3

loc_BC1E:
		test	byte ptr _key_det, INPUT_OK
		jnz	short loc_BC2C
		test	byte ptr _key_det, INPUT_SHOT
		jz	short loc_BC99

loc_BC2C:
		cmp	byte_1DB74, 0
		jnz	short loc_BC94
		call	gaiji_putsa pascal, (17 shl 16) + 14, ds, offset g11SPACES, TX_WHITE
		call	gaiji_putsa pascal, (17 shl 16) + 15, ds, offset g11SPACES, TX_WHITE
		call	gaiji_putsa pascal, (17 shl 16) + 16, ds, offset g11SPACES, TX_WHITE
		call	text_putsa pascal, (23 shl 16) + 15, off_1DB70, TX_WHITE + TX_UNDERLINE
		call	text_putsa pascal, (23 shl 16) + 16, off_1DB6C, TX_MAGENTA
		mov	[bp+var_1], 0
		jmp	short loc_BC99
; ---------------------------------------------------------------------------

loc_BC94:
		mov	ax, 1
		jmp	short loc_BCAE
; ---------------------------------------------------------------------------

loc_BC99:
		test	byte ptr _key_det, INPUT_CANCEL
		jz	short loc_BCA4

loc_BCA0:
		mov	[bp+var_1], 2

loc_BCA4:
		call	@frame_delay$qi pascal, 1
		jmp	loc_BA1D
; ---------------------------------------------------------------------------

loc_BCAE:
		pop	si
		leave
		retn
sub_B9E2	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_BCB1	proc far

var_8		= dword	ptr -8
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 8
		push	si
		mov	eax, dword_1DB82
		mov	[bp+var_8], eax
		jmp	loc_BF63
; ---------------------------------------------------------------------------

loc_BCC3:
		call	_snd_se_update
		call	farfp_1F498
		call	bgm_show
		mov	si, _scroll_line
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		lea	dx, [bp+var_8]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		mov	_scroll_line, ax
		call	_boss_bg_render
		cmp	_midboss_active, 0
		jz	short loc_BCF9
		call	_midboss_invalidate
		mov	_midboss_active, al

loc_BCF9:
		call	farfp_26C3C
		call	@player_invalidate$qv
		call	@bullets_invalidate$qv
		call	farfp_23A72
		call	@items_invalidate$qv
		call	sub_4288
		call	sub_E2D9
		cmp	word_2034C, 0
		jz	short loc_BD26
		call	sub_16D9B
		mov	word_2034C, 0

loc_BD26:
		call	@egc_start_copy_1$qv
		call	farfp_1F4A0
		call	@tiles_egc_render$qv
		call	farfp_1F490
		outw2	EGC_ACTIVEPLANEREG, 0FFF0h
		outw2	EGC_MASKREG, 0FFFFh
		graph_mode_change	1
		graph_mode_egc	0
		GRCG_OFF_VIA_MOV al
		graph_mode_change	0
		mov	ax, word_2034A
		cmp	ax, word_20616
		jnz	short loc_BD62
		mov	_midboss_active, 1

loc_BD62:
		mov	byte_1E503, 0
		mov	_scroll_line, si
		cmp	_scroll_done, 0
		jnz	short loc_BDA2
		mov	al, _scroll_cycle
		mov	ah, 0
		mov	dl, _scroll_interval
		mov	dh, 0
		push	dx
		cwd
		pop	bx
		idiv	bx
		or	dx, dx
		jnz	short loc_BDA2
		mov	al, _scroll_speed
		mov	ah, 0
		sub	_scroll_line, ax
		cmp	_scroll_line, 0
		jge	short loc_BD9C
		add	_scroll_line, RES_Y

loc_BD9C:
		mov	al, _scroll_speed
		mov	byte_1E503, al

loc_BDA2:
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		lea	dx, [bp+var_8]
		add	ax, dx
		mov	dx, _scroll_line
		mov	bx, ax
		mov	ss:[bx], dx
		call	@input_reset_sense$qv
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jz	short loc_BDCC
		nopcall	DemoPlay

loc_BDCC:
		call	sub_F1D8
		call	@bomb_update_and_render$qv
		call	farfp_26C40
		call	_boss_update
		mov	_stage_progression, al
		cmp	_midboss_active, 0
		jz	short loc_BDE8
		call	_midboss_update_and_render

loc_BDE8:
		call	sub_EF36
		call	@items_update_and_render$qv
		call	farfp_23A76
		call	@bullets_update_and_render$qv
		call	sub_41AA
		test	byte ptr _key_det, INPUT_CANCEL
		jz	short loc_BE0F
		call	sub_B9E2
		or	ax, ax
		jz	short loc_BE0F
		mov	byte_20607, 1

loc_BE0F:
		cmp	byte_1E503, 0
		jz	loc_BEDC
		mov	ax, _scroll_line
		shl	ax, 5
		mov	dx, _scroll_line
		shl	dx, 3
		add	ax, dx
		mov	word_20348, ax
		test	byte ptr _scroll_line, 7
		jnz	short loc_BE3B
		inc	word_2034A
		mov	word_2034C, 1

loc_BE3B:
		call	@egc_start_copy_1$qv
		mov	al, _scroll_speed
		mov	ah, 0
		call	@tiles_scroll_and_egc_render_both$qi pascal, ax
		mov	_scroll_done, al
		outw2	EGC_ACTIVEPLANEREG, 0FFF0h
		outw2	EGC_MASKREG, 0FFFFh
		graph_mode_change	1
		graph_mode_egc	0
		GRCG_OFF_VIA_MOV al
		graph_mode_change	0
		cmp	_scroll_done, 0
		jz	short loc_BE77

		; On this final frame of the stage, we already were one pixel past the
		; end of the tile map. Pretend we didn't overshoot by just not running
		; the GDC SCROLL command this frame, and fix up [scroll_line] so that
		; all sprites blitted during the boss fight appear at their correct Y
		; coordinate.
		; ZUN bug: But we've just rendered a full frame of sprites *at* the
		; wrong [scroll_line] :zunpet: As a result, these will appear one pixel
		; higher than where they should be, since we skip the GDC SCROLL that
		; would compensate for it.
		inc	_scroll_line
		jmp	short loc_BEE0
; ---------------------------------------------------------------------------

loc_BE77:
		mov	ax, RES_Y
		sub	ax, _scroll_line
		mov	[bp+var_2], ax
		mov	ax, word_20348
		mov	[bp+var_4], ax
		mov	cx, graph_VramZoom
		mov	cl, 4

loc_BE8D:
		jmp	short $+2
		in	al, 0A0h	; PIC 2	 same as 0020 for PIC 1
		test	cl, al
		jz	short loc_BE8D
		mov	al, 70h	; 7 = SCROLL, 0 = starting regularly with the first parameter
		out	0A2h, al
		mov	ax, [bp+var_4]
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	al, ah
		jmp	short $+2
		jmp	short $+2
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	ax, [bp+var_2]
		shl	ax, cl
		or	ah, ch
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	al, ah
		jmp	short $+2
		jmp	short $+2
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	ax, 0
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	al, ah
		jmp	short $+2
		jmp	short $+2
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	ax, RES_Y
		shl	ax, cl
		or	ah, ch
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		mov	al, ah
		jmp	short $+2
		jmp	short $+2
		out	0A0h, al	; PIC 2	 same as 0020 for PIC 1
		cmp	_scroll_done, 0
		jnz	short loc_BEE0

loc_BEDC:
		inc	_scroll_cycle

loc_BEE0:
		cmp	_slowdown_factor, 1
		jnz	short loc_BEED
		mov	vsync_Count1, 0

loc_BEED:
		mov	al, _slowdown_factor
		mov	ah, 0
		cmp	ax, vsync_Count1
		ja	short loc_BEED
		mov	vsync_Count1, 0
		mov	al, _page_back
		mov	_page_front, al
		out	0A4h, al
		xor	_page_back, 1
		mov	al, _page_back
		out	0A6h, al
		call	farfp_1F494
		les	bx, _resident
		inc	es:[bx+mikoconfig_t.frame]
		inc	_stage_frame
		call	farfp_1F48C
		or	ax, ax
		jz	short loc_BF36
		cmp	byte_20607, 0
		jnz	short loc_BF36
		mov	ax, 1
		jmp	short loc_BF78
; ---------------------------------------------------------------------------

loc_BF36:
		mov	eax, _stage_frame
		mov	ebx, 1800
		xor	edx, edx
		div	ebx
		cmp	edx, 1500
		jnz	short loc_BF60
		mov	al, _playperf_max
		mov	ah, 0
		cmp	ax, _playperf
		jle	short loc_BF60
		inc	_playperf
		jmp	short $+2

loc_BF60:
		call	@score_update_and_render$qv

loc_BF63:
		cmp	byte_20607, 0
		jz	loc_BCC3
		nopcall	@score_delta_commit$qv
		mov	byte_20607, 0
		xor	ax, ax

loc_BF78:
		pop	si
		leave
		retf
sub_BCB1	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public TEXT_WIPE
text_wipe	proc near
		push	bp
		mov	bp, sp
		call	text_clear
		call	text_fillca pascal, (' ' shl 16) + TX_BLACK + TX_REVERSE
		pop	bp
		retn
text_wipe	endp

include th02/main/null.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_BF9C	proc far
		push	bp
		mov	bp, sp
		cmp	_stage_progression, SP_CLEAR
		jnz	short loc_BFCC
		mov	al, _stage_id
		cbw
		cmp	ax, 2
		jnz	short loc_BFC3
		mov	Palettes[0 * size rgb_t].r, 0
		mov	Palettes[0 * size rgb_t].g, 0
		mov	Palettes[0 * size rgb_t].b, 0
		call	far ptr	palette_show

loc_BFC3:
		call	_boss_end
		mov	ax, 1
		pop	bp
		retf
; ---------------------------------------------------------------------------

loc_BFCC:
		xor	ax, ax
		pop	bp
		retf
sub_BF9C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_BFD0	proc far
		push	bp
		mov	bp, sp
		cmp	_scroll_done, 1
		jnz	loc_C05B
		mov	_stage_progression, SP_BOSS
		mov	al, _stage_id
		cbw
		cmp	ax, 3
		jnz	short loc_BFF8
		setfarfp	farfp_1F490, @nullfunc_void$qv
		jmp	short loc_C015
; ---------------------------------------------------------------------------

loc_BFF8:
		mov	al, _stage_id
		cbw
		cmp	ax, 2
		jnz	short loc_C015
		mov	Palettes, 0
		mov	Palettes+1, 0
		mov	Palettes+2, 0
		call	far ptr	palette_show

loc_C015:
		call	_boss_init
		call	sub_17A55
		call	sub_16A8A
		setfarfp	farfp_1F494, @nullfunc_void$qv
		mov	eax, _boss_bg_render_func
		mov	_boss_bg_render, eax
		mov	eax, _boss_update_func
		mov	_boss_update, eax
		setfarfp	farfp_1F48C, sub_BF9C
		mov	_scroll_cycle, -1
		mov	bgm_show_timer, 1
		mov	al, byte_1F46E
		mov	_bgm_title_id, al

loc_C05B:
		pop	bp
		retf
sub_BFD0	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C05D	proc far
		push	bp
		mov	bp, sp
		cmp	_stage_frame, 160
		jnz	short loc_C0A6
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 0
		jnz	short loc_C09A
		call	text_putsa pascal, (4 shl 16) + 12, ds, offset aEMPTY, TX_WHITE
		call	text_putsa pascal, (4 shl 16) + 13, ds, offset aEMPTY, TX_WHITE

loc_C09A:
		setfarfp	farfp_1F498, @nullfunc_void$qv

loc_C0A6:
		pop	bp
		retf
sub_C05D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

bgm_show	proc near
		push	bp
		mov	bp, sp
		cmp	bgm_show_timer, 0
		jz	short loc_C108
		cmp	bgm_show_timer, 1
		jnz	short loc_C0E6
		call	gaiji_putca pascal, (24 shl 16) + 23, (gs_NOTES shl 16) + TX_YELLOW
		push	(26 shl 16) + 23
		push	ds
		mov	al, _bgm_title_id
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	word ptr _BGM_TITLES[bx]
		push	TX_WHITE
		call	text_putsa

loc_C0E6:
		inc	bgm_show_timer
		cmp	bgm_show_timer, 0A0h
		jb	short loc_C108
		call	text_putsa pascal, (24 shl 16) + 23, ds, offset aEMPTY+22, TX_WHITE
		mov	bgm_show_timer, 0

loc_C108:
		pop	bp
		retn
bgm_show	endp

EGC_START_COPY_DEF 1, near

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public demo_load
demo_load	proc far
		push	bp
		mov	bp, sp
		call	hmem_allocbyte pascal, DEMO_N * 2
		mov	word ptr _DemoBuf+2, ax
		mov	word ptr _DemoBuf, 0
		mov	_power, POWER_MAX
		mov	_playperf, 12
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.frame], 12h
		cmp	es:[bx+mikoconfig_t.demo_num], 1
		jnz	short loc_C18A
		mov	_stage_id, 3
		push	ds
		push	offset aDemo1_rec ; "DEMO1.REC"
		call	file_ropen
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.shottype], 0
		jmp	short loc_C1D0
; ---------------------------------------------------------------------------

loc_C18A:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 2
		jnz	short loc_C1AE
		mov	_stage_id, 2
		push	ds
		push	offset aDemo2_rec ; "DEMO2.REC"
		call	file_ropen
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.shottype], 2
		jmp	short loc_C1D0
; ---------------------------------------------------------------------------

loc_C1AE:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.demo_num], 3
		jnz	short loc_C1D0
		mov	_stage_id, 1
		push	ds
		push	offset aDemo3_rec ; "DEMO3.REC"
		call	file_ropen
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.shottype], 1

loc_C1D0:
		call	file_read pascal, large [_DemoBuf], DEMO_N * 2
		call	file_close
		pop	bp
		retf
demo_load	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public DEMOPLAY
DemoPlay	proc far ; ZUN symbol [MAGNet2010]
		push	bp
		mov	bp, sp
		cmp	_key_det, 0
		jnz	short loc_C20B
		mov	ax, _demo_frame
		add	ax, ax
		les	bx, _DemoBuf
		add	bx, ax
		mov	ax, es:[bx]
		mov	_key_det, ax
		inc	_demo_frame
		cmp	_demo_frame, DEMO_N - 50
		jl	short loc_C222

loc_C20B:
		mov	_key_det, 0
		push	0Ah
		call	palette_black_out
		mov	byte_20607, 1
		call	_snd_se_reset

loc_C222:
		pop	bp
		retf
DemoPlay	endp

include th02/math/randring_fill.asm
RANDRING_NEXT_DEF 1

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public CFG_LOAD
cfg_load	proc near

@@resident_seg		= word ptr -2

		enter	2, 0
		push	ds
		push	offset aHuuma_cfg ; "huuma.cfg"
		call	file_ropen
		pushd	5
		push	0
		call	file_seek
		push	ss
		lea	ax, [bp+@@resident_seg]
		push	ax
		push	2
		call	file_read
		call	file_close
		cmp	[bp+@@resident_seg], 0
		jz	short loc_C2F0
		mov	ax, [bp+@@resident_seg]
		mov	word ptr _resident+2, ax
		mov	word ptr _resident, 0
		les	bx, _resident
		mov	al, es:[bx+mikoconfig_t.stage]
		mov	_stage_id, al
		mov	al, es:[bx+mikoconfig_t.start_lives]
		mov	_lives, al
		mov	al, es:[bx+mikoconfig_t.start_bombs]
		mov	_bombs, al
		mov	al, es:[bx+mikoconfig_t.rank]
		mov	_rank, al
		mov	al, es:[bx+mikoconfig_t.start_power]
		mov	_power, al
		cmp	_power, 0
		jnz	short loc_C2DF
		inc	_power

loc_C2DF:
		mov	_playperf, 0
		mov	_item_bigpower_override, 0
		mov	ax, 1
		leave
		retn
; ---------------------------------------------------------------------------

loc_C2F0:
		xor	ax, ax
		leave
		retn
cfg_load	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C2F4	proc near

arg_0		= word ptr  4
arg_2		= word ptr  6

		push	bp
		mov	bp, sp
		push	18000Eh
		push	ds
		push	offset gYES
		push	[bp+arg_2]
		call	gaiji_putsa
		push	19000Fh
		push	ds
		push	offset gNO
		push	[bp+arg_0]
		call	gaiji_putsa
		pop	bp
		retn	4
sub_C2F4	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C31F	proc near

var_2		= word ptr -2

		enter	2, 0
		push	si
		push	di
		mov	[bp+var_2], 0
		mov	di, 1
		nopcall	@overlay_stage_leave_animate$qv
		mov	PaletteTone, 50
		call	far ptr	palette_show
		nopcall	@overlay_stage_enter_animate$qv
		mov	si, 15h
		jmp	loc_C3E5
; ---------------------------------------------------------------------------

loc_C348:
		push	18
		lea	ax, [si+1]
		push	ax
		push	ds
		push	offset asc_1E47E ; "		    "
		push	TX_WHITE
		call	text_putsa
		call	gaiji_putsa pascal, 18, si, ds, offset gGAMEOVER, TX_WHITE
		push	18
		mov	ax, 23
		sub	ax, si
		push	ax
		push	ds
		push	offset asc_1E47E ; "		    "
		push	TX_WHITE
		call	text_putsa
		push	18
		mov	ax, 24
		sub	ax, si
		push	ax
		push	ds
		push	offset gGAMEOVER
		push	TX_WHITE
		call	gaiji_putsa
		mov	ax, 29
		sub	ax, si
		call	text_putsa pascal, ax, 12, ds, offset asc_1E47E, TX_WHITE
		mov	ax, 30
		sub	ax, si
		call	gaiji_putsa pascal, ax, 12, ds, offset gGAMEOVER, TX_WHITE
		lea	ax, [si+7]
		call	text_putsa pascal, ax, 12, ds, offset asc_1E47E, TX_WHITE
		lea	ax, [si+6]
		call	gaiji_putsa pascal, ax, 12, ds, offset gGAMEOVER, TX_WHITE
		call	@frame_delay$qi pascal, 1
		dec	si

loc_C3E5:
		cmp	si, 0Ch
		jge	loc_C348
		call	@frame_delay$qi pascal, 30
		mov	_key_det, 0
		jmp	short loc_C400
; ---------------------------------------------------------------------------

loc_C3FB:
		call	@input_reset_sense$qv

loc_C400:
		cmp	_key_det, 0
		jz	short loc_C3FB
		call	@overlay_wipe$qv
		call	@regist_menu$qv
		call	@overlay_wipe$qv
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.continues_used], 3
		jnb	loc_C4F5
		mov	al, _rank
		cbw
		cmp	ax, RANK_EXTRA
		jge	loc_C4F5
		call	gaiji_putsa pascal, (18 shl 16) + 12, ds, offset gCONTINUE?, TX_WHITE
		push	0E500E1h
		call	sub_C2F4
		call	gaiji_putsa pascal, (18 shl 16) + 20, ds, offset gCREDIT, TX_GREEN
		les	bx, _resident
		mov	ax, gb_3_
		sub	ax, es:[bx+mikoconfig_t.continues_used]
		mov	si, ax
		call	gaiji_putca pascal, (32 shl 16) + 20, ax, TX_GREEN
		mov	di, 1

loc_C47A:
		call	@input_reset_sense$qv
		cmp	[bp+var_2], 0
		jnz	short loc_C493
		cmp	_key_det, 0
		jnz	short loc_C493
		mov	[bp+var_2], 1
		jmp	short loc_C4A5
; ---------------------------------------------------------------------------

loc_C493:
		cmp	[bp+var_2], 1
		jnz	short loc_C4A5
		cmp	_key_det, 0
		jz	short loc_C4A5
		mov	[bp+var_2], 2

loc_C4A5:
		test	byte ptr _key_det, INPUT_UP
		jz	short loc_C4B8
		mov	di, 1
		push	0E500E1h
		call	sub_C2F4

loc_C4B8:
		test	byte ptr _key_det, INPUT_DOWN
		jz	short loc_C4CA
		xor	di, di
		push	0E100E5h
		call	sub_C2F4

loc_C4CA:
		cmp	[bp+var_2], 2
		jnz	short loc_C4E5
		test	byte ptr _key_det, INPUT_SHOT
		jnz	short loc_C4EE
		test	byte ptr _key_det, INPUT_OK
		jnz	short loc_C4EE
		test	byte ptr _key_det, INPUT_CANCEL
		jnz	short loc_C4EE

loc_C4E5:
		call	@frame_delay$qi pascal, 1
		jmp	short loc_C47A
; ---------------------------------------------------------------------------

loc_C4EE:
		test	byte ptr _key_det, INPUT_CANCEL
		jz	short loc_C4F7

loc_C4F5:
		xor	di, di

loc_C4F7:
		les	bx, _resident
		mov	eax, es:[bx+mikoconfig_t.score_highest]
		cmp	eax, _score
		jnb	short loc_C50D
		mov	eax, _score
		jmp	short loc_C516
; ---------------------------------------------------------------------------

loc_C50D:
		les	bx, _resident
		mov	eax, es:[bx+mikoconfig_t.score_highest]

loc_C516:
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.score_highest], eax
		mov	al, es:[bx+mikoconfig_t.start_lives]
		mov	_lives, al
		mov	al, es:[bx+mikoconfig_t.start_bombs]
		mov	_bombs, al
		mov	_power, POWER_MIN
		inc	es:[bx+mikoconfig_t.continues_used]
		call	@score_reset$qv
		mov	al, _stage_id
		cbw
		mov	bx, 5
		cwd
		idiv	bx
		add	dx, 2
		mov	_item_bigpower_override, dx
		mov	_power_overflow, 10
		mov	PaletteTone, 100
		call	far ptr	palette_show
		call	@overlay_wipe$qv
		mov	ax, di
		pop	di
		pop	si
		leave
		retn
sub_C31F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

public @GameExecl$qnxc
@GameExecl$qnxc	proc far

@@binary_fn		= dword	ptr  6

		push	bp
		mov	bp, sp
		freePISlotLarge	0
		call	sub_E24A
		call	_mpn_free
		call	sub_1C608
		call	super_free
		call	graph_clear
		call	text_clear
		call	@gaiji_free$qv
		call	@game_exit$qv
		call	_execl c, large [bp+@@binary_fn], large [bp+@@binary_fn], large 0
		pop	bp
		retf
@GameExecl$qnxc	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C5B0	proc near
		push	bp
		mov	bp, sp
		xor	dx, dx
		jmp	short loc_C5C2
; ---------------------------------------------------------------------------

loc_C5B7:
		mov	bx, dx
		shl	bx, 4
		mov	byte ptr [bx+2908h], 0
		inc	dx

loc_C5C2:
		cmp	dx, 26h	; '&'
		jl	short loc_C5B7
		mov	byte_205DE, 0
		mov	_player_invincibility_time, 0
		mov	_player_invincible_via_bomb, 0
		mov	byte_20607, 0
		mov	_stage_miss_count, 0
		mov	byte_20609, 0
		mov	byte_205DF, 8
		mov	byte_205E0, 0
		mov	_player_is_hit, 0
		mov	byte_1E517, 0
		mov	_player_option_patnum, PAT_OPTION_A
		mov	word_205D8, 0FFFFh
		mov	word_205DC, 0FFFFh
		mov	word_205DA, 0FFFFh
		mov	byte_20610, 0
		mov	byte_20611, 0
		les	bx, _resident
		mov	al, es:[bx+mikoconfig_t.shottype]
		mov	ah, 0
		or	ax, ax
		jz	short loc_C634
		cmp	ax, 1
		jz	short loc_C655
		cmp	ax, 2
		jz	short loc_C67F
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_C634:
		mov	playchar_shot_func, offset shot_a
		mov	_playchar_speed_aligned_x, 5
		mov	_playchar_speed_aligned_y, 5
		mov	_playchar_speed_diagonal_x, 4
		mov	_playchar_speed_diagonal_y, 4
		mov	byte_2060E, 30h	; '0'
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_C655:
		mov	playchar_shot_func, offset shot_b
		mov	_playchar_speed_aligned_x, 4
		mov	_playchar_speed_aligned_y, 4
		mov	_playchar_speed_diagonal_x, 3
		mov	_playchar_speed_diagonal_y, 3
		mov	byte_2060E, 34h	; '4'
		mov	byte_2060F, 37h	; '7'
		inc	_player_option_patnum
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_C67F:
		mov	playchar_shot_func, offset shot_c
		mov	_playchar_speed_aligned_x, 3
		mov	_playchar_speed_aligned_y, 3
		mov	_playchar_speed_diagonal_x, 3
		mov	_playchar_speed_diagonal_y, 3
		mov	byte_1E518, 3
		mov	byte_2060E, 7Dh	; '}'
		mov	byte_2060F, 3Bh	; ';'
		mov	al, _player_option_patnum
		add	al, 2
		mov	_player_option_patnum, al
		pop	bp
		retn
sub_C5B0	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @PLAYER_INVALIDATE$QV
@player_invalidate$qv proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	[bp+var_2], 2
		call	sub_D38F
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _player_left_on_page
		mov	_player_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _player_top_on_page
		mov	_player_top_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, offset _player_option_left_topleft.x
		mov	_player_option_left_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, offset _player_option_left_topleft.y
		mov	_player_option_left_top_on_back_page, ax
		mov	bx, _player_left_on_back_page
		push	word ptr [bx]	; left
		mov	bx, _player_top_on_back_page
		push	word ptr [bx]	; top
		push	(PLAYER_W shl 16) or PLAYER_H	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	bx, _player_option_left_left_on_back_page
		mov	si, [bx]
		push	si	; left
		mov	bx, _player_option_left_top_on_back_page
		push	word ptr [bx]	; top
		push	(PLAYER_OPTION_W shl 16) or PLAYER_OPTION_H	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		lea	ax, [si+PLAYER_OPTION_TO_OPTION_DISTANCE]
		push	ax	; left
		mov	bx, _player_option_left_top_on_back_page
		push	word ptr [bx]	; top
		push	(PLAYER_OPTION_W shl 16) or PLAYER_OPTION_H	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		mov	bx, _player_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_top_on_page[bx]
		mov	bx, _player_top_on_back_page
		mov	[bx], ax
		pop	si
		leave
		retn
@player_invalidate$qv endp
main_01_TEXT	ends

POINTNUM_TEXT	segment	byte public 'CODE' use16
	@pointnums_init_for_rank_and_rese$qv procdesc near
	@pointnums_invalidate$qv procdesc near
	@pointnums_update_and_render$qv procdesc near
POINTNUM_TEXT	ends

main_01__TEXT	segment	word public 'CODE' use16
include th02/main/pointnum/num_put.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_CA1C	proc far
		push	bp
		mov	bp, sp
		mov	_scroll_speed, 1
		mov	_scroll_cycle, 0
		mov	_scroll_line, 0
		mov	_scroll_unused, 0
		mov	word_2034A, 0
		mov	_scroll_interval, 4
		mov	_scroll_done, 0
		mov	byte_2034E, 0
		mov	byte_1E502, 0
		mov	word_20348, 0
		mov	word_2034C, 0
		mov	byte_1E503, 0
		pop	bp
		retf
sub_CA1C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_CA62	proc near

@@angle		= byte ptr  4
arg_2		= word ptr  6

		push	bp
		mov	bp, sp
		push	si
		mov	dl, [bp+@@angle]
		mov	ax, word_205E2
		shl	ax, 4
		add	ax, 2908h
		mov	si, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	cx, ax
		mov	word ptr [si], 1
		mov	ax, _player_topleft.x
		add	ax, [bp+arg_2]
		shl	ax, 4
		mov	bx, cx
		add	bx, bx
		mov	[bx+si+2], ax
		mov	bx, cx
		add	bx, bx
		mov	ax, word_205E4
		mov	[bx+si+4], ax
		mov	al, dl
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _CosTable8[bx]
		imul	ax, 0Ch
		sar	ax, 4
		mov	[si+0Ah], ax
		mov	al, dl
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _SinTable8[bx]
		imul	ax, 0Ch
		sar	ax, 4
		mov	[si+0Ch], ax
		mov	al, byte_1E519
		mov	ah, 0
		mov	[si+0Eh], ax
		pop	si
		pop	bp
		retn	4
sub_CA62	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_CAD2	proc near

arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8

		push	bp
		mov	bp, sp
		push	si
		mov	ax, word_205E2
		shl	ax, 4
		add	ax, 2908h
		mov	si, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	dx, ax
		mov	word ptr [si], 101h
		mov	bx, _player_option_left_left_on_back_page
		mov	ax, [bx]
		add	ax, [bp+arg_4]
		shl	ax, 4
		mov	bx, dx
		add	bx, bx
		mov	[bx+si+2], ax
		mov	bx, _player_option_left_top_on_back_page
		mov	ax, [bx]
		shl	ax, 4
		mov	bx, dx
		add	bx, bx
		mov	[bx+si+4], ax
		mov	ax, [bp+arg_2]
		mov	[si+0Ah], ax
		mov	ax, [bp+arg_0]
		mov	[si+0Ch], ax
		mov	al, byte_1E51A
		mov	ah, 0
		add	ax, 100h
		mov	[si+0Eh], ax
		pop	si
		pop	bp
		retn	6
sub_CAD2	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

shot_a	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		xor	si, si
		xor	di, di
		mov	[bp+var_2], 0
		mov	ax, _player_topleft.y
		add	ax, 32
		shl	ax, 4
		mov	word_205E4, ax
		mov	word_205E2, 0
		jmp	loc_CD04
; ---------------------------------------------------------------------------

loc_CB53:
		mov	bx, word_205E2
		shl	bx, 4
		cmp	byte ptr [bx+2908h], 0
		jnz	loc_CD00
		mov	al, _shot_level
		mov	ah, 0
		mov	bx, ax
		cmp	bx, SHOT_LEVEL_MAX
		ja	loc_CCFB
		add	bx, bx
		jmp	cs:off_CD16[bx]

loc_CB78:
		push	8
		push	0C0h
		call	sub_CA62
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CB83:
		push	8
		push	3
		call	@randring1_next8_and$quc
		add	al, 0BEh
		push	ax
		call	sub_CA62
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CB93:
		cmp	si, 1
		jnz	short loc_CB9D
		mov	[bp+var_2], 10h

loc_CB9D:
		push	[bp+var_2]
		push	7
		call	@randring1_next8_and$quc
		add	al, 0BCh
		push	ax

loc_CBA8:
		call	sub_CA62
		mov	di, 1
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CBB1:
		cmp	si, 1
		jnz	short loc_CBBB
		mov	[bp+var_2], 10h

loc_CBBB:
		push	[bp+var_2]
		push	0C0h
		jmp	short loc_CBA8
; ---------------------------------------------------------------------------

loc_CBC3:
		mov	[bp+var_2], 2

loc_CBC8:
		or	si, si
		jnz	short loc_CBD3
		push	8
		push	0C0h
		jmp	short loc_CBE9
; ---------------------------------------------------------------------------

loc_CBD3:
		cmp	si, 1
		jnz	short loc_CBE1
		push	8
		mov	al, 0BBh
		sub	al, byte ptr [bp+var_2]
		jmp	short loc_CBE8
; ---------------------------------------------------------------------------

loc_CBE1:
		push	8
		mov	al, byte ptr [bp+var_2]
		add	al, 0C5h

loc_CBE8:
		push	ax

loc_CBE9:
		call	sub_CA62
		mov	di, 2
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CBF2:
		or	si, si
		jnz	short loc_CBFD
		push	0
		push	0C0h
		jmp	short loc_CC19
; ---------------------------------------------------------------------------

loc_CBFD:
		cmp	si, 1
		jnz	short loc_CC09
		push	10h
		push	0C0h
		jmp	short loc_CC19
; ---------------------------------------------------------------------------

loc_CC09:
		push	1Fh
		call	@randring1_next8_and$quc
		mov	ah, 0
		add	ax, 0B1h
		mov	[bp+var_2], ax
		push	8
		push	ax

loc_CC19:
		call	sub_CA62
		mov	di, 3
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CC22:
		or	si, si
		jnz	short loc_CC2D
		push	0
		push	0C0h
		jmp	short loc_CC4A
; ---------------------------------------------------------------------------

loc_CC2D:
		cmp	si, 1
		jnz	short loc_CC39
		push	10h
		push	0C0h
		jmp	short loc_CC4A
; ---------------------------------------------------------------------------

loc_CC39:
		cmp	si, 2
		jnz	short loc_CC45
		push	8
		push	0B8h
		jmp	short loc_CC4A
; ---------------------------------------------------------------------------

loc_CC45:
		push	8
		push	0C8h

loc_CC4A:
		call	sub_CA62
		mov	di, 3
		jmp	loc_CCFB
; ---------------------------------------------------------------------------

loc_CC53:
		or	si, si
		jnz	short loc_CC5E
		mov	[bp+var_2], 0C0h
		jmp	short loc_CC87
; ---------------------------------------------------------------------------

loc_CC5E:
		cmp	si, 1
		jnz	short loc_CC6A
		mov	[bp+var_2], 0B8h
		jmp	short loc_CC87
; ---------------------------------------------------------------------------

loc_CC6A:
		cmp	si, 2
		jnz	short loc_CC76
		mov	[bp+var_2], 0C8h
		jmp	short loc_CC87
; ---------------------------------------------------------------------------

loc_CC76:
		cmp	si, 3
		jnz	short loc_CC82
		mov	[bp+var_2], 0B0h ; ''
		jmp	short loc_CC87
; ---------------------------------------------------------------------------

loc_CC82:
		mov	[bp+var_2], 0D0h

loc_CC87:
		push	8
		push	[bp+var_2]
		call	sub_CA62
		mov	di, 4
		jmp	short loc_CCFB
; ---------------------------------------------------------------------------

loc_CC94:
		or	si, si
		jnz	short loc_CC9F
		push	0
		push	0C0h
		jmp	short loc_CCF5
; ---------------------------------------------------------------------------

loc_CC9F:
		cmp	si, 1
		jnz	short loc_CCAB
		push	10h
		push	0C0h
		jmp	short loc_CCF5
; ---------------------------------------------------------------------------

loc_CCAB:
		cmp	si, 2
		jnz	short loc_CCBE
		mov	byte_1E519, 34h	; '4'
		mov	[bp+var_2], 0B3h
		push	8
		jmp	short loc_CCF2
; ---------------------------------------------------------------------------

loc_CCBE:
		cmp	si, 3
		jnz	short loc_CCCC
		mov	[bp+var_2], 0CDh
		push	8
		jmp	short loc_CCF2
; ---------------------------------------------------------------------------

loc_CCCC:
		cmp	si, 4
		jnz	short loc_CCE6
		mov	byte_1E519, 36h	; '6'
		mov	al, byte_20610
		cbw
		mov	dx, 0C0h
		sub	dx, ax
		mov	[bp+var_2], dx
		push	0FFE8h
		jmp	short loc_CCF2
; ---------------------------------------------------------------------------

loc_CCE6:
		mov	al, byte_20610
		cbw
		add	ax, 0C0h
		mov	[bp+var_2], ax
		push	28h ; '('

loc_CCF2:
		push	[bp+var_2]

loc_CCF5:
		call	sub_CA62
		mov	di, 5

loc_CCFB:
		cmp	si, di
		jz	short loc_CD0D
		inc	si

loc_CD00:
		inc	word_205E2

loc_CD04:
		cmp	word_205E2, 26h	; '&'
		jl	loc_CB53

loc_CD0D:
		mov	byte_205DE, 0
		pop	di
		pop	si
		leave
		retn
shot_a	endp

; ---------------------------------------------------------------------------
off_CD16	dw offset loc_CB78
		dw offset loc_CB83
		dw offset loc_CB93
		dw offset loc_CBB1
		dw offset loc_CBC8
		dw offset loc_CBC3
		dw offset loc_CBF2
		dw offset loc_CC22
		dw offset loc_CC53
		dw offset loc_CC94

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

shot_b	proc near

var_3		= byte ptr -3
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		xor	si, si
		xor	di, di
		mov	[bp+var_2], 0
		mov	[bp+var_3], 0
		mov	ax, _player_topleft.y
		add	ax, 32
		shl	ax, 4
		mov	word_205E4, ax
		mov	word_205E2, 0
		jmp	loc_D039
; ---------------------------------------------------------------------------

loc_CD54:
		mov	bx, word_205E2
		shl	bx, 4
		cmp	byte ptr [bx+2908h], 0
		jnz	loc_D035
		cmp	[bp+var_3], 0
		jnz	loc_CEF7
		mov	al, _shot_level
		mov	ah, 0
		mov	bx, ax
		cmp	bx, SHOT_LEVEL_MAX
		ja	loc_CEE8
		add	bx, bx
		jmp	cs:off_D057[bx]

loc_CD81:
		push	8
		push	0C0h
		call	sub_CA62
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CD8C:
		push	8
		push	3
		call	@randring1_next8_and$quc
		add	al, 0BEh
		jmp	short loc_CDA0
; ---------------------------------------------------------------------------

loc_CD97:
		push	8
		push	7
		call	@randring1_next8_and$quc
		add	al, 0BCh

loc_CDA0:
		push	ax
		call	sub_CA62
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CDA7:
		or	si, si
		jnz	short loc_CDAF
		push	0
		jmp	short loc_CDB1
; ---------------------------------------------------------------------------

loc_CDAF:
		push	10h

loc_CDB1:
		push	7
		call	@randring1_next8_and$quc
		add	al, 0BCh
		push	ax
		call	sub_CA62
		mov	di, 1
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CDC2:
		cmp	si, 1
		jnz	short loc_CDCC
		mov	[bp+var_2], 10h

loc_CDCC:
		push	[bp+var_2]
		push	0C0h
		call	sub_CA62
		mov	di, 1
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CDDB:
		or	si, si
		jnz	short loc_CDE6
		push	0
		push	0BEh
		jmp	short loc_CDEB
; ---------------------------------------------------------------------------

loc_CDE6:
		push	10h
		push	0C2h

loc_CDEB:
		call	sub_CA62
		mov	di, 1
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CDF4:
		mov	[bp+var_2], 2

loc_CDF9:
		or	si, si
		jnz	short loc_CE04
		push	8
		push	0C0h
		jmp	short loc_CE1A
; ---------------------------------------------------------------------------

loc_CE04:
		cmp	si, 1
		jnz	short loc_CE12
		push	8
		mov	al, 0BBh
		sub	al, byte ptr [bp+var_2]
		jmp	short loc_CE19
; ---------------------------------------------------------------------------

loc_CE12:
		push	8
		mov	al, byte ptr [bp+var_2]
		add	al, 0C5h

loc_CE19:
		push	ax

loc_CE1A:
		call	sub_CA62
		mov	di, 2
		jmp	loc_CEE8
; ---------------------------------------------------------------------------

loc_CE23:
		or	si, si
		jnz	short loc_CE29
		jmp	short loc_CE46
; ---------------------------------------------------------------------------

loc_CE29:
		cmp	si, 1
		jnz	short loc_CE30
		jmp	short loc_CE53
; ---------------------------------------------------------------------------

loc_CE30:
		push	1Fh
		call	@randring1_next8_and$quc
		mov	ah, 0
		add	ax, 0B1h
		mov	[bp+var_2], ax
		push	8
		jmp	loc_CEDF
; ---------------------------------------------------------------------------

loc_CE42:
		or	si, si
		jnz	short loc_CE4E

loc_CE46:
		push	0
		push	0C0h
		jmp	loc_CEE2
; ---------------------------------------------------------------------------

loc_CE4E:
		cmp	si, 1
		jnz	short loc_CE5B

loc_CE53:
		push	10h
		push	0C0h
		jmp	loc_CEE2
; ---------------------------------------------------------------------------

loc_CE5B:
		cmp	si, 2
		jnz	short loc_CE9F
		mov	byte_1E519, 32h	; '2'
		cmp	word_205DA, 0
		jle	short loc_CE96
		mov	ax, word_205DA
		sub	ax, _player_topleft.y
		add	ax, -32
		push	ax
		mov	ax, word_205D8
		sub	ax, _player_topleft.x
		push	ax
		call	iatan2
		mov	[bp+var_2], ax
		push	7
		call	@randring1_next8_and$quc
		mov	ah, 0
		add	ax, 0FFFDh
		add	[bp+var_2], ax
		jmp	short loc_CE9B
; ---------------------------------------------------------------------------

loc_CE96:
		mov	[bp+var_2], 0B7h

loc_CE9B:
		push	0
		jmp	short loc_CEDF
; ---------------------------------------------------------------------------

loc_CE9F:
		cmp	si, 3
		jnz	short loc_CEE5
		cmp	word_205DA, 0
		jle	short loc_CED8
		mov	ax, word_205DA
		sub	ax, _player_topleft.y
		add	ax, -32
		push	ax
		mov	ax, word_205D8
		sub	ax, _player_topleft.x
		add	ax, -16
		push	ax
		call	iatan2
		mov	[bp+var_2], ax
		push	7
		call	@randring1_next8_and$quc
		mov	ah, 0
		add	ax, 0FFFDh
		add	[bp+var_2], ax
		jmp	short loc_CEDD
; ---------------------------------------------------------------------------

loc_CED8:
		mov	[bp+var_2], 0C9h

loc_CEDD:
		push	10h

loc_CEDF:
		push	[bp+var_2]

loc_CEE2:
		call	sub_CA62

loc_CEE5:
		mov	di, 3

loc_CEE8:
		cmp	si, di
		jnz	loc_D034
		mov	[bp+var_3], 1
		xor	si, si
		jmp	loc_D035
; ---------------------------------------------------------------------------

loc_CEF7:
		cmp	_shot_level, 2
		jb	loc_D042
		cmp	_shot_level, SHOT_LEVEL_MAX
		jnz	short loc_CF0F
		mov	ax, word_205D8
		mov	word_205DC, ax
		jmp	short loc_CF15
; ---------------------------------------------------------------------------

loc_CF0F:
		mov	word_205DC, 0FFFFh

loc_CF15:
		cmp	byte_205DE, 0
		jnz	loc_D042
		mov	al, _shot_level
		mov	ah, 0
		sub	ax, 2
		mov	bx, ax
		cmp	bx, 7
		ja	loc_D029
		add	bx, bx
		jmp	cs:off_D047[bx]

loc_CF36:
		mov	ax, si
		imul	ax, 30h
		push	ax
		pushd	0FFFCh
		call	sub_CAD2
		mov	di, 1
		jmp	loc_D029
; ---------------------------------------------------------------------------

loc_CF4B:
		or	si, si
		jnz	short loc_CF56
		pushd	0
		push	0FFF0h
		jmp	short loc_CF7A
; ---------------------------------------------------------------------------

loc_CF56:
		cmp	si, 1
		jnz	short loc_CF65
		push	300000h
		push	0FFF0h
		jmp	short loc_CF7A
; ---------------------------------------------------------------------------

loc_CF65:
		cmp	si, 2
		jnz	short loc_CF72
		push	0FFF8FFFDh
		jmp	short loc_CF78
; ---------------------------------------------------------------------------

loc_CF72:
		push	380003h

loc_CF78:
		push	0FFFAh

loc_CF7A:
		call	sub_CAD2
		mov	di, 3
		jmp	loc_D029
; ---------------------------------------------------------------------------

loc_CF83:
		or	si, si
		jnz	short loc_CF8E
		pushd	0
		push	0FFDEh
		jmp	short loc_CFD0
; ---------------------------------------------------------------------------

loc_CF8E:
		cmp	si, 1
		jnz	short loc_CF9D
		push	300000h
		push	0FFDEh
		jmp	short loc_CFD0
; ---------------------------------------------------------------------------

loc_CF9D:
		cmp	si, 2
		jnz	short loc_CFAC
		push	0FFF8FFFBh
		push	0FFE4h
		jmp	short loc_CFD0
; ---------------------------------------------------------------------------

loc_CFAC:
		cmp	si, 3
		jnz	short loc_CFBB
		push	380005h
		push	0FFE4h
		jmp	short loc_CFD0
; ---------------------------------------------------------------------------

loc_CFBB:
		cmp	si, 4
		jnz	short loc_CFC8
		push	0FFF0FFF6h
		jmp	short loc_CFCE
; ---------------------------------------------------------------------------

loc_CFC8:
		push	40000Ah

loc_CFCE:
		push	0FFE8h

loc_CFD0:
		call	sub_CAD2
		mov	di, 5

loc_CFD6:
		or	si, si
		jnz	short loc_CFE1
		pushd	0
		push	0FFCAh
		jmp	short loc_D023
; ---------------------------------------------------------------------------

loc_CFE1:
		cmp	si, 1
		jnz	short loc_CFF0
		push	300000h
		push	0FFCAh
		jmp	short loc_D023
; ---------------------------------------------------------------------------

loc_CFF0:
		cmp	si, 2
		jnz	short loc_CFFF
		push	0FFF8FFF0h
		push	0FFCEh
		jmp	short loc_D023
; ---------------------------------------------------------------------------

loc_CFFF:
		cmp	si, 3
		jnz	short loc_D00E
		push	380010h
		push	0FFCEh
		jmp	short loc_D023
; ---------------------------------------------------------------------------

loc_D00E:
		cmp	si, 4
		jnz	short loc_D01B
		push	0FFF0FFE0h
		jmp	short loc_D021
; ---------------------------------------------------------------------------

loc_D01B:
		push	400020h

loc_D021:
		push	0FFD8h

loc_D023:
		call	sub_CAD2
		mov	di, 5

loc_D029:
		cmp	si, di
		jnz	short loc_D034
		mov	byte_205DE, 1
		jmp	short loc_D042
; ---------------------------------------------------------------------------

loc_D034:
		inc	si

loc_D035:
		inc	word_205E2

loc_D039:
		cmp	word_205E2, 26h	; '&'
		jl	loc_CD54

loc_D042:
		pop	di
		pop	si
		leave
		retn
shot_b	endp

; ---------------------------------------------------------------------------
		db 0
off_D047	dw offset loc_CF36
		dw offset loc_CF36
		dw offset loc_CF36
		dw offset loc_CF4B
		dw offset loc_CF4B
		dw offset loc_CF4B
		dw offset loc_CF83
		dw offset loc_CFD6
off_D057	dw offset loc_CD81
		dw offset loc_CD8C
		dw offset loc_CD97
		dw offset loc_CDA7
		dw offset loc_CDC2
		dw offset loc_CDDB
		dw offset loc_CDF9
		dw offset loc_CDF4
		dw offset loc_CE23
		dw offset loc_CE42

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

shot_c	proc near

var_3		= byte ptr -3
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		xor	si, si
		mov	[bp+var_2], 0
		xor	di, di
		mov	[bp+var_3], 0
		inc	byte_20350
		mov	ax, _player_topleft.y
		add	ax, 32
		shl	ax, 4
		mov	word_205E4, ax
		cmp	_shot_level, 2
		jb	short loc_D09C
		mov	byte_1E519, 7Ch	; '|'

loc_D09C:
		mov	word_205E2, 0
		jmp	loc_D345
; ---------------------------------------------------------------------------

loc_D0A5:
		mov	bx, word_205E2
		shl	bx, 4
		cmp	byte ptr [bx+2908h], 0
		jnz	loc_D341
		cmp	[bp+var_3], 0
		jnz	loc_D17D
		mov	al, _shot_level
		mov	ah, 0
		mov	bx, ax
		cmp	bx, SHOT_LEVEL_MAX
		ja	loc_D16E
		add	bx, bx
		jmp	cs:off_D362[bx]

loc_D0D2:
		push	8
		push	0C0h
		call	sub_CA62
		jmp	loc_D16E
; ---------------------------------------------------------------------------

loc_D0DD:
		push	8
		push	3
		call	@randring1_next8_and$quc
		add	al, 0BEh
		jmp	short loc_D0F1
; ---------------------------------------------------------------------------

loc_D0E8:
		push	8
		push	7
		call	@randring1_next8_and$quc
		add	al, 0BCh

loc_D0F1:
		push	ax
		call	sub_CA62
		jmp	short loc_D16E
; ---------------------------------------------------------------------------

loc_D0F7:
		or	si, si
		jnz	short loc_D105
		push	8
		push	0C0h
		call	sub_CA62
		jmp	short loc_D158
; ---------------------------------------------------------------------------

loc_D105:
		cmp	si, 1
		jnz	short loc_D116
		mov	[bp+var_2], 0FFF0h
		mov	byte_1E519, 31h	; '1'
		jmp	short loc_D133
; ---------------------------------------------------------------------------

loc_D116:
		cmp	si, 2
		jnz	short loc_D11D
		jmp	short loc_D12E
; ---------------------------------------------------------------------------

loc_D11D:
		cmp	si, 3
		jnz	short loc_D129
		mov	[bp+var_2], 0FFF0h
		jmp	short loc_D133
; ---------------------------------------------------------------------------

loc_D129:
		cmp	si, 4
		jnz	short loc_D133

loc_D12E:
		mov	[bp+var_2], 20h	; ' '

loc_D133:
		push	[bp+var_2]
		push	0C0h
		call	sub_CA62
		cmp	si, 3
		jl	short loc_D158
		mov	bx, word_205E2
		shl	bx, 4
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		sub	word ptr [bx+290Ch], 100h

loc_D158:
		mov	al, byte_20350
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_D16C
		mov	di, 4
		jmp	short loc_D16E
; ---------------------------------------------------------------------------

loc_D16C:
		xor	di, di

loc_D16E:
		cmp	si, di
		jnz	loc_D340
		mov	[bp+var_3], 1
		xor	si, si
		jmp	loc_D341
; ---------------------------------------------------------------------------

loc_D17D:
		cmp	_shot_level, 2
		jb	loc_D34E
		cmp	_shot_level, 3
		jnb	short loc_D197
		cmp	byte_205DE, 0
		jz	short loc_D1E3
		jmp	loc_D34E
; ---------------------------------------------------------------------------

loc_D197:
		cmp	_shot_level, 4
		jnb	short loc_D1B0
		mov	al, byte_20350
		mov	ah, 0
		mov	bx, 5
		cwd
		idiv	bx
		or	dx, dx
		jz	short loc_D1E3
		jmp	loc_D34E
; ---------------------------------------------------------------------------

loc_D1B0:
		cmp	_shot_level, 6
		jnb	short loc_D1C1
		test	byte_20350, 3
		jz	short loc_D1E3
		jmp	loc_D34E
; ---------------------------------------------------------------------------

loc_D1C1:
		cmp	_shot_level, SHOT_LEVEL_MAX
		jnb	short loc_D1DA
		mov	al, byte_20350
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jz	short loc_D1E3
		jmp	loc_D34E
; ---------------------------------------------------------------------------

loc_D1DA:
		test	byte_20350, 1
		jnz	loc_D34E

loc_D1E3:
		mov	al, _shot_level
		mov	ah, 0
		sub	ax, 2
		mov	bx, ax
		cmp	bx, 7
		ja	loc_D335
		add	bx, bx
		jmp	cs:off_D352[bx]

loc_D1FB:
		mov	ax, si
		imul	ax, 30h
		push	ax
		pushd	0FFFCh
		jmp	short loc_D215
; ---------------------------------------------------------------------------

loc_D209:
		mov	ax, si
		imul	ax, 30h
		push	ax
		pushd	0FFF0h

loc_D215:
		call	sub_CAD2
		mov	di, 1
		jmp	loc_D335
; ---------------------------------------------------------------------------

loc_D21E:
		or	si, si
		jnz	short loc_D227
		pushd	4
		jmp	short loc_D241
; ---------------------------------------------------------------------------

loc_D227:
		cmp	si, 1
		jnz	short loc_D234
		push	30FFFCh
		jmp	short loc_D241
; ---------------------------------------------------------------------------

loc_D234:
		cmp	si, 2
		jnz	short loc_D23D
		push	0FFF8h
		jmp	short loc_D23F
; ---------------------------------------------------------------------------

loc_D23D:
		push	38h ; '8'

loc_D23F:
		push	0

loc_D241:
		push	0FFF0h
		call	sub_CAD2
		jmp	loc_D332
; ---------------------------------------------------------------------------

loc_D249:
		or	si, si
		jnz	short loc_D252
		pushd	6
		jmp	short loc_D26C
; ---------------------------------------------------------------------------

loc_D252:
		cmp	si, 1
		jnz	short loc_D25F
		push	30FFFAh
		jmp	short loc_D26C
; ---------------------------------------------------------------------------

loc_D25F:
		cmp	si, 2
		jnz	short loc_D268
		push	0FFF8h
		jmp	short loc_D26A
; ---------------------------------------------------------------------------

loc_D268:
		push	38h ; '8'

loc_D26A:
		push	0

loc_D26C:
		push	0FFE8h
		call	sub_CAD2
		jmp	loc_D332
; ---------------------------------------------------------------------------

loc_D274:
		or	si, si
		jnz	short loc_D27D
		pushd	6
		jmp	short loc_D297
; ---------------------------------------------------------------------------

loc_D27D:
		cmp	si, 1
		jnz	short loc_D28A
		push	30FFFAh
		jmp	short loc_D297
; ---------------------------------------------------------------------------

loc_D28A:
		cmp	si, 2
		jnz	short loc_D293
		push	0FFF8h
		jmp	short loc_D295
; ---------------------------------------------------------------------------

loc_D293:
		push	38h ; '8'

loc_D295:
		push	0

loc_D297:
		push	0FFE6h
		call	sub_CAD2
		jmp	loc_D332
; ---------------------------------------------------------------------------

loc_D29F:
		or	si, si
		jnz	short loc_D2A8
		pushd	0Ah
		jmp	short loc_D2C8
; ---------------------------------------------------------------------------

loc_D2A8:
		cmp	si, 1
		jnz	short loc_D2B5
		push	30FFF6h
		jmp	short loc_D2C8
; ---------------------------------------------------------------------------

loc_D2B5:
		cmp	si, 2
		jnz	short loc_D2C2
		push	0FFF8FFFCh
		jmp	short loc_D2C8
; ---------------------------------------------------------------------------

loc_D2C2:
		push	380004h

loc_D2C8:
		push	0FFD0h
		call	sub_CAD2
		jmp	short loc_D332
; ---------------------------------------------------------------------------

loc_D2CF:
		or	si, si
		jnz	short loc_D2DE
		pushd	0FFF6h
		push	0FF60h
		jmp	short loc_D323
; ---------------------------------------------------------------------------

loc_D2DE:
		cmp	si, 1
		jnz	short loc_D2EE
		push	30000Ah
		push	0FF60h
		jmp	short loc_D323
; ---------------------------------------------------------------------------

loc_D2EE:
		cmp	si, 2
		jnz	short loc_D2FE
		push	0FFF80014h
		push	0FF74h
		jmp	short loc_D323
; ---------------------------------------------------------------------------

loc_D2FE:
		cmp	si, 3
		jnz	short loc_D30E
		push	38FFECh
		push	0FF74h
		jmp	short loc_D323
; ---------------------------------------------------------------------------

loc_D30E:
		cmp	si, 4
		jnz	short loc_D31B
		push	0FFF0FFF9h
		jmp	short loc_D321
; ---------------------------------------------------------------------------

loc_D31B:
		push	400007h

loc_D321:
		push	0FF88h

loc_D323:
		call	sub_CAD2
		test	byte_20350, 3
		jnz	short loc_D332
		mov	di, 5
		jmp	short loc_D335
; ---------------------------------------------------------------------------

loc_D332:
		mov	di, 3

loc_D335:
		cmp	si, di
		jnz	short loc_D340
		mov	byte_205DE, 1
		jmp	short loc_D34E
; ---------------------------------------------------------------------------

loc_D340:
		inc	si

loc_D341:
		inc	word_205E2

loc_D345:
		cmp	word_205E2, 26h	; '&'
		jl	loc_D0A5

loc_D34E:
		pop	di
		pop	si
		leave
		retn
shot_c	endp

; ---------------------------------------------------------------------------
off_D352	dw offset loc_D1FB
		dw offset loc_D1FB
		dw offset loc_D209
		dw offset loc_D21E
		dw offset loc_D249
		dw offset loc_D274
		dw offset loc_D29F
		dw offset loc_D2CF
off_D362	dw offset loc_D0D2
		dw offset loc_D0D2
		dw offset loc_D0D2
		dw offset loc_D0DD
		dw offset loc_D0DD
		dw offset loc_D0DD
		dw offset loc_D0E8
		dw offset loc_D0E8
		dw offset loc_D0E8
		dw offset loc_D0F7

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_D376	proc far
		push	bp
		mov	bp, sp
		xor	ax, ax
		jmp	short loc_D388
; ---------------------------------------------------------------------------

loc_D37D:
		mov	bx, ax
		shl	bx, 4
		mov	byte ptr [bx+2908h], 0
		inc	ax

loc_D388:
		cmp	ax, 26h	; '&'
		jl	short loc_D37D
		pop	bp
		retf
sub_D376	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_D38F	proc near

var_3		= byte ptr -3
@@left		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	[bp+var_3], 0
		mov	si, 2908h
		xor	di, di
		jmp	loc_D472
; ---------------------------------------------------------------------------

loc_D3A3:
		cmp	byte ptr [si], 0
		jz	loc_D46E
		cmp	_reduce_effects, 0
		jz	short loc_D3BF
		mov	al, _page_back
		mov	ah, 0
		mov	dx, di
		and	dx, 1
		cmp	ax, dx
		jnz	short loc_D419

loc_D3BF:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+2]
		sar	ax, 4
		mov	[bp+@@left], ax
		cmp	byte ptr [si+0Eh], 7Ch ; '|'
		jb	short loc_D3DE
		cmp	byte ptr [si+1], 0
		jnz	short loc_D3FA

loc_D3DE:
		push	[bp+@@left]	; left
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+4]
		sar	ax, 4
		push	ax	; top
		push	(16 shl 16) or 16	; (w shl 16) or h
		jmp	short loc_D414
; ---------------------------------------------------------------------------

loc_D3FA:
		push	[bp+@@left]	; left
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, [bx+si+4]
		sar	ax, 4
		push	ax	; top
		push	(32 shl 16) or 32	; (w shl 16) or h

loc_D414:
		call	@tiles_invalidate_rect$qiiii

loc_D419:
		cmp	byte ptr [si], 2
		jnz	short loc_D423
		mov	byte ptr [si], 0
		jmp	short loc_D46E
; ---------------------------------------------------------------------------

loc_D423:
		mov	bx, di
		shl	bx, 4
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, [bx+290Ah]
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 2
		mov	bx, dx
		mov	[bx+si+2], ax
		mov	bx, di
		shl	bx, 4
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, [bx+290Ch]
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 2
		mov	bx, dx
		mov	[bx+si+4], ax
		cmp	byte ptr [si+0Fh], 0
		jz	short loc_D46E
		inc	[bp+var_3]

loc_D46E:
		inc	di
		add	si, 10h

loc_D472:
		cmp	di, 26h	; '&'
		jl	loc_D3A3
		cmp	[bp+var_3], 0
		jnz	short loc_D484
		mov	byte_205DE, 0

loc_D484:
		pop	di
		pop	si
		leave
		retn
sub_D38F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_D488	proc near

var_E		= word ptr -0Eh
var_C		= word ptr -0Ch
var_9		= byte ptr -9
var_8		= word ptr -8
var_6		= word ptr -6
@@x		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 0Eh
		push	si
		push	di
		mov	al, _reduce_effects
		mov	cl, _page_back
		shl	al, cl
		mov	[bp+var_9], al
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	[bp+var_C], ax
		mov	si, 2908h
		mov	[bp+var_2], 0
		jmp	loc_D61D
; ---------------------------------------------------------------------------

loc_D4B2:
		cmp	byte ptr [si], 1
		jnz	loc_D613
		mov	ax, si
		add	ax, [bp+var_C]
		add	ax, 2
		mov	[bp+var_6], ax
		mov	ax, si
		add	ax, [bp+var_C]
		add	ax, 4
		mov	[bp+var_8], ax
		mov	ax, [si+0Ah]
		mov	bx, [bp+var_6]
		add	[bx], ax
		mov	ax, [si+0Ch]
		mov	bx, [bp+var_8]
		add	[bx], ax
		mov	ax, [bx]
		sar	ax, 4
		mov	di, ax
		mov	bx, [bp+var_6]
		mov	ax, [bx]
		sar	ax, 4
		mov	[bp+@@x], ax
		cmp	word ptr [bx], 100h
		jle	short loc_D508
		cmp	word ptr [bx], 1A20h
		jge	short loc_D508
		cmp	di, 180h
		jg	short loc_D508
		cmp	di, 8
		jge	short loc_D50E

loc_D508:
		mov	byte ptr [si], 2
		jmp	loc_D613
; ---------------------------------------------------------------------------

loc_D50E:
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_D51C
		sub	di, RES_Y

loc_D51C:
		cmp	byte ptr [si+0Fh], 0
		jnz	loc_D5B0
		mov	bx, [bp+var_2]
		inc	byte ptr [bx+28E1h]
		cmp	byte ptr [si+1], 0
		jnz	short loc_D55D
		cmp	[bp+var_9], 2
		jz	loc_D613
		mov	al, [si+0Eh]
		mov	ah, 0
		mov	[bp+var_E], ax
		cmp	[bp+var_E], 32h	; '2'
		jl	short loc_D553
		mov	al, [bx+28E1h]
		mov	ah, 0
		and	ax, 1
		add	[bp+var_E], ax

loc_D553:
		push	[bp+@@x]
		push	di
		push	[bp+var_E]
		jmp	loc_D60E
; ---------------------------------------------------------------------------

loc_D55D:
		cmp	byte ptr [si+1], 5
		jbe	short loc_D569
		mov	byte ptr [si], 2
		jmp	loc_D613
; ---------------------------------------------------------------------------

loc_D569:
		cmp	[bp+var_9], 2
		jz	short loc_D59F
		cmp	byte ptr [si+0Eh], 7Ch ; '|'
		jnb	short loc_D589
		push	[bp+@@x]
		push	di
		mov	al, [si+1]
		mov	ah, 0
		add	ax, 74
		push	ax
		call	super_roll_put_tiny
		jmp	short loc_D59F
; ---------------------------------------------------------------------------

loc_D589:
		push	[bp+@@x]
		push	di
		mov	al, [si+1]
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	word ptr [bx+0A94h]
		call	super_roll_put

loc_D59F:
		test	byte ptr _stage_frame, 3
		jnz	short loc_D613
		mov	al, [si+1]
		inc	al
		mov	[si+1],	al
		jmp	short loc_D613
; ---------------------------------------------------------------------------

loc_D5B0:
		cmp	byte ptr [si+1], 1
		jbe	short loc_D5ED
		mov	al, byte_1E518
		cbw
		movsx	ebx, ax
		mov	eax, _stage_frame
		xor	edx, edx
		div	ebx
		cmp	edx, 0
		jnz	short loc_D5E1
		mov	al, [si+1]
		inc	al
		mov	[si+1],	al
		cmp	byte ptr [si+1], 4
		jbe	short loc_D5E1
		mov	byte ptr [si], 2
		jmp	short loc_D613
; ---------------------------------------------------------------------------

loc_D5E1:
		test	byte ptr _stage_frame, 1
		jz	short loc_D5F7
		sar	word ptr [si+0Ch], 1
		jmp	short loc_D5F7
; ---------------------------------------------------------------------------

loc_D5ED:
		cmp	byte ptr [si+0Eh], 3Bh ; ';'
		jz	short loc_D5F7
		sub	word ptr [si+0Ch], 4

loc_D5F7:
		cmp	[bp+var_9], 2
		jz	short loc_D613
		push	[bp+@@x]
		push	di
		mov	al, [si+0Eh]
		mov	ah, 0
		mov	dl, [si+1]
		mov	dh, 0
		add	ax, dx
		push	ax

loc_D60E:
		call	super_roll_put_tiny

loc_D613:
		inc	[bp+var_2]
		xor	[bp+var_9], 3
		add	si, 10h

loc_D61D:
		cmp	[bp+var_2], 26h	; '&'
		jl	loc_D4B2
		pop	di
		pop	si
		leave
		retn
sub_D488	endp
main_01__TEXT	ends

ITEM_TEXT	segment	byte public 'CODE' use16
	@items_init_and_reset$qv procdesc near
	extern @ITEMS_ADD_SEMIRANDOM$QII:proc
	extern @ITEMS_ADD$QIII:proc
	@ITEMS_MISS_ADD$QII procdesc pascal near \
		player_left:word, player_top:word
	@items_invalidate$qv procdesc near
	@items_update_and_render$qv procdesc near
ITEM_TEXT	ends

HUD_TEXT	segment	byte public 'CODE' use16
	@gaiji_load$qv procdesc near
	@gaiji_free$qv procdesc near
	@score_extend_init$qv procdesc near
	extern @score_delta_commit$qv:proc
	@score_reset$qv procdesc near
	@score_update_and_render$qv procdesc near
	extern @score_grant_current_delta_as_bon$qv:proc
	@player_shot_level_update_and_hud$qv procdesc near
	@hud_lives_put$qv procdesc near
	@hud_bombs_put$qv procdesc near
	@hud_put$qv procdesc near
	extern @overlay_stage_leave_animate$qv:proc
	extern @overlay_stage_enter_animate$qv:proc
HUD_TEXT	ends

main_01___TEXT	segment	byte public 'CODE' use16

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E178	proc near
		push	bp
		mov	bp, sp
		push	ds
		push	offset aBombs_bft ; "bombs.bft"
		call	file_ropen
		pushd	20h ; ' '
		push	0
		call	file_seek
		push	438h
		call	hmem_allocbyte
		mov	word_218C0, ax
		mov	word_218BE, 0
		push	ax
		push	word_218BE
		push	438h
		call	file_read
		call	file_close
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 0
		jnz	short loc_E1D2
		call	@pi_load$qinxc c, 1, offset aBomb1_pi, ds
		mov	_playchar_bomb_func, offset bomb_reimu_a
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_E1D2:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 2
		jnz	short loc_E1F3
		call	@pi_load$qinxc c, 1, offset aBomb3_pi, ds
		mov	_playchar_bomb_func, offset bomb_reimu_c
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_E1F3:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 1
		jnz	short loc_E248
		call	@pi_load$qinxc c, 1, offset aBomb2_pi, ds
		push	ds
		push	offset aBomb1_bft ; "bomb1.bft"
		call	file_ropen
		pushd	50h ; 'P'
		push	0
		call	file_seek
		push	1440h
		call	hmem_allocbyte
		mov	word ptr dword_218BA+2,	ax
		mov	word ptr dword_218BA, 0
		push	ax
		push	word ptr dword_218BA
		push	1440h
		call	file_read
		call	file_close
		mov	_playchar_bomb_func, offset bomb_reimu_b

loc_E248:
		pop	bp
		retn
sub_E178	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E24A	proc near
		push	bp
		mov	bp, sp
		freePISlotLarge	1
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 1
		jnz	short loc_E26F
		push	word ptr dword_218BA+2
		call	hmem_free

loc_E26F:
		pop	bp
		retn
sub_E24A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E271	proc near
		push	bp
		mov	bp, sp
		mov	_stage_bombs_used, 0
		mov	_bombing, 0
		pop	bp
		retn
sub_E271	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public PLAYER_BOMB
player_bomb	proc near
		push	bp
		mov	bp, sp
		cmp	_bombing, 0
		jnz	short loc_E2D7
		cmp	_bombs, 0
		jz	short loc_E2D7
		mov	_bombing, 1
		mov	_player_invincible_via_bomb, 1
		dec	_bombs
		call	@hud_bombs_put$qv
		mov	_bomb_frame, 0
		inc	_stage_bombs_used
		inc	_total_bombs_used
		call	_snd_se_play c, 9
		mov	_bomb_circle_center.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 4)
		mov	_bomb_circle_center.y, (PLAYFIELD_TOP + (PLAYFIELD_H / 2) - 4)
		mov	_bomb_circle_frame, 0
		mov	_bomb_circle_done, 0
		call	sub_10E0A

loc_E2D7:
		pop	bp
		retn
player_bomb	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E2D9	proc near

@@angle		= byte ptr -5
@@left		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		cmp	_bombing, 0
		jz	loc_E3EA
		cmp	_bomb_circle_frame, 1
		jle	loc_E38A
		dec	_bomb_frame
		mov	ax, _bomb_frame
		shl	ax, 3
		mov	dx, 256
		sub	dx, ax
		mov	[bp+var_2], dx
		xor	di, di
		mov	al, byte ptr _bomb_frame
		jmp	short loc_E371
; ---------------------------------------------------------------------------

loc_E30C:
		movsx	eax, [bp+var_2]
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.x
		mov	[bp+@@left], ax
		movsx	eax, [bp+var_2]
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.y
		mov	si, ax
		cmp	si, 8
		jle	short loc_E36B
		cmp	si, PLAYFIELD_BOTTOM
		jge	short loc_E36B
		call	@tiles_invalidate_rect$qiiii pascal, [bp+@@left], si, (8 shl 16) or 8

loc_E36B:
		inc	di
		mov	al, [bp+@@angle]
		add	al, 4

loc_E371:
		mov	[bp+@@angle], al
		cmp	di, 40h
		jl	short loc_E30C
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jl	short loc_E386
		mov	_bomb_circle_frame, 0

loc_E386:
		inc	_bomb_frame

loc_E38A:
		cmp	_bomb_circle_done, 1
		jnz	short loc_E39D
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jg	short loc_E39D
		mov	_tiles_egc_render_all, 1

loc_E39D:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 0
		jnz	short loc_E3BA
		cmp	_bomb_frame, 136
		jz	short loc_E3E5
		cmp	_bomb_frame, 137
		jnz	short loc_E3EA
		jmp	short loc_E3E5
; ---------------------------------------------------------------------------

loc_E3BA:
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.shottype], 1
		jnz	short loc_E3D7
		cmp	_bomb_frame, 164
		jz	short loc_E3E5
		cmp	_bomb_frame, 165
		jnz	short loc_E3EA
		jmp	short loc_E3E5
; ---------------------------------------------------------------------------

loc_E3D7:
		cmp	_bomb_frame, 112
		jz	short loc_E3E5
		cmp	_bomb_frame, 113
		jnz	short loc_E3EA

loc_E3E5:
		mov	_tiles_egc_render_all, 1

loc_E3EA:
		pop	di
		pop	si
		leave
		retn
sub_E2D9	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @bomb_circle_update_and_render$qv
@bomb_circle_update_and_render$qv proc near

@@angle		= byte ptr -5
@@top 	= word ptr -4
@@left	= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		inc	_bomb_circle_frame
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	dx, _scroll_line
		mov	bx, ax
		mov	[bx+3E5Ch], dx
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	ax, _bomb_frame
		shl	ax, 3
		mov	dx, 256
		sub	dx, ax
		mov	di, dx
		xor	si, si
		mov	al, byte ptr _bomb_frame
		jmp	short loc_E47B
; ---------------------------------------------------------------------------

loc_E42A:
		movsx	eax, di
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.x
		mov	[bp+@@left], ax
		movsx	eax, di
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.y
		mov	[bp+@@top], ax
		call	@bomb_circle_point_put$qii pascal, [bp+@@left], ax
		inc	si
		mov	al, [bp+@@angle]
		add	al, 4

loc_E47B:
		mov	[bp+@@angle], al
		cmp	si, 40h
		jl	short loc_E42A
		call	grcg_off
		pop	di
		pop	si
		leave
		retn
@bomb_circle_update_and_render$qv endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E48C	proc near

@@angle		= byte ptr -5
@@top		= word ptr -4
@@left		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 14
		mov	ax, [bp+arg_0]
		shl	ax, 5
		mov	di, ax
		xor	si, si
		mov	al, byte ptr [bp+arg_0]
		jmp	short loc_E4FF
; ---------------------------------------------------------------------------

loc_E4AE:
		movsx	eax, di
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.x
		mov	[bp+@@left], ax
		movsx	eax, di
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, _bomb_circle_center.y
		mov	[bp+@@top], ax
		call	@bomb_circle_point_put$qii pascal, [bp+@@left], ax
		inc	si
		mov	al, [bp+@@angle]
		add	al, 4

loc_E4FF:
		mov	[bp+@@angle], al
		cmp	si, 40h
		jl	short loc_E4AE
		call	grcg_off
		pop	di
		pop	si
		leave
		retn	2
sub_E48C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E512	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	ax, _bomb_frame
		and	ax, 0Fh
		add	ax, ax
		mov	di, ax
		xor	si, si
		jmp	short loc_E55D
; ---------------------------------------------------------------------------

loc_E525:
		call	@randring1_next16$qv
		mov	bx, 384
		xor	dx, dx
		div	bx
		add	dx, 20h	; ' '
		mov	bx, di
		add	bx, si
		shl	bx, 2
		mov	[bx+3F5Ch], dx
		call	@randring1_next16$qv
		mov	bx, 368
		xor	dx, dx
		div	bx
		add	dx, 10h
		mov	bx, di
		add	bx, si
		shl	bx, 2
		mov	[bx+3F5Eh], dx
		mov	bx, si
		mov	byte ptr [bx+di+3F28h],	1
		inc	si

loc_E55D:
		cmp	si, 2
		jl	short loc_E525
		xor	si, si
		jmp	short loc_E5AC
; ---------------------------------------------------------------------------

loc_E566:
		cmp	byte ptr [si+3F28h], 0
		jz	short loc_E5AB
		mov	ax, _bomb_frame
		and	ax, 3
		mov	dx, si
		and	dx, 3
		cmp	ax, dx
		jnz	short loc_E58E
		inc	byte ptr [si+3F28h]
		cmp	byte ptr [si+3F28h], 5
		jb	short loc_E58E
		mov	byte ptr [si+3F28h], 0
		jmp	short loc_E5AB
; ---------------------------------------------------------------------------

loc_E58E:
		mov	bx, si
		shl	bx, 2
		push	word ptr [bx+3F5Ch]	; cel
		mov	bx, si
		shl	bx, 2
		push	word ptr [bx+3F5Eh]	; top
		mov	al, [si+3F28h]
		mov	ah, 0
		dec	ax
		push	ax	; left
		call	@bomb_particle_put_8$qiii

loc_E5AB:
		inc	si

loc_E5AC:
		cmp	si, 20h	; ' '
		jl	short loc_E566
		pop	di
		pop	si
		pop	bp
		retn
sub_E512	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_E5B5	proc near

var_6		= word ptr -6
var_4		= dword	ptr -4

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		mov	ax, _bomb_frame
		dec	ax
		sar	ax, 1
		mov	[bp+var_6], ax
		imul	ax, 48h
		mov	dx, word_218C0
		mov	bx, word_218BE
		add	bx, ax
		mov	word ptr [bp+var_4+2], dx
		mov	word ptr [bp+var_4], bx
		mov	si, PLAYFIELD_TOP
		jmp	short loc_E60F
; ---------------------------------------------------------------------------

loc_E5DD:
		push	(PLAYFIELD_LEFT + (0 * 8 * TILE_W))	; left
		push	si	; top
		les	bx, [bp+var_4]
		mov	al, es:[bx]
		push	ax	; eight_tiles
		call	@bomb_bft_8tiles_put_8$qiiuc
		push	(PLAYFIELD_LEFT + (1 * 8 * TILE_W))	; left
		push	si	; top
		les	bx, [bp+var_4]
		mov	al, es:[bx+1]
		push	ax	; eight_tiles
		call	@bomb_bft_8tiles_put_8$qiiuc
		push	(PLAYFIELD_LEFT + (2 * 8 * TILE_W))	; left
		push	si	; top
		les	bx, [bp+var_4]
		mov	al, es:[bx+2]
		push	ax	; eight_tiles
		call	@bomb_bft_8tiles_put_8$qiiuc
		add	word ptr [bp+var_4], 3
		add	si, TILE_H

loc_E60F:
		cmp	si, (PLAYFIELD_BOTTOM + TILE_H) ; ???
		jl	short loc_E5DD
		pop	si
		leave
		retn
sub_E5B5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public BOMB_REIMU_A
bomb_reimu_a	proc near

@@component		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		cmp	_bomb_frame, 1
		jnz	short loc_E668
		mov	[bp+@@component], 0
		jmp	short loc_E64E
; ---------------------------------------------------------------------------

loc_E638:
		mov	bx, [bp+@@component]
		mov	al, Palettes[0 * size rgb_t][bx]
		mov	byte ptr rgb_21A4D[bx], al
		mov	al, Palettes[3 * size rgb_t][bx]
		mov	byte ptr rgb_21A50[bx], al
		inc	[bp+@@component]

loc_E64E:
		cmp	[bp+@@component], size rgb_t
		jl	short loc_E638
		mov	Palettes[3 * size rgb_t].r, 64
		mov	Palettes[3 * size rgb_t].g, 16
		mov	Palettes[3 * size rgb_t].b, 64
		call	far ptr	palette_show

loc_E668:
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jge	short loc_E680
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 3
		call	sub_E5B5
		jmp	loc_E892
; ---------------------------------------------------------------------------

loc_E680:
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jnz	short loc_E6CC
		mov	al, rgb_21A50.r
		mov	Palettes[3 * size rgb_t].r, al
		mov	al, rgb_21A50.g
		mov	Palettes[3 * size rgb_t].g, al
		mov	al, rgb_21A50.b
		mov	Palettes[3 * size rgb_t].b, al
		mov	Palettes[0 * size rgb_t].r, 128
		mov	Palettes[0 * size rgb_t].g, 0
		mov	Palettes[0 * size rgb_t].b, 128
		call	far ptr	palette_show
		mov	al, _tile_mode
		mov	tilemode_21A4C, al
		mov	_tile_mode, TM_NONE
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		jmp	loc_E892
; ---------------------------------------------------------------------------

loc_E6CC:
		cmp	_bomb_frame, 136
		jge	loc_E821
		cmp	_bomb_frame, 64
		jle	short loc_E6E8
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 11

loc_E6E8:
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		call	grcg_off
		cmp	_bomb_frame, 64
		jg	short loc_E74D
		mov	ax, _bomb_frame
		shl	ax, 2
		add	ax, -128
		mov	dx, 128
		sub	dx, ax
		mov	[bp+var_2], dx
		mov	al, byte ptr [bp+var_2]
		mov	Palettes[0 * size rgb_t].r, al
		mov	Palettes[0 * size rgb_t].g, 0
		mov	Palettes[0 * size rgb_t].b, al
		cmp	_bomb_frame, 64
		jnz	short loc_E745
		mov	PaletteTone, 200
		call	far ptr	palette_show
		mov	Palettes[0 * size rgb_t].r, 255
		mov	Palettes[0 * size rgb_t].g, 255
		mov	Palettes[0 * size rgb_t].b, 255

loc_E745:
		call	far ptr	palette_show
		jmp	loc_E7E8
; ---------------------------------------------------------------------------

loc_E74D:
		push	0D400BEh
		push	320001h
		push	0
		call	sub_4090
		cmp	_bomb_frame, 70
		jnz	short loc_E774
		mov	PaletteTone, 100
		call	far ptr	palette_show
		jmp	short loc_E7A0
; ---------------------------------------------------------------------------

loc_E774:
		cmp	_reduce_effects, 0
		jz	short loc_E782
		test	byte ptr _bomb_frame, 1
		jz	short loc_E7A0

loc_E782:
		mov	si, 90
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_E793
		sub	si, RES_Y

loc_E793:
		call	@pi_put_8$qiii c, 112, si, 1

loc_E7A0:
		cmp	_bomb_frame, 86
		jl	short loc_E7E8
		mov	ax, _bomb_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jz	short loc_E7BB
		mov	[bp+var_2], 255
		jmp	short loc_E7C0
; ---------------------------------------------------------------------------

loc_E7BB:
		mov	[bp+var_2], 160

loc_E7C0:
		mov	al, byte ptr [bp+var_2]
		mov	Palettes[0 * size rgb_t].r, al
		mov	Palettes[0 * size rgb_t].g, al
		mov	Palettes[0 * size rgb_t].b, al
		mov	ax, _bomb_frame
		add	ax, ax
		add	ax, -72
		mov	PaletteTone, ax
		call	far ptr	palette_show
		cmp	_bomb_frame, 111
		jle	short loc_E7E8
		mov	_slowdown_factor, 2

loc_E7E8:
		cmp	_bomb_frame, 86
		jge	short loc_E80E
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		test	byte ptr _bomb_frame, 3
		jnz	short loc_E80B
		call	_snd_se_play c, 15

loc_E80B:
		call	sub_E512

loc_E80E:
		cmp	_bomb_frame, 86
		jnz	short loc_E892
		call	_snd_se_play c, 17
		jmp	short loc_E892
; ---------------------------------------------------------------------------

loc_E821:
		cmp	_bomb_frame, 136
		jnz	short loc_E867
		mov	al, rgb_21A4D.r
		mov	Palettes[0 * size rgb_t].r, al
		mov	al, rgb_21A4D.g
		mov	Palettes[0 * size rgb_t].g, al
		mov	al, rgb_21A4D.b
		mov	Palettes[0 * size rgb_t].b, al
		call	far ptr	palette_show
		call	_snd_se_play c, 16
		mov	al, tilemode_21A4C
		mov	_tile_mode, al
		mov	_slowdown_factor, 1
		mov	PaletteTone, 200
		call	far ptr	palette_show
		call	sub_10E0A
		jmp	short loc_E892
; ---------------------------------------------------------------------------

loc_E867:
		cmp	_bomb_frame, 156
		jge	short loc_E888
		mov	ax, _bomb_frame
		imul	ax, 5
		add	ax, -680
		mov	dx, 200
		sub	dx, ax
		mov	PaletteTone, dx
		call	far ptr	palette_show
		jmp	short loc_E892
; ---------------------------------------------------------------------------

loc_E888:
		call	grcg_off
		mov	ax, 1
		jmp	short loc_E899
; ---------------------------------------------------------------------------

loc_E892:
		call	grcg_off
		xor	ax, ax

loc_E899:
		pop	si
		leave
		retn
bomb_reimu_a	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public BOMB_REIMU_C
bomb_reimu_c	proc near

var_64		= byte ptr -64h
var_4		= word ptr -4
@@top		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 64h
		push	si
		push	di
		mov	si, 0BE0h
		lea	di, [bp+var_64]
		push	ss
		pop	es
		mov	cx, 30h	; '0'
		rep movsw
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 2
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jge	short loc_E8C9
		call	sub_E5B5
		jmp	loc_EA60
; ---------------------------------------------------------------------------

loc_E8C9:
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jnz	short loc_E915
		mov	al, _tile_mode
		mov	tilemode_21A53, al
		mov	_tile_mode, TM_NONE
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		mov	[bp+var_4], 0
		jmp	short loc_E902
; ---------------------------------------------------------------------------

loc_E8F3:
		mov	bx, [bp+var_4]
		shl	bx, 2
		mov	word ptr [bx+3E62h], 14h
		inc	[bp+var_4]

loc_E902:
		cmp	[bp+var_4], 30h	; '0'
		jl	short loc_E8F3
		call	_snd_se_play c, 17
		jmp	loc_EA60
; ---------------------------------------------------------------------------

loc_E915:
		cmp	_bomb_frame, 100
		jge	loc_E9A6
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		cmp	_bomb_frame, 80
		jl	short loc_E94C
		mov	ax, _bomb_frame
		imul	ax, 5
		add	ax, -300
		mov	PaletteTone, ax
		call	far ptr	palette_show
		mov	_slowdown_factor, 2

loc_E94C:
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 14
		call	sub_E512
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 1
		mov	[bp+var_4], 0
		jmp	short loc_E99D
; ---------------------------------------------------------------------------

loc_E96C:
		mov	bx, [bp+var_4]
		add	bx, bx
		lea	ax, [bp+var_64]
		add	bx, ax
		mov	ax, ss:[bx]
		mov	bx, [bp+var_4]
		shl	bx, 2
		add	[bx+3E62h], ax
		mov	ax, [bp+var_4]
		shl	ax, 3
		add	ax, 32
		push	ax	; column_bottom
		mov	bx, [bp+var_4]
		shl	bx, 2
		push	word ptr [bx+3E62h]	; left
		call	@bomb_smear_put_8$qii
		inc	[bp+var_4]

loc_E99D:
		cmp	[bp+var_4], 30h	; '0'
		jl	short loc_E96C
		jmp	loc_EA60
; ---------------------------------------------------------------------------

loc_E9A6:
		cmp	_bomb_frame, 112
		jge	short loc_EA11
		mov	PaletteTone, 100
		call	far ptr	palette_show
		test	byte ptr _bomb_frame, 1
		jz	short loc_E9F3
		call	grcg_off
		mov	[bp+@@top], 16
		mov	ax, _scroll_line
		add	[bp+@@top], ax
		cmp	[bp+@@top], RES_Y
		jl	short loc_E9DB
		sub	[bp+@@top], RES_Y

loc_E9DB:
		call	@pi_put_8$qiii stdcall, 32, [bp+@@top], 1
		call	_snd_se_play stdcall, 16
		add	sp, 8
		jmp	short loc_EA60
; ---------------------------------------------------------------------------

loc_E9F3:
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		jmp	short loc_EA60
; ---------------------------------------------------------------------------

loc_EA11:
		cmp	_bomb_frame, 112
		jnz	short loc_EA35
		mov	al, tilemode_21A53
		mov	_tile_mode, al
		mov	_slowdown_factor, 1
		mov	PaletteTone, 200
		call	far ptr	palette_show
		call	sub_10E0A
		jmp	short loc_EA60
; ---------------------------------------------------------------------------

loc_EA35:
		cmp	_bomb_frame, 128
		jge	short loc_EA56
		mov	ax, _bomb_frame
		imul	ax, 5
		add	ax, -540
		mov	dx, 200
		sub	dx, ax
		mov	PaletteTone, dx
		call	far ptr	palette_show
		jmp	short loc_EA60
; ---------------------------------------------------------------------------

loc_EA56:
		call	grcg_off
		mov	ax, 1
		jmp	short loc_EA67
; ---------------------------------------------------------------------------

loc_EA60:
		call	grcg_off
		xor	ax, ax

loc_EA67:
		pop	di
		pop	si
		leave
		retn
bomb_reimu_c	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_EA6B	proc near

var_2		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	ax, 120h
		imul	[bp+arg_0]
		mov	[bp+arg_0], ax
		mov	[bp+var_2], 1
		jmp	short loc_EADF
; ---------------------------------------------------------------------------

loc_EA83:
		mov	si, 4
		jmp	short loc_EAD7
; ---------------------------------------------------------------------------

loc_EA88:
		les	bx, dword_218BA
		add	bx, [bp+arg_0]
		test	byte ptr es:[bx], 0F0h
		jz	short loc_EA9A
		mov	di, TX_RED + TX_REVERSE
		jmp	short loc_EA9D
; ---------------------------------------------------------------------------

loc_EA9A:
		mov	di, TX_WHITE

loc_EA9D:
		call	text_putsa pascal, si, [bp+var_2], ds, offset asc_1E6DF, di
		add	si, 2
		les	bx, dword_218BA
		add	bx, [bp+arg_0]
		test	byte ptr es:[bx], 0Fh
		jz	short loc_EAC0
		mov	di, TX_RED + TX_REVERSE
		jmp	short loc_EAC3
; ---------------------------------------------------------------------------

loc_EAC0:
		mov	di, TX_WHITE

loc_EAC3:
		call	text_putsa pascal, si, [bp+var_2], ds, offset asc_1E6DF, di
		add	si, 2
		inc	[bp+arg_0]

loc_EAD7:
		cmp	si, 34h	; '4'
		jl	short loc_EA88
		inc	[bp+var_2]

loc_EADF:
		cmp	[bp+var_2], 17h
		jle	short loc_EA83
		pop	di
		pop	si
		leave
		retn	2
sub_EA6B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public BOMB_REIMU_B
bomb_reimu_b	proc near
		push	bp
		mov	bp, sp
		push	si
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jge	short loc_EB07
		call	sub_E5B5
		jmp	loc_ECA2
; ---------------------------------------------------------------------------

loc_EB07:
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jnz	short loc_EB32
		mov	byte_21A55, 0
		mov	al, _tile_mode
		mov	tilemode_21A54, al
		mov	_tile_mode, TM_NONE
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		jmp	loc_ECA2
; ---------------------------------------------------------------------------

loc_EB32:
		cmp	_bomb_frame, 132
		jge	short loc_EB9E
		cmp	_bomb_frame, BOMB_CIRCLE_FRAMES
		jle	short loc_EB7C
		test	byte ptr _bomb_frame, 3
		jnz	short loc_EB7C
		mov	ax, _bomb_frame
		and	ax, 7
		cmp	ax, 4
		jnz	short loc_EB5D
		call	_snd_se_play c, 16

loc_EB5D:
		mov	al, byte_21A55
		mov	ah, 0
		push	ax
		call	sub_EA6B
		inc	byte_21A55
		cmp	byte_21A55, 12h
		jb	short loc_EB7C
		call	@overlay_wipe$qv
		mov	_bomb_frame, 132

loc_EB7C:
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 4
		call	sub_E512
		jmp	loc_ECA2
; ---------------------------------------------------------------------------

loc_EB9E:
		cmp	_bomb_frame, 164
		jge	loc_EC56
		call	grcg_boxfill pascal, (PLAYFIELD_LEFT shl 16) or 0, ((PLAYFIELD_RIGHT - 1) shl 16) or (RES_Y - 1)
		mov	_slowdown_factor, 2
		cmp	_reduce_effects, 0
		jz	short loc_EBCC
		test	byte ptr _bomb_frame, 1
		jz	short loc_EBEF

loc_EBCC:
		call	grcg_off
		mov	si, 84
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_EBE2
		sub	si, RES_Y

loc_EBE2:
		call	@pi_put_8$qiii c, 32, si, 1

loc_EBEF:
		test	byte ptr _bomb_frame, 3
		jnz	short loc_EC00
		call	_snd_se_play c, 15

loc_EC00:
		cmp	_bomb_frame, 140
		jg	short loc_EC10
		mov	ax, _bomb_frame
		add	ax, -132
		jmp	short loc_EC36
; ---------------------------------------------------------------------------

loc_EC10:
		cmp	_bomb_frame, 148
		jg	short loc_EC20
		mov	ax, _bomb_frame
		add	ax, -140
		jmp	short loc_EC36
; ---------------------------------------------------------------------------

loc_EC20:
		cmp	_bomb_frame, 156
		jg	short loc_EC30
		mov	ax, _bomb_frame
		add	ax, -148
		jmp	short loc_EC36
; ---------------------------------------------------------------------------

loc_EC30:
		mov	ax, _bomb_frame
		add	ax, -156

loc_EC36:
		push	ax
		call	sub_E48C
		mov	ax, _bomb_frame
		add	ax, ax
		add	ax, _bomb_frame
		add	ax, -396

loc_EC46:
		mov	dx, 200
		sub	dx, ax
		mov	PaletteTone, dx
		call	far ptr	palette_show
		jmp	short loc_ECA2
; ---------------------------------------------------------------------------

loc_EC56:
		cmp	_bomb_frame, 164
		jnz	short loc_EC85
		call	_snd_se_play c, 16
		mov	al, tilemode_21A54
		mov	_tile_mode, al
		mov	_slowdown_factor, 1
		mov	PaletteTone, 200
		call	far ptr	palette_show
		call	sub_10E0A
		jmp	short loc_ECA2
; ---------------------------------------------------------------------------

loc_EC85:
		cmp	_bomb_frame, 184
		jge	short loc_EC98
		mov	ax, _bomb_frame
		imul	ax, 5
		add	ax, -820
		jmp	short loc_EC46
; ---------------------------------------------------------------------------

loc_EC98:
		call	grcg_off
		mov	ax, 1
		jmp	short loc_ECA9
; ---------------------------------------------------------------------------

loc_ECA2:
		call	grcg_off
		xor	ax, ax

loc_ECA9:
		pop	si
		pop	bp
		retn
bomb_reimu_b	endp
main_01___TEXT	ends

PLAYER_B_TEXT	segment	byte public 'CODE' use16
	@bomb_update_and_render$qv procdesc near
	@BOMB_CIRCLE_POINT_PUT$QII procdesc pascal near \
		left:word, top:word
	@BOMB_PARTICLE_PUT_8$QIII procdesc pascal near \
		left:word, top:word, cel:word
	@BOMB_SMEAR_PUT_8$QII procdesc pascal near \
		left:word
	@BOMB_BFT_8TILES_PUT_8$QIIUC procdesc pascal near \
		left:word, top:word, eight_tiles:byte
PLAYER_B_TEXT	ends

main_01____TEXT	segment	byte public 'CODE' use16

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @PLAYER_MOVE$QII
@player_move$qii proc near

@@delta_y	= word ptr  4
@@delta_x	= word ptr  6

		push	bp
		mov	bp, sp
		mov	bx, _player_top_on_back_page
		mov	ax, [bx]
		mov	_player_topleft.y, ax
		mov	ax, [bp+@@delta_y]
		add	_player_topleft.y, ax
		cmp	_player_topleft.y, PLAYFIELD_TOP
		jge	short loc_EEE5
		mov	_player_topleft.y, PLAYFIELD_TOP
		jmp	short loc_EEF3
; ---------------------------------------------------------------------------

loc_EEE5:
		cmp	_player_topleft.y, (PLAYFIELD_BOTTOM - PLAYER_H + (PLAYER_H / 6))
		jle	short loc_EEF3
		mov	_player_topleft.y, (PLAYFIELD_BOTTOM - PLAYER_H + (PLAYER_H / 6))

loc_EEF3:
		mov	bx, _player_top_on_back_page
		mov	ax, _player_topleft.y
		mov	[bx], ax
		mov	bx, _player_left_on_back_page
		mov	ax, [bx]
		mov	_player_topleft.x, ax
		mov	ax, [bp+@@delta_x]
		add	_player_topleft.x, ax
		cmp	_player_topleft.x, (PLAYFIELD_RIGHT - PLAYER_W + 6)
		jl	short loc_EF1C
		mov	_player_topleft.x, (PLAYFIELD_RIGHT - PLAYER_W + 6)
		jmp	short loc_EF29
; ---------------------------------------------------------------------------

loc_EF1C:
		cmp	_player_topleft.x, (PLAYFIELD_LEFT - (PLAYER_W / 8))
		jg	short loc_EF29
		mov	_player_topleft.x, (PLAYFIELD_LEFT - (PLAYER_W / 8))

loc_EF29:
		mov	bx, _player_left_on_back_page
		mov	ax, _player_topleft.x
		mov	[bx], ax
		pop	bp
		retn	4
@player_move$qii endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_EF36	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_player_invincible_via_bomb, 0
		jnz	short loc_EF4F
		cmp	_player_invincibility_time, 0
		jz	short loc_EF54
		cmp	byte_1E517, 0
		jnz	short loc_EF54

loc_EF4F:
		mov	_player_is_hit, 0

loc_EF54:
		cmp	_player_invincibility_time, 0
		jbe	short loc_EF5F
		dec	_player_invincibility_time

loc_EF5F:
		call	sub_D488
		cmp	_player_is_hit, 0
		jz	short loc_EF7F
		call	sub_EFF2
		cmp	_player_is_hit, -1
		jnz	short loc_EFEF
		mov	byte_20607, 1
		mov	_player_is_hit, 0
		jmp	short loc_EFEF
; ---------------------------------------------------------------------------

loc_EF7F:
		mov	al, _player_invincibility_time
		mov	ah, 0
		and	ax, 3
		cmp	ax, 3
		jge	short loc_EFAC
		mov	si, _player_topleft.y
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_EF9E
		sub	si, RES_Y

loc_EF9E:
		call	super_roll_put pascal, _player_topleft.x, si, _player_patnum

loc_EFAC:
		cmp	_power, 8
		jb	short loc_EFEF
		mov	bx, _player_option_left_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_EFC7
		sub	si, RES_Y

loc_EFC7:
		mov	bx, _player_option_left_left_on_back_page
		push	word ptr [bx]
		push	si
		mov	al, _player_option_patnum
		mov	ah, 0
		push	ax
		call	super_roll_put_tiny
		mov	bx, _player_option_left_left_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_OPTION_DISTANCE * 2)
		push	ax
		push	si
		mov	al, _player_option_patnum
		mov	ah, 0
		push	ax
		call	super_roll_put_tiny

loc_EFEF:
		pop	si
		pop	bp
		retn
sub_EF36	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_EFF2	proc near

@@patnum		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		cmp	byte_20609, 0
		jnz	short loc_F03D
		call	_snd_se_play c, 2
		mov	byte_1E517, 1
		inc	_stage_miss_count

		; ZUN bug: The fact that this function does not re-render the score
		; means that any existing [score_delta] will stop being animated. The
		; score display will therefore only refresh with the correct value
		; after the player gained another point.
		nopcall	@score_delta_commit$qv

		inc	_total_miss_count
		mov	bx, _player_left_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_W / 2)
		push	ax
		mov	bx, _player_top_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_H / 2)
		push	ax
		push	800010h
		push	1
		call	sub_4090

loc_F03D:
		mov	bx, _player_left_on_back_page
		mov	ax, [bx]
		mov	_player_topleft.x, ax
		mov	bx, _player_top_on_back_page
		mov	ax, [bx]
		mov	_player_topleft.y, ax
		inc	byte_20609
		cmp	byte_20609, 18h
		jnb	short loc_F08A
		mov	al, byte_20609
		mov	ah, 0
		sar	ax, 2
		add	ax, PAT_PLAYCHAR_MISS
		mov	[bp+@@patnum], ax
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_F078
		sub	si, RES_Y

loc_F078:
		mov	bx, _player_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, [bp+@@patnum]
		jmp	loc_F1D5
; ---------------------------------------------------------------------------

loc_F08A:
		cmp	byte_20609, 18h
		jnz	loc_F12A
		mov	_player_invincibility_time, MISS_INVINCIBILITY_FRAMES
		cmp	_playperf, 2
		jle	short loc_F0A7
		mov	_playperf, 0
		jmp	short loc_F0B9
; ---------------------------------------------------------------------------

loc_F0A7:
		sub	_playperf, 2
		cmp	_playperf, playperf_min
		jge	short loc_F0B9
		mov	_playperf, playperf_min

loc_F0B9:
		mov	bx, _player_left_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_W / 2)
		push	ax
		mov	bx, _player_top_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_H / 2)
		push	ax
		push	800020h
		push	1
		call	sub_4090
		cmp	_lives, 0
		jnz	short loc_F107
		mov	byte_20609, 0
		mov	_items_miss_add_gameover, 1
		mov	bx, _player_left_on_back_page
		push	word ptr [bx]	; screen_left
		mov	bx, _player_top_on_back_page
		push	word ptr [bx]	; screen_top
		call	@items_miss_add$qii
		mov	_items_miss_add_gameover, 0
		mov	_player_is_hit, -1
		jmp	loc_F1D5
; ---------------------------------------------------------------------------

loc_F107:
		mov	al, _shot_level
		mov	ah, 0
		mov	bx, ax
		mov	al, [bx+109Fh]
		mov	_power, al
		call	@player_shot_level_update_and_hud$qv
		mov	bx, _player_left_on_back_page
		push	word ptr [bx]	; screen_left
		mov	bx, _player_top_on_back_page
		push	word ptr [bx]	; screen_top
		call	@items_miss_add$qii
		jmp	loc_F1D5
; ---------------------------------------------------------------------------

loc_F12A:
		cmp	byte_20609, 2Bh	; '+'
		jnb	short loc_F13B
		mov	bx, _player_top_on_back_page
		add	word ptr [bx], 4
		jmp	loc_F1D5
; ---------------------------------------------------------------------------

loc_F13B:
		cmp	byte_20609, 2Bh	; '+'
		jnz	short loc_F198
		dec	_lives
		call	@hud_lives_put$qv
		les	bx, _resident
		assume es:nothing
		mov	al, es:[bx+mikoconfig_t.start_bombs]
		mov	_bombs, al
		cmp	_lives, 0
		jnz	short loc_F160
		add	al, 2
		mov	_bombs, al

loc_F160:
		call	@hud_bombs_put$qv
		mov	bx, _player_left_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_W / 2)
		push	ax
		mov	bx, _player_top_on_back_page
		mov	ax, [bx]
		add	ax, (PLAYER_H / 2)
		push	ax
		push	800010h
		push	1
		call	sub_4090
		mov	ax, PLAYER_LEFT_START
		mov	_player_left_on_page[0 * word], ax
		mov	_player_left_on_page[1 * word], ax
		mov	ax, (((PLAYFIELD_BOTTOM + PLAYFIELD_ROLL_MARGIN) - PLAYER_H) - 2)
		mov	_player_top_on_page[0 * word], ax
		mov	_player_top_on_page[1 * word], ax
		jmp	short loc_F1D5
; ---------------------------------------------------------------------------

loc_F198:
		cmp	byte_20609, 44h	; 'D'
		jnb	short loc_F1C6
		mov	bx, _player_top_on_back_page
		sub	word ptr [bx], 2
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_F1B6
		sub	si, RES_Y

loc_F1B6:
		mov	bx, _player_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, PAT_PLAYCHAR_STILL
		jmp	short loc_F1D5
; ---------------------------------------------------------------------------

loc_F1C6:
		mov	byte_20609, 0
		mov	byte_1E517, 0
		mov	_player_is_hit, 0

loc_F1D5:
		pop	si
		leave
		retn
sub_EFF2	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_F1D8	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		cmp	_player_invincible_via_bomb, 0
		jnz	short loc_F1F2
		cmp	_player_invincibility_time, 0
		jz	short loc_F1F7
		cmp	byte_1E517, 0
		jnz	short loc_F1F7

loc_F1F2:
		mov	_player_is_hit, 0

loc_F1F7:
		cmp	_player_is_hit, 0
		jnz	loc_F43E
		mov	ax, _key_det
		and	ax, INPUT_MOVEMENT_DIAGONAL
		cmp	ax, INPUT_DOWN_LEFT
		jz	loc_F29E
		ja	short loc_F21B
		cmp	ax, INPUT_UP_LEFT
		jz	short loc_F270
		cmp	ax, INPUT_UP_RIGHT
		jz	short loc_F288
		jmp	short loc_F222
; ---------------------------------------------------------------------------

loc_F21B:
		cmp	ax, INPUT_DOWN_RIGHT
		jz	loc_F2A4

loc_F222:
		mov	bx, _key_det
		and	bx, INPUT_MOVEMENT_ALIGNED
		dec	bx
		cmp	bx, 9
		ja	loc_F2B8
		add	bx, bx
		jmp	cs:off_F443[bx]

loc_F238:
		mov	al, _playchar_speed_aligned_y
		cbw
		neg	ax
		mov	di, ax
		xor	si, si
		jmp	short loc_F2BC
; ---------------------------------------------------------------------------

loc_F244:
		mov	al, _playchar_speed_aligned_y
		cbw
		mov	di, ax
		xor	si, si
		jmp	short loc_F2BC
; ---------------------------------------------------------------------------

loc_F24E:
		mov	al, _playchar_speed_aligned_x
		cbw
		neg	ax
		mov	si, ax
		xor	di, di
		mov	_player_patnum, PAT_PLAYCHAR_LEFT
		jmp	short loc_F2C2
; ---------------------------------------------------------------------------

loc_F260:
		mov	al, _playchar_speed_aligned_x
		cbw
		mov	si, ax
		xor	di, di
		mov	_player_patnum, PAT_PLAYCHAR_RIGHT
		jmp	short loc_F2C2
; ---------------------------------------------------------------------------

loc_F270:
		mov	al, _playchar_speed_diagonal_y
		cbw
		neg	ax

loc_F276:
		mov	di, ax
		mov	al, _playchar_speed_diagonal_x
		cbw
		neg	ax
		mov	si, ax
		mov	_player_patnum, PAT_PLAYCHAR_LEFT
		jmp	short loc_F2C2
; ---------------------------------------------------------------------------

loc_F288:
		mov	al, _playchar_speed_diagonal_y
		cbw
		neg	ax
		mov	di, ax
		mov	al, _playchar_speed_diagonal_x
		cbw
		mov	si, ax
		mov	_player_patnum, PAT_PLAYCHAR_RIGHT
		jmp	short loc_F2C2
; ---------------------------------------------------------------------------

loc_F29E:
		mov	al, _playchar_speed_diagonal_y
		cbw
		jmp	short loc_F276
; ---------------------------------------------------------------------------

loc_F2A4:
		mov	al, _playchar_speed_diagonal_y
		cbw
		mov	di, ax
		mov	al, _playchar_speed_diagonal_x
		cbw
		mov	si, ax
		mov	_player_patnum, PAT_PLAYCHAR_RIGHT
		jmp	short loc_F2C2
; ---------------------------------------------------------------------------

loc_F2B8:
		xor	si, si
		xor	di, di

loc_F2BC:
		mov	_player_patnum, PAT_PLAYCHAR_STILL

loc_F2C2:
		mov	al, _playchar_speed_aligned_x
		cbw
		cmp	ax, 5
		jnz	short loc_F2FB
		or	si, si
		jge	short loc_F2D8
		mov	al, _page_back
		mov	ah, 0
		add	si, ax
		jmp	short loc_F2E3
; ---------------------------------------------------------------------------

loc_F2D8:
		or	si, si
		jle	short loc_F2E3
		mov	al, _page_back
		mov	ah, 0
		sub	si, ax

loc_F2E3:
		or	di, di
		jge	short loc_F2F0
		mov	al, _page_back
		mov	ah, 0
		add	di, ax
		jmp	short loc_F2FB
; ---------------------------------------------------------------------------

loc_F2F0:
		or	di, di
		jle	short loc_F2FB
		mov	al, _page_back
		mov	ah, 0
		sub	di, ax

loc_F2FB:
		call	@player_move$qii pascal, si, di
		mov	ax, _player_topleft.x
		add	ax, -PLAYER_LEFT_TO_OPTION_LEFT_LEFT
		sub	ax, si
		mov	bx, _player_option_left_left_on_back_page
		mov	[bx], ax
		mov	ax, _player_topleft.y
		add	ax, ((PLAYER_H / 2) - (PLAYER_OPTION_H / 2))
		sub	ax, di
		mov	bx, _player_option_left_top_on_back_page
		mov	[bx], ax
		test	byte ptr _key_det, INPUT_SHOT
		jz	short loc_F349
		cmp	byte_1EB0D, -1
		jnz	short loc_F336
		mov	byte_1EB0D, 0
		mov	byte_22D4A, 0
		jmp	short loc_F368
; ---------------------------------------------------------------------------

loc_F336:
		cmp	byte_1EB0E, -1
		jnz	short loc_F368
		mov	byte_1EB0E, 0
		mov	byte_22D4B, 0
		jmp	short loc_F368
; ---------------------------------------------------------------------------

loc_F349:
		cmp	byte_1EB0D, 3
		jb	short loc_F35C
		mov	byte_1EB0D, -1
		mov	byte_1EB0E, 4
		jmp	short loc_F368
; ---------------------------------------------------------------------------

loc_F35C:
		cmp	byte_1EB0E, 2
		jb	short loc_F368
		mov	byte_1EB0E, -1

loc_F368:
		cmp	byte_1EB0D, -1
		jz	short loc_F3B3
		cmp	byte_22D4A, 0
		jnz	short loc_F3AF
		cmp	_shot_level, SHOT_LEVEL_MAX
		jnz	short loc_F38B
		mov	al, byte_2060E
		mov	byte_1E519, al
		mov	al, byte_2060F
		mov	byte_1E51A, al
		jmp	short loc_F395
; ---------------------------------------------------------------------------

loc_F38B:
		mov	byte_1E519, 34h	; '4'
		mov	byte_1E51A, 3Fh	; '?'

loc_F395:
		call	playchar_shot_func
		call	_snd_se_play c, 1
		mov	byte_22D4A, 8
		inc	byte_1EB0D
		jmp	loc_F434
; ---------------------------------------------------------------------------

loc_F3AF:
		dec	byte_22D4A

loc_F3B3:
		cmp	byte_1EB0E, 2
		jnb	short loc_F434
		cmp	byte_22D4B, 0
		jnz	short loc_F426
		cmp	_shot_level, SHOT_LEVEL_MAX
		jnz	short loc_F40D
		mov	al, byte_2060E
		mov	byte_1E519, al
		mov	al, byte_2060F
		mov	byte_1E51A, al
		test	_key_det, INPUT_DOWN or INPUT_DOWN_LEFT or INPUT_DOWN_RIGHT
		jz	short loc_F3F1
		mov	al, byte_20610
		add	al, 5
		mov	byte_20610, al
		cbw
		cmp	ax, 1Ah
		jle	short loc_F417
		mov	byte_20610, 1Ah
		jmp	short loc_F417
; ---------------------------------------------------------------------------

loc_F3F1:
		test	_key_det, INPUT_UP or INPUT_DOWN or INPUT_LEFT or INPUT_RIGHT or INPUT_UP_LEFT or INPUT_UP_RIGHT or INPUT_DOWN_LEFT or INPUT_DOWN_RIGHT
		jnz	short loc_F417
		mov	al, byte_20610
		add	al, 0FBh
		mov	byte_20610, al
		cbw
		or	ax, ax
		jge	short loc_F417
		mov	byte_20610, 0
		jmp	short loc_F417
; ---------------------------------------------------------------------------

loc_F40D:
		mov	byte_1E519, 34h	; '4'
		mov	byte_1E51A, 3Fh	; '?'

loc_F417:
		call	playchar_shot_func
		mov	byte_22D4B, 8
		inc	byte_1EB0E
		jmp	short loc_F434
; ---------------------------------------------------------------------------

loc_F426:
		call	_snd_se_play c, 1
		dec	byte_22D4B

loc_F434:
		test	byte ptr _key_det, INPUT_BOMB
		jz	short loc_F43E
		call	player_bomb

loc_F43E:
		pop	di
		pop	si
		pop	bp
		retn
sub_F1D8	endp

; ---------------------------------------------------------------------------
		db 0
off_F443	dw offset loc_F238
		dw offset loc_F244
		dw offset loc_F2B8
		dw offset loc_F24E
		dw offset loc_F270
		dw offset loc_F29E
		dw offset loc_F2B8
		dw offset loc_F260
		dw offset loc_F288
		dw offset loc_F2A4
main_01____TEXT	ends

; ===========================================================================

SHARED	segment	word public 'CODE' use16
include th02/snd/snd.inc
	extern @ZUN_ERROR$Q11ZUN_ERROR_T:proc
	extern @key_delay$qv:proc
	extern MPN_LOAD:proc
	extern _mpn_free:proc
	extern @pi_load$qinxc:proc
	extern @VECTOR2$QMIT1UCI:proc
	extern @VECTOR2_BETWEEN_PLUS$QIIIIUCMIT6I:proc
	extern @FRAME_DELAY$QI:proc
	extern @input_reset_sense$qv:proc
	extern @game_exit$qv:proc
	extern _snd_mmd_resident:proc
	extern _snd_determine_mode:proc
	extern _snd_pmd_resident:proc
	extern _snd_delay_until_volume:proc
	extern _snd_load:proc
	extern @game_init_main$qv:proc
	extern @pi_palette_apply$qi:proc
	extern @pi_put_8$qiii:proc
	extern _snd_kaja_interrupt:proc
	extern _snd_se_reset:proc
	extern _snd_se_play:proc
	extern _snd_se_update:proc
SHARED	ends

; ===========================================================================

; Segment type:	Pure code
main_03_TEXT	segment	byte public 'CODE' use16
main_03_TEXT	ends

BULLET_TEXT	segment	byte public 'CODE' use16
		assume cs:main_03
		;org 6
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

	@randring2_next8$qv procdesc near
	@RANDRING2_NEXT8_AND$QUC procdesc pascal near \
		mask:byte
	@randring2_next16$qv procdesc near
	extern @overlay_wipe$qv:far
	@stage_clear_bonus_animate$qv procdesc near
	@stage_extra_clear_bonus_animate$qv procdesc near

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_FF91	proc near
		push	bp
		mov	bp, sp
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		graph_accesspage _page_front
		call	grcg_byteboxfill_x pascal, (( 16 / 8) shl 16) or 0, (( 24 / 8) shl 16) or (RES_Y - 1)
		call	grcg_byteboxfill_x pascal, ((416 / 8) shl 16) or 0, ((424 / 8) shl 16) or (RES_Y - 1)
		graph_accesspage _page_back
		call	grcg_byteboxfill_x pascal, (( 16 / 8) shl 16) or 0, (( 24 / 8) shl 16) or (RES_Y - 1)
		call	grcg_byteboxfill_x pascal, ((416 / 8) shl 16) or 0, ((424 / 8) shl 16) or (RES_Y - 1)
		call	grcg_off
		pop	bp
		retn
sub_FF91	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_FFF8	proc near

var_A		= byte ptr -0Ah
@@angle		= byte ptr -9
var_8		= word ptr -8
@@y		= word ptr -6
@@patnum		= word ptr -4
var_2		= word ptr -2
arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8

		enter	0Ah, 0
		push	si
		push	di
		cmp	[bp+arg_0], 0
		jl	loc_10286
		cmp	[bp+arg_0], 0
		jnz	short loc_1000F
		call	sub_FF91

loc_1000F:
		cmp	[bp+arg_0], 20h	; ' '
		jge	loc_100A0
		cmp	[bp+arg_0], 1
		jnz	short loc_10025
		call	_snd_se_play stdcall, 18
		pop	cx

loc_10025:
		add	[bp+arg_4], 7
		cmp	[bp+arg_0], 2
		jl	short loc_1005C
		call	@egc_start_copy_noframe$qv
		sub	[bp+arg_0], 2
		mov	ax, [bp+arg_0]
		shl	ax, 3
		mov	dx, 0F0h
		sub	dx, ax
		mov	si, dx
		push	[bp+arg_4]
		push	[bp+arg_2]
		push	dx
		push	2
		call	sub_1C341
		add	[bp+arg_0], 2
		call	egc_off

loc_1005C:
		cmp	[bp+arg_0], 1Eh
		jge	loc_10286
		mov	ax, [bp+arg_0]
		and	ax, 1
		imul	ax, 0Bh
		add	al, 4
		mov	[bp+var_A], al
		push	GC_RMW
		mov	ah, 0
		push	ax
		call	grcg_setcolor
		mov	ax, [bp+arg_0]
		shl	ax, 3
		mov	dx, 0F0h
		sub	dx, ax
		mov	si, dx
		push	[bp+arg_4]
		push	[bp+arg_2]
		push	dx
		push	2
		call	sub_1C287
		call	grcg_off
		jmp	loc_10286
; ---------------------------------------------------------------------------

loc_100A0:
		sub	[bp+arg_0], 20h	; ' '
		cmp	[bp+arg_0], 1Ah
		jge	loc_10286
		cmp	[bp+arg_0], 0
		jnz	short loc_100BA
		call	_snd_se_play stdcall, 14
		pop	cx

loc_100BA:
		cmp	[bp+arg_0], 2
		jl	loc_10171
		sub	[bp+arg_0], 2
		mov	ax, [bp+arg_0]
		shl	ax, 4
		mov	si, ax
		call	@egc_start_copy_noframe$qv
		mov	[bp+var_8], 0
		jmp	loc_1015A
; ---------------------------------------------------------------------------

loc_100DB:
		mov	al, byte ptr [bp+var_8]
		add	al, byte ptr [bp+arg_0]
		mov	[bp+@@angle], al
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_4]
		mov	di, ax
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		mov	bl, angle_1E510
		mov	bh, 0
		add	dx, bx
		and	dx, 255
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_2]
		mov	[bp+var_2], ax
		cmp	di, 10h
		jl	short loc_10156
		cmp	di, 1A0h
		jge	short loc_10156
		cmp	[bp+var_2], 0
		jle	short loc_10156
		cmp	[bp+var_2], 180h
		jge	short loc_10156
		call	@tiles_invalidate_rect$qiiii pascal, di, ax, (16 shl 16) or 16

loc_10156:
		add	[bp+var_8], 4

loc_1015A:
		cmp	[bp+var_8], 100h
		jl	loc_100DB
		add	[bp+arg_0], 2
		call	@tiles_egc_render$qv
		call	egc_off

loc_10171:
		mov	_slowdown_factor, 1
		cmp	[bp+arg_0], 18h
		jge	loc_10286
		mov	ax, [bp+arg_0]
		mov	bx, 6
		cwd
		idiv	bx
		add	ax, 88
		mov	[bp+@@patnum], ax
		mov	ax, [bp+arg_0]
		shl	ax, 4
		mov	si, ax
		mov	[bp+var_8], 0
		jmp	loc_10230
; ---------------------------------------------------------------------------

loc_1019D:
		mov	al, byte ptr [bp+var_8]
		add	al, byte ptr [bp+arg_0]
		mov	[bp+@@angle], al
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_4]
		mov	di, ax
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		mov	bl, angle_1E510
		mov	bh, 0
		add	dx, bx
		and	dx, 255
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_2]
		mov	[bp+var_2], ax
		mov	[bp+@@y], ax
		mov	ax, _scroll_line
		add	[bp+@@y], ax
		cmp	[bp+@@y], RES_Y
		jl	short loc_10208
		sub	[bp+@@y], RES_Y

loc_10208:
		cmp	di, 10h
		jle	short loc_1022C
		cmp	di, 1A0h
		jge	short loc_1022C
		cmp	[bp+var_2], 0
		jle	short loc_1022C
		cmp	[bp+var_2], 180h
		jge	short loc_1022C
		call	super_roll_put_tiny pascal, di, [bp+@@y], [bp+@@patnum]

loc_1022C:
		add	[bp+var_8], 4

loc_10230:
		cmp	[bp+var_8], 100h
		jl	loc_1019D
		mov	_slowdown_factor, 2
		cmp	[bp+arg_0], 8
		jg	short loc_10258
		mov	ax, [bp+arg_0]
		and	ax, 1
		imul	ax, 70
		add	ax, 100
		mov	PaletteTone, ax
		call	far ptr	palette_show

loc_10258:
		cmp	[bp+arg_0], 14h
		jg	short loc_10286
		mov	ax, [bp+arg_0]
		and	ax, 1
		mov	[bp+var_8], ax
		mov	ax, RES_Y
		sub	ax, _scroll_line
		push	ax
		mov	ax, _scroll_line
		imul	ax, 40
		add	ax, [bp+var_8]
		push	ax
		push	[bp+var_8]
		call	graph_scroll
		mov	_slowdown_factor, 3

loc_10286:
		pop	di
		pop	si
		leave
		retn	6
sub_FFF8	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1028C	proc far
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	short loc_102A9
; ---------------------------------------------------------------------------

loc_10294:
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+2BD4h], 0
		mov	byte ptr [si+2BF0h], 0
		mov	byte ptr [si+2BF5h], 0
		inc	si

loc_102A9:
		cmp	si, 5
		jl	short loc_10294
		mov	_boss_phase_frame, 0
		mov	byte_2066A, 0
		mov	_boss_damage, 0
		mov	byte_2066B, 0
		mov	_sigma_frames, 0
		mov	word_20686, 0
		pop	si
		pop	bp
		retf
sub_1028C	endp
BULLET_TEXT ends

DIALOG_TEXT	segment	byte public 'CODE' use16

BG_NONE = 00h
BG_1 = 20h
BG_1_AIMED = 19h
BG_2_SPREAD_NARROW = 01h
BG_2_SPREAD_MEDIUM = 02h
BG_2_SPREAD_WIDE = 03h
BG_2_SPREAD_NARROW_AIMED = 04h
BG_2_SPREAD_MEDIUM_AIMED = 05h
BG_2_SPREAD_WIDE_AIMED = 06h
BG_2_SPREAD_ULTRAWIDE_AIMED = 26h
BG_3_SPREAD_NARROW = 07h
BG_3_SPREAD_MEDIUM = 08h
BG_3_SPREAD_WIDE = 09h
BG_3_SPREAD_NARROW_AIMED = 0Ah
BG_3_SPREAD_MEDIUM_AIMED = 0Bh
BG_3_SPREAD_WIDE_AIMED = 0Ch
BG_4_SPREAD_NARROW = 0Dh
BG_4_SPREAD_MEDIUM = 0Eh
BG_4_SPREAD_WIDE = 0Fh
BG_4_SPREAD_NARROW_AIMED = 10h
BG_4_SPREAD_MEDIUM_AIMED = 11h
BG_4_SPREAD_WIDE_AIMED = 12h
BG_5_SPREAD_NARROW = 13h
BG_5_SPREAD_MEDIUM = 14h
BG_5_SPREAD_WIDE = 15h
BG_5_SPREAD_NARROW_AIMED = 16h
BG_5_SPREAD_MEDIUM_AIMED = 17h
BG_5_SPREAD_WIDE_AIMED = 18h
BG_2_RING = 22h
BG_4_RING = 21h
BG_8_RING = 24h
BG_16_RING = 25h
BG_32_RING = 27h
BG_1_RANDOM_ANGLE = 1Ah
BG_RANDOM_ANGLE = 1Bh
BG_RANDOM_ANGLE_AND_SPEED = 1Ch
BG_2_SPREAD_HORIZONTALLY_SYMMETRIC = 23h
BG_SPECIAL_MOTIONS = 80h
BSM_CHASE = BG_SPECIAL_MOTIONS
BSM_HOMING = 81h
BSM_DECELERATE_THEN_TURN_AIMED = 82h
BSM_GRAVITY = 83h
BSM_DRIFT_ANGLE_AND_SPEED = 84h
BSM_DRIFT_ANGLE_CHASE = 85h
BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM = 87h
BSM_BOUNCE_TOP_BOTTOM = 88h
BSM_1 = 0FFh

PAT_BULLET16_OUTLINED_BALL_BEIGE = 80
PAT_BULLET16_OUTLINED_BALL_RED = 81
PAT_BULLET16_OUTLINED_BALL_GREEN = 82
PAT_BULLET16_NOROI = 84
PAT_BULLET16_STAR = 85
PAT_BULLET16_BALL = 86
PAT_BULLET16_BILLIARD_BALL_RED = 122
PAT_BULLET16_BILLIARD_BALL_PURPLE = 123

PELLET_W = 8
BULLET16_W = 16

	extern @bullets_and_sparks_init$qv:proc
	@BULLETS_ADD_PELLET$QIIUCUCI procdesc pascal near \
		left:word, top:word, angle:byte, group:byte, speed:word
	@BULLETS_ADD_16X16$QIIUC32BULLET_GROUP_OR_SPECIAL_MOTION_T13MAIN_PATNUM_TI procdesc pascal near \
		left:word, top:word, angle:byte, group_or_special_motion:byte, patnum:byte, speed:word
	extern @bullets_update_and_render$qv:proc
	extern @bullets_invalidate$qv:proc

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_10E0A	proc far
		push	bp
		mov	bp, sp
		push	si
		call	@bullets_invalidate$qv
		xor	si, si
		jmp	short loc_10E30
; ---------------------------------------------------------------------------

loc_10E16:
		mov	bx, si
		imul	bx, size bullet_t
		mov	al, _bullets[bx].BULLET_flag
		cbw
		cmp	ax, F_ALIVE
		jnz	short loc_10E2F
		mov	bx, si
		imul	bx, size bullet_t
		mov	_bullets[bx].BULLET_flag, F_REMOVE

loc_10E2F:
		inc	si

loc_10E30:
		cmp	si, BULLET_COUNT
		jl	short loc_10E16
		pop	si
		pop	bp
		retf
sub_10E0A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_10E39	proc near

arg_0		= byte ptr  4

		push	bp
		mov	bp, sp
		mov	al, _rank_base_stack
		mov	ah, 0
		mov	dl, [bp+arg_0]
		mov	dh, 0
		imul	dx
		mov	_bullet_stack, al
		pop	bp
		retn	2
sub_10E39	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_10E4F	proc far
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	short loc_10E8D
; ---------------------------------------------------------------------------

loc_10E57:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 8
		mov	dx, si
		shl	dx, 2
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx+5336h]	; left
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 8
		mov	dx, si
		shl	dx, 2
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx+5338h]	; top
		push	(1 shl 16) or 2	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		inc	si

loc_10E8D:
		cmp	si, 40h
		jl	short loc_10E57
		pop	si
		pop	bp
		retf
sub_10E4F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_10E95	proc far

@@angle		= byte ptr -3
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		inc	word_20686
		cmp	word_20686, 0A8h ; ''
		jb	loc_110B3
		cmp	word_20686, 0A8h ; ''
		jnz	short loc_10EC0
		call	_snd_se_play c, 14
		jmp	loc_10FF6
; ---------------------------------------------------------------------------

loc_10EC0:
		cmp	word_20686, 0C8h
		jnb	short loc_10F22
		cmp	word_20686, 0B4h
		ja	short loc_10EE4
		mov	ax, word_20686
		and	ax, 1
		imul	ax, 70
		add	ax, 100
		mov	PaletteTone, ax
		call	far ptr	palette_show

loc_10EE4:
		mov	ax, word_20686
		and	ax, 1
		mov	di, ax
		mov	ax, RES_Y
		sub	ax, _scroll_line
		push	ax
		mov	ax, _scroll_line
		imul	ax, 40
		add	ax, di
		push	ax
		push	di
		call	graph_scroll
		mov	_slowdown_factor, 3
		mov	word_22DA0, 0E0h
		mov	word_22DA2, 0C8h
		mov	word_22D9E, 0
		mov	byte_22DA4, 0
		jmp	loc_10FF6
; ---------------------------------------------------------------------------

loc_10F22:
		cmp	word_20686, 190h
		jnb	short loc_10F5E
		cmp	word_20686, 0C8h
		jnz	short loc_10F37
		mov	_slowdown_factor, 1

loc_10F37:
		mov	ax, word_20686
		shr	ax, 1
		mov	dl, 200
		sub	dl, al
		mov	Palettes[0 * size rgb_t].r, dl
		mov	Palettes[0 * size rgb_t].g, 0
		mov	Palettes[0 * size rgb_t].b, 0
		mov	ax, word_20686
		sub	ax, 0C8h
		mov	word_22D9E, ax
		inc	byte_22DA4
		jmp	loc_10FF6
; ---------------------------------------------------------------------------

loc_10F5E:
		cmp	word_20686, 258h
		jnb	short loc_10F8C
		mov	Palettes[0 * size rgb_t].r, 0
		mov	ax, word_20686
		shr	ax, 1
		mov	dl, 44
		sub	dl, al
		mov	Palettes[0 * size rgb_t].g, dl
		mov	Palettes[0 * size rgb_t].b, 0
		mov	ax, word_20686
		sub	ax, 190h
		mov	word_22D9E, ax
		dec	byte_22DA4
		jmp	short loc_10FF6
; ---------------------------------------------------------------------------

loc_10F8C:
		cmp	word_20686, 320h
		jnb	short loc_10FBA
		mov	Palettes[0 * size rgb_t].r, 0
		mov	Palettes[0 * size rgb_t].g, 0
		mov	ax, word_20686
		shr	ax, 1
		mov	dl, 144
		sub	dl, al
		mov	Palettes[0 * size rgb_t].b, dl
		mov	ax, word_20686
		sub	ax, 258h
		mov	word_22D9E, ax
		inc	byte_22DA4
		jmp	short loc_10FF6
; ---------------------------------------------------------------------------

loc_10FBA:
		cmp	word_20686, 3E8h
		jnb	short loc_10FF0
		mov	ax, word_20686
		shr	ax, 1
		mov	dl, 244
		sub	dl, al
		mov	Palettes[0 * size rgb_t].r, dl
		mov	Palettes[0 * size rgb_t].g, 0
		mov	ax, word_20686
		shr	ax, 1
		mov	dl, 244
		sub	dl, al
		mov	Palettes[0 * size rgb_t].b, dl
		mov	ax, word_20686
		sub	ax, 320h
		mov	word_22D9E, ax
		dec	byte_22DA4
		jmp	short loc_10FF6
; ---------------------------------------------------------------------------

loc_10FF0:
		mov	word_20686, 0C8h

loc_10FF6:
		call	far ptr	palette_show
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 7
		xor	di, di
		mov	al, byte_22DA4
		jmp	loc_110A4
; ---------------------------------------------------------------------------

loc_11013:
		movsx	eax, word_22D9E
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, word_22DA0
		mov	[bp+var_2], ax
		movsx	eax, word_22D9E
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, word_22DA2
		mov	si, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 8
		mov	dx, di
		shl	dx, 2
		add	ax, dx
		mov	dx, [bp+var_2]
		mov	bx, ax
		mov	[bx+5336h], dx
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 8
		mov	dx, di
		shl	dx, 2
		add	ax, dx
		mov	bx, ax
		mov	[bx+5338h], si
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_11095
		sub	si, RES_Y

loc_11095:
		push	[bp+var_2]
		push	si
		call	grcg_pset
		inc	di
		mov	al, [bp+@@angle]
		add	al, 4

loc_110A4:
		mov	[bp+@@angle], al
		cmp	di, 40h
		jl	loc_11013
		call	grcg_off

loc_110B3:
		pop	di
		pop	si
		leave
		retf
sub_10E95	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss3_invalidate$qv
@midboss3_invalidate$qv	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		xor	di, di
		xor	si, si
		jmp	loc_1116C
; ---------------------------------------------------------------------------

loc_110C3:
		cmp	byte ptr [si+2BF0h], 2
		jnz	short loc_110CE
		inc	di
		jmp	loc_1116B
; ---------------------------------------------------------------------------

loc_110CE:
		mov	ax, si
		shl	ax, 2
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		add	ax, dx
		add	ax, 2BACh
		mov	bx, si
		shl	bx, 2
		mov	word ptr [bx+52EEh], ds
		mov	[bx+52ECh], ax
		mov	ax, si
		shl	ax, 2
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		add	ax, dx
		add	ax, 2BC0h
		mov	bx, si
		shl	bx, 2
		mov	word ptr [bx+5302h], ds
		mov	[bx+5300h], ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		push	word ptr es:[bx]	; left
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		push	word ptr es:[bx]	; top
		push	(64 shl 16) or 32	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	bx, si
		shl	bx, 2
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		add	bx, ax
		mov	ax, [bx+2BACh]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	es:[bx], ax
		mov	bx, si
		shl	bx, 2
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		add	bx, ax
		mov	ax, [bx+2BC0h]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	es:[bx], ax

loc_1116B:
		inc	si

loc_1116C:
		cmp	si, 2
		jl	loc_110C3
		cmp	di, 2
		jnz	short loc_1117C
		xor	ax, ax
		jmp	short loc_1117F
; ---------------------------------------------------------------------------

loc_1117C:
		mov	ax, 1

loc_1117F:
		pop	di
		pop	si
		pop	bp
		retf
@midboss3_invalidate$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss3_11183	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	di, [bp+arg_0]
		call	_snd_se_play c, 4
		mov	bx, di
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	si, es:[bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_111AF
		sub	si, RES_Y

loc_111AF:
		mov	bx, di
		shl	bx, 2
		les	bx, [bx+52ECh]
		call	super_roll_put_1plane pascal, word ptr es:[bx], si, word_22D4C, large PLANE_PUT or GC_BRGI
		pop	di
		pop	si
		pop	bp
		retn	2
midboss3_11183	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss3_111D1	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	di, [bp+arg_0]
		mov	bx, di
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	si, es:[bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_111F3
		sub	si, RES_Y

loc_111F3:
		mov	bx, di
		shl	bx, 2
		les	bx, [bx+52ECh]
		call	super_roll_put pascal, word ptr es:[bx], si, word_22D4C
		pop	di
		pop	si
		pop	bp
		retn	2
midboss3_111D1	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss3_1120F	proc near

@@patnum		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	si, [bp+arg_0]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 20h	; ' '
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	ax, es:[bx]
		add	ax, 10h
		push	ax
		push	3C0001h
		push	0
		call	sub_4090
		mov	[bp+@@patnum], 10
		mov	bx, si
		add	bx, bx
		mov	ax, [bx+10AAh]
		mov	bx, 6
		cwd
		idiv	bx
		add	[bp+@@patnum], ax
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+10AAh]
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+10AAh], 30h ; '0'
		jl	short loc_112BA
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 20h	; ' '
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	ax, es:[bx]
		add	ax, 10h
		push	ax
		push	800020h
		push	1
		call	sub_4090
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+10AAh], 0
		mov	byte ptr [si+2BF0h], 2
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh
		jmp	short loc_11302
; ---------------------------------------------------------------------------

loc_112BA:
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	di, es:[bx]
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_112D4
		sub	di, RES_Y

loc_112D4:
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		call	super_roll_put pascal, word ptr es:[bx], di, [bp+@@patnum]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 32
		call	super_roll_put pascal, ax, di, [bp+@@patnum]

loc_11302:
		pop	di
		pop	si
		leave
		retn	2
midboss3_1120F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss3_11308	proc near

@@group	= byte ptr -3
var_2		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	si, [bp+arg_0]
		or	si, si
		jnz	short loc_1131C
		mov	ax, 8
		jmp	short loc_1131F
; ---------------------------------------------------------------------------

loc_1131C:
		mov	ax, 0FFF8h

loc_1131F:
		mov	[bp+var_2], ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		mov	ax, es:[bx]
		add	ax, 12
		mov	di, ax
		cmp	_boss_phase_frame, 152
		jge	short loc_11381
		cmp	_boss_phase_frame, 128
		jnz	short loc_1134D
		mov	byte_22FA6, 0
		mov	byte_22FA7, 80h

loc_1134D:
		test	byte ptr _boss_phase_frame, 3
		jnz	loc_114D0
		mov	al, [si+5536h]
		add	al, byte ptr [bp+var_2]
		mov	[si+5536h], al
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 28
		push	ax	; left
		push	di	; top
		mov	al, [si+5536h]
		push	ax	; angle
		push	BG_1	; group

loc_11379:
		push	((2 shl 4) + 8)	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	loc_114D0
; ---------------------------------------------------------------------------

loc_11381:
		cmp	_boss_phase_frame, 192
		jge	short loc_113DE
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, [bp+var_2]
		add	es:[bx], ax
		test	byte ptr _boss_phase_frame, 7
		jnz	loc_114D0
		mov	al, [si+5536h]
		mov	dl, byte ptr [bp+var_2]
		add	dl, dl
		add	al, dl
		mov	[si+5536h], al
		cmp	_rank, RANK_EASY
		jz	short loc_113BD
		mov	[bp+@@group], BG_4_SPREAD_MEDIUM
		jmp	short loc_113C1
; ---------------------------------------------------------------------------

loc_113BD:
		mov	[bp+@@group], BG_2_SPREAD_MEDIUM

loc_113C1:
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 28
		push	ax	; left
		push	di	; top
		mov	al, 80h
		sub	al, [si+5536h]
		push	ax	; angle
		push	word ptr [bp+@@group]	; group
		jmp	short loc_11379
; ---------------------------------------------------------------------------

loc_113DE:
		cmp	_boss_phase_frame, 352
		jge	short loc_11416
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		add	word ptr es:[bx], 2
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx+5300h]
		cmp	word ptr es:[bx], 190h
		jl	loc_114D0
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx+5300h]
		sub	word ptr es:[bx], 190h
		jmp	loc_114D0
; ---------------------------------------------------------------------------

loc_11416:
		cmp	_boss_phase_frame, 376
		jge	short loc_11429
		test	byte ptr _boss_phase_frame, 3
		jnz	loc_114D0
		jmp	short loc_11449
; ---------------------------------------------------------------------------

loc_11429:
		cmp	_boss_phase_frame, 416
		jge	short loc_11473
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, [bp+var_2]
		sub	es:[bx], ax
		test	byte ptr _boss_phase_frame, 3
		jnz	loc_114D0

loc_11449:
		mov	al, [si+5536h]
		sub	al, byte ptr [bp+var_2]
		mov	[si+5536h], al
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 28
		push	ax	; left
		push	di	; top
		mov	al, [si+5536h]
		push	ax	; angle
		push	BG_1	; group
		push	((3 shl 4) + 2)	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	short loc_114D0
; ---------------------------------------------------------------------------

loc_11473:
		cmp	_boss_phase_frame, 576
		jge	short loc_114CA
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		sub	word ptr es:[bx], 2
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx+5300h]
		cmp	word ptr es:[bx], 0
		jge	short loc_114A5
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx+5300h]
		add	word ptr es:[bx], 190h

loc_114A5:
		mov	ax, _boss_phase_frame
		mov	bx, 60
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_114D0
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 28
		push	ax	; left
		push	di	; top
		push	00h	; angle
		push	BG_1_AIMED	; group
		jmp	loc_11379
; ---------------------------------------------------------------------------

loc_114CA:
		mov	_boss_phase_frame, 127 ; Skip the scroll-in animation

loc_114D0:
		pop	di
		pop	si
		leave
		retn	2
midboss3_11308	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss3_update_and_render$qv
@midboss3_update_and_render$qv	proc far

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	[bp+var_2], 0
		cmp	byte_20660, 0
		jnz	short loc_1150C
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, [bx+2BACh]
		add	ax, 18h
		mov	word_205D8, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, [bx+2BC0h]
		jmp	short loc_1152C
; ---------------------------------------------------------------------------

loc_1150C:
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, [bx+2BB0h]
		add	ax, 18h
		mov	word_205D8, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, [bx+2BC4h]

loc_1152C:
		add	ax, 10h
		mov	word_205DA, ax
		inc	_boss_phase_frame
		cmp	_boss_phase_frame, 1
		jnz	short loc_11581
		mov	word_2061C, 20h	; ' '
		mov	word_2061E, 20h	; ' '
		mov	word_20630, 0FFF0h
		mov	word_20632, 0FFF0h
		mov	word_20644, 0
		mov	word_20620, 160h
		mov	word_20622, 160h
		mov	ax, word_20630
		mov	word_20634, ax
		mov	ax, word_20630
		mov	word_20636, ax
		mov	word_20646, 0
		mov	byte_22FA8, 0
		jmp	loc_116A9
; ---------------------------------------------------------------------------

loc_11581:
		cmp	_boss_phase_frame, 128
		jge	short loc_115F0
		mov	ax, _scroll_line
		and	ax, 3
		add	ax, 144
		mov	word_22D4C, ax
		xor	si, si
		jmp	short loc_115E8
; ---------------------------------------------------------------------------

loc_11599:
		mov	al, byte_1E503
		mov	ah, 0
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		add	es:[bx], ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 0Ch
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		push	word ptr es:[bx]
		push	28001Eh
		call	sub_1283C
		mov	di, ax
		or	ax, ax
		jz	short loc_115E3
		mov	bx, si
		add	bx, bx
		add	[bx+2BD4h], di
		push	si
		call	midboss3_11183
		jmp	short loc_115E7
; ---------------------------------------------------------------------------

loc_115E3:
		push	si
		call	midboss3_111D1

loc_115E7:
		inc	si

loc_115E8:
		cmp	si, 2
		jl	short loc_11599
		jmp	loc_116A9
; ---------------------------------------------------------------------------

loc_115F0:
		mov	ax, _scroll_line
		and	ax, 3
		add	ax, 144
		mov	word_22D4C, ax
		cmp	_boss_phase_frame, 128
		jnz	short loc_11608
		inc	byte_22FA8

loc_11608:
		xor	si, si
		jmp	loc_116A2
; ---------------------------------------------------------------------------

loc_1160D:
		cmp	byte ptr [si+2BF0h], 1
		jnz	short loc_1161B
		push	si
		call	midboss3_1120F
		jmp	loc_116A1
; ---------------------------------------------------------------------------

loc_1161B:
		cmp	byte ptr [si+2BF0h], 0
		jnz	short loc_11697
		push	si
		call	midboss3_11308
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+52ECh]
		mov	ax, es:[bx]
		add	ax, 0Ch
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx+5300h]
		push	word ptr es:[bx]
		push	28001Eh
		call	sub_1283C
		mov	di, ax
		or	ax, ax
		jz	short loc_11685
		mov	bx, si
		add	bx, bx
		add	[bx+2BD4h], di
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+2BD4h], 118h
		jg	short loc_1166B
		push	si
		call	midboss3_11183
		jmp	short loc_11689
; ---------------------------------------------------------------------------

loc_1166B:
		call	_snd_se_play c, 2
		mov	byte ptr [si+2BF0h], 1
		add	_score_delta, 20000
		jmp	short loc_11689
; ---------------------------------------------------------------------------

loc_11685:
		push	si
		call	midboss3_111D1

loc_11689:
		cmp	byte_22FA8, 4
		jb	short loc_116A1
		mov	byte ptr [si+2BF0h], 1
		jmp	short loc_116A1
; ---------------------------------------------------------------------------

loc_11697:
		cmp	byte ptr [si+2BF0h], 2
		jnz	short loc_116A1
		inc	[bp+var_2]

loc_116A1:
		inc	si

loc_116A2:
		cmp	si, 2
		jl	loc_1160D

loc_116A9:
		pop	di
		pop	si
		leave
		retf
@midboss3_update_and_render$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_bg_render	proc far
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	short loc_116E4
; ---------------------------------------------------------------------------

loc_116B5:
		cmp	byte ptr [si+2BF0h], 4
		jnb	short loc_116E3
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]	; left
		mov	bx, si
		add	bx, bx
		push	_stone_top[bx]	; top
		push	(32 shl 16) or 32	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		cmp	byte ptr [si+2BF0h], 3
		jnz	short loc_116E3
		mov	byte ptr [si+2BF0h], 4

loc_116E3:
		inc	si

loc_116E4:
		cmp	si, STONE_COUNT
		jl	short loc_116B5
		pop	si
		pop	bp
		retf
stones_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_116EC	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		xor	si, si
		jmp	short loc_1175D
; ---------------------------------------------------------------------------

loc_116F5:
		cmp	byte ptr [si+2BF0h], 2
		jnb	short loc_1175C
		mov	bx, si
		add	bx, bx
		mov	di, _stone_top[bx]
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_11712
		sub	di, RES_Y

loc_11712:
		cmp	byte ptr [si+2BF5h], 0
		jz	short loc_11746
		call	_snd_se_play c, 4
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]
		push	di
		mov	bx, si
		add	bx, bx
		push	word ptr [bx+52DCh]
		pushd	PLANE_PUT or GC_BRGI
		call	super_roll_put_1plane
		mov	byte ptr [si+2BF5h], 0
		jmp	short loc_1175C
; ---------------------------------------------------------------------------

loc_11746:
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]
		push	di
		mov	bx, si
		add	bx, bx
		push	word ptr [bx+52DCh]
		call	super_roll_put

loc_1175C:
		inc	si

loc_1175D:
		cmp	si, STONE_COUNT
		jl	short loc_116F5
		pop	di
		pop	si
		pop	bp
		retn
stones_116EC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11766	proc near

var_4		= word ptr -4
var_2		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	si, [bp+arg_0]
		mov	[bp+var_4], 40h
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 16
		push	ax
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 12
		push	ax
		push	500002h
		push	0
		call	sub_4090
		mov	[bp+var_2], 0Ah
		mov	bx, si
		add	bx, bx
		mov	di, _stone_top[bx]
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_117B6
		sub	di, RES_Y

loc_117B6:
		cmp	si, 4
		jnz	short loc_11824
		add	[bp+var_4], 20h	; ' '
		mov	ax, _stone_left[STONE_NORTH * word]
		add	ax, 8
		push	ax
		mov	ax, _stone_top[STONE_NORTH * word]
		add	ax, 8
		push	ax
		push	word_1EB26
		call	sub_FFF8
		cmp	word_1EB26, 18h
		jl	short loc_117F3
		mov	ax, _stone_left[STONE_NORTH * word]
		add	ax, 8
		push	ax
		mov	ax, _stone_top[STONE_NORTH * word]
		add	ax, 8
		push	ax
		mov	ax, word_1EB26
		add	ax, 0FFE8h
		push	ax
		call	sub_FFF8

loc_117F3:
		cmp	word_1EB26, 20h	; ' '
		jge	short loc_11810
		call	super_roll_put pascal, _stone_left[STONE_NORTH * word], di, patnum_22D54
		inc	word_1EB26
		xor	ax, ax
		jmp	short loc_11871
; ---------------------------------------------------------------------------

loc_11810:
		cmp	word_1EB26, 38h	; '8'
		jnz	short loc_1181C
		mov	angle_1E510, -20h

loc_1181C:
		mov	ax, word_1EB26
		add	ax, 0FFE0h
		jmp	short loc_1182C
; ---------------------------------------------------------------------------

loc_11824:
		mov	bx, si
		add	bx, bx
		mov	ax, [bx+10AEh]

loc_1182C:
		mov	bx, 8
		cwd
		idiv	bx
		add	[bp+var_2], ax
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+10AEh]
		mov	bx, si
		add	bx, bx
		mov	ax, [bx+10AEh]
		cmp	ax, [bp+var_4]
		jl	short loc_1185E
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+10AEh], 0
		mov	byte ptr [si+2BF0h], 3
		mov	ax, 1
		jmp	short loc_11871
; ---------------------------------------------------------------------------

loc_1185E:
		mov	bx, si
		add	bx, bx
		call	super_put pascal, _stone_left[bx], di, [bp+var_2]
		xor	ax, ax

loc_11871:
		pop	di
		pop	si
		leave
		retn	2
stones_11766	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11877	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		inc	word_22FAA
		xor	si, si
		jmp	loc_1193F
; ---------------------------------------------------------------------------

loc_11885:
		cmp	byte ptr [si+2BF0h], 1
		ja	loc_1193E
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]
		mov	bx, si
		add	bx, bx
		push	_stone_top[bx]
		push	200028h
		call	sub_1283C
		mov	di, ax
		or	ax, ax
		jz	loc_1193E
		cmp	byte ptr [si+2BF0h], 1
		jnz	loc_1193E
		mov	byte ptr [si+2BF5h], 1
		mov	bx, si
		add	bx, bx
		add	[bx+2BD4h], di
		cmp	si, 4
		jnz	short loc_118CF
		mov	ax, 3A2h
		jmp	short loc_118DC
; ---------------------------------------------------------------------------

loc_118CF:
		cmp	si, 1
		jg	short loc_118D9
		mov	ax, 8Ch
		jmp	short loc_118DC
; ---------------------------------------------------------------------------

loc_118D9:
		mov	ax, 78h	; 'x'

loc_118DC:
		mov	bx, si
		add	bx, bx
		cmp	ax, [bx+2BD4h]
		jg	short loc_1193E
		mov	byte ptr [si+2BF0h], 2
		add	_score_delta, 30000
		cmp	si, 3
		jg	short loc_11939
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 8
		push	ax	; left
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 12
		push	ax	; top
		or	si, si
		jnz	short loc_1191A
		mov	ax, IT_BOMB
		jmp	short loc_11927
; ---------------------------------------------------------------------------

loc_1191A:
		cmp	si, IT_BOMB
		jg	short loc_11924
		mov	ax, IT_BIGPOWER
		jmp	short loc_11927
; ---------------------------------------------------------------------------

loc_11924:
		mov	ax, IT_BOMB

loc_11927:
		push	ax	; type
		call	@items_add$qiii
		call	_snd_se_play c, 2
		jmp	short loc_1193E
; ---------------------------------------------------------------------------

loc_11939:
		mov	_player_invincibility_time, BOSS_DEFEAT_INVINCIBILITY_FRAMES

loc_1193E:
		inc	si

loc_1193F:
		cmp	si, STONE_COUNT
		jl	loc_11885
		xor	si, si
		jmp	short loc_11970
; ---------------------------------------------------------------------------

loc_1194A:
		cmp	byte ptr [si+2BF0h], 1
		jnz	short loc_1196F
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 8
		mov	word_205D8, ax
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		mov	word_205DA, ax
		jmp	short loc_11975
; ---------------------------------------------------------------------------

loc_1196F:
		inc	si

loc_11970:
		cmp	si, STONE_COUNT
		jl	short loc_1194A

loc_11975:
		cmp	_player_topleft.y, (PLAYFIELD_TOP + 80)
		jge	short loc_11993
		push	left_22D98	; left
		push	top_22D9A	; top
		call	@randring2_next8_and$quc pascal, 0Fh
		add	al, -07h
		push	ax	; angle
		push	BG_1_AIMED	; group
		push	((4 shl 4) + 13)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_11993:
		pop	di
		pop	si
		pop	bp
		retn
stones_11877	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11997	proc near
		push	bp
		mov	bp, sp
		cmp	_rank, RANK_EASY
		jz	short loc_119B7
		mov	byte_2066E, 18h
		mov	byte_2066F, 0
		mov	group_20670, BG_8_RING
		mov	byte_20671, 21h
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_119B7:
		mov	byte_2066E, 0Ch
		mov	byte_2066F, 2
		mov	group_20670, BG_4_RING
		mov	byte_20671, 22h
		pop	bp
		retn
stones_11997	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_119CD	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 30
		jl	loc_11A84
		cmp	_boss_phase_frame, 180
		jge	short loc_11A27
		mov	ax, _boss_phase_frame
		mov	bx, 24
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_11A84
		xor	si, si
		jmp	short loc_11A20
; ---------------------------------------------------------------------------

loc_119F5:
		cmp	byte ptr [si+2BF0h], 1
		jnz	short loc_11A1F
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		push	ax	; top
		push	00h	; angle
		push	word ptr byte_2066E	; group
		push	((2 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_11A1F:
		inc	si

loc_11A20:
		cmp	si, 2
		jl	short loc_119F5
		jmp	short loc_11A84
; ---------------------------------------------------------------------------

loc_11A27:
		cmp	_boss_phase_frame, 200
		jl	short loc_11A84
		cmp	_boss_phase_frame, 310
		jge	short loc_11A76
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	short loc_11A84
		xor	si, si
		jmp	short loc_11A6F
; ---------------------------------------------------------------------------

loc_11A42:
		cmp	byte ptr [si+2BF0h], 1
		jnz	short loc_11A6E
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		push	ax	; top
		push	0	; angle
		push	BG_1_AIMED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_RED shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti

loc_11A6E:
		inc	si

loc_11A6F:
		cmp	si, STONE_OUTER_WEST
		jl	short loc_11A42
		jmp	short loc_11A84
; ---------------------------------------------------------------------------

loc_11A76:
		cmp	_boss_phase_frame, 350
		jle	short loc_11A84
		mov	_boss_phase_frame, 0

loc_11A84:
		pop	si
		pop	bp
		retn
stones_119CD	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11A87	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		push	di
		cmp	_boss_phase_frame, 30
		jl	loc_11B57
		cmp	_boss_phase_frame, 200
		jge	short loc_11AFC
		mov	ax, [bp+arg_0]
		imul	ax, 20
		mov	bx, 110
		sub	bx, ax
		mov	ax, _boss_phase_frame
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_11B57
		mov	di, STONE_OUTER_WEST
		jmp	short loc_11AF5
; ---------------------------------------------------------------------------

loc_11AB9:
		cmp	byte ptr [di+2BF0h], 1
		jnz	short loc_11AF4
		xor	si, si
		jmp	short loc_11AEF
; ---------------------------------------------------------------------------

loc_11AC4:
		mov	bx, di
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, di
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		push	ax	; top
		mov	ax, si
		imul	ax, 2Ah
		push	ax	; angle
		push	BSM_DECELERATE_THEN_TURN_AIMED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_GREEN shl 16) or ((3 shl 4) + 8)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_11AEF:
		cmp	si, 6
		jl	short loc_11AC4

loc_11AF4:
		inc	di

loc_11AF5:
		cmp	di, STONE_NORTH
		jl	short loc_11AB9
		jmp	short loc_11B57
; ---------------------------------------------------------------------------

loc_11AFC:
		mov	ax, [bp+arg_0]
		imul	ax, 20
		mov	bx, 90
		sub	bx, ax
		mov	ax, _boss_phase_frame
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_11B57
		mov	di, STONE_OUTER_WEST
		jmp	short loc_11B52
; ---------------------------------------------------------------------------

loc_11B16:
		cmp	byte ptr [di+2BF0h], 1
		jnz	short loc_11B51
		xor	si, si
		jmp	short loc_11B4C
; ---------------------------------------------------------------------------

loc_11B21:
		mov	bx, di
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, di
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		push	ax	; top
		mov	ax, si
		imul	ax, 2Ah
		push	ax	; angle
		push	BSM_DECELERATE_THEN_TURN_AIMED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_GREEN shl 16) or ((3 shl 4) + 8)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_11B4C:
		cmp	si, 6
		jl	short loc_11B21

loc_11B51:
		inc	di

loc_11B52:
		cmp	di, STONE_NORTH
		jl	short loc_11B16

loc_11B57:
		pop	di
		pop	si
		pop	bp
		retn	2
stones_11A87	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11B5D	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_11BFC
		cmp	_boss_phase_frame, 50
		jnz	short loc_11BB3
		mov	byte_23A70, 24h	; '$'
		push	300060h
		push	100067h
		call	sub_12A19
		push	0C00060h
		push	100067h
		call	sub_12A19
		push	0F00060h
		push	100067h
		call	sub_12A19
		push	1800060h
		push	100067h
		call	sub_12A19
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_11BB3:
		cmp	_boss_phase_frame, 80
		jnz	short loc_11BFC
		push	500060h
		push	100067h
		call	sub_12A19
		push	0A00060h
		push	100067h
		call	sub_12A19
		push	1100060h
		push	100067h
		call	sub_12A19
		push	1600060h
		push	100067h
		call	sub_12A19
		mov	_boss_phase_frame, 0

loc_11BFC:
		pop	bp
		retn
stones_11B5D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11BFE	proc near
		push	bp
		mov	bp, sp
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_11C35
		call	@bullets_add_pellet$qiiucuci pascal, left_22D98, top_22D9A, word ptr angle_1EB28, BG_2_SPREAD_HORIZONTALLY_SYMMETRIC, ((4 shl 4) + 6)
		mov	al, angle_1EB28
		add	al, 8
		mov	angle_1EB28, al
		cmp	angle_1EB28, -7Eh
		jbe	short loc_11C35
		mov	_boss_phase_frame, 0
		mov	angle_1EB28, 0

loc_11C35:
		pop	bp
		retn
stones_11BFE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11C37	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	_boss_phase_frame, 24
		jl	short locret_11C88
		mov	al, _rank
		cbw
		mov	dx, ax
		add	dx, dx
		add	dx, ax
		mov	bx, 28
		sub	bx, dx
		mov	ax, _boss_phase_frame
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_11C7A
		mov	byte_23A70, 1Eh
		mov	ax, _player_topleft.x
		add	ax, (PLAYER_W / 2)
		and	ax, 0FFF0h
		mov	[bp+var_2], ax
		push	ax
		push	600010h
		push	67h ; 'g'
		call	sub_12A19

loc_11C7A:
		cmp	_boss_phase_frame, 140
		jl	short locret_11C88
		mov	_boss_phase_frame, 0

locret_11C88:
		leave
		retn
stones_11C37	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11C8A	proc near

@@angle_2	= byte ptr -2
@@angle_1	= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	_boss_phase_frame, 40
		jge	short loc_11CF5
		mov	ax, _boss_phase_frame
		mov	bx, 6
		cwd
		idiv	bx
		or	dx, dx
		jnz	locret_11D2E
		mov	ax, _player_topleft.y
		add	ax, -32
		push	ax
		mov	ax, _player_topleft.x
		sub	ax, _stone_left[STONE_NORTH * word]
		push	ax
		call	iatan2
		mov	[bp+@@angle_1], al
		call	@randring2_next8_and$quc pascal, 1Fh
		add	al, 10h

loc_11CC4:
		mov	[bp+@@angle_2], al
		push	left_22D98	; left
		push	top_22D9A	; top
		mov	al, [bp+@@angle_1]
		add	al, [bp+@@angle_2]
		push	ax	; angle
		push	BG_1	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		push	left_22D98	; left
		push	top_22D9A	; top
		mov	al, [bp+@@angle_1]
		sub	al, [bp+@@angle_2]
		push	ax	; angle
		push	BG_1	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		leave
		retn
; ---------------------------------------------------------------------------

loc_11CF5:
		cmp	_boss_phase_frame, 102
		jge	short loc_11D28
		mov	ax, _boss_phase_frame
		mov	bx, 6
		cwd
		idiv	bx
		or	dx, dx
		jnz	short locret_11D2E
		mov	ax, _player_topleft.y
		add	ax, -32
		push	ax
		mov	ax, _player_topleft.x
		sub	ax, _stone_left[STONE_NORTH * word]
		push	ax
		call	iatan2
		mov	[bp+@@angle_1], al
		mov	al, 5Fh	; '_'
		sub	al, byte ptr _boss_phase_frame
		jmp	short loc_11CC4
; ---------------------------------------------------------------------------

loc_11D28:
		mov	_boss_phase_frame, 0

locret_11D2E:
		leave
		retn
stones_11C8A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11D30	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 16
		jl	loc_11DF4
		cmp	_boss_phase_frame, 16
		jnz	short loc_11D4E
		mov	word_22FAC, 20h	; ' '
		mov	byte_22FAE, 0

loc_11D4E:
		cmp	byte_22FAE, 0
		jnz	short loc_11D9A
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_11D9A
		mov	byte_23A70, 10h
		push	word_22FAC
		push	600003h
		push	6Fh ; 'o'
		call	sub_12A19
		mov	ax, 1B0h
		sub	ax, word_22FAC
		push	ax
		push	600003h
		push	6Fh ; 'o'
		call	sub_12A19
		add	word_22FAC, 10h
		cmp	word_22FAC, 0B0h ; ''
		jle	short loc_11D9A
		mov	byte_22FAE, 1
		add	word_22FAC, 10h

loc_11D9A:
		cmp	byte_22FAE, 24h	; '$'
		jbe	short loc_11DE9
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_11DF4
		push	word_22FAC
		push	600001h
		push	6Fh ; 'o'
		call	sub_12A19
		mov	ax, 1B0h
		sub	ax, word_22FAC
		push	ax
		push	600001h
		push	6Fh ; 'o'
		call	sub_12A19
		sub	word_22FAC, 10h
		cmp	word_22FAC, 40h
		jge	short loc_11DF4
		mov	byte_22FAE, 0
		mov	_boss_phase_frame, 0
		mov	word_22FAC, 20h	; ' '
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_11DE9:
		cmp	byte_22FAE, 0
		jz	short loc_11DF4
		inc	byte_22FAE

loc_11DF4:
		pop	bp
		retn
stones_11D30	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11DF6	proc near
		push	bp
		mov	bp, sp
		push	si
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	short loc_11E30
		mov	al, byte_2066F
		mov	ah, 0
		mov	si, ax
		jmp	short loc_11E2B
; ---------------------------------------------------------------------------

loc_11E0A:
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]	; left
		mov	bx, si
		add	bx, bx
		push	_stone_top[bx]	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BSM_GRAVITY	; group
		push	(PAT_BULLET16_OUTLINED_BALL_GREEN shl 16) or (2 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_11E2B:
		cmp	si, STONE_NORTH
		jl	short loc_11E0A

loc_11E30:
		cmp	_boss_phase_frame, 110
		jle	short loc_11E3D
		mov	_boss_phase_frame, 0

loc_11E3D:
		pop	si
		pop	bp
		retn
stones_11DF6	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11E40	proc near
		push	bp
		mov	bp, sp
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_11E66
		push	left_22D98	; left
		push	top_22D9A	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	word ptr byte_20671	; group
		mov	ax, _boss_phase_frame
		sar	ax, 1
		add	ax, ((1 shl 4) + 14)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci

loc_11E66:
		cmp	_boss_phase_frame, 130
		jle	short loc_11E74
		mov	_boss_phase_frame, 0

loc_11E74:
		pop	bp
		retn
stones_11E40	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11E76	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		cmp	_boss_phase_frame, 16
		jl	loc_11F2B
		cmp	_boss_phase_frame, 80
		jge	short loc_11EE5
		mov	ax, _boss_phase_frame
		mov	bx, 36
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_11EBE
		mov	byte_23A70, 1Eh
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 18h
		cwd
		idiv	bx
		add	dx, 2
		mov	di, dx
		mov	ax, di
		shl	ax, 4
		push	ax
		push	60000Ch
		push	6Fh ; 'o'
		call	sub_12A19

loc_11EBE:
		mov	ax, _boss_phase_frame
		mov	bx, 40
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_11F2B
		cmp	_rank, RANK_EASY
		jz	short loc_11F2B
		call	@bullets_add_pellet$qiiucuci pascal, left_22D98, top_22D9A, 00h, BG_1_AIMED, ((4 shl 4) + 6)
		jmp	short loc_11F2B
; ---------------------------------------------------------------------------

loc_11EE5:
		cmp	_boss_phase_frame, 120
		jge	short loc_11F25
		cmp	_boss_phase_frame, 100
		jnz	short loc_11F2B
		mov	byte_23A70, 1Eh
		xor	si, si
		jmp	short loc_11F1E
; ---------------------------------------------------------------------------

loc_11EFC:
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 18h
		cwd
		idiv	bx
		add	dx, 2
		mov	di, dx
		mov	ax, di
		shl	ax, 4
		push	ax
		push	60000Ch
		push	6Fh ; 'o'
		call	sub_12A19
		inc	si

loc_11F1E:
		cmp	si, 3
		jl	short loc_11EFC
		jmp	short loc_11F2B
; ---------------------------------------------------------------------------

loc_11F25:
		mov	_boss_phase_frame, 0

loc_11F2B:
		pop	di
		pop	si
		pop	bp
		retn
stones_11E76	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11F2F	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 16
		jl	short loc_11FB2
		cmp	_boss_phase_frame, 16
		jnz	short loc_11F46
		mov	angle_22FAF, 29h

loc_11F46:
		mov	ax, _boss_phase_frame
		mov	bx, 30
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_11FA5
		xor	si, si
		jmp	short loc_11F98
; ---------------------------------------------------------------------------

loc_11F57:
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]	; left
		mov	bx, si
		add	bx, bx
		push	_stone_top[bx]	; top
		push	word ptr angle_22FAF	; angle
		push	BG_1_AIMED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_GREEN shl 16) or ((3 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	bx, si
		add	bx, bx
		push	_stone_left[bx]	; left
		mov	bx, si
		add	bx, bx
		push	_stone_top[bx]	; top
		mov	al, angle_22FAF
		neg	al
		push	ax	; angle
		push	BG_1_AIMED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_GREEN shl 16) or ((3 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_11F98:
		cmp	si, STONE_NORTH
		jl	short loc_11F57
		mov	al, angle_22FAF
		add	al, -03h
		mov	angle_22FAF, al

loc_11FA5:
		cmp	angle_22FAF, -38h
		jb	short loc_11FB2
		mov	_boss_phase_frame, 0

loc_11FB2:
		pop	si
		pop	bp
		retn
stones_11F2F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_11FB5	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 2
		jnz	short loc_11FC4
		mov	angle_22FB0, 3Eh

loc_11FC4:
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_1200D
		push	left_22D98	; left
		push	top_22D9A	; top
		mov	al, 0
		sub	al, angle_22FB0
		push	ax	; angle
		push	word ptr group_20670	; group
		push	(4 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		call	@bullets_add_pellet$qiiucuci pascal, left_22D98, top_22D9A, word ptr angle_22FB0, word ptr group_20670, (4 shl 4)
		mov	al, angle_22FB0
		add	al, -03h
		mov	angle_22FB0, al
		cmp	angle_22FB0, -38h
		jbe	short loc_1200D
		mov	_boss_phase_frame, 0

loc_1200D:
		pop	bp
		retn
stones_11FB5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_1200F	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 60
		jl	loc_120F4
		mov	ax, _boss_phase_frame
		mov	bx, 64
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1204F
		xor	si, si
		jmp	short loc_1204A
; ---------------------------------------------------------------------------

loc_1202D:
		mov	ax, _player_topleft.y
		add	ax, -32
		push	ax
		mov	bx, si
		add	bx, bx
		mov	ax, _player_topleft.x
		sub	ax, _stone_left[bx]
		push	ax
		call	iatan2
		mov	angle_22FB1[si], al
		inc	si

loc_1204A:
		cmp	si, STONE_COUNT
		jl	short loc_1202D

loc_1204F:
		test	byte ptr _boss_phase_frame, 3
		jnz	loc_120E1
		cmp	_boss_phase_frame, 384
		jge	short loc_120A1
		mov	ax, _boss_phase_frame
		mov	bx, 64
		cwd
		idiv	bx
		sar	dx, 2
		cmp	dx, 8
		jg	short loc_120E1
		xor	si, si
		jmp	short loc_1209A
; ---------------------------------------------------------------------------

loc_12075:
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 12
		push	ax	; top
		mov	al, angle_22FB1[si]
		push	ax	; angle
		push	BG_1	; group
		push	(7 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		inc	si

loc_1209A:
		cmp	si, STONE_COUNT
		jl	short loc_12075
		jmp	short loc_120D7
; ---------------------------------------------------------------------------

loc_120A1:
		push	0
		call	sub_10E39
		xor	si, si
		jmp	short loc_120D2
; ---------------------------------------------------------------------------

loc_120AA:
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_left[bx]
		add	ax, 8
		push	ax	; left
		mov	bx, si
		add	bx, bx
		mov	ax, _stone_top[bx]
		add	ax, 8
		push	ax	; top
		push	word ptr angle_22FB1[4]	; angle
		push	BG_4_RING	; group
		push	(PAT_BULLET16_BALL shl 16) or (7 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_120D2:
		cmp	si, STONE_COUNT
		jl	short loc_120AA

loc_120D7:
		call	_snd_se_play c, 3

loc_120E1:
		cmp	_boss_phase_frame, 447
		jl	short loc_120F4
		mov	_boss_phase_frame, 0
		push	1
		call	sub_10E39

loc_120F4:
		pop	si
		pop	bp
		retn
stones_1200F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_120F7	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+arg_0]
		or	si, si
		jz	short loc_12107
		cmp	si, 1
		jnz	short loc_12128

loc_12107:
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+52DCh]
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+52DCh], 9Bh
		jl	loc_121B3
		mov	byte ptr [si+2BF0h], 1
		mov	ax, 1
		jmp	loc_121B5
; ---------------------------------------------------------------------------

loc_12128:
		cmp	si, 2
		jz	short loc_12132
		cmp	si, 3
		jnz	short loc_1217C

loc_12132:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+52DCh], 98h
		jge	short loc_12146
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+52DCh]

loc_12146:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+52DCh], 98h
		jnz	short loc_1215E
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+52DCh], 9Ch
		jmp	short loc_12166
; ---------------------------------------------------------------------------

loc_1215E:
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+52DCh]

loc_12166:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+52DCh], 9Fh
		jl	short loc_121B3
		mov	byte ptr [si+2BF0h], 1
		mov	ax, 1
		jmp	short loc_121B5
; ---------------------------------------------------------------------------

loc_1217C:
		cmp	si, 4
		jnz	short loc_121B3
		cmp	patnum_22D54, 152
		jge	short loc_1218D
		inc	patnum_22D54

loc_1218D:
		cmp	patnum_22D54, 152
		jnz	short loc_1219D
		mov	patnum_22D54, 160
		jmp	short loc_121A1
; ---------------------------------------------------------------------------

loc_1219D:
		inc	patnum_22D54

loc_121A1:
		cmp	patnum_22D54, 163
		jl	short loc_121B3
		mov	byte_20664, 1
		mov	ax, 1
		jmp	short loc_121B5
; ---------------------------------------------------------------------------

loc_121B3:
		xor	ax, ax

loc_121B5:
		pop	si
		pop	bp
		retn	2
stones_120F7	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_121BA	proc near
		push	bp
		mov	bp, sp
		cmp	patnum_22D54, 160
		jl	short loc_121C9
		dec	patnum_22D54

loc_121C9:
		cmp	patnum_22D54, 159
		jnz	short loc_121DE
		mov	byte_20664, 0
		mov	patnum_22D54, 151
		jmp	short loc_121E2
; ---------------------------------------------------------------------------

loc_121DE:
		dec	patnum_22D54

loc_121E2:
		cmp	patnum_22D54, 148
		jg	short loc_121EF
		mov	ax, 1
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_121EF:
		xor	ax, ax
		pop	bp
		retn
stones_121BA	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_121F3	proc near

arg_0		= byte ptr  4

		push	bp
		mov	bp, sp
		mov	cl, [bp+arg_0]
		test	byte ptr _boss_phase_frame, 1
		jz	short loc_1223A
		mov	al, byte_22FCF
		mov	ah, 0
		mov	bx, ax
		mov	al, [bx+10B9h]
		mov	ah, 0
		mov	bx, ax
		mov	[bx+5546h], cl
		mov	al, byte_22FCF
		mov	ah, 0
		mov	bx, ax
		mov	al, [bx+10C5h]
		mov	ah, 0
		mov	bx, ax
		mov	[bx+5546h], cl
		inc	byte_22FCF
		cmp	byte_22FCF, 0Ch
		jb	short loc_1223A
		inc	byte_22FCE
		mov	byte_22FCF, 0

loc_1223A:
		pop	bp
		retn	2
stones_121F3	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_1223E	proc near

@@left		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	si, 5546h
		call	@egc_start_copy_noframe$qv
		xor	di, di
		mov	[bp+@@left], PLAYFIELD_LEFT
		jmp	short loc_122A7
; ---------------------------------------------------------------------------

loc_12257:
		cmp	byte ptr [si], 1
		jnz	short loc_12269
		push	[bp+@@left]
		push	y_22D9C
		push	tile_image_22FD2
		jmp	short loc_12279
; ---------------------------------------------------------------------------

loc_12269:
		cmp	byte ptr [si], 2
		jnz	short loc_12283
		push	[bp+@@left]
		push	y_22D9C
		push	tile_image_22FD4

loc_12279:
		call	@tile_ring_set_and_put_both_8$qiii
		mov	byte ptr [si], 0
		jmp	short loc_122A1
; ---------------------------------------------------------------------------

loc_12283:
		cmp	byte ptr [di+5546h], 3
		jnz	short loc_122A1
		call	@tile_ring_set_and_put_both_8$qiii pascal, [bp+@@left], y_22D9C, tile_image_22FD6
		mov	byte ptr [si], 0
		inc	byte_22FD0

loc_122A1:
		inc	di
		add	[bp+@@left], TILE_W
		inc	si

loc_122A7:
		cmp	di, TILES_X
		jl	short loc_12257
		call	egc_off
		pop	di
		pop	si
		leave
		retn
stones_1223E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_122B5	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 49
		jl	short loc_1232A
		cmp	_boss_phase_frame, 49
		jnz	short loc_122F9
		xor	si, si
		jmp	short loc_122D1
; ---------------------------------------------------------------------------

loc_122CB:
		mov	byte ptr [si+5546h], 0
		inc	si

loc_122D1:
		cmp	si, 18h
		jl	short loc_122CB
		mov	byte_22FCF, 0
		mov	byte_22FCE, 0
		mov	byte_22FD0, 0
		mov	tile_image_22FD2, 41
		mov	tile_image_22FD4, 42
		mov	tile_image_22FD6, 43
		jmp	short loc_1231B
; ---------------------------------------------------------------------------

loc_122F9:
		cmp	byte_22FCE, 0
		jnz	short loc_12304
		push	1
		jmp	short loc_12318
; ---------------------------------------------------------------------------

loc_12304:
		cmp	byte_22FCE, 1
		jnz	short loc_1230F
		push	2
		jmp	short loc_12318
; ---------------------------------------------------------------------------

loc_1230F:
		cmp	byte_22FCE, 2
		jnz	short loc_1231B
		push	3

loc_12318:
		call	stones_121F3

loc_1231B:
		call	stones_1223E
		cmp	byte_22FD0, 18h
		jb	short loc_1232A
		mov	ax, 1
		jmp	short loc_1232C
; ---------------------------------------------------------------------------

loc_1232A:
		xor	ax, ax

loc_1232C:
		pop	si
		pop	bp
		retn
stones_122B5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_1232F	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 49
		jl	short loc_123A4
		cmp	_boss_phase_frame, 49
		jnz	short loc_12373
		xor	si, si
		jmp	short loc_1234B
; ---------------------------------------------------------------------------

loc_12345:
		mov	byte ptr [si+5546h], 0
		inc	si

loc_1234B:
		cmp	si, 18h
		jl	short loc_12345
		mov	byte_22FCF, 0
		mov	byte_22FCE, 0
		mov	byte_22FD0, 0
		mov	tile_image_22FD2, 42
		mov	tile_image_22FD4, 41
		mov	tile_image_22FD6, 40
		jmp	short loc_12395
; ---------------------------------------------------------------------------

loc_12373:
		cmp	byte_22FCE, 0
		jnz	short loc_1237E
		push	1
		jmp	short loc_12392
; ---------------------------------------------------------------------------

loc_1237E:
		cmp	byte_22FCE, 1
		jnz	short loc_12389
		push	2
		jmp	short loc_12392
; ---------------------------------------------------------------------------

loc_12389:
		cmp	byte_22FCE, 2
		jnz	short loc_12395
		push	3

loc_12392:
		call	stones_121F3

loc_12395:
		call	stones_1223E
		cmp	byte_22FD0, 18h
		jb	short loc_123A4
		mov	ax, 1
		jmp	short loc_123A6
; ---------------------------------------------------------------------------

loc_123A4:
		xor	ax, ax

loc_123A6:
		pop	si
		pop	bp
		retn
stones_1232F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_update	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		xor	di, di
		inc	_boss_phase_frame
		inc	dword_22D58
		call	stones_11877
		call	stones_116EC
		xor	si, si
		jmp	short loc_123D9
; ---------------------------------------------------------------------------

loc_123C3:
		cmp	byte ptr [si+2BF0h], 2
		jnz	short loc_123D0
		push	si
		call	stones_11766
		jmp	short loc_123D8
; ---------------------------------------------------------------------------

loc_123D0:
		cmp	byte ptr [si+2BF0h], 4
		jnz	short loc_123D8
		inc	di

loc_123D8:
		inc	si

loc_123D9:
		cmp	si, 5
		jl	short loc_123C3
		cmp	di, 5
		jl	short loc_123E9
		mov	ax, 2
		jmp	loc_12737
; ---------------------------------------------------------------------------

loc_123E9:
		cmp	byte_22D56, 0
		jnz	short loc_12454
		cmp	_boss_phase_frame, 50
		jz	short loc_1241A
		cmp	_boss_phase_frame, 52
		jz	short loc_1241A
		cmp	_boss_phase_frame, 54
		jz	short loc_1241A
		cmp	_boss_phase_frame, 58
		jz	short loc_1241A
		cmp	_boss_phase_frame, 60
		jz	short loc_1241A
		cmp	_boss_phase_frame, 62
		jnz	short loc_12425

loc_1241A:
		inc	word_22D4C
		inc	word_22D4E
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_12425:
		cmp	_boss_phase_frame, 64
		jnz	loc_12734
		inc	word_22D4C
		inc	word_22D4E
		mov	_boss_phase_frame, 0
		mov	byte_20660, 1
		mov	byte_20661, 1
		mov	byte_22D56, 1
		mov	word_22FAA, 0
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_12454:
		cmp	byte_22D56, 1
		jnz	short loc_124C2
		call	stones_119CD
		cmp	dword_22D58, 514h
		jle	short loc_12481
		cmp	byte_20660, 1
		jnz	short loc_12475
		mov	byte_20660, 2

loc_12475:
		cmp	byte_20661, 1
		jnz	short loc_12481
		mov	byte_20661, 2

loc_12481:
		cmp	di, 2
		jl	loc_12734
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_12734
		push	2
		call	stones_120F7
		push	3
		call	stones_120F7
		or	ax, ax
		jz	short loc_124B6
		mov	byte_22D56, 2
		mov	_boss_phase_frame, 0
		mov	word_22FAA, 0

loc_124B6:
		mov	dword_22D58, 0
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_124C2:
		cmp	byte_22D56, 2
		jnz	short loc_12520
		cmp	dword_22D58, 514h
		jle	short loc_124EC
		cmp	byte_20662, 1
		jnz	short loc_124E0
		mov	byte_20662, 2

loc_124E0:
		cmp	byte_20663, 1
		jnz	short loc_124EC
		mov	byte_20663, 2

loc_124EC:
		cmp	di, 4
		jl	short loc_12519
		mov	byte_22D56, 3
		mov	_boss_phase_frame, 0
		mov	byte_22D57, 0
		mov	word_22FAA, 0
		mov	ax, _stone_left[STONE_NORTH * word]
		add	ax, 8
		mov	word_205D8, ax
		mov	word_205DA, 20h	; ' '
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_12519:
		push	di
		call	stones_11A87
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_12520:
		cmp	byte_22D56, 3
		jnz	short loc_12567
		call	stones_122B5
		or	ax, ax
		jz	loc_12734
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_12734
		push	4
		call	stones_120F7
		or	ax, ax
		jz	loc_12734
		mov	byte_22D56, 4
		mov	_boss_phase_frame, 0
		mov	word_22FAA, 0
		mov	dword_22D58, 0
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_12567:
		cmp	byte_22D56, 4
		jnz	short loc_125E9
		cmp	byte_22D57, 0
		jnz	short loc_1257A
		call	stones_11B5D
		jmp	short loc_125B4
; ---------------------------------------------------------------------------

loc_1257A:
		cmp	byte_22D57, 1
		jnz	short loc_12586
		call	stones_11BFE
		jmp	short loc_125B4
; ---------------------------------------------------------------------------

loc_12586:
		cmp	byte_22D57, 2
		jnz	short loc_12592
		call	stones_11C37
		jmp	short loc_125B4
; ---------------------------------------------------------------------------

loc_12592:
		cmp	byte_22D57, 3
		jnz	short loc_1259E
		call	stones_11DF6
		jmp	short loc_125B4
; ---------------------------------------------------------------------------

loc_1259E:
		cmp	byte_22D57, 4
		jnz	short loc_125AA
		call	stones_11E40
		jmp	short loc_125B4
; ---------------------------------------------------------------------------

loc_125AA:
		cmp	byte_22D57, 5
		jnz	short loc_125B4
		call	stones_11E76

loc_125B4:
		cmp	_boss_phase_frame, 0
		jnz	short loc_125D6
		inc	byte_22D57
		mov	word_22FAA, 0
		cmp	byte_22D57, 5
		jbe	short loc_125D6
		mov	byte_22D56, 5
		mov	byte_22D57, 0

loc_125D6:
		cmp	word_2064C, 1F4h
		jl	loc_12734
		mov	word_2064C, 1F4h
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_125E9:
		cmp	byte_22D56, 5
		jnz	short loc_1261B
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1260A
		cmp	byte_22D57, 0
		jnz	short loc_1260A
		call	stones_121BA
		mov	byte_22D57, al

loc_1260A:
		call	stones_1232F
		or	ax, ax
		jz	loc_12734
		mov	byte_22D56, 6
		jmp	loc_1269E
; ---------------------------------------------------------------------------

loc_1261B:
		cmp	byte_22D56, 6
		jnz	short loc_1266F
		cmp	byte_22D57, 0
		jz	short loc_1263C
		cmp	byte_22D57, 1
		jnz	short loc_12635
		call	stones_11F2F
		jmp	short loc_1264B
; ---------------------------------------------------------------------------

loc_12635:
		cmp	byte_22D57, 2
		jnz	short loc_12641

loc_1263C:
		call	stones_11FB5
		jmp	short loc_1264B
; ---------------------------------------------------------------------------

loc_12641:
		cmp	byte_22D57, 3
		jnz	short loc_1264B
		call	stones_1200F

loc_1264B:
		cmp	_boss_phase_frame, 0
		jnz	loc_12734
		inc	byte_22D57
		mov	word_22FAA, 0
		cmp	byte_22D57, 3
		jbe	loc_12734
		mov	byte_22D56, 7
		jmp	loc_12734
; ---------------------------------------------------------------------------

loc_1266F:
		cmp	byte_22D56, 7
		jnz	short loc_126BA
		call	stones_122B5
		or	ax, ax
		jz	loc_12734
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_12734
		push	4
		call	stones_120F7
		or	ax, ax
		jz	loc_12734
		mov	byte_22D56, 8

loc_1269E:
		mov	_boss_phase_frame, 0
		mov	word_22FAA, 0
		mov	dword_22D58, 0
		mov	byte_22D57, 0
		jmp	short loc_12734
; ---------------------------------------------------------------------------

loc_126BA:
		cmp	byte_22D56, 8
		jnz	short loc_12734
		cmp	byte_22D57, 0
		jnz	short loc_126CD
		call	stones_11D30
		jmp	short loc_12707
; ---------------------------------------------------------------------------

loc_126CD:
		cmp	byte_22D57, 1
		jnz	short loc_126D9
		call	stones_11BFE
		jmp	short loc_12707
; ---------------------------------------------------------------------------

loc_126D9:
		cmp	byte_22D57, 2
		jnz	short loc_126E5
		call	stones_11C8A
		jmp	short loc_12707
; ---------------------------------------------------------------------------

loc_126E5:
		cmp	byte_22D57, 3
		jnz	short loc_126F1
		call	stones_11DF6
		jmp	short loc_12707
; ---------------------------------------------------------------------------

loc_126F1:
		cmp	byte_22D57, 4
		jnz	short loc_126FD
		call	stones_11E40
		jmp	short loc_12707
; ---------------------------------------------------------------------------

loc_126FD:
		cmp	byte_22D57, 5
		jnz	short loc_12707
		call	stones_11E76

loc_12707:
		cmp	_boss_phase_frame, 0
		jnz	short loc_12734
		inc	byte_22D57
		mov	word_22FAA, 0
		cmp	byte_22D57, 5
		jbe	short loc_12724
		mov	byte_22D57, 1

loc_12724:
		cmp	dword_22D58, 7D0h
		jle	short loc_12734
		mov	byte_20664, 2

loc_12734:
		mov	ax, 1

loc_12737:
		pop	di
		pop	si
		pop	bp
		retf
stones_update	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_end	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_POSTBOSS
		call	@stage_clear_bonus_animate$qv
		call	@overlay_stage_leave_animate$qv
		inc	_stage_id
		pop	bp
		retf
stones_end	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_init	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_PREBOSS
		call	@dialog_post$qv
		push	ds
		push	offset aBoss2_m	; "boss2.m"
		nopcall	sub_13ABB
		add	sp, 4
		call	stones_12778
		nopcall	sub_129FC
		pop	bp
		retf
stones_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

stones_12778	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	_boss_phase_frame, 0
		xor	si, si
		jmp	short loc_127A5
; ---------------------------------------------------------------------------

loc_12786:
		mov	byte ptr [si+2BF0h], 0
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+2BD4h], 0
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+52DCh], 94h
		mov	byte ptr [si+2BF5h], 0
		inc	si

loc_127A5:
		cmp	si, 5
		jl	short loc_12786
		mov	_stone_left[STONE_INNER_WEST * word], (PLAYFIELD_LEFT + 16 + (1 * 80))
		mov	_stone_top[STONE_INNER_WEST * word], (PLAYFIELD_TOP + 16)
		mov	_stone_left[STONE_INNER_EAST * word], (PLAYFIELD_LEFT + 16 + (3 * 80))
		mov	_stone_top[STONE_INNER_EAST * word], (PLAYFIELD_TOP + 16)
		mov	_stone_left[STONE_OUTER_WEST * word], (PLAYFIELD_LEFT + 16 + (0 * 80))
		mov	_stone_top[STONE_OUTER_WEST * word], (PLAYFIELD_TOP + 32)
		mov	_stone_left[STONE_OUTER_EAST * word], (PLAYFIELD_LEFT + 16 + (4 * 80))
		mov	_stone_top[STONE_OUTER_EAST * word], (PLAYFIELD_TOP + 32)
		mov	_stone_left[STONE_NORTH * word], (PLAYFIELD_LEFT + 16 + (2 * 80))
		mov	_stone_top[STONE_NORTH * word], (PLAYFIELD_TOP + 16)
		mov	top_22D9A, (PLAYFIELD_TOP + 24)
		mov	left_22D98, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - (PELLET_W / 2))
		nopcall	sub_17A55
		mov	byte_23A70, 0Ch
		mov	word_22FAA, 0
		mov	dword_22D58, 0
		mov	byte_22D56, 0
		mov	byte_22D57, 0
		mov	angle_1E510, 20h
		mov	y_22D9C, 96
		mov	ax, _scroll_line
		add	y_22D9C, ax
		cmp	y_22D9C, RES_Y
		jl	short loc_12835
		sub	y_22D9C, RES_Y

loc_12835:
		call	stones_11997
		pop	si
		pop	bp
		retn
stones_12778	endp

; ---------------------------------------------------------------------------
		db 0

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1283C	proc near

var_12		= word ptr -12h
var_10		= word ptr -10h
var_E		= word ptr -0Eh
var_B		= byte ptr -0Bh
var_A		= word ptr -0Ah
var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2
arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8
arg_6		= word ptr  0Ah

		push	bp
		mov	bp, sp
		sub	sp, 12h
		push	si
		push	di
		mov	bl, _shot_level
		mov	bh, 0
		add	bx, bx
		mov	ax, [bx+10DAh]
		mov	[bp+var_E], ax
		mov	ax, [bx+10EEh]
		mov	[bp+var_10], ax
		mov	ax, [bx+1102h]
		mov	[bp+var_12], ax
		mov	[bp+var_8], 0
		mov	ax, [bp+arg_6]
		add	ax, [bp+arg_2]
		mov	[bp+var_A], ax
		mov	al, _page_back
		shl	al, 2
		add	al, 4
		mov	[bp+var_B], al
		mov	ax, [bp+arg_4]
		add	ax, 0FFF8h
		mov	[bp+var_6], ax
		sub	[bp+arg_6], 8
		mov	si, 2908h
		mov	[bp+var_2], 0

loc_1288F:
		cmp	byte ptr [si], 1
		jz	short loc_12897
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_12897:
		cmp	byte ptr [si+0Fh], 0
		jz	short loc_128A0
		jmp	loc_12943
; ---------------------------------------------------------------------------

loc_128A0:
		cmp	byte ptr [si+1], 0
		jz	short loc_128A9
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_128A9:
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si-2]
		sar	ax, 4
		mov	[bp+var_4], ax
		cmp	ax, [bp+arg_6]
		jg	short loc_128C1
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_128C1:
		cmp	ax, [bp+var_A]
		jl	short loc_128C9
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_128C9:
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si]
		sar	ax, 4
		mov	di, ax
		cmp	di, [bp+var_6]
		jg	short loc_128DF
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_128DF:
		mov	ax, [bp+var_6]
		add	ax, [bp+arg_0]
		cmp	ax, di
		jg	short loc_128EC
		jmp	loc_129AB
; ---------------------------------------------------------------------------

loc_128EC:
		inc	[bp+var_8]
		cmp	word ptr [si+0Eh], 32h ; '2'
		jl	short loc_12926
		sar	word ptr [si+0Ah], 3
		sar	word ptr [si+0Ch], 3
		cmp	word ptr [si+0Eh], 78h ; 'x'
		jl	short loc_1291C
		mov	byte ptr [si+1], 1
		mov	ax, [bx+si-2]
		sub	ax, 80h
		mov	[bx+si-2], ax
		mov	ax, [bx+si]
		sub	ax, 80h
		mov	[bx+si], ax
		mov	ax, [bp+var_12]
		jmp	short loc_12923
; ---------------------------------------------------------------------------

loc_1291C:
		mov	byte ptr [si+1], 2
		mov	ax, [bp+var_E]

loc_12923:
		add	[bp+var_8], ax

loc_12926:
		push	[bp+var_4]
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si]
		sar	ax, 4
		push	ax
		push	1Eh
		push	1
		push	0
		call	sub_4090
		jmp	short loc_129AB
; ---------------------------------------------------------------------------

loc_12943:
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si-2]
		sar	ax, 4
		mov	[bp+var_4], ax
		cmp	ax, [bp+arg_6]
		jle	short loc_129AB
		mov	ax, [bp+arg_6]
		add	ax, [bp+arg_2]
		cmp	ax, [bp+var_4]
		jle	short loc_129AB
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si]
		sar	ax, 4
		mov	di, ax
		cmp	di, [bp+var_6]
		jle	short loc_129AB
		mov	ax, [bp+var_6]
		add	ax, [bp+arg_0]
		cmp	ax, di
		jle	short loc_129AB
		cmp	byte ptr [si+1], 1
		jnz	short loc_129A5
		push	[bp+var_4]
		mov	al, [bp+var_B]
		mov	ah, 0
		mov	bx, ax
		mov	ax, [bx+si]
		sar	ax, 4
		push	ax
		push	28h ; '('
		push	1
		push	0
		call	sub_4090
		mov	byte ptr [si+1], 2

loc_129A5:
		mov	ax, [bp+var_10]
		add	[bp+var_8], ax

loc_129AB:
		inc	[bp+var_2]
		add	si, 10h
		cmp	[bp+var_2], 23h	; '#'
		jge	short loc_129BA
		jmp	loc_1288F
; ---------------------------------------------------------------------------

loc_129BA:
		cmp	_bombing, 0
		jz	short loc_129CD
		mov	al, byte_1EB88
		test	byte ptr _stage_frame, al
		jnz	short loc_129CD
		inc	[bp+var_8]

loc_129CD:
		mov	ax, [bp+var_8]
		add	word ptr _score_delta, ax
		mov	ax, [bp+var_8]
		pop	di
		pop	si
		leave
		retn	8
sub_1283C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_129DD	proc far
		push	bp
		mov	bp, sp
		push	si
		mov	si, 5F6Ch
		xor	ax, ax
		jmp	short loc_129EF
; ---------------------------------------------------------------------------

loc_129E8:
		mov	byte ptr [si], 0
		inc	ax
		add	si, 0Ch

loc_129EF:
		cmp	ax, 0Ch
		jl	short loc_129E8
		mov	byte_23A70, 10h
		pop	si
		pop	bp
		retf
sub_129DD	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_129FC	proc far
		push	bp
		mov	bp, sp
		setfarfp	farfp_23A72, sub_12A7D
		setfarfp	farfp_23A76, sub_12B9E
		pop	bp
		retf
sub_129FC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_12A19	proc near

arg_0		= byte ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8
arg_6		= word ptr  0Ah

		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	si, 5F6Ch
		cmp	[bp+arg_6], 20h	; ' '
		jl	short loc_12A77
		cmp	[bp+arg_6], 1A0h
		jge	short loc_12A77
		xor	di, di
		jmp	short loc_12A72
; ---------------------------------------------------------------------------

loc_12A32:
		cmp	byte ptr [si], 0
		jnz	short loc_12A6E
		mov	byte ptr [si], 1
		mov	byte ptr [si+1], 1
		mov	ax, [bp+arg_6]
		mov	[si+2],	ax
		mov	ax, [bp+arg_4]
		mov	[si+4],	ax
		mov	al, byte_23A70
		mov	ah, 0
		mov	[si+6],	ax
		mov	ax, [bp+arg_2]
		mov	[si+8],	ax
		mov	byte ptr [si+0Ah], 0
		mov	al, [bp+arg_0]
		mov	[si+0Bh], al
		call	_snd_se_play c, 6
		jmp	short loc_12A77
; ---------------------------------------------------------------------------

loc_12A6E:
		inc	di
		add	si, 0Ch

loc_12A72:
		cmp	di, 0Ch
		jl	short loc_12A32

loc_12A77:
		pop	di
		pop	si
		pop	bp
		retn	8
sub_12A19	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_12A7D	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	si, 5F6Ch
		xor	di, di
		jmp	short loc_12AD9
; ---------------------------------------------------------------------------

loc_12A89:
		cmp	byte ptr [si], 0
		jz	short loc_12AD5
		cmp	byte ptr [si+0Ah], 4
		ja	short loc_12AB9
		mov	ax, [si+2]
		add	ax, -8
		push	ax	; left
		mov	ax, [si+4]
		add	ax, -8
		push	ax	; top
		push	(32 shl 16) or 32	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		test	byte ptr _stage_frame, 3
		jnz	short loc_12ACD
		inc	byte ptr [si+0Ah]
		jmp	short loc_12ACD
; ---------------------------------------------------------------------------

loc_12AB9:
		push	word ptr [si+2]	; left
		push	word ptr [si+4]	; top
		push	16	; w
		mov	ax, RES_Y
		sub	ax, [si+4]
		push	ax	; h
		call	@tiles_invalidate_rect$qiiii

loc_12ACD:
		cmp	byte ptr [si], 2
		jnz	short loc_12AD5
		mov	byte ptr [si], 0

loc_12AD5:
		inc	di
		add	si, 0Ch

loc_12AD9:
		cmp	di, 0Ch
		jl	short loc_12A89
		pop	di
		pop	si
		pop	bp
		retf
sub_12A7D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_12AE2	proc near

@@patnum		= word ptr -4
@@y		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	di, [bp+arg_0]
		mov	si, _scroll_line
		mov	ax, point_23A6C.y
		mov	[bp+@@y], ax
		add	si, point_23A6C.y
		cmp	si, RES_Y
		jl	short loc_12B05
		sub	si, RES_Y

loc_12B05:
		cmp	byte ptr [di+1], 5
		jnb	short loc_12B1E
		push	point_23A6C.x
		push	si
		mov	al, [di+1]
		mov	ah, 0
		add	ax, 91
		push	ax
		call	super_roll_put_tiny

loc_12B1E:
		add	si, 8
		cmp	si, RES_Y
		jl	short loc_12B2B
		sub	si, RES_Y

loc_12B2B:
		add	[bp+@@y], 8
		mov	al, [di+0Bh]
		mov	ah, 0
		mov	dl, [di+1]
		mov	dh, 0
		add	ax, dx
		mov	[bp+@@patnum], ax
		jmp	short loc_12B5E
; ---------------------------------------------------------------------------

loc_12B40:
		call	super_roll_put_tiny pascal, point_23A6C.x, si, [bp+@@patnum]
		add	si, 16
		cmp	si, RES_Y
		jl	short loc_12B5A
		sub	si, RES_Y

loc_12B5A:
		add	[bp+@@y], 16

loc_12B5E:
		cmp	[bp+@@y], 384
		jl	short loc_12B40
		cmp	byte ptr [di+1], 4
		jnz	short loc_12B98
		mov	ax, point_23A6C.x
		add	ax, -24
		cmp	ax, _player_topleft.x
		jge	short loc_12B98
		mov	ax, point_23A6C.x
		add	ax, 8
		cmp	ax, _player_topleft.x
		jle	short loc_12B98
		mov	ax, _player_topleft.y
		cmp	ax, point_23A6C.y
		jl	short loc_12B98
		cmp	_player_is_hit, 0
		jnz	short loc_12B98
		mov	_player_is_hit, 1

loc_12B98:
		pop	di
		pop	si
		leave
		retn	2
sub_12AE2	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_12B9E	proc far

@@patnum		= word ptr -6
var_4		= word ptr -4
@@x		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		mov	si, 5F6Ch
		mov	[bp+var_4], 0
		jmp	loc_12C66
; ---------------------------------------------------------------------------

loc_12BB1:
		cmp	byte ptr [si], 1
		jnz	loc_12C60
		mov	ax, [si+2]
		mov	point_23A6C.x, ax
		mov	ax, [si+4]
		mov	point_23A6C.y, ax
		cmp	byte ptr [si+0Ah], 4
		jnb	short loc_12C00
		add	ax, 0FFF8h
		mov	di, ax
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_12BDD
		sub	di, RES_Y

loc_12BDD:
		mov	ax, point_23A6C.x
		add	ax, -8
		mov	[bp+@@x], ax
		mov	al, [si+0Ah]
		mov	ah, 0
		add	ax, 30
		mov	[bp+@@patnum], ax
		call	super_roll_put pascal, [bp+@@x], di, ax
		dec	word ptr [si+6]
		jmp	short loc_12C60
; ---------------------------------------------------------------------------

loc_12C00:
		cmp	byte ptr [si+1], 1
		jnz	short loc_12C11
		dec	word ptr [si+6]
		cmp	word ptr [si+6], 0
		jg	short loc_12C5C
		jmp	short loc_12C42
; ---------------------------------------------------------------------------

loc_12C11:
		cmp	byte ptr [si+1], 4
		jnb	short loc_12C33
		test	byte ptr _stage_frame, 7
		jnz	short loc_12C21
		inc	byte ptr [si+1]

loc_12C21:
		cmp	byte ptr [si+1], 4
		jnz	short loc_12C5C
		call	_snd_se_play c, 7
		jmp	short loc_12C5C
; ---------------------------------------------------------------------------

loc_12C33:
		cmp	byte ptr [si+1], 4
		jnz	short loc_12C47
		dec	word ptr [si+8]
		cmp	word ptr [si+8], 0
		jnz	short loc_12C5C

loc_12C42:
		inc	byte ptr [si+1]
		jmp	short loc_12C5C
; ---------------------------------------------------------------------------

loc_12C47:
		test	byte ptr _stage_frame, 3
		jnz	short loc_12C51
		inc	byte ptr [si+1]

loc_12C51:
		cmp	byte ptr [si+1], 9
		jnz	short loc_12C5C
		mov	byte ptr [si], 2
		jmp	short loc_12C60
; ---------------------------------------------------------------------------

loc_12C5C:
		push	si
		call	sub_12AE2

loc_12C60:
		inc	[bp+var_4]
		add	si, 0Ch

loc_12C66:
		cmp	[bp+var_4], 0Ch
		jl	loc_12BB1
		pop	di
		pop	si
		leave
		retf
sub_12B9E	endp

DS_PREBOSS = 0
DS_POSTBOSS = 1

	extern @dialog_load_and_init$qv:proc
	@dialog_pre$qv procdesc near
	@dialog_post$qv procdesc near
	@DIALOG_SCRIPT_GENERIC_PART_ANIMA$Q17DIALOG_SEQUENCE_T procdesc pascal near \
		sequence:word
	@dialog_script_stage2_pre_intro_a$qv procdesc near
	@dialog_script_stage4_pre_intro_a$qv procdesc near
	@dialog_script_stage4_pre_marisa_$qv procdesc near
	@dialog_script_stage4_post_animat$qv procdesc near
	@dialog_script_stage5_pre_intro_a$qv procdesc near
	@dialog_script_stage5_pre_unseale$qv procdesc near
	@dialog_script_stage5_pre_winged_$qv procdesc near
	@dialog_script_stage5_form1defeat$qv procdesc near
	@dialog_script_stage5_post_animat$qv procdesc near
	@dialog_script_extra_pre_intro_an$qv procdesc near
DIALOG_TEXT	ends

BOSS_5_TEXT	segment	byte public 'CODE' use16

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_134B6	proc near

var_4		= dword	ptr -4
arg_0		= word ptr  4
arg_2		= word ptr  6

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	di, [bp+arg_2]
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], 7416h
		xor	si, si
		jmp	short loc_13508
; ---------------------------------------------------------------------------

loc_134CD:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 0
		jnz	short loc_13503
		les	bx, [bp+var_4]
		mov	byte ptr es:[bx], 1
		mov	es:[bx+2], di
		mov	ax, [bp+arg_0]
		mov	es:[bx+6], ax
		mov	es:[bx+4], di
		mov	es:[bx+8], ax
		call	@randring2_next8_and$quc pascal, 3
		mov	ah, 0
		add	ax, 3
		les	bx, [bp+var_4]
		mov	es:[bx+0Ah], ax
		jmp	short loc_1350D
; ---------------------------------------------------------------------------

loc_13503:
		inc	si
		add	word ptr [bp+var_4], 0Ch

loc_13508:
		cmp	si, 32h	; '2'
		jl	short loc_134CD

loc_1350D:
		pop	di
		pop	si
		leave
		retn	4
sub_134B6	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_13513	proc far

var_4		= dword	ptr -4

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], 7416h
		xor	si, si
		jmp	loc_135B1
; ---------------------------------------------------------------------------

loc_13527:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 0
		jz	short loc_135AC
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		les	bx, [bp+var_4]
		add	bx, ax
		push	word ptr es:[bx+2]	; left
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, word ptr [bp+var_4]
		add	bx, ax
		push	word ptr es:[bx+6]	; top
		push	(2 shl 16) or 3	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 2
		jnz	short loc_1356A
		mov	byte ptr es:[bx], 0
		jmp	short loc_135AC
; ---------------------------------------------------------------------------

loc_1356A:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		les	bx, [bp+var_4]
		add	bx, ax
		mov	ax, es:[bx+2]
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		mov	bx, word ptr [bp+var_4]
		add	bx, dx
		mov	es:[bx+2], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, word ptr [bp+var_4]
		add	bx, ax
		mov	ax, es:[bx+6]
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		mov	bx, word ptr [bp+var_4]
		add	bx, dx
		mov	es:[bx+6], ax

loc_135AC:
		inc	si
		add	word ptr [bp+var_4], 0Ch

loc_135B1:
		cmp	si, 32h	; '2'
		jl	loc_13527
		pop	si
		leave
		retf
sub_13513	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_135BB	proc near

var_6		= dword	ptr -6
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		mov	word ptr [bp+var_6+2], ds
		mov	word ptr [bp+var_6], 7416h
		mov	[bp+var_2], 0
		jmp	loc_13660
; ---------------------------------------------------------------------------

loc_135D3:
		les	bx, [bp+var_6]
		cmp	byte ptr es:[bx], 1
		jnz	short loc_13659
		les	bx, [bp+var_6]
		mov	ax, es:[bx+0Ah]
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		add	bx, dx
		sub	es:[bx+2], ax
		mov	bx, word ptr [bp+var_6]
		mov	dl, _page_back
		mov	dh, 0
		add	dx, dx
		add	bx, dx
		add	es:[bx+6], ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, word ptr [bp+var_6]
		add	bx, ax
		mov	di, es:[bx+2]
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, word ptr [bp+var_6]
		add	bx, ax
		mov	si, es:[bx+6]
		cmp	di, 20h	; ' '
		jge	short loc_13630
		mov	bx, word ptr [bp+var_6]
		mov	byte ptr es:[bx], 2
		jmp	short loc_13659
; ---------------------------------------------------------------------------

loc_13630:
		cmp	si, 180h
		jge	short loc_13659
		cmp	di, 1A0h
		jge	short loc_13659
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1364A
		sub	si, RES_Y

loc_1364A:
		mov	word_20164, di
		mov	word_20166, si
		push	2
		call	sub_3E6A

loc_13659:
		inc	[bp+var_2]
		add	word ptr [bp+var_6], 0Ch

loc_13660:
		cmp	[bp+var_2], 32h	; '2'
		jl	loc_135D3
		call	grcg_off
		pop	di
		pop	si
		leave
		retn
sub_135BB	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_13671	proc far

var_4		= byte ptr -4
var_3		= byte ptr -3
var_2		= byte ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		cmp	word_1ED94, 3E7h
		jge	loc_13739
		cmp	word_1ED94, 0
		jz	loc_13739
		inc	word_1ED94
		mov	ax, word_1ED94
		mov	bx, 10h
		cwd
		idiv	bx
		add	al, 144
		mov	[bp+var_3], al
		mov	ax, word_1ED94
		mov	bx, 8
		cwd
		idiv	bx
		add	al, 144
		mov	[bp+var_2], al
		mov	Palettes[8 * size rgb_t].r, 176
		mov	al, [bp+var_3]
		mov	Palettes[8 * size rgb_t].g, al
		mov	al, [bp+var_2]
		mov	Palettes[8 * size rgb_t].b, al
		mov	ax, word_1ED94
		mov	bx, 10h
		cwd
		idiv	bx
		mov	dl, 160
		sub	dl, al
		mov	[bp+var_4], dl
		mov	ax, word_1ED94
		cwd
		idiv	bx
		mov	dl, 160
		sub	dl, al
		mov	[bp+var_3], dl
		mov	ax, word_1ED94
		mov	bx, 4
		cwd
		idiv	bx
		mov	dl, 255
		sub	dl, al
		mov	[bp+var_2], dl
		mov	al, [bp+var_4]
		mov	Palettes[13 * size rgb_t].r, al
		mov	al, [bp+var_3]
		mov	Palettes[13 * size rgb_t].g, al
		mov	al, [bp+var_2]
		mov	Palettes[13 * size rgb_t].b, al
		cmp	[bp+var_4], 80h
		ja	short loc_13732
		mov	word_1ED94, 3E8h
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		mov	Palettes[14 * size rgb_t].r, 224
		mov	Palettes[14 * size rgb_t].g, 192
		mov	Palettes[14 * size rgb_t].b, 176
		mov	_spark_accel_x, -1
		mov	word_1EDA4, 1

loc_13732:
		call	far ptr	palette_show
		leave
		retf
; ---------------------------------------------------------------------------

loc_13739:
		cmp	word_1ED94, 3E8h
		jl	short locret_13784
		call	sub_1403E
		inc	word_1ED94
		mov	al, _reduce_effects
		mov	ah, 0
		add	ax, ax
		add	ax, 3EAh
		cmp	ax, word_1ED94
		jge	short loc_13771
		call	@randring2_next16$qv
		mov	bx, 640
		xor	dx, dx
		div	bx
		add	dx, 30h	; '0'
		push	dx
		push	10h
		call	sub_134B6
		mov	word_1ED94, 3E8h

loc_13771:
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 8
		call	sub_135BB

locret_13784:
		leave
		retf
sub_13671	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss1_invalidate$qv
@midboss1_invalidate$qv	proc far
		push	bp
		mov	bp, sp
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		cmp	byte_2066A, 0
		jz	short loc_137BE
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, -16
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]	; top
		push	96	; w
		jmp	short loc_137CC
; ---------------------------------------------------------------------------

loc_137BE:
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]	; left
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]	; top
		push	64	; w

loc_137CC:
		push	96	; h
		call	@tiles_invalidate_rect$qiiii
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		mov	ax, word_24E82
		pop	bp
		retf
@midboss1_invalidate$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss1_137FE	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	di, 0Ah
		mov	ax, word_1ED96
		sar	ax, 3
		add	di, ax
		inc	word_1ED96
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 48
		push	ax
		push	3C0001h
		push	0
		call	sub_4090
		cmp	word_1ED96, 40h
		jl	short loc_1387B
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 48
		push	ax
		push	800030h
		push	1
		call	sub_4090
		mov	word_1ED96, 0
		mov	_boss_phase_frame, 0
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh
		mov	word_24E82, 0
		jmp	short loc_138AF
; ---------------------------------------------------------------------------

loc_1387B:
		test	byte ptr word_1ED96, 3
		jnz	short loc_13888
		mov	bx, _boss_top_on_back_page
		inc	word ptr [bx]

loc_13888:
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1389C
		sub	si, RES_Y

loc_1389C:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, -16
		call	super_zoom pascal, ax, si, di, 3

loc_138AF:
		pop	di
		pop	si
		pop	bp
		retn
midboss1_137FE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss1_138B3	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 88
		mov	si, ax
		test	byte ptr _boss_phase_frame, 7Fh
		jz	short loc_138F2
		mov	ax, _boss_phase_frame
		and	ax, 7Fh
		cmp	ax, 48
		jnz	short loc_138E7
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 28
		push	ax	; left
		push	si	; top
		push	00h	; angle
		push	BG_3_SPREAD_MEDIUM_AIMED	; group
		push	((1 shl 4) + 14)	; speed
		jmp	short loc_13903
; ---------------------------------------------------------------------------

loc_138E7:
		mov	ax, _boss_phase_frame
		and	ax, 7Fh
		cmp	ax, 96
		jnz	short loc_13906

loc_138F2:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 28
		push	ax	; left
		push	si	; top
		push	00h	; angle
		push	BG_4_SPREAD_WIDE_AIMED	; group
		push	((3 shl 4) + 2)	; speed

loc_13903:
		call	@bullets_add_pellet$qiiucuci

loc_13906:
		pop	si
		pop	bp
		retn
midboss1_138B3	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss1_update_and_render$qv
@midboss1_update_and_render$qv	proc far

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	word_205D8, 0D8h
		mov	word_205DA, 40h
		inc	_boss_phase_frame
		cmp	_boss_phase_frame, 1
		jnz	short loc_1395A
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_left_on_page[1 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_top_on_page[1 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_damage, 0
		mov	word_24E84, 94h
		mov	word_24E82, 1
		mov	word_1ED94, 1
		jmp	loc_13AB8
; ---------------------------------------------------------------------------

loc_1395A:
		cmp	_boss_phase_frame, 18
		jge	short loc_13988
		mov	bx, _boss_top_on_back_page
		add	word ptr [bx], 2
		mov	si, [bx]
		add	si, _scroll_line
		or	si, si
		jge	short loc_13979
		add	si, RES_Y
		jmp	loc_13AA8
; ---------------------------------------------------------------------------

loc_13979:
		cmp	si, RES_Y
		jl	loc_13AA8
		sub	si, RES_Y
		jmp	loc_13AA8
; ---------------------------------------------------------------------------

loc_13988:
		test	byte ptr _scroll_line, 1
		jz	short loc_13997
		mov	word_24E84, 95h
		jmp	short loc_1399D
; ---------------------------------------------------------------------------

loc_13997:
		mov	word_24E84, 94h

loc_1399D:
		cmp	byte_2066A, 0
		jz	short loc_139AA
		call	midboss1_137FE
		jmp	loc_13AB8
; ---------------------------------------------------------------------------

loc_139AA:
		call	midboss1_138B3
		test	byte ptr _scroll_line, 0Fh
		jnz	short loc_13A09
		mov	si, 48
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_139C5
		sub	si, RES_Y

loc_139C5:
		mov	bx, _boss_left_on_back_page
		call	@tile_ring_set_and_put_both_8$qiii pascal, word ptr [bx], si, 60
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 16
		call	@tile_ring_set_and_put_both_8$qiii pascal, ax, si, 61
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 32
		call	@tile_ring_set_and_put_both_8$qiii pascal, ax, si, 62
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 48
		call	@tile_ring_set_and_put_both_8$qiii pascal, ax, si, 63

loc_13A09:
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_13A1D
		sub	si, RES_Y

loc_13A1D:
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]
		push	400060h
		call	sub_1283C
		mov	[bp+var_2], ax
		or	ax, ax
		jz	short loc_13A85
		add	_boss_damage, ax
		cmp	_boss_damage, 300
		jle	short loc_13A4B
		cmp	si, 130h
		jl	short loc_13A6B

loc_13A4B:
		call	_snd_se_play c, 4
		mov	bx, _boss_left_on_back_page
		call	super_roll_put_1plane pascal, word ptr [bx], si, (148 shl 16) or 0, PLANE_PUT or GC_BRGI
		jmp	short loc_13AB8
; ---------------------------------------------------------------------------

loc_13A6B:
		call	_snd_se_play c, 2
		mov	byte_2066A, 1
		add	_score_delta, 10000
		jmp	short loc_13AB8
; ---------------------------------------------------------------------------

loc_13A85:
		cmp	word_2034A, 0B8h
		jl	short loc_13AA8
		mov	bx, _boss_top_on_back_page
		cmp	word ptr [bx], 304
		jg	short loc_13AA8
		call	_snd_se_play c, 2
		mov	byte_2066A, 1
		jmp	short loc_13AB8
; ---------------------------------------------------------------------------

loc_13AA8:
		mov	bx, _boss_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, word_24E84

loc_13AB8:
		pop	si
		leave
		retf
@midboss1_update_and_render$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_13ABB	proc far

arg_0		= dword	ptr  6

		push	bp
		mov	bp, sp
		kajacall	KAJA_SONG_STOP
		call	_snd_load stdcall, [bp+arg_0], SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY
		add	sp, 0Ah
		pop	bp
		retf
sub_13ABB	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_init	proc far
		push	bp
		mov	bp, sp
		push	ds
		push	offset aBoss1_m	; "boss1.m"
		call	sub_13ABB
		add	sp, 4
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_PREBOSS
		call	@dialog_post$qv
		mov	angle_1E510, 20h
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_left_on_page[1 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_damage, 0
		mov	byte_2066A, 0
		mov	patnum_2064E, 150
		mov	_stage_frame, 0
		mov	word_24E80, 0
		nopcall	sub_129FC
		mov	patnum_2064E, 150
		mov	point_24E7C.y, 48
		mov	ax, _scroll_line
		add	point_24E7C.y, ax
		cmp	point_24E7C.y, RES_Y
		jl	short loc_13B4E
		sub	point_24E7C.y, RES_Y

loc_13B4E:
		cmp	_rank, RANK_EASY
		jz	short loc_13B70
		mov	byte_2066E, 0Bh
		mov	byte_2066F, 15h
		mov	group_20670, BG_1
		mov	byte_20671, 2
		mov	byte_20672, 3
		pop	bp
		retf
; ---------------------------------------------------------------------------

loc_13B70:
		mov	byte_2066E, 19h
		mov	byte_2066F, 15h
		mov	group_20670, BG_1
		mov	byte_20671, 20h
		mov	byte_20672, 7
		pop	bp
		retf
rika_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_end	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_POSTBOSS
		call	@stage_clear_bonus_animate$qv
		call	@key_delay$qv
		call	@overlay_stage_leave_animate$qv
		inc	_stage_id
		mov	_spark_accel_x, 0
		mov	word_1EDA4, 0
		pop	bp
		retf
rika_end	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_bg_render	proc far
		push	bp
		mov	bp, sp
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	bx, _boss_left_on_back_page
		call	@tiles_invalidate_rect$qiiii pascal, word ptr [bx], (48 shl 16) or 64, 96
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		cmp	word_24E80, 0
		jnz	short loc_13C0A
		cmp	_boss_phase_frame, 3
		jge	short loc_13C0A
		call	@tiles_invalidate_rect$qiiii pascal, (208 shl 16) or 16, (32 shl 16) or 32

loc_13C0A:
		pop	bp
		retf
rika_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_13C0C	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	ax, point_24E7C.x
		add	ax, 32
		push	ax
		push	800032h
		push	20000h
		call	sub_4090
		mov	si, 0Ah
		mov	ax, word_1ED98
		add	ax, 0FFE0h
		mov	bx, 8
		cwd
		idiv	bx
		add	si, ax
		inc	word_1ED98
		cmp	word_1ED98, 50h	; 'P'
		jl	short loc_13C4F
		mov	word_1ED98, 0
		mov	ax, 1
		jmp	short loc_13C8E
; ---------------------------------------------------------------------------

loc_13C4F:
		cmp	_boss_phase_frame, 32
		jge	short loc_13C69
		call	super_roll_put pascal, point_24E7C.x, point_24E7C.y, patnum_2064E
		jmp	short loc_13C7C
; ---------------------------------------------------------------------------

loc_13C69:
		push	point_24E7C.x
		mov	ax, point_24E7C.y
		add	ax, 16
		push	ax
		push	si
		push	2
		call	super_zoom

loc_13C7C:
		mov	ax, point_24E7C.x
		add	ax, 24
		push	ax
		push	70h ; 'p'
		push	word_1ED98
		call	sub_FFF8
		xor	ax, ax

loc_13C8E:
		pop	si
		pop	bp
		retn
rika_13C0C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_13C91	proc near

@@group		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	ax, point_24E7C.x
		add	ax, 28
		mov	si, ax
		cmp	_boss_damage, 700
		jge	short loc_13CE0
		mov	word_24E80, 0
		test	byte ptr _boss_phase_frame, 3Fh
		jnz	loc_13ECA
		call	_snd_se_play c, 3
		call	@bullets_add_pellet$qiiucuci pascal, si, (PLAYFIELD_TOP + 96), 00h, word ptr byte_2066E, ((3 shl 4) + 2)
		call	@bullets_add_pellet$qiiucuci pascal, si, (PLAYFIELD_TOP + 96), 40h, word ptr byte_2066F, ((1 shl 4) + 14)
		jmp	loc_13ECA
; ---------------------------------------------------------------------------

loc_13CE0:
		cmp	_boss_damage, 1400
		jge	short loc_13D63
		test	byte ptr _stage_frame, 1Fh
		jnz	loc_13ECA
		mov	al, angle_250DE
		add	al, 18h
		mov	angle_250DE, al
		mov	ah, 0
		mov	bx, 80h
		cwd
		idiv	bx
		mov	angle_250DE, dl
		mov	ax, point_24E7C.x
		add	ax, 8
		mov	si, ax
		call	_snd_se_play c, 3
		call	@bullets_add_pellet$qiiucuci pascal, si, (PLAYFIELD_TOP + 96), word ptr angle_250DE, word ptr group_20670, ((3 shl 4) + 6)
		call	@bullets_add_pellet$qiiucuci pascal, si, (PLAYFIELD_TOP + 96), word ptr angle_250DE, word ptr byte_20671, ((2 shl 4) + 12)
		add	si, 2Ch	; ','
		push	si	; left
		push	(PLAYFIELD_TOP + 96)	; top
		mov	al, 80h
		sub	al, angle_250DE
		push	ax	; angle
		push	word ptr group_20670	; group
		push	((3 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci
		push	si	; left
		push	(PLAYFIELD_TOP + 96)	; top
		mov	al, 80h
		sub	al, angle_250DE
		push	ax	; angle
		push	word ptr byte_20671	; group
		push	((2 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	loc_13ECA
; ---------------------------------------------------------------------------

loc_13D63:
		cmp	word_24E80, 0
		jnz	short loc_13D7B
		mov	word_24E80, 1
		mov	word_250E0, 0
		mov	angle_250DE, 0

loc_13D7B:
		inc	word_250E0
		cmp	word_250E0, 64h	; 'd'
		jnb	short loc_13DB5
		mov	ax, word_250E0
		and	ax, 7
		cmp	ax, 4
		jnb	short loc_13D99
		mov	patnum_2064E, 150
		jmp	short loc_13D9F
; ---------------------------------------------------------------------------

loc_13D99:
		mov	patnum_2064E, 151

loc_13D9F:
		test	byte ptr word_250E0, 1Fh
		jnz	loc_13ECA
		call	_snd_se_play c, 9
		jmp	loc_13ECA
; ---------------------------------------------------------------------------

loc_13DB5:
		cmp	word_250E0, 64h	; 'd'
		jnz	short loc_13DF9
		test	byte ptr word_250E0, 1Fh
		jnz	short loc_13DCD
		call	_snd_se_play c, 9

loc_13DCD:
		mov	byte_23A70, 40h
		mov	ax, point_24E7C.x
		add	ax, 2
		push	ax
		push	7000A0h
		push	6Fh ; 'o'
		call	sub_12A19
		mov	ax, point_24E7C.x
		add	ax, 46
		push	ax
		push	7000A0h
		push	6Fh ; 'o'
		call	sub_12A19
		jmp	loc_13ECA
; ---------------------------------------------------------------------------

loc_13DF9:
		cmp	word_250E0, 0A4h
		jbe	loc_13EA7
		cmp	word_250E0, 118h
		jnb	loc_13EA7
		cmp	word_250E0, 0FAh
		jnb	short loc_13E30
		mov	ax, word_250E0
		and	ax, 7
		cmp	ax, 4
		jnb	short loc_13E28
		mov	patnum_2064E, 150
		jmp	short loc_13E4E
; ---------------------------------------------------------------------------

loc_13E28:
		mov	patnum_2064E, 151
		jmp	short loc_13E4E
; ---------------------------------------------------------------------------

loc_13E30:
		cmp	word_250E0, 104h
		jnz	short loc_13E40
		mov	patnum_2064E, 152
		jmp	short loc_13E4E
; ---------------------------------------------------------------------------

loc_13E40:
		cmp	word_250E0, 10Eh
		jnz	short loc_13E4E
		mov	patnum_2064E, 153

loc_13E4E:
		test	byte ptr word_250E0, 0Fh
		jnz	short loc_13E5F
		call	_snd_se_play c, 6

loc_13E5F:
		test	byte ptr word_250E0, 0Fh
		jnz	short loc_13ECA
		test	byte ptr word_250E0, 3Fh
		jz	short loc_13E83
		mov	ax, word_250E0
		and	ax, 3Fh
		cmp	ax, 10h
		jz	short loc_13E94
		mov	ax, word_250E0
		and	ax, 3Fh
		cmp	ax, 20h	; ' '
		jnz	short loc_13E89

loc_13E83:
		mov	[bp+@@group], BG_4_SPREAD_WIDE
		jmp	short loc_13E98
; ---------------------------------------------------------------------------

loc_13E89:
		mov	ax, word_250E0
		and	ax, 3Fh
		cmp	ax, 30h	; '0'
		jnz	short loc_13E98

loc_13E94:
		mov	[bp+@@group], BG_4_SPREAD_MEDIUM

loc_13E98:
		call	@bullets_add_pellet$qiiucuci pascal, si, (PLAYFIELD_TOP + 96), 40h, word ptr [bp+@@group], ((3 shl 4) + 10)
		jmp	short loc_13ECA
; ---------------------------------------------------------------------------

loc_13EA7:
		cmp	word_250E0, 118h
		jb	short loc_13ECA
		mov	al, byte_20672
		mov	ah, 0
		test	word_250E0, ax
		jnz	short loc_13ECA
		push	si	; left
		push	(PLAYFIELD_TOP + 56)	; top
		push	01h	; angle
		push	BG_RANDOM_ANGLE_AND_SPEED	; group
		push	(PAT_BULLET16_OUTLINED_BALL_BEIGE shl 16) or ((2 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti

loc_13ECA:
		pop	si
		leave
		retn
rika_13C91	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_13ECD	proc far

@@damage		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	point_24E7C.x
		push	300040h
		push	60h
		call	sub_1283C
		mov	[bp+@@damage], ax
		or	ax, ax
		jz	short loc_13F30
		add	_boss_damage, ax
		cmp	_boss_damage, 2260
		jg	short loc_13F18
		call	_snd_se_play c, 4
		call	super_roll_put_1plane pascal, point_24E7C.x, point_24E7C.y, patnum_2064E, large PLANE_PUT or GC_BRGI
		jmp	short loc_13F2B
; ---------------------------------------------------------------------------

loc_13F18:
		mov	byte_2066A, 1
		add	_score_delta, 20000
		mov	_player_invincibility_time, BOSS_DEFEAT_INVINCIBILITY_FRAMES

loc_13F2B:
		mov	ax, 1
		leave
		retf
; ---------------------------------------------------------------------------

loc_13F30:
		xor	ax, ax
		leave
		retf
rika_13ECD	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_13F34	proc far

@@angle	= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	word_24E80, 0
		jnz	short loc_13FA5
		cmp	_boss_phase_frame, 16
		jge	short loc_13F80
		test	byte ptr _boss_phase_frame, 3
		jnz	locret_13FE3
		mov	al, _rank
		cbw
		cmp	ax, RANK_HARD
		jl	short loc_13F62
		mov	al, byte ptr _boss_phase_frame
		mov	[bp+@@angle], al
		jmp	short loc_13F66
; ---------------------------------------------------------------------------

loc_13F62:
		mov	[bp+@@angle], 0

loc_13F66:
		push	(228 shl 16) or 112 ; (left shl 16) or top
		push	word ptr [bp+@@angle]	; angle
		push	BG_16_RING	; group
		mov	ax, _boss_phase_frame
		shl	ax, 2
		add	ax, ((2 shl 4) + 8)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		leave
		retf
; ---------------------------------------------------------------------------

loc_13F80:
		cmp	_boss_phase_frame, 116
		jl	short loc_13FC6
		cmp	_boss_phase_frame, 316
		jl	short loc_13FB6
		cmp	_boss_phase_frame, 416
		jl	short loc_13F9D
		mov	_boss_phase_frame, 16 ; Skip the initial 16-ring subpattern

loc_13F9D:
		mov	bx, _boss_left_on_back_page
		dec	word ptr [bx]
		leave
		retf
; ---------------------------------------------------------------------------

loc_13FA5:
		cmp	word_24E80, 1
		jnz	short loc_13FD6
		mov	bx, _boss_left_on_back_page
		cmp	word ptr [bx], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		jge	short loc_13FBE

loc_13FB6:
		mov	bx, _boss_left_on_back_page
		inc	word ptr [bx]
		leave
		retf
; ---------------------------------------------------------------------------

loc_13FBE:
		cmp	_boss_phase_frame, 192
		jle	short loc_13FCE

loc_13FC6:
		mov	bx, _boss_left_on_back_page
		dec	word ptr [bx]
		leave
		retf
; ---------------------------------------------------------------------------

loc_13FCE:
		mov	word_24E80, 2
		leave
		retf
; ---------------------------------------------------------------------------

loc_13FD6:
		cmp	word_24E80, 2
		jnz	short locret_13FE3
		mov	_boss_phase_frame, 0

locret_13FE3:
		leave
		retf
rika_13F34	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

rika_update	proc far
		push	bp
		mov	bp, sp
		mov	ax, point_24E7C.x
		add	ax, 24
		mov	word_205D8, ax
		mov	word_205DA, 30h	; '0'
		inc	_boss_phase_frame
		cmp	byte_2066A, 0
		jnz	short loc_1402D
		call	rika_13F34
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_24E7C.x, ax
		call	rika_13ECD
		or	ax, ax
		jnz	short loc_14028
		call	super_roll_put pascal, point_24E7C.x, point_24E7C.y, patnum_2064E

loc_14028:
		call	rika_13C91
		jmp	short loc_14039
; ---------------------------------------------------------------------------

loc_1402D:
		call	rika_13C0C
		or	ax, ax
		jz	short loc_14039
		mov	ax, 2
		pop	bp
		retf
; ---------------------------------------------------------------------------

loc_14039:
		mov	ax, 1
		pop	bp
		retf
rika_update	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1403E	proc near
		push	bp
		mov	bp, sp
		cmp	word_1EDA4, 0
		jz	short loc_140AC
		cmp	word_1EDA4, 1
		jnz	short loc_14055
		mov	word_250E4, 64h	; 'd'

loc_14055:
		inc	word_1EDA4
		mov	ax, word_1EDA4
		cmp	ax, word_250E4
		jb	short loc_140AC
		mov	ax, word_250E4
		add	ax, 8
		cmp	ax, word_1EDA4
		jbe	short loc_140AC
		test	byte ptr word_1EDA4, 1
		jz	short loc_1407D
		mov	PaletteTone, 140
		jmp	short loc_14083
; ---------------------------------------------------------------------------

loc_1407D:
		mov	PaletteTone, 100

loc_14083:
		call	far ptr	palette_show
		mov	ax, word_250E4
		add	ax, 7
		cmp	ax, word_1EDA4
		jnz	short loc_140AC
		mov	PaletteTone, 100
		call	far ptr	palette_show
		call	@randring2_next16$qv
		and	ax, 3FFh
		add	ax, 14h
		add	word_250E4, ax

loc_140AC:
		pop	bp
		retn
sub_1403E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_140AE	proc far
		push	bp
		mov	bp, sp
		cmp	byte_1EDA6, 0
		jz	short loc_140D4
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		mov	byte_1EDA6, 0
		mov	_spark_accel_x, -1

loc_140D4:
		inc	word_1EDA2
		test	byte ptr word_1EDA2, 1
		jnz	short loc_140F2
		call	@randring2_next16$qv
		mov	bx, 640
		xor	dx, dx
		div	bx
		add	dx, 30h	; '0'
		push	dx
		push	10h
		call	sub_134B6

loc_140F2:
		call	sub_1403E
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 3
		call	sub_135BB
		pop	bp
		retf
sub_140AE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss2_invalidate$qv
@midboss2_invalidate$qv	proc far
		push	bp
		mov	bp, sp
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]	; left
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]	; top
		push	(64 shl 16) or 64	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		mov	ax, word_250E2
		pop	bp
		retf
@midboss2_invalidate$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss2_14169	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		cmp	word_1EDA8, 30h	; '0'
		jge	short loc_141A1
		mov	ax, word_1EDA8
		and	ax, 0Fh
		cmp	ax, 5
		jnz	short loc_141A1
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		push	800018h
		push	1
		call	sub_4090

loc_141A1:
		mov	di, 0Ah
		mov	ax, word_1EDA8
		sar	ax, 3
		add	di, ax
		inc	word_1EDA8
		cmp	word_1EDA8, 40h
		jl	short loc_141DC
		mov	word_1EDA8, 0
		mov	_boss_phase_frame, 0
		mov	byte_2066A, 0
		mov	word_250E2, 0
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh
		jmp	short loc_141FF
; ---------------------------------------------------------------------------

loc_141DC:
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_141F0
		sub	si, RES_Y

loc_141F0:
		mov	bx, _boss_left_on_back_page
		call	super_zoom pascal, word ptr [bx], si, di, 2

loc_141FF:
		pop	di
		pop	si
		pop	bp
		retn
midboss2_14169	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss2_14203	proc near
		push	bp
		mov	bp, sp
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_14248
		mov	ax, _boss_phase_frame
		mov	bx, 192
		cwd
		idiv	bx
		cmp	dx, 64
		jge	short loc_14248
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 28
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax	; top
		mov	al, byte ptr _boss_phase_frame
		shl	al, 2
		push	ax	; angle
		push	BSM_CHASE	; group
		push	(PAT_BULLET16_NOROI shl 16) or ((1 shl 4) + 14)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti

loc_14248:
		pop	bp
		retn
midboss2_14203	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss2_update_and_render$qv
@midboss2_update_and_render$qv	proc far

@@damage		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		xor	di, di
		mov	word_205D8, 0D8h
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 24
		mov	word_205DA, ax
		inc	_boss_phase_frame
		cmp	_boss_phase_frame, 1
		jnz	short loc_1429E
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_left_on_page[1 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_top_on_page[1 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_damage, 0
		mov	word_250E2, 1
		mov	word_1EDA4, 1
		jmp	loc_143E1
; ---------------------------------------------------------------------------

loc_1429E:
		cmp	_boss_phase_frame, 320
		jge	short loc_14321
		mov	ax, _scroll_line
		sar	ax, 1
		and	ax, 3
		mov	[bp+var_2], ax
		add	ax, 89h
		mov	di, ax
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_142C3
		mov	bx, _boss_top_on_back_page
		inc	word ptr [bx]

loc_142C3:
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		or	si, si
		jge	short loc_142D7
		add	si, RES_Y
		jmp	short loc_142E1
; ---------------------------------------------------------------------------

loc_142D7:
		cmp	si, RES_Y
		jl	short loc_142E1
		sub	si, RES_Y

loc_142E1:
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]
		push	40003Ah
		call	sub_1283C
		or	ax, ax
		jz	loc_143D4
		call	_snd_se_play c, 4
		mov	bx, _boss_left_on_back_page
		call	super_roll_put_1plane pascal, word ptr [bx], si, (136 shl 16) or 0, PLANE_PUT or GC_BRGI
		inc	_boss_damage
		jmp	loc_143E1
; ---------------------------------------------------------------------------

loc_14321:
		mov	ax, _scroll_line
		sar	ax, 1
		and	ax, 3
		mov	[bp+var_2], ax
		add	ax, 89h
		mov	di, ax
		cmp	byte_2066A, 0
		jz	short loc_1433E
		call	midboss2_14169
		jmp	loc_143E1
; ---------------------------------------------------------------------------

loc_1433E:
		call	midboss2_14203
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		or	si, si
		jge	short loc_14355
		add	si, RES_Y
		jmp	short loc_1435F
; ---------------------------------------------------------------------------

loc_14355:
		cmp	si, RES_Y
		jl	short loc_1435F
		sub	si, RES_Y

loc_1435F:
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]
		push	40003Ah
		call	sub_1283C
		mov	[bp+@@damage], ax
		or	ax, ax
		jz	short loc_143C7
		add	_boss_damage, ax
		cmp	_boss_damage, 380
		jle	short loc_1438D
		cmp	si, 130h
		jl	short loc_143AD

loc_1438D:
		call	_snd_se_play c, 4
		mov	bx, _boss_left_on_back_page
		call	super_roll_put_1plane pascal, word ptr [bx], si, (136 shl 16) or 0, PLANE_PUT or GC_BRGI
		jmp	short loc_143E1
; ---------------------------------------------------------------------------

loc_143AD:
		call	_snd_se_play c, 2
		mov	byte_2066A, 1
		add	_score_delta, 20000
		jmp	short loc_143E1
; ---------------------------------------------------------------------------

loc_143C7:
		cmp	_boss_phase_frame, 1600
		jle	short loc_143D4
		mov	byte_2066A, 1

loc_143D4:
		mov	bx, _boss_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, di

loc_143E1:
		pop	di
		pop	si
		leave
		retf
@midboss2_update_and_render$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_bg_render	proc far
		push	bp
		mov	bp, sp
		push	si
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]	; left
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]	; top
		push	(64 shl 16) or 64	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		cmp	word_250FE, 0
		jz	loc_144ED
		xor	si, si
		jmp	loc_144E6
; ---------------------------------------------------------------------------

loc_14428:
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx+7676h]
		mov	bx, _boss_left_on_back_page
		cmp	ax, [bx]
		jz	short loc_14493
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx+7682h]
		mov	bx, _boss_top_on_back_page
		cmp	ax, [bx]
		jz	short loc_14493
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx+7676h]	; left
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx+7682h]	; top
		push	(64 shl 16) or 64	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii

loc_14493:
		mov	al, _page_front
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx+7676h]
		mov	dl, _page_back
		mov	dh, 0
		imul	dx, 6
		mov	bx, si
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx+7676h], ax
		mov	al, _page_front
		mov	ah, 0
		imul	ax, 6
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx+7682h]
		mov	dl, _page_back
		mov	dh, 0
		imul	dx, 6
		mov	bx, si
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx+7682h], ax
		inc	si

loc_144E6:
		cmp	si, 3
		jl	loc_14428

loc_144ED:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		call	meira_146EF
		pop	si
		pop	bp
		retf
meira_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14519	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax
		push	word_1EDAA
		call	sub_FFF8
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax
		mov	ax, word_1EDAA
		add	ax, 0FFE8h
		push	ax
		call	sub_FFF8
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 48
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 48
		push	ax
		push	3C0001h
		push	0
		call	sub_4090
		mov	di, 0Ah
		mov	ax, word_1EDAA
		add	ax, 0FFE0h
		mov	bx, 0Ah
		cwd
		idiv	bx
		add	di, ax
		inc	word_1EDAA
		cmp	word_1EDAA, 60h
		jl	short loc_1459F
		mov	word_1EDAA, 0
		mov	ax, 1
		jmp	short loc_145DD
; ---------------------------------------------------------------------------

loc_1459F:
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_145B3
		sub	si, RES_Y

loc_145B3:
		cmp	_boss_phase_frame, 32
		jge	short loc_145CC
		mov	bx, _boss_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, patnum_2064E
		jmp	short loc_145DB
; ---------------------------------------------------------------------------

loc_145CC:
		mov	bx, _boss_left_on_back_page
		call	super_zoom pascal, word ptr [bx], si, di, 2

loc_145DB:
		xor	ax, ax

loc_145DD:
		pop	di
		pop	si
		pop	bp
		retn
meira_14519	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_145E1	proc near

@@damage		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		cmp	ax, _player_topleft.x
		jg	short loc_1461A
		add	ax, 32
		cmp	ax, _player_topleft.x
		jle	short loc_1461A
		lea	ax, [si-16]
		cmp	ax, _player_topleft.y
		jge	short loc_1461A
		lea	ax, [si+32]
		cmp	ax, _player_topleft.y
		jle	short loc_1461A
		mov	_player_is_hit, 1

loc_1461A:
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_14628
		sub	si, RES_Y

loc_14628:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 8
		push	ax
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]
		push	300030h
		call	sub_1283C
		mov	[bp+@@damage], ax
		or	ax, ax
		jz	short loc_14689
		add	_boss_damage, ax
		call	_snd_se_play c, 4
		mov	bx, _boss_left_on_back_page
		call	super_roll_put_1plane pascal, word ptr [bx], si, patnum_2064E, large PLANE_PUT or GC_BRGI
		cmp	_boss_damage, 2400
		jl	short loc_14699
		mov	byte_2066A, 1
		add	_score_delta, 30000
		mov	_player_invincibility_time, BOSS_DEFEAT_INVINCIBILITY_FRAMES
		jmp	short loc_14699
; ---------------------------------------------------------------------------

loc_14689:
		mov	bx, _boss_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, patnum_2064E

loc_14699:
		pop	si
		leave
		retn
meira_145E1	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_1469C	proc near

arg_0		= byte ptr  4
arg_2		= byte ptr  6
arg_4		= byte ptr  8
arg_6		= byte ptr  0Ah
arg_8		= word ptr  0Ch
arg_A		= word ptr  0Eh

		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	cx, [bp+arg_A]
		mov	di, [bp+arg_8]
		mov	si, 7690h
		xor	dx, dx
		jmp	short loc_146E4
; ---------------------------------------------------------------------------

loc_146AE:
		cmp	byte ptr [si], 0
		jnz	short loc_146E0
		mov	byte ptr [si], 1
		mov	al, [bp+arg_4]
		mov	[si+1],	al
		mov	[si+2],	cx
		mov	[si+4],	di
		mov	al, [bp+arg_6]
		mov	[si+6],	al
		mov	byte ptr [si+7], 0
		mov	al, [bp+arg_2]
		mov	[si+8],	al
		mov	al, byte_252E0
		mov	[si+9],	al
		mov	al, [bp+arg_0]
		mov	[si+0Ah], al
		jmp	short loc_146E9
; ---------------------------------------------------------------------------

loc_146E0:
		inc	dx
		add	si, 0Ch

loc_146E4:
		cmp	dx, 28h	; '('
		jl	short loc_146AE

loc_146E9:
		pop	di
		pop	si
		pop	bp
		retn	0Ch
meira_1469C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_146EF	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	si, 7690h
		xor	di, di
		jmp	short loc_1471D
; ---------------------------------------------------------------------------

loc_146FB:
		cmp	byte ptr [si], 0
		jz	short loc_14719
		call	@tiles_invalidate_rect$qiiii pascal, word ptr [si+2], word ptr [si+4], (32 shl 16) or 32
		cmp	byte ptr [si], 2
		jnz	short loc_14719
		mov	byte ptr [si], 0

loc_14719:
		inc	di
		add	si, 0Ch

loc_1471D:
		cmp	di, 28h	; '('
		jl	short loc_146FB
		pop	di
		pop	si
		pop	bp
		retn
meira_146EF	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14726	proc near

@@patnum		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	si, 7690h
		mov	[bp+var_2], 0
		jmp	loc_1482F
; ---------------------------------------------------------------------------

loc_14739:
		cmp	byte ptr [si], 1
		jnz	loc_14829
		cmp	byte ptr [si+0Ah], 0
		jbe	short loc_147A3
		mov	di, [si+4]
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_14757
		sub	di, RES_Y

loc_14757:
		push	word ptr [si+2]
		push	di
		mov	al, [si+9]
		mov	ah, 0
		push	ax
		call	super_roll_put_tiny
		dec	byte ptr [si+0Ah]
		mov	ax, [si+2]
		add	ax, -16
		cmp	ax, _player_topleft.x
		jg	loc_14829
		mov	ax, [si+2]
		cmp	ax, _player_topleft.x
		jl	loc_14829
		mov	ax, [si+4]
		add	ax, -16
		cmp	ax, _player_topleft.y
		jge	loc_14829
		mov	ax, [si+4]
		cmp	ax, _player_topleft.y
		jle	loc_14829
		mov	_player_is_hit, 1
		jmp	loc_14829
; ---------------------------------------------------------------------------

loc_147A3:
		cmp	byte ptr [si+7], 0
		jnz	short loc_147BD
		call	_snd_se_play c, 10
		sub	word ptr [si+2], 8
		sub	word ptr [si+4], 8
		jmp	short loc_147C3
; ---------------------------------------------------------------------------

loc_147BD:
		cmp	byte ptr [si+7], 20h ; ' '
		jnb	short loc_147F3

loc_147C3:
		mov	al, [si+7]
		mov	ah, 0
		sar	ax, 2
		add	ax, 26
		mov	[bp+@@patnum], ax
		mov	di, [si+4]
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_147E2
		sub	di, RES_Y

loc_147E2:
		call	super_roll_put pascal, word ptr [si+2], di, [bp+@@patnum]
		inc	byte ptr [si+7]
		jmp	short loc_14829
; ---------------------------------------------------------------------------

loc_147F3:
		mov	al, byte_252E1
		mov	ah, 0
		and	ax, 1
		push	ax
		mov	al, _rank
		cbw
		pop	dx
		cmp	dx, ax
		jg	short loc_14822
		mov	di, [si+4]
		add	di, 12
		mov	ax, [si+2]
		add	ax, 12
		push	ax	; left
		push	di	; top
		push	word ptr [si+6]	; angle
		push	word ptr [si+1]	; group
		mov	al, [si+8]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci

loc_14822:
		inc	byte_252E1
		mov	byte ptr [si], 2

loc_14829:
		inc	[bp+var_2]
		add	si, 0Ch

loc_1482F:
		cmp	[bp+var_2], 28h	; '('
		jl	loc_14739
		pop	di
		pop	si
		leave
		retn
meira_14726	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_1483B	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	short loc_1489A
		cmp	_boss_phase_frame, 10
		jnz	short loc_1485E
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1485E:
		cmp	_boss_phase_frame, 50
		jl	short loc_1489A
		cmp	_boss_phase_frame, 50
		jnz	short loc_1487E
		call	_snd_se_play c, 3
		mov	patnum_2064E, 143
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1487E:
		cmp	_boss_phase_frame, 90
		jg	short loc_1488E
		mov	bx, _boss_top_on_back_page
		add	word ptr [bx], 6
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1488E:
		mov	patnum_2064E, 141
		mov	_boss_phase_frame, 0

loc_1489A:
		pop	bp
		retn
meira_1483B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_1489C	proc near

arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= byte ptr  8

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+arg_2]
		cmp	[bp+arg_4], 0
		jnz	short loc_148BB
		mov	bx, _boss_left_on_back_page
		add	[bx], si
		cmp	word ptr [bx], (PLAYFIELD_RIGHT - 48)
		jle	short loc_148CA
		mov	word ptr [bx], (PLAYFIELD_RIGHT - 48)
		jmp	short loc_148CA
; ---------------------------------------------------------------------------

loc_148BB:
		mov	bx, _boss_left_on_back_page
		sub	[bx], si
		cmp	word ptr [bx], (PLAYFIELD_LEFT - 16)
		jge	short loc_148CA
		mov	word ptr [bx], (PLAYFIELD_LEFT - 16)

loc_148CA:
		mov	bx, _boss_top_on_back_page
		mov	ax, [bp+arg_0]
		add	[bx], ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 12
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 12
		push	ax
		push	0
		push	word_252E2
		push	word_252E2+1
		push	word_252E4
		call	meira_1469C
		pop	si
		pop	bp
		retn	6
meira_1489C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_148FD	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 20
		jl	loc_14A36
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		cmp	_boss_phase_frame, 20
		jnz	short loc_14954
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 16
		cmp	ax, _player_topleft.x
		jge	short loc_1492B
		mov	ax, 1
		jmp	short loc_1492D
; ---------------------------------------------------------------------------

loc_1492B:
		xor	ax, ax

loc_1492D:
		mov	byte ptr word_252E6, al
		mov	ah, 0
		add	ax, 144
		mov	patnum_2064E, ax
		mov	word_252E4, 10h
		mov	al, 79h	; 'y'
		sub	al, byte ptr word_252E6
		mov	byte_252E0, al
		mov	byte ptr word_252E2, 19h
		mov	byte ptr word_252E2+1, 40h
		jmp	loc_14A36
; ---------------------------------------------------------------------------

loc_14954:
		cmp	_boss_phase_frame, 32
		jg	short loc_14968
		push	word_252E6
		push	0FFF8FFF8h
		jmp	loc_14A12
; ---------------------------------------------------------------------------

loc_14968:
		cmp	_boss_phase_frame, 56
		jge	short loc_14978
		mov	patnum_2064E, 141
		jmp	loc_14A36
; ---------------------------------------------------------------------------

loc_14978:
		cmp	_boss_phase_frame, 56
		jnz	short loc_1499E
		mov	al, byte ptr word_252E6
		mov	ah, 0
		mov	dx, 145
		sub	dx, ax
		mov	patnum_2064E, dx
		mov	al, byte ptr word_252E6
		add	al, 78h	; 'x'
		mov	byte_252E0, al
		mov	word_252E4, 10h
		jmp	loc_14A36
; ---------------------------------------------------------------------------

loc_1499E:
		cmp	_boss_phase_frame, 57
		jnz	short loc_149C4
		push	word_252E6
		push	8FFF8h
		call	meira_1489C
		add	word_252E4, 2
		cmp	si, 30h	; '0'
		jle	short loc_14A36
		mov	_boss_phase_frame, 56 ; Ensures the intended movement?
		jmp	short loc_14A36
; ---------------------------------------------------------------------------

loc_149C4:
		cmp	_boss_phase_frame, 80
		jge	short loc_149D3
		mov	patnum_2064E, 141
		jmp	short loc_14A36
; ---------------------------------------------------------------------------

loc_149D3:
		cmp	_boss_phase_frame, 80
		jnz	short loc_149F9
		mov	al, byte ptr word_252E6
		mov	ah, 0
		mov	dx, 149
		sub	dx, ax
		mov	patnum_2064E, dx
		mov	al, 79h	; 'y'
		sub	al, byte ptr word_252E6
		mov	byte_252E0, al
		mov	word_252E4, 10h
		jmp	short loc_14A36
; ---------------------------------------------------------------------------

loc_149F9:
		mov	bx, _boss_left_on_back_page
		cmp	word ptr [bx], 32
		jle	short loc_14A1C
		cmp	word ptr [bx], 352
		jge	short loc_14A1C
		push	word_252E6
		push	80008h

loc_14A12:
		call	meira_1489C
		add	word_252E4, 2
		jmp	short loc_14A36
; ---------------------------------------------------------------------------

loc_14A1C:
		cmp	si, 30h	; '0'
		jle	short loc_14A30
		mov	bx, _boss_top_on_back_page
		sub	word ptr [bx], 2
		mov	patnum_2064E, 141
		jmp	short loc_14A36
; ---------------------------------------------------------------------------

loc_14A30:
		mov	_boss_phase_frame, 0

loc_14A36:
		pop	si
		pop	bp
		retn
meira_148FD	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14A39	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_14B31
		cmp	_boss_phase_frame, 50
		jnz	short loc_14A64
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		mov	al, byte_2066E
		mov	byte ptr word_252E2, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14A64:
		cmp	_boss_phase_frame, 99
		jl	loc_14B31
		cmp	_boss_phase_frame, 99
		jnz	short loc_14A9C
		call	_snd_se_play c, 3
		mov	al, byte ptr word_252E6
		mov	ah, 0
		mov	dx, 149
		sub	dx, ax
		mov	patnum_2064E, dx
		mov	al, byte ptr word_252E6
		add	al, 78h	; 'x'
		mov	byte_252E0, al
		mov	word_252E4, 50h	; 'P'
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14A9C:
		cmp	_boss_phase_frame, 120
		jge	short loc_14AAF
		push	word_252E6
		push	0FFF80008h
		jmp	short loc_14AFB
; ---------------------------------------------------------------------------

loc_14AAF:
		cmp	_boss_phase_frame, 136
		jge	short loc_14AE9
		mov	patnum_2064E, 142
		mov	al, byte ptr word_252E6
		mov	ah, 0
		add	ax, 144
		mov	patnum_2064E, ax
		mov	al, 79h	; 'y'
		sub	al, byte ptr word_252E6
		mov	byte_252E0, al
		dec	word_252E4
		cmp	_boss_phase_frame, 135
		jnz	short loc_14B31
		call	_snd_se_play c, 3
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14AE9:
		cmp	_boss_phase_frame, 156
		jge	short loc_14B04
		push	word_252E6
		push	0FFF8FFF8h

loc_14AFB:
		call	meira_1489C
		dec	word_252E4
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14B04:
		mov	bx, _boss_left_on_back_page
		cmp	word ptr [bx], 192
		jz	short loc_14B2B
		mov	patnum_2064E, 141
		cmp	byte ptr word_252E6, 0
		jnz	short loc_14B20
		mov	ax, 2
		jmp	short loc_14B23
; ---------------------------------------------------------------------------

loc_14B20:
		mov	ax, -2

loc_14B23:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14B2B:
		mov	_boss_phase_frame, 0

loc_14B31:
		pop	bp
		retn
meira_14A39	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14B33	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_14BC0
		cmp	_boss_phase_frame, 50
		jnz	short loc_14B58
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14B58:
		cmp	_boss_phase_frame, 99
		jl	short loc_14BC0
		cmp	_boss_phase_frame, 99
		jnz	short loc_14B7E
		call	_snd_se_play c, 3
		mov	patnum_2064E, 143
		mov	speed_252E8, (2 shl 4)
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14B7E:
		cmp	_boss_phase_frame, 116
		jge	short loc_14BB4
		test	byte ptr _boss_phase_frame, 1
		jz	short loc_14BC0
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax	; top
		push	40h	; angle
		push	word ptr byte_2066F	; group
		push	speed_252E8	; speed
		call	@bullets_add_pellet$qiiucuci
		add	speed_252E8, 11
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14BB4:
		mov	patnum_2064E, 141
		mov	_boss_phase_frame, 0

loc_14BC0:
		pop	bp
		retn
meira_14B33	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14BC2	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_14C74
		cmp	_boss_phase_frame, 50
		jnz	short loc_14BEC
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		mov	byte ptr word_252E2, 1Ah
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14BEC:
		cmp	_boss_phase_frame, 99
		jl	loc_14C74
		cmp	_boss_phase_frame, 99
		jnz	short loc_14C14
		call	_snd_se_play c, 3
		mov	patnum_2064E, 143
		mov	speed_252EA, (2 shl 4)
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14C14:
		cmp	_boss_phase_frame, 120
		jge	short loc_14C68
		test	byte ptr _boss_phase_frame, 1
		jz	short loc_14C48
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax	; top
		push	00h	; angle
		push	word ptr group_20670	; group
		push	speed_252EA	; speed
		call	@bullets_add_pellet$qiiucuci
		add	speed_252EA, 11

loc_14C48:
		mov	bx, _boss_left_on_back_page
		cmp	word ptr [bx], 192
		jz	short loc_14C74
		cmp	word ptr [bx], 192
		jge	short loc_14C5D
		mov	ax, 8
		jmp	short loc_14C60
; ---------------------------------------------------------------------------

loc_14C5D:
		mov	ax, -8

loc_14C60:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14C68:
		mov	patnum_2064E, 141
		mov	_boss_phase_frame, 0

loc_14C74:
		pop	bp
		retn
meira_14BC2	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14C76	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_14DFA
		cmp	_boss_phase_frame, 50
		jnz	short loc_14CBE
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 16
		cmp	ax, _player_topleft.x
		jge	short loc_14C9D
		mov	ax, 1
		jmp	short loc_14C9F
; ---------------------------------------------------------------------------

loc_14C9D:
		xor	ax, ax

loc_14C9F:
		mov	byte ptr word_252E6, al
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		mov	byte ptr word_252E2, 1Ah
		mov	byte ptr word_252E2+1, 30h ; '0'
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14CBE:
		cmp	_boss_phase_frame, 99
		jl	loc_14DFA
		cmp	_boss_phase_frame, 99
		jnz	short loc_14CF3
		call	_snd_se_play c, 3
		mov	al, byte ptr word_252E6
		mov	ah, 0
		add	ax, 148
		mov	patnum_2064E, ax
		mov	al, byte ptr word_252E6
		add	al, 78h	; 'x'
		mov	byte_252E0, al
		mov	word_252E4, 14h
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14CF3:
		cmp	_boss_phase_frame, 116
		jge	short loc_14D07
		push	word_252E6
		push	0FFF80008h
		jmp	loc_14DE4
; ---------------------------------------------------------------------------

loc_14D07:
		cmp	_boss_phase_frame, 136
		jge	short loc_14D3F
		mov	patnum_2064E, 142
		mov	al, byte ptr word_252E6
		mov	ah, 0
		mov	dx, 149
		sub	dx, ax
		mov	patnum_2064E, dx
		mov	al, 79h	; 'y'
		sub	al, byte ptr word_252E6
		mov	byte_252E0, al
		mov	word_252E4, 14h
		cmp	_boss_phase_frame, 135
		jnz	loc_14DFA
		jmp	loc_14DC8
; ---------------------------------------------------------------------------

loc_14D3F:
		cmp	_boss_phase_frame, 152
		jge	short loc_14D54
		push	word_252E6
		push	80008h
		jmp	loc_14DE4
; ---------------------------------------------------------------------------

loc_14D54:
		cmp	_boss_phase_frame, 172
		jge	short loc_14D88
		mov	patnum_2064E, 142
		mov	al, byte ptr word_252E6
		mov	ah, 0
		mov	dx, 145
		sub	dx, ax
		mov	patnum_2064E, dx
		mov	al, byte ptr word_252E6
		add	al, 78h	; 'x'
		mov	byte_252E0, al
		mov	word_252E4, 14h
		cmp	_boss_phase_frame, 171
		jnz	short loc_14DFA
		jmp	short loc_14DC8
; ---------------------------------------------------------------------------

loc_14D88:
		cmp	_boss_phase_frame, 188
		jge	short loc_14D98
		push	word_252E6
		push	8
		jmp	short loc_14DE2
; ---------------------------------------------------------------------------

loc_14D98:
		cmp	_boss_phase_frame, 208
		jge	short loc_14DD4
		mov	patnum_2064E, 142
		mov	al, byte ptr word_252E6
		mov	ah, 0
		add	ax, 144
		mov	patnum_2064E, ax
		mov	al, 79h	; 'y'
		sub	al, byte ptr word_252E6
		mov	byte_252E0, al
		mov	word_252E4, 14h
		cmp	_boss_phase_frame, 207
		jnz	short loc_14DFA

loc_14DC8:
		call	_snd_se_play c, 3
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14DD4:
		cmp	_boss_phase_frame, 224
		jge	short loc_14DEE
		push	word_252E6
		push	0FFF8h

loc_14DE2:
		push	0FFF8h

loc_14DE4:
		call	meira_1489C
		add	word_252E4, 2
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14DEE:
		mov	patnum_2064E, 141
		mov	_boss_phase_frame, 0

loc_14DFA:
		pop	bp
		retn
meira_14C76	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14DFC	proc near
		push	bp
		mov	bp, sp
		call	_snd_se_play c, 3
		mov	patnum_2064E, 143
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax	; top
		push	00h	; angle
		push	word ptr group_20670	; group
		push	((4 shl 4) + 10)	; speed
		call	@bullets_add_pellet$qiiucuci
		pop	bp
		retn
meira_14DFC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14E30	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	short loc_14E9B
		cmp	_boss_phase_frame, 50
		jnz	short loc_14E58
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		mov	byte ptr word_252E2, 1Ah
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14E58:
		cmp	_boss_phase_frame, 99
		jl	short loc_14E9B
		cmp	_boss_phase_frame, 99
		jz	short loc_14E8A
		cmp	_boss_phase_frame, 108
		jl	short loc_14E7B
		cmp	_boss_phase_frame, 108
		jz	short loc_14E8A
		cmp	_boss_phase_frame, 116
		jge	short loc_14E83

loc_14E7B:
		mov	patnum_2064E, 142
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14E83:
		cmp	_boss_phase_frame, 116
		jnz	short loc_14E8F

loc_14E8A:
		call	meira_14DFC
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_14E8F:
		mov	patnum_2064E, 141
		mov	_boss_phase_frame, 0

loc_14E9B:
		pop	bp
		retn
meira_14E30	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14E9D	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 50
		jl	short loc_14F13
		cmp	_boss_phase_frame, 50
		jnz	short loc_14EC7
		call	_snd_se_play c, 9
		mov	patnum_2064E, 142
		mov	bullet_special_turns_max, 5
		jmp	short loc_14F13
; ---------------------------------------------------------------------------

loc_14EC7:
		cmp	_boss_phase_frame, 99
		jl	short loc_14F13
		mov	patnum_2064E, 146
		xor	si, si
		jmp	short loc_14F02
; ---------------------------------------------------------------------------

loc_14ED8:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM	; group
		mov	ax, si
		and	ax, 1
		add	ax, PAT_BULLET16_BILLIARD_BALL_RED
		push	ax	; patnum
		push	(3 shl 4) + 6	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	si

loc_14F02:
		cmp	si, 3
		jl	short loc_14ED8
		mov	_boss_phase_frame, 0
		mov	word_250FE, 1

loc_14F13:
		pop	si
		pop	bp
		retn
meira_14E9D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_14F16	proc near

var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 8
		push	si
		push	di
		cmp	_boss_phase_frame, 50
		jl	loc_150F0
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		add	ax, 7676h
		mov	[bp+var_6], ax
		mov	al, _page_back
		mov	ah, 0
		imul	ax, 6
		add	ax, 7682h
		mov	[bp+var_8], ax
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_14F84
		mov	bx, [bp+var_6]
		mov	ax, [bx+2]
		mov	[bx], ax
		mov	bx, [bp+var_8]
		mov	ax, [bx+2]
		mov	[bx], ax
		mov	bx, [bp+var_6]
		mov	ax, [bx+4]
		mov	[bx+2],	ax
		mov	bx, [bp+var_8]
		mov	ax, [bx+4]
		mov	[bx+2],	ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	bx, [bp+var_6]
		mov	[bx+4],	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	bx, [bp+var_8]
		mov	[bx+4],	ax

loc_14F84:
		cmp	_boss_phase_frame, 50
		jnz	short loc_14FEA
		xor	di, di
		jmp	short loc_14FAE
; ---------------------------------------------------------------------------

loc_14F8F:
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_6]
		mov	si, _boss_left_on_back_page
		mov	ax, [si]
		mov	[bx], ax
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_8]
		mov	si, _boss_top_on_back_page
		mov	ax, [si]
		mov	[bx], ax
		inc	di

loc_14FAE:
		cmp	di, 3
		jl	short loc_14F8F
		call	@randring2_next16$qv
		mov	bx, 320
		xor	dx, dx
		div	bx
		add	dx, 20h	; ' '
		mov	word_252F0, dx
		call	@randring2_next8$qv
		mov	ah, 0
		add	ax, 10h
		mov	word_252F2, ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	word_252EC, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	word_252EE, ax
		mov	word_252F4, 1
		jmp	loc_1508F
; ---------------------------------------------------------------------------

loc_14FEA:
		cmp	_boss_phase_frame, 114
		jg	short loc_15038
		mov	ax, word_252F0
		sub	ax, word_252EC
		imul	word_252F4
		mov	bx, 40h
		cwd
		idiv	bx
		mov	[bp+var_2], ax
		mov	ax, word_252F2
		sub	ax, word_252EE
		imul	word_252F4
		cwd
		idiv	bx
		mov	[bp+var_4], ax
		mov	ax, word_252EE
		add	[bp+var_4], ax
		mov	ax, [bp+var_2]
		add	ax, word_252EC
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bp+var_4]
		mov	[bx], ax
		inc	word_252F4
		jmp	short loc_1508F
; ---------------------------------------------------------------------------

loc_15038:
		cmp	_boss_phase_frame, 114
		jnz	short loc_1504B
		call	_snd_se_play c, 9
		jmp	short loc_1508F
; ---------------------------------------------------------------------------

loc_1504B:
		cmp	_boss_phase_frame, 164
		jl	loc_150F0
		mov	patnum_2064E, 146
		xor	di, di
		jmp	short loc_15084
; ---------------------------------------------------------------------------

loc_1505F:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; left
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 24
		push	ax	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM	; group
		lea	ax, [di+PAT_BULLET16_BILLIARD_BALL_RED]
		push	ax	; patnum
		push	(3 shl 4) + 6	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	di

loc_15084:
		cmp	di, 2
		jl	short loc_1505F
		mov	_boss_phase_frame, 0

loc_1508F:
		xor	di, di
		jmp	short loc_150EB
; ---------------------------------------------------------------------------

loc_15093:
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_6]
		mov	ax, [bx]
		mov	bx, _boss_left_on_back_page
		cmp	ax, [bx]
		jz	short loc_150EA
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_8]
		mov	ax, [bx]
		mov	bx, _boss_top_on_back_page
		cmp	ax, [bx]
		jz	short loc_150EA
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_8]
		mov	[bp+var_4], ax
		mov	ax, _scroll_line
		add	[bp+var_4], ax
		cmp	[bp+var_4], RES_Y
		jl	short loc_150D1
		sub	[bp+var_4], RES_Y

loc_150D1:
		mov	bx, di
		add	bx, bx
		add	bx, [bp+var_6]
		call	super_roll_put_1plane pascal, word ptr [bx], [bp+var_4], (147 shl 16) or 0, PLANE_PUT or GC_RGI

loc_150EA:
		inc	di

loc_150EB:
		cmp	di, 3
		jl	short loc_15093

loc_150F0:
		pop	di
		pop	si
		leave
		retn
meira_14F16	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_update	proc far
		push	bp
		mov	bp, sp
		push	si
		inc	_boss_phase_frame
		mov	bx, _boss_top_on_back_page
		mov	si, [bx]
		add	si, 40
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 40
		mov	word_205D8, ax
		mov	word_205DA, si
		cmp	byte_2066A, 0
		jz	short loc_1512B
		call	meira_14519
		or	ax, ax
		jz	loc_15206
		mov	ax, 2
		jmp	loc_1520C
; ---------------------------------------------------------------------------

loc_1512B:
		cmp	byte_252F6, 0
		jnz	short loc_15185
		mov	al, byte_252F7
		mov	ah, 0
		mov	bx, ax
		cmp	bx, 3
		ja	short loc_15157
		add	bx, bx
		jmp	cs:off_15210[bx]

loc_15145:
		call	meira_1483B
		jmp	short loc_15157
; ---------------------------------------------------------------------------

loc_1514A:
		call	meira_148FD
		jmp	short loc_15157
; ---------------------------------------------------------------------------

loc_1514F:
		call	meira_14A39
		jmp	short loc_15157
; ---------------------------------------------------------------------------

loc_15154:
		call	meira_14B33

loc_15157:
		cmp	_boss_phase_frame, 0
		jnz	loc_15203
		inc	byte_252F7
		cmp	byte_252F7, 3
		jbe	short loc_15170
		mov	byte_252F7, 0

loc_15170:
		cmp	_boss_damage, 700
		jle	loc_15203
		cmp	byte_252F7, 1
		jz	loc_15203
		jmp	short loc_151CD
; ---------------------------------------------------------------------------

loc_15185:
		cmp	byte_252F6, 1
		jnz	short loc_151D8
		mov	al, byte_252F7
		mov	ah, 0
		or	ax, ax
		jz	short loc_151A1
		cmp	ax, 1
		jz	short loc_151A6
		cmp	ax, 2
		jz	short loc_151AB
		jmp	short loc_151AE
; ---------------------------------------------------------------------------

loc_151A1:
		call	meira_14BC2
		jmp	short loc_151AE
; ---------------------------------------------------------------------------

loc_151A6:
		call	meira_14C76
		jmp	short loc_151AE
; ---------------------------------------------------------------------------

loc_151AB:
		call	meira_14E30

loc_151AE:
		cmp	_boss_phase_frame, 0
		jnz	short loc_15203
		inc	byte_252F7
		cmp	byte_252F7, 2
		jbe	short loc_151C5
		mov	byte_252F7, 0

loc_151C5:
		cmp	_boss_damage, 1500
		jle	short loc_15203

loc_151CD:
		inc	byte_252F6
		mov	byte_252F7, 0
		jmp	short loc_15203
; ---------------------------------------------------------------------------

loc_151D8:
		cmp	byte_252F6, 2
		jnz	short loc_15203
		mov	al, byte_252F7
		mov	ah, 0
		or	ax, ax
		jz	short loc_151EF
		cmp	ax, 1
		jz	short loc_151F4
		jmp	short loc_151F7
; ---------------------------------------------------------------------------

loc_151EF:
		call	meira_14E9D
		jmp	short loc_151F7
; ---------------------------------------------------------------------------

loc_151F4:
		call	meira_14F16

loc_151F7:
		cmp	_boss_phase_frame, 0
		jnz	short loc_15203
		mov	byte_252F7, 1

loc_15203:
		call	meira_145E1

loc_15206:
		call	meira_14726
		mov	ax, 1

loc_1520C:
		pop	si
		pop	bp
		retf
meira_update	endp

; ---------------------------------------------------------------------------
		db 0
off_15210	dw offset loc_15145
		dw offset loc_1514A
		dw offset loc_1514F
		dw offset loc_15154

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_end	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_POSTBOSS
		call	@stage_clear_bonus_animate$qv
		call	@key_delay$qv
		call	@overlay_stage_leave_animate$qv
		inc	_stage_id
		mov	_spark_accel_x, 0
		pop	bp
		retf
meira_end	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

meira_init	proc far
		push	bp
		mov	bp, sp
		push	si
		mov	patnum_2064E, 141
		call	@dialog_pre$qv
		call	@dialog_script_stage2_pre_intro_a$qv
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 32)
		mov	ax, _boss_left_on_page[0 * word]
		mov	_boss_left_on_page[1 * word], ax
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP + 32)
		mov	_boss_top_on_page[1 * word], (PLAYFIELD_TOP + 32)
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		push	1
		call	palette_white_out
		mov	si, 48
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_15296
		sub	si, RES_Y

loc_15296:
		mov	bx, _boss_left_on_back_page
		call	super_roll_put pascal, word ptr [bx], si, patnum_2064E
		push	ds
		push	offset aBoss4_m	; "boss4.m"
		nopcall	sub_13ABB
		add	sp, 4
		push	1
		call	palette_white_in
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_PREBOSS
		call	@dialog_post$qv
		mov	_boss_damage, 0
		mov	byte_2066A, 0
		mov	bullet_special_turns_max, 2
		mov	angle_1E510, 0
		mov	byte_252F6, 0
		mov	byte_252F7, 0
		mov	word_250FE, 0
		cmp	_rank, RANK_EASY
		jz	short loc_152FF
		mov	byte_2066E, 1Ah
		mov	byte_2066F, 15h
		mov	group_20670, BG_5_SPREAD_MEDIUM_AIMED
		jmp	short loc_1530E
; ---------------------------------------------------------------------------

loc_152FF:
		mov	byte_2066E, 1Ah
		mov	byte_2066F, 9
		mov	group_20670, BG_3_SPREAD_MEDIUM_AIMED

loc_1530E:
		pop	si
		pop	bp
		retf
meira_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midbossx_15311	proc near

arg_0		= byte ptr  4
arg_2		= byte ptr  6
arg_4		= byte ptr  8
arg_6		= word ptr  0Ah
arg_8		= word ptr  0Ch

		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	di, [bp+arg_8]
		mov	dx, [bp+arg_6]
		or	dx, dx
		jge	short loc_15326
		add	dx, 190h
		jmp	short loc_15330
; ---------------------------------------------------------------------------

loc_15326:
		cmp	dx, 190h
		jl	short loc_15330
		sub	dx, 190h

loc_15330:
		mov	si, 794Ah
		xor	cx, cx
		jmp	short loc_15361
; ---------------------------------------------------------------------------

loc_15337:
		cmp	byte ptr [si], 0
		jnz	short loc_1535D
		mov	byte ptr [si], 1
		mov	byte ptr [si+1], 0
		mov	[si+2],	di
		mov	[si+4],	dx
		mov	al, [bp+arg_4]
		mov	[si+6],	al
		mov	al, [bp+arg_2]
		mov	[si+7],	al
		mov	al, [bp+arg_0]
		mov	[si+8],	al
		jmp	short loc_15366
; ---------------------------------------------------------------------------

loc_1535D:
		inc	cx
		add	si, 0Ah

loc_15361:
		cmp	cx, 1Eh
		jl	short loc_15337

loc_15366:
		pop	di
		pop	si
		pop	bp
		retn	0Ah
midbossx_15311	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midbossx_1536C	proc near

var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= byte ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 8
		push	si
		push	di
		mov	ax, word_1EE16
		mov	[bp+var_8], ax
		mov	ax, word_1EE18
		mov	[bp+var_6], ax
		mov	ax, word_1EE1A
		mov	[bp+var_4], ax
		mov	al, byte_1EE1C
		mov	[bp+var_2], al
		mov	si, 794Ah
		xor	di, di
		jmp	short loc_153F9
; ---------------------------------------------------------------------------

loc_15393:
		cmp	byte ptr [si], 0
		jz	short loc_153F5
		inc	byte ptr [si+1]
		test	byte ptr [si+1], 7
		jnz	short loc_153F5
		push	word ptr [si+2]	; left
		push	word ptr [si+4]	; y
		mov	al, [si]
		mov	ah, 0
		lea	dx, [bp+var_8]
		add	ax, dx
		mov	bx, ax
		mov	al, ss:[bx]
		mov	ah, 0
		push	ax	; image
		call	@tile_ring_set_and_put_both_8$qiii
		inc	byte ptr [si]
		cmp	byte ptr [si], 7
		jb	short loc_153F5
		mov	ax, _scroll_line
		sub	[si+4],	ax
		cmp	word ptr [si+4], 0
		jge	short loc_153D5
		add	word ptr [si+4], RES_Y

loc_153D5:
		mov	ax, [si+2]
		add	ax, 4
		push	ax	; left
		mov	ax, [si+4]
		add	ax, 4
		push	ax	; top
		push	word ptr [si+7]	; angle
		push	word ptr [si+6]	; group
		mov	al, [si+8]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	byte ptr [si], 0

loc_153F5:
		inc	di
		add	si, 0Ah

loc_153F9:
		cmp	di, 1Eh
		jl	short loc_15393
		pop	di
		pop	si
		leave
		retn
midbossx_1536C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midbossx_invalidate$qv
@midbossx_invalidate$qv	proc far
		push	bp
		mov	bp, sp
		mov	al, byte_253B4
		mov	ah, 0
		pop	bp
		retf
@midbossx_invalidate$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midbossx_update_and_render$qv
@midbossx_update_and_render$qv	proc far
		push	bp
		mov	bp, sp
		inc	_boss_phase_frame
		cmp	_boss_phase_frame, 1
		jnz	short loc_15427
		mov	byte_254EA, 0
		mov	byte_253B4, 1
		jmp	loc_155AD
; ---------------------------------------------------------------------------

loc_15427:
		cmp	_boss_phase_frame, 96
		jge	short loc_154A0
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_155AD
		cmp	byte_254EA, 0
		jnz	short loc_1544C
		push	800080h
		jmp	short loc_1549B
; ---------------------------------------------------------------------------

loc_1544C:
		mov	al, byte_254EA
		mov	ah, 0
		mov	dx, 80h
		sub	dx, ax
		push	dx
		push	80h
		push	21h ; '!'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	80h
		mov	al, byte_254EA
		mov	ah, 0
		mov	dx, 80h
		sub	dx, ax
		push	dx
		push	21h ; '!'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		mov	al, byte_254EA
		mov	ah, 0
		add	ax, 80h
		push	ax
		push	80h
		push	21h ; '!'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	80h
		mov	al, byte_254EA
		mov	ah, 0
		add	ax, 80h
		push	ax

loc_1549B:
		push	21h ; '!'
		jmp	loc_1559E
; ---------------------------------------------------------------------------

loc_154A0:
		cmp	_boss_phase_frame, 96
		jz	short loc_15521
		cmp	_boss_phase_frame, 192
		jge	short loc_15519
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_155AD
		cmp	byte_254EA, 0
		jnz	short loc_154CD
		push	1300000h
		jmp	short loc_15514
; ---------------------------------------------------------------------------

loc_154CD:
		mov	al, byte_254EA
		mov	ah, 0
		mov	dx, 130h
		sub	dx, ax
		push	dx
		push	0
		push	24h ; '$'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	130h
		mov	al, byte_254EA
		mov	ah, 0
		neg	ax
		push	ax
		push	24h ; '$'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		mov	al, byte_254EA
		mov	ah, 0
		add	ax, 130h
		push	ax
		push	0
		push	24h ; '$'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	130h
		mov	al, byte_254EA
		mov	ah, 0
		push	ax

loc_15514:
		push	24h ; '$'
		jmp	loc_1559E
; ---------------------------------------------------------------------------

loc_15519:
		cmp	_boss_phase_frame, 192
		jnz	short loc_15529

loc_15521:
		mov	byte_254EA, 0
		jmp	loc_155AD
; ---------------------------------------------------------------------------

loc_15529:
		cmp	_boss_phase_frame, 288
		jge	short loc_155AD
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_155AD
		cmp	byte_254EA, 0
		jnz	short loc_1554D
		push	0C00150h
		jmp	short loc_1559C
; ---------------------------------------------------------------------------

loc_1554D:
		mov	al, byte_254EA
		mov	ah, 0
		mov	dx, 0C0h
		sub	dx, ax
		push	dx
		push	150h
		push	25h ; '%'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	0C0h
		mov	al, byte_254EA
		mov	ah, 0
		mov	dx, 150h
		sub	dx, ax
		push	dx
		push	25h ; '%'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		mov	al, byte_254EA
		mov	ah, 0
		add	ax, 0C0h
		push	ax
		push	150h
		push	25h ; '%'
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		push	0C0h
		mov	al, byte_254EA
		mov	ah, 0
		add	ax, 150h
		push	ax

loc_1559C:
		push	25h ; '%'

loc_1559E:
		push	0
		push	64h ; 'd'
		call	midbossx_15311
		mov	al, byte_254EA
		add	al, 10h
		mov	byte_254EA, al

loc_155AD:
		cmp	_boss_phase_frame, 420
		jle	short loc_155C0
		mov	_boss_phase_frame, 0
		mov	byte_253B4, 0

loc_155C0:
		call	midbossx_1536C
		pop	bp
		retf
@midbossx_update_and_render$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_155C5	proc near

var_4		= dword	ptr -4
arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	di, [bp+arg_4]
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], 7A7Ch
		or	di, di
		jle	short loc_1563C
		cmp	di, 1BCh
		jge	short loc_1563C
		cmp	[bp+arg_2], 0
		jle	short loc_1563C
		cmp	[bp+arg_2], 190h
		jge	short loc_1563C
		xor	si, si
		jmp	short loc_15637
; ---------------------------------------------------------------------------

loc_155F3:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 0
		jnz	short loc_15632
		les	bx, [bp+var_4]
		mov	byte ptr es:[bx], 1
		mov	byte ptr es:[bx+1], 0
		mov	es:[bx+2], di
		mov	ax, [bp+arg_2]
		mov	es:[bx+4], ax
		mov	ax, [bp+arg_0]
		mov	es:[bx+6], ax
		mov	byte ptr es:[bx+8], 1Ah
		mov	byte ptr es:[bx+9], 40h
		call	_snd_se_play c, 9
		xor	ax, ax
		jmp	short loc_1563F
; ---------------------------------------------------------------------------

loc_15632:
		inc	si
		add	word ptr [bp+var_4], 0Ah

loc_15637:
		cmp	si, 10h
		jl	short loc_155F3

loc_1563C:
		mov	ax, 1

loc_1563F:
		pop	di
		pop	si
		leave
		retn	6
sigma_155C5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15645	proc near

var_4		= dword	ptr -4

		push	bp
		mov	bp, sp
		sub	sp, 4
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], 7A7Ch
		xor	ax, ax
		jmp	short loc_15668
; ---------------------------------------------------------------------------

loc_15657:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 2
		jnz	short loc_15663
		inc	byte ptr es:[bx]

loc_15663:
		inc	ax
		add	word ptr [bp+var_4], 0Ah

loc_15668:
		cmp	ax, 10h
		jl	short loc_15657
		leave
		retn
sigma_15645	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_1566F	proc near

var_4		= dword	ptr -4

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], 7A7Ch
		xor	si, si
		jmp	loc_158D2
; ---------------------------------------------------------------------------

loc_15683:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 0
		jz	loc_158CD
		les	bx, [bp+var_4]
		inc	byte ptr es:[bx+1]
		cmp	byte ptr es:[bx], 1
		jnz	loc_15721
		mov	al, byte_2558C
		test	es:[bx+1], al
		jnz	short loc_156F7
		inc	byte ptr es:[bx+8]
		cmp	byte ptr es:[bx+8], 22h	; '"'
		jb	short loc_156BE
		inc	byte ptr es:[bx]
		call	_snd_se_play c, 3

loc_156BE:
		les	bx, [bp+var_4]
		mov	byte ptr es:[bx+1], 0
		mov	al, es:[bx+9]
		add	al, 0F8h
		mov	es:[bx+9], al
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		les	bx, [bp+var_4]
		push	word ptr es:[bx+2]
		push	word ptr es:[bx+4]
		mov	al, es:[bx+9]
		mov	ah, 0
		push	ax
		call	grcg_circle
		call	grcg_off

loc_156F7:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 1
		jnz	loc_158CD
		mov	ax, es:[bx+2]
		add	ax, -16
		push	ax
		mov	ax, es:[bx+4]
		add	ax, -16
		push	ax
		mov	al, es:[bx+8]
		mov	ah, 0
		push	ax
		call	super_put_rect
		jmp	loc_158CD
; ---------------------------------------------------------------------------

loc_15721:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 3
		jnz	loc_15849
		mov	al, _page_back
		mov	ah, 0
		mov	dx, si
		and	dx, 1
		cmp	ax, dx
		jnz	short loc_1577A
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		les	bx, [bp+var_4]
		push	word ptr es:[bx+2]
		push	word ptr es:[bx+4]
		mov	al, es:[bx+9]
		mov	ah, 0
		push	ax
		call	grcg_circlefill
		call	grcg_off
		les	bx, [bp+var_4]
		mov	al, es:[bx+9]
		mov	ah, 0
		cmp	ax, es:[bx+6]
		jge	short loc_1577A
		mov	al, es:[bx+9]
		add	al, 10h
		mov	es:[bx+9], al

loc_1577A:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx+1], 20h	; ' '
		jbe	short loc_1579B
		inc	byte ptr es:[bx]
		mov	byte ptr es:[bx+1], 0
		mov	al, es:[bx+9]
		mov	ah, 0
		mov	es:[bx+6], ax
		mov	byte ptr es:[bx+9], 8

loc_1579B:
		les	bx, [bp+var_4]
		mov	ax, es:[bx+2]
		mov	dl, es:[bx+9]
		mov	dh, 0
		sub	ax, dx
		push	ax
		mov	al, byte_2558D
		cbw
		pop	dx
		add	dx, ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		cmp	dx, _player_left_on_page[bx]
		jge	loc_158CD
		mov	bx, word ptr [bp+var_4]
		mov	ax, es:[bx+2]
		mov	dl, es:[bx+9]
		mov	dh, 0
		add	ax, dx
		push	ax
		mov	al, byte_2558D
		cbw
		pop	dx
		sub	dx, ax
		add	dx, 0FFE0h
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		cmp	dx, _player_left_on_page[bx]
		jle	loc_158CD
		mov	bx, word ptr [bp+var_4]
		mov	ax, es:[bx+4]
		mov	dl, es:[bx+9]
		mov	dh, 0
		sub	ax, dx
		push	ax
		mov	al, byte_2558D
		cbw
		pop	dx
		add	dx, ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		cmp	dx, _player_top_on_page[bx]
		jge	loc_158CD
		mov	bx, word ptr [bp+var_4]
		mov	ax, es:[bx+4]
		mov	dl, es:[bx+9]
		mov	dh, 0
		add	ax, dx
		push	ax
		mov	al, byte_2558D
		cbw
		pop	dx
		sub	dx, ax
		add	dx, 0FFE0h
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		cmp	dx, _player_top_on_page[bx]
		jle	loc_158CD
		mov	_player_is_hit, 1
		jmp	loc_158CD
; ---------------------------------------------------------------------------

loc_15849:
		les	bx, [bp+var_4]
		cmp	byte ptr es:[bx], 4
		jnz	short loc_158CD
		mov	al, _page_back
		mov	ah, 0
		mov	dx, si
		and	dx, 1
		cmp	ax, dx
		jnz	short loc_158CD
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		les	bx, [bp+var_4]
		call	grcg_circlefill pascal, word ptr es:[bx+2], word ptr es:[bx+4], word ptr es:[bx+6]
		call	grcg_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		les	bx, [bp+var_4]
		push	word ptr es:[bx+2]
		push	word ptr es:[bx+4]
		mov	al, es:[bx+9]
		mov	ah, 0
		push	ax
		call	grcg_circlefill
		call	grcg_off
		les	bx, [bp+var_4]
		mov	al, es:[bx+9]
		mov	ah, 0
		cmp	ax, es:[bx+6]
		jl	short loc_158C0
		mov	byte ptr es:[bx], 0
		jmp	short loc_158CD
; ---------------------------------------------------------------------------

loc_158C0:
		les	bx, [bp+var_4]
		mov	al, es:[bx+9]
		add	al, 10h
		mov	es:[bx+9], al

loc_158CD:
		inc	si
		add	word ptr [bp+var_4], 0Ah

loc_158D2:
		cmp	si, 10h
		jl	loc_15683
		pop	si
		leave
		retn
sigma_1566F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_158DC	proc near
		push	bp
		mov	bp, sp
		call	super_put_rect pascal, point_254E6.x, point_254E6.y, patnum_2064E
		mov	ax, point_254E6.x
		add	ax, 64
		push	ax
		push	point_254E6.y
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		pop	bp
		retn
sigma_158DC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15907	proc near

@@patnum		= word ptr -4
@@damage		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		mov	ax, patnum_2064E
		mov	[bp+@@patnum], ax
		cmp	byte_2066A, 0
		jnz	loc_159A4
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 36
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		push	380020h
		call	sub_1283C
		mov	[bp+@@damage], ax
		or	ax, ax
		jz	short loc_1594A
		mov	patnum_2064E, 130
		add	_boss_damage, ax

loc_1594A:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_254E6.x
		add	dx, 8
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jle	short loc_159A4
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_254E6.x
		add	dx, 88
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short loc_159A4
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_top_on_page[bx]
		cmp	ax, point_254E6.y
		jle	short loc_159A4
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_254E6.y
		add	dx, 64
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jge	short loc_159A4
		mov	_player_is_hit, 1

loc_159A4:
		call	sigma_158DC
		mov	ax, [bp+@@patnum]
		mov	patnum_2064E, ax
		leave
		retn
sigma_15907	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_bg_render	proc far

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		mov	[bp+var_2], 8
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_byteboxfill_x pascal, (PLAYFIELD_VRAM_LEFT shl 16) or PLAYFIELD_TOP, ((PLAYFIELD_VRAM_RIGHT - 1) shl 16) or PLAYFIELD_BOTTOM - 1
		call	grcg_off
		call	sigma_15645
		leave
		retf
sigma_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15A25	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 10
		jge	short loc_15A38
		call	sigma_158DC
		xor	ax, ax
		jmp	loc_15D53
; ---------------------------------------------------------------------------

loc_15A38:
		cmp	_boss_phase_frame, 10
		jnz	short loc_15A54
		mov	byte_2558E, 8
		call	sigma_158DC
		call	_snd_se_play c, 9
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15A54:
		cmp	_boss_phase_frame, 90
		jge	short loc_15AD0
		call	sigma_158DC
		cmp	_page_back, 0
		jnz	short loc_15A8A
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	ax, point_254E6.x
		add	ax, 64
		push	ax
		mov	ax, point_254E6.y
		add	ax, 64
		push	ax
		push	24
		call	grcg_circlefill
		call	grcg_off

loc_15A8A:
		cmp	_boss_phase_frame, 50
		jl	short loc_15ABA
		cmp	_page_back, 0
		jz	short loc_15ABA
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	ax, point_254E6.x
		add	ax, 64
		call	grcg_vline pascal, ax, (PLAYFIELD_TOP shl 16) or PLAYFIELD_BOTTOM - 1
		call	grcg_off

loc_15ABA:
		cmp	_boss_phase_frame, 89
		jnz	loc_15D51
		call	_snd_se_play c, 3
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15AD0:
		cmp	_boss_phase_frame, 100
		jge	loc_15B65
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	al, byte_2558E
		mov	ah, 0
		push	ax
		mov	ax, point_254E6.x
		add	ax, 64
		pop	dx
		sub	ax, dx
		mov	bx, 8
		cwd
		idiv	bx
		push	ax
		push	10h
		mov	al, byte_2558E
		mov	ah, 0
		add	ax, point_254E6.x
		add	ax, 64
		cwd
		idiv	bx
		push	ax
		push	PLAYFIELD_BOTTOM - 1
		call	grcg_byteboxfill_x
		call	grcg_off
		mov	al, byte_2558E
		mov	ah, 0
		mov	dx, point_254E6.x
		add	dx, 56
		sub	dx, ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		cmp	dx, _player_left_on_page[bx]
		jge	short loc_15B57
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dl, byte_2558E
		mov	dh, 0
		add	dx, point_254E6.x
		add	dx, 40
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short loc_15B57
		mov	_player_is_hit, 1

loc_15B57:
		mov	al, byte_2558E
		add	al, 8
		mov	byte_2558E, al
		call	sigma_158DC
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15B65:
		cmp	_boss_phase_frame, 100
		jnz	short loc_15BC2
		mov	al, byte_2558E
		mov	ah, 0
		mov	dx, point_254E6.x
		add	dx, 56
		sub	dx, ax
		mov	word_25592, dx
		mov	al, byte_2558E
		mov	ah, 0
		add	ax, point_254E6.x
		add	ax, 40
		mov	word_25594, ax
		mov	al, byte_2558E
		mov	ah, 0
		push	ax
		mov	ax, point_254E6.x
		add	ax, 64
		pop	dx
		sub	ax, dx
		mov	bx, 8
		cwd
		idiv	bx
		mov	byte_2558F, al
		mov	al, byte_2558E
		mov	ah, 0
		add	ax, point_254E6.x
		add	ax, 64
		cwd
		idiv	bx
		add	al, -1
		mov	byte_25590, al
		mov	patnum_2064E, 134
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15BC2:
		cmp	_boss_phase_frame, 140
		jg	short loc_15C25
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	al, byte_2558F
		mov	ah, 0
		push	ax
		push	10h
		mov	al, byte_25590
		mov	ah, 0
		push	ax
		push	PLAYFIELD_BOTTOM - 1
		call	grcg_byteboxfill_x
		call	grcg_off
		call	sigma_158DC
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25592
		jle	loc_15D51
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25594
		jge	loc_15D51
		mov	_player_is_hit, 1
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15C25:
		cmp	_boss_phase_frame, 180
		jge	loc_15CBC
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	al, byte_2558F
		mov	ah, 0
		push	ax
		push	10h
		mov	al, byte_25590
		mov	ah, 0
		push	ax
		push	PLAYFIELD_BOTTOM - 1
		call	grcg_byteboxfill_x
		call	grcg_off
		mov	ax, _boss_phase_frame
		mov	bx, 10
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_15C67
		add	patnum_2064E, 2

loc_15C67:
		call	sigma_158DC
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25592
		jle	short loc_15C95
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25594
		jge	short loc_15C95
		mov	_player_is_hit, 1

loc_15C95:
		mov	ax, _boss_phase_frame
		and	ax, 1
		mov	si, ax
		mov	ax, RES_Y
		sub	ax, _scroll_line
		push	ax
		mov	ax, _scroll_line
		imul	ax, 40
		add	ax, si
		push	ax
		push	si
		call	graph_scroll
		mov	_slowdown_factor, 2
		jmp	loc_15D51
; ---------------------------------------------------------------------------

loc_15CBC:
		cmp	_boss_phase_frame, 220
		jg	short loc_15D1C
		mov	_slowdown_factor, 1
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		mov	al, byte_2558F
		mov	ah, 0
		push	ax
		push	10h
		mov	al, byte_25590
		mov	ah, 0
		push	ax
		push	PLAYFIELD_BOTTOM - 1
		call	grcg_byteboxfill_x
		call	grcg_off
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25592
		jle	short loc_15D51
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_left_on_page[bx]
		cmp	ax, word_25594
		jge	short loc_15D51
		mov	_player_is_hit, 1
		jmp	short loc_15D51
; ---------------------------------------------------------------------------

loc_15D1C:
		cmp	_boss_phase_frame, 224
		jge	short loc_15D4C
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		mov	al, byte_2558F
		mov	ah, 0
		push	ax
		push	10h
		mov	al, byte_25590
		mov	ah, 0
		push	ax
		push	PLAYFIELD_BOTTOM - 1
		call	grcg_byteboxfill_x
		call	grcg_off
		jmp	short loc_15D51
; ---------------------------------------------------------------------------

loc_15D4C:
		mov	ax, 1
		jmp	short loc_15D53
; ---------------------------------------------------------------------------

loc_15D51:
		xor	ax, ax

loc_15D53:
		pop	si
		pop	bp
		retn
sigma_15A25	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15D56	proc near

@@angle		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		cmp	_boss_phase_frame, 20
		jl	loc_15E81
		cmp	_boss_phase_frame, 20
		jnz	short loc_15D83
		mov	byte_25596, 0
		cmp	_player_topleft.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - (PLAYER_W / 2))
		jge	short loc_15D7E
		mov	al, 1
		jmp	short loc_15D80
; ---------------------------------------------------------------------------

loc_15D7E:
		mov	al, -1

loc_15D80:
		mov	byte_25597, al

loc_15D83:
		mov	ax, _boss_phase_frame
		mov	bx, 4
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_15D9A
		call	_snd_se_play c, 3

loc_15D9A:
		cmp	_boss_phase_frame, 148
		jge	short loc_15DB7
		mov	al, byte_25597
		cbw
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		test	byte ptr _boss_phase_frame, 1
		jz	loc_15E81
		jmp	short loc_15DF2
; ---------------------------------------------------------------------------

loc_15DB7:
		cmp	_boss_phase_frame, 212
		jge	short loc_15DD7
		mov	al, byte_25597
		cbw
		shl	ax, 2
		mov	bx, _boss_left_on_back_page
		sub	[bx], ax
		test	byte ptr _boss_phase_frame, 1
		jz	loc_15E81
		jmp	short loc_15DF2
; ---------------------------------------------------------------------------

loc_15DD7:
		cmp	_boss_phase_frame, 340
		jge	short loc_15E19
		mov	al, byte_25597
		cbw
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		test	byte ptr _boss_phase_frame, 1
		jz	loc_15E81

loc_15DF2:
		call	@randring2_next8_and$quc pascal, 7Fh
		mov	ah, 0
		add	ax, point_254E6.x
		push	ax	; left
		mov	ax, point_254E6.y
		add	ax, 64
		push	ax	; top
		push	40h	; angle
		push	BG_1	; group
		call	@randring2_next8_and$quc pascal, 1Fh
		mov	ah, 0
		add	ax, ((1 shl 4) + 14)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	short loc_15E81
; ---------------------------------------------------------------------------

loc_15E19:
		cmp	_boss_phase_frame, 440
		jge	short loc_15E7B
		inc	byte_25596
		call	@randring2_next8$qv
		mov	ah, 0
		mov	dl, byte_25596
		mov	dh, 0
		add	dx, dx
		push	dx
		cwd
		pop	bx
		idiv	bx
		mov	al, 40h
		sub	al, byte_25596
		add	dl, al
		mov	[bp+@@angle], dl
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_15E81
		xor	si, si
		jmp	short loc_15E74
; ---------------------------------------------------------------------------

loc_15E4D:
		call	@randring2_next8_and$quc pascal, 7Fh
		mov	ah, 0
		add	ax, point_254E6.x
		push	ax	; left
		mov	ax, point_254E6.y
		add	ax, 64
		push	ax	; top
		push	word ptr [bp+@@angle]	; angle
		push	BG_1	; group
		call	@randring2_next8_and$quc pascal, 1Fh
		mov	ah, 0
		add	ax, ((1 shl 4) + 14)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		inc	si

loc_15E74:
		cmp	si, 3
		jl	short loc_15E4D
		jmp	short loc_15E81
; ---------------------------------------------------------------------------

loc_15E7B:
		mov	_boss_phase_frame, 0

loc_15E81:
		pop	si
		leave
		retn
sigma_15D56	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15E84	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 100
		jl	short loc_15EF5
		cmp	_boss_phase_frame, 100
		jnz	short loc_15EAD
		mov	byte_2558C, 7
		mov	byte_2558D, 4
		push	80h

loc_15EA2:
		push	1400040h
		call	sigma_155C5
		jmp	short loc_15EE7
; ---------------------------------------------------------------------------

loc_15EAD:
		cmp	_boss_phase_frame, 120
		jnz	short loc_15EB9
		push	140h
		jmp	short loc_15EA2
; ---------------------------------------------------------------------------

loc_15EB9:
		cmp	_boss_phase_frame, 130
		jle	short loc_15EE7
		cmp	_boss_phase_frame, 150
		jge	short loc_15EE7
		mov	ax, _boss_phase_frame
		mov	bx, 4
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_15EE7
		call	@bullets_add_pellet$qiiucuci pascal, left_253B6, top_253B8, 00h, BG_5_SPREAD_MEDIUM_AIMED, ((7 shl 4) + 8)

loc_15EE7:
		cmp	_boss_phase_frame, 200
		jle	short loc_15EF5
		mov	_boss_phase_frame, 0

loc_15EF5:
		pop	bp
		retn
sigma_15E84	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15EF7	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jge	short loc_15F06
		mov	ax, 1
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_15F06:
		cmp	_boss_phase_frame, 50
		jnz	short loc_15F1E
		cmp	_player_topleft.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - (PLAYER_W / 2))
		jge	short loc_15F19
		mov	al, 1
		jmp	short loc_15F1B
; ---------------------------------------------------------------------------

loc_15F19:
		mov	al, -1

loc_15F1B:
		mov	byte_25598, al

loc_15F1E:
		cmp	_boss_phase_frame, 114
		jge	short loc_15F37
		mov	al, byte_25598
		cbw
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		mov	bx, _boss_top_on_back_page
		inc	word ptr [bx]
		jmp	short loc_15F6B
; ---------------------------------------------------------------------------

loc_15F37:
		cmp	_boss_phase_frame, 242
		jge	short loc_15F4B
		mov	al, byte_25598
		cbw
		mov	bx, _boss_left_on_back_page
		sub	[bx], ax
		jmp	short loc_15F6B
; ---------------------------------------------------------------------------

loc_15F4B:
		cmp	_boss_phase_frame, 306
		jge	short loc_15F65
		mov	al, byte_25598
		cbw
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		mov	bx, _boss_top_on_back_page
		dec	word ptr [bx]
		jmp	short loc_15F6B
; ---------------------------------------------------------------------------

loc_15F65:
		mov	_boss_phase_frame, 0

loc_15F6B:
		xor	ax, ax
		pop	bp
		retn
sigma_15EF7	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15F6F	proc near
		push	bp
		mov	bp, sp
		call	sigma_15EF7
		or	ax, ax
		jnz	short loc_15F93
		test	byte ptr _boss_phase_frame, 1Fh
		jnz	short loc_15F93
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_32_RING	; group
		push	((5 shl 4) + 5)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_15F93:
		pop	bp
		retn
sigma_15F6F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_15F95	proc near

@@angle		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		cmp	_boss_phase_frame, 50
		jl	loc_16172
		cmp	_boss_phase_frame, 50
		jnz	short loc_15FB7
		call	_snd_se_play c, 9

loc_15FB7:
		cmp	_boss_phase_frame, 100
		jge	short loc_15FCF
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, 128
		mov	patnum_2064E, ax
		jmp	loc_16172
; ---------------------------------------------------------------------------

loc_15FCF:
		cmp	_boss_phase_frame, 100
		jnz	short loc_15FFD
		mov	ax, _player_topleft.x
		add	ax, 16
		mov	word_2559A, ax
		mov	ax, _player_topleft.y
		add	ax, 16
		mov	word_2559C, ax
		mov	byte_2558C, 3
		mov	byte_2558D, 0FCh
		mov	angle_2559E, 0
		mov	patnum_2064E, 128

loc_15FFD:
		cmp	_boss_phase_frame, 130
		jge	short loc_1604A
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1601A
		push	(GC_RMW shl 16) + V_WHITE
		jmp	short loc_1602E
; ---------------------------------------------------------------------------

loc_1601A:
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		cmp	dx, 2
		jnz	short loc_16042
		push	(GC_RMW shl 16) + 0

loc_1602E:
		call	grcg_setcolor
		call	grcg_circle pascal, word_2559A, word_2559C, 112

loc_16042:
		call	grcg_off
		jmp	loc_16172
; ---------------------------------------------------------------------------

loc_1604A:
		cmp	_boss_phase_frame, 450
		jge	loc_16146
		cmp	_page_back, 0
		jnz	short loc_1607A
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		call	grcg_circle pascal, word_2559A, word_2559C, 112
		call	grcg_off

loc_1607A:
		cmp	_boss_phase_frame, 150
		jl	loc_16172
		mov	ax, _boss_phase_frame
		mov	bx, 12
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_16122
		mov	al, angle_2559E
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _CosTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_2559A
		mov	si, ax
		mov	al, angle_2559E
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _SinTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_2559C
		mov	di, ax
		push	si
		push	ax
		push	18h
		call	sigma_155C5
		mov	al, angle_2559E
		add	al, 80h
		mov	[bp+@@angle], al
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _CosTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_2559A
		mov	si, ax
		mov	al, [bp+@@angle]
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _SinTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_2559C
		mov	di, ax
		push	si
		push	ax
		push	18h
		call	sigma_155C5
		mov	al, angle_2559E
		add	al, -10h
		mov	angle_2559E, al

loc_16122:
		cmp	_boss_phase_frame, 200
		jl	short loc_16172
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	short loc_16172
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_32_RING	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	short loc_16172
; ---------------------------------------------------------------------------

loc_16146:
		cmp	_page_back, 0
		jnz	short loc_16172
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_circle pascal, word_2559A, word_2559C, 112
		call	grcg_off
		mov	_boss_phase_frame, 0

loc_16172:
		pop	di
		pop	si
		leave
		retn
sigma_15F95	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_16176	proc near
		push	bp
		mov	bp, sp
		call	sigma_15EF7
		or	ax, ax
		jnz	short loc_1619A
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_1619A
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_16_RING	; group
		push	((3 shl 4) + 2)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1619A:
		pop	bp
		retn
sigma_16176	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_1619C	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_162D1
		cmp	_boss_phase_frame, 50
		jnz	short loc_161B9
		call	_snd_se_play c, 9

loc_161B9:
		cmp	_boss_phase_frame, 100
		jge	short loc_161D0
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, 128
		mov	patnum_2064E, ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_161D0:
		cmp	_boss_phase_frame, 100
		jnz	short loc_161EE
		mov	patnum_2064E, 128
		mov	left_255A0, PLAYFIELD_LEFT
		mov	byte_255A2, 0
		mov	bullet_special_turns_max, 1

loc_161EE:
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	loc_162D1
		push	left_255A0	; left
		push	(PLAYFIELD_TOP + 8)	; top
		push	40h	; angle
		push	BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM	; group
		mov	al, byte_255A2
		mov	ah, 0
		add	ax, PAT_BULLET16_BILLIARD_BALL_RED
		push	ax	; patnum
		push	(4 shl 4)	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	ax, (PLAYFIELD_RIGHT + BULLET16_W)
		sub	ax, left_255A0
		push	ax	; left
		push	(PLAYFIELD_TOP + 8)	; top
		push	40h	; angle
		push	BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM	; group
		mov	al, byte_255A2
		mov	ah, 0
		add	ax, PAT_BULLET16_BILLIARD_BALL_RED
		push	ax	; patnum
		push	(4 shl 4)	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		add	left_255A0, BULLET16_W
		cmp	left_255A0, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2))
		jnz	short loc_162B2
		mov	byte_23A70, 20h	; ' '
		mov	ax, point_254E6.x
		add	ax, 60
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	byte_23A70, 30h	; '0'
		mov	ax, point_254E6.x
		add	ax, 44
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	ax, point_254E6.x
		add	ax, 76
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	byte_23A70, 64h	; 'd'
		mov	ax, point_254E6.x
		add	ax, 28
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	ax, point_254E6.x
		add	ax, 92
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	byte_23A70, 10h

loc_162B2:
		cmp	left_255A0, (PLAYFIELD_RIGHT + BULLET16_W)
		jl	short loc_162D1
		mov	left_255A0, PLAYFIELD_LEFT
		inc	byte_255A2
		cmp	byte_255A2, 2
		jb	short loc_162D1
		mov	_boss_phase_frame, 0

loc_162D1:
		pop	bp
		retn
sigma_1619C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_162D3	proc near

var_E		= word ptr -0Eh
@@angle	= byte ptr -0Bh
var_A	= word ptr -0Ah

		push	bp
		mov	bp, sp
		sub	sp, 0Eh
		push	si
		push	di
		mov	si, 13AEh
		lea	di, [bp+var_A]
		push	ss
		pop	es
		mov	cx, 5
		rep movsw
		call	sigma_15EF7
		or	ax, ax
		jnz	loc_1641D
		cmp	_boss_phase_frame, 100
		jnz	short loc_16300
		mov	byte_255A3, 0
		jmp	loc_1641D
; ---------------------------------------------------------------------------

loc_16300:
		cmp	_boss_phase_frame, 114
		jz	short loc_1634B
		cmp	_boss_phase_frame, 118
		jz	short loc_16325
		cmp	_boss_phase_frame, 122
		jz	short loc_1637C
		cmp	_boss_phase_frame, 242
		jz	short loc_1634B
		cmp	_boss_phase_frame, 246
		jnz	short loc_16374

loc_16325:
		mov	al, byte_255A3
		inc	byte_255A3
		cbw
		add	ax, ax
		lea	dx, [bp+var_A]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		add	ax, point_254E6.x
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19

loc_1634B:
		mov	al, byte_255A3
		inc	byte_255A3
		cbw
		add	ax, ax
		lea	dx, [bp+var_A]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		add	ax, point_254E6.x
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		jmp	loc_1641D
; ---------------------------------------------------------------------------

loc_16374:
		cmp	_boss_phase_frame, 250
		jnz	short loc_163CB

loc_1637C:
		mov	al, byte_255A3
		inc	byte_255A3
		cbw
		add	ax, ax
		lea	dx, [bp+var_A]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		add	ax, point_254E6.x
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	al, byte_255A3
		cbw
		add	ax, ax
		lea	dx, [bp+var_A]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		add	ax, point_254E6.x
		push	ax
		push	top_253B8
		push	1006Fh
		call	sub_12A19
		mov	byte_255A3, 0
		jmp	short loc_1641D
; ---------------------------------------------------------------------------

loc_163CB:
		cmp	_boss_phase_frame, 120
		jle	short loc_1641D
		cmp	_boss_phase_frame, 240
		jge	short loc_1641D
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	short loc_1641D
		mov	[bp+@@angle], -70h
		mov	[bp+var_E], 0
		jmp	short loc_16417
; ---------------------------------------------------------------------------

loc_163EC:
		push	left_253B6	; left
		push	top_253B8	; top
		push	word ptr [bp+@@angle]	; angle
		push	BSM_BOUNCE_LEFT_RIGHT_TOP_BOTTOM	; group
		mov	ax, [bp+var_E]
		mov	bx, 2
		cwd
		idiv	bx
		add	dx, PAT_BULLET16_BILLIARD_BALL_RED
		push	dx	; patnum
		push	(3 shl 4) + 12	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	al, [bp+@@angle]
		add	al, 10h
		mov	[bp+@@angle], al
		inc	[bp+var_E]

loc_16417:
		cmp	[bp+@@angle], -10h
		jb	short loc_163EC

loc_1641D:
		pop	di
		pop	si
		leave
		retn
sigma_162D3	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_16421	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	_boss_phase_frame, 50
		jl	locret_16553
		cmp	_boss_phase_frame, 50
		jnz	short loc_16441
		call	_snd_se_play c, 9

loc_16441:
		cmp	_boss_phase_frame, 100
		jge	short loc_16458
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, 128
		mov	patnum_2064E, ax
		leave
		retn
; ---------------------------------------------------------------------------

loc_16458:
		cmp	_boss_phase_frame, 100
		jnz	short loc_164AD
		push	left_253B6
		push	top_253B8
		mov	ax, _player_topleft.x
		add	ax, 16
		push	ax
		mov	ax, _player_topleft.y
		add	ax, 16
		push	ax
		push	0
		push	ds
		push	offset point_255A4.x
		push	ds
		push	offset point_255A4.y
		push	48
		call	@vector2_between_plus$qiiiiucmit6i
		mov	ax, point_255A4.x
		neg	ax
		mov	word_255AC, ax
		mov	patnum_2064E, 128
		mov	ax, left_253B6
		mov	word_255A8, ax
		mov	word_255AE, ax
		mov	byte_2558D, 0FCh
		mov	byte_2558C, 3
		mov	ax, top_253B8
		mov	word_255AA, ax

loc_164AD:
		test	byte ptr _boss_phase_frame, 7
		jnz	locret_16553
		push	word_255A8
		push	word_255AA
		push	30h ; '0'
		call	sigma_155C5
		mov	[bp+var_2], ax
		push	word_255AE
		push	word_255AA
		push	30h ; '0'
		call	sigma_155C5
		or	ax, ax
		jz	short loc_164E3
		cmp	[bp+var_2], 0
		jz	short loc_164E3
		mov	_boss_phase_frame, 0

loc_164E3:
		mov	ax, point_255A4.x
		add	word_255A8, ax
		mov	ax, word_255AC
		add	word_255AE, ax
		mov	ax, point_255A4.y
		add	word_255AA, ax
		mov	ax, _player_topleft.x
		add	ax, 16
		cmp	ax, word_255A8
		jle	short loc_1650B
		add	word_255A8, 10h
		jmp	short loc_1651C
; ---------------------------------------------------------------------------

loc_1650B:
		mov	ax, _player_topleft.x
		add	ax, 16
		cmp	ax, word_255A8
		jge	short loc_1651C
		sub	word_255A8, 10h

loc_1651C:
		mov	ax, _player_topleft.x
		add	ax, 16
		cmp	ax, word_255AE
		jle	short loc_1652F
		sub	word_255AE, 10h
		jmp	short loc_16540
; ---------------------------------------------------------------------------

loc_1652F:
		mov	ax, _player_topleft.x
		add	ax, 16
		cmp	ax, word_255AE
		jge	short loc_16540
		add	word_255AE, 10h

loc_16540:
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_16_RING	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci

locret_16553:
		leave
		retn
sigma_16421	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_16555	proc near
		push	bp
		mov	bp, sp
		call	sigma_15EF7
		or	ax, ax
		jnz	short loc_165A3
		cmp	_boss_phase_frame, 50
		jnz	short loc_1656B
		mov	byte_2558C, 7

loc_1656B:
		mov	ax, _boss_phase_frame
		and	ax, 3Fh
		cmp	ax, 32
		jnz	short loc_16589
		mov	ax, _player_topleft.x
		add	ax, 16
		push	ax
		mov	ax, _player_topleft.y
		add	ax, 16
		push	ax
		push	30h ; '0'
		call	sigma_155C5

loc_16589:
		test	byte ptr _boss_phase_frame, 3Fh
		jnz	short loc_165A3
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_32_RING	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_165A3:
		pop	bp
		retn
sigma_16555	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_165A5	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jge	short loc_165B4
		mov	ax, 1
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_165B4:
		cmp	_boss_phase_frame, 50
		jnz	short loc_165CC
		cmp	_player_topleft.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - (PLAYER_W / 2))
		jge	short loc_165C7
		mov	al, 2
		jmp	short loc_165C9
; ---------------------------------------------------------------------------

loc_165C7:
		mov	al, 0FEh

loc_165C9:
		mov	byte_255B0, al

loc_165CC:
		cmp	_boss_phase_frame, 130
		jl	short loc_165F0
		cmp	_boss_phase_frame, 290
		jge	short loc_165E8
		mov	al, byte_255B0
		cbw
		mov	bx, _boss_left_on_back_page
		sub	[bx], ax
		jmp	short loc_16602
; ---------------------------------------------------------------------------

loc_165E8:
		cmp	_boss_phase_frame, 370
		jge	short loc_165FC

loc_165F0:
		mov	al, byte_255B0
		cbw
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		jmp	short loc_16602
; ---------------------------------------------------------------------------

loc_165FC:
		mov	_boss_phase_frame, 0

loc_16602:
		xor	ax, ax
		pop	bp
		retn
sigma_165A5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_16606	proc near
		push	bp
		mov	bp, sp
		call	sigma_165A5
		or	ax, ax
		jnz	short loc_1664E
		cmp	_boss_phase_frame, 50
		jnz	short loc_1661C
		mov	byte_2558C, 7

loc_1661C:
		test	byte ptr _boss_phase_frame, 3Fh
		jnz	short loc_16636
		mov	ax, _player_topleft.x
		add	ax, 16
		push	ax
		mov	ax, _player_topleft.y
		add	ax, 16
		push	ax
		push	30h ; '0'
		call	sigma_155C5

loc_16636:
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_1664E
		call	@bullets_add_pellet$qiiucuci pascal, left_253B6, top_253B8, 00h, BG_2_SPREAD_ULTRAWIDE_AIMED, ((4 shl 4) + 6)

loc_1664E:
		pop	bp
		retn
sigma_16606	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_16650	proc near
		push	bp
		mov	bp, sp
		call	sigma_165A5
		or	ax, ax
		jnz	short loc_1668C
		cmp	_boss_phase_frame, 50
		jnz	short loc_16666
		mov	angle_255B1, 0

loc_16666:
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_1668C
		push	left_253B6	; left
		push	top_253B8	; top
		push	word ptr angle_255B1	; angle
		push	BG_8_RING	; group
		push	(PAT_BULLET16_BALL shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	al, angle_255B1
		add	al, 08h
		mov	angle_255B1, al

loc_1668C:
		pop	bp
		retn
sigma_16650	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_1668E	proc near
		push	bp
		mov	bp, sp
		call	sigma_165A5
		or	ax, ax
		jnz	short loc_166DC
		cmp	_boss_phase_frame, 50
		jnz	short loc_166A4
		mov	byte_2558C, 7

loc_166A4:
		test	byte ptr _boss_phase_frame, 1Fh
		jnz	short loc_166BE
		mov	ax, _player_topleft.x
		add	ax, 16
		push	ax
		mov	ax, _player_topleft.y
		add	ax, 16
		push	ax
		push	30h ; '0'
		call	sigma_155C5

loc_166BE:
		mov	ax, _boss_phase_frame
		and	ax, 1Fh
		cmp	ax, 16
		jnz	short loc_166DC
		push	left_253B6	; left
		push	top_253B8	; top
		call	@randring2_next8$qv
		push	ax	; angle
		push	BG_16_RING	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_166DC:
		pop	bp
		retn
sigma_1668E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_166DE	proc far

arg_0		= word ptr  6

		push	bp
		mov	bp, sp
		mov	al, byte_255B4
		mov	ah, 0
		or	ax, ax
		jz	short loc_166F6
		cmp	ax, 1
		jz	short loc_166FC
		cmp	ax, 2
		jz	short loc_16702
		jmp	short loc_16706
; ---------------------------------------------------------------------------

loc_166F6:
		call	fp_255B6
		jmp	short loc_16706
; ---------------------------------------------------------------------------

loc_166FC:
		call	fp_255B8
		jmp	short loc_16706
; ---------------------------------------------------------------------------

loc_16702:
		call	fp_255BA

loc_16706:
		cmp	_boss_phase_frame, 0
		jnz	short loc_16742
		inc	byte_255B4
		mov	al, byte_255B4
		mov	ah, 0
		cmp	ax, [bp+arg_0]
		jl	short loc_16725
		mov	byte_255B4, 0
		mov	byte_255B3, 1

loc_16725:
		mov	ax, _boss_damage
		cmp	ax, word_255BC
		jl	short loc_16742
		mov	_boss_damage, 0
		inc	byte_255B2
		mov	byte_255B4, 0
		mov	byte_255B3, 0

loc_16742:
		pop	bp
		retf
sigma_166DE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_update	proc far

var_1		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_254E6.x, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	point_254E6.y, ax
		mov	ax, point_254E6.x
		add	ax, 60
		mov	left_253B6, ax
		mov	ax, point_254E6.y
		add	ax, 60
		mov	top_253B8, ax
		inc	_boss_phase_frame
		mov	ax, left_253B6
		mov	word_205D8, ax
		mov	ax, top_253B8
		mov	word_205DA, ax
		test	byte ptr _stage_frame, 1
		jnz	short loc_167D0
		mov	al, byte_255BE
		add	al, 8
		mov	byte_255BE, al
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 4
		xor	si, si
		mov	al, byte_255BE
		jmp	short loc_167C3
; ---------------------------------------------------------------------------

loc_167A0:
		push	0E000C8h
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		mov	al, _reduce_effects
		mov	ah, 0
		imul	ax, 0Eh
		add	ax, 2
		push	ax
		call	sub_1C287
		inc	si
		mov	al, [bp+var_1]
		add	al, 80h

loc_167C3:
		mov	[bp+var_1], al
		cmp	si, 2
		jl	short loc_167A0
		call	grcg_off

loc_167D0:
		cmp	byte_2066A, 0
		jz	short loc_167E6
		call	sigma_15A25
		or	ax, ax
		jz	loc_16962
		mov	ax, 2
		jmp	loc_16968
; ---------------------------------------------------------------------------

loc_167E6:
		cmp	byte_255B2, 0
		jnz	short loc_16825
		cmp	_boss_phase_frame, 50
		jle	loc_16948
		mov	byte_255B4, 0
		mov	_boss_phase_frame, 0
		inc	byte_255B2
		mov	byte_255B3, 0
		mov	fp_255B6, offset sigma_15D56
		mov	fp_255B8, offset sigma_15E84
		mov	fp_255BA, offset sigma_15F6F
		mov	word_255BC, 708h
		jmp	loc_16948
; ---------------------------------------------------------------------------

loc_16825:
		cmp	byte_255B2, 1
		jnz	short loc_16838
		push	3
		call	sigma_166DE
		add	sp, 2
		jmp	loc_16948
; ---------------------------------------------------------------------------

loc_16838:
		cmp	byte_255B2, 2
		jnz	short loc_16868
		mov	byte_255B4, 0
		mov	_boss_phase_frame, 0
		inc	byte_255B2
		mov	byte_255B3, 0
		mov	fp_255B6, offset sigma_15F95
		mov	fp_255B8, offset sigma_16176
		mov	word_255BC, 708h
		jmp	loc_16948
; ---------------------------------------------------------------------------

loc_16868:
		cmp	byte_255B2, 3
		jz	short loc_168DC
		cmp	byte_255B2, 4
		jnz	short loc_1689F
		mov	byte_255B4, 0
		mov	_boss_phase_frame, 0
		inc	byte_255B2
		mov	byte_255B3, 0
		mov	fp_255B6, offset sigma_1619C
		mov	fp_255B8, offset sigma_162D3
		mov	word_255BC, 708h
		jmp	loc_16948
; ---------------------------------------------------------------------------

loc_1689F:
		cmp	byte_255B2, 5
		jz	short loc_168DC
		cmp	byte_255B2, 6
		jnz	short loc_168D5
		mov	byte_255B4, 0
		mov	_boss_phase_frame, 0
		inc	byte_255B2
		mov	byte_255B3, 0
		mov	fp_255B6, offset sigma_16421
		mov	fp_255B8, offset sigma_16555
		mov	word_255BC, 708h
		jmp	short loc_16948
; ---------------------------------------------------------------------------

loc_168D5:
		cmp	byte_255B2, 7
		jnz	short loc_168E7

loc_168DC:
		push	2
		call	sigma_166DE
		add	sp, 2
		jmp	short loc_16948
; ---------------------------------------------------------------------------

loc_168E7:
		cmp	byte_255B2, 8
		jnz	short loc_1691C
		mov	byte_255B4, 0
		mov	_boss_phase_frame, 0
		inc	byte_255B2
		mov	byte_255B3, 0
		mov	fp_255B6, offset sigma_16606
		mov	fp_255B8, offset sigma_16650
		mov	fp_255BA, offset sigma_1668E
		mov	word_255BC, 1388h
		jmp	short loc_16948
; ---------------------------------------------------------------------------

loc_1691C:
		cmp	byte_255B2, 9
		jnz	short loc_16948
		push	3
		call	sigma_166DE
		add	sp, 2
		cmp	_boss_damage, 1300
		jl	short loc_16948
		mov	byte_2066A, 1
		add	_score, 300000
		mov	_boss_phase_frame, 0

loc_16948:
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_254E6.x, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	point_254E6.y, ax
		call	sigma_15907
		inc	_sigma_frames

loc_16962:
		call	sigma_1566F
		mov	ax, 1

loc_16968:
		pop	si
		leave
		retf
sigma_update	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_init	proc far
		push	bp
		mov	bp, sp
		call	sub_1A6C5
		mov	_tile_mode, TM_NONE
		call	@dialog_pre$qv
		call	super_clean pascal, (128 shl 16) or 192
		mov	super_patnum, 80h
		call	super_entry_bfnt pascal, ds, offset aStage5b1_bft ; "stage5b1.bft"
		call	super_entry_bfnt pascal, ds, offset aStage5b2_bft ; "stage5b2.bft"
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		call	@dialog_script_extra_pre_intro_an$qv
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 64)
		mov	_boss_left_on_page[1 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 64)
		mov	point_254E6.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 64)
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP + 32)
		mov	_boss_top_on_page[1 * word], (PLAYFIELD_TOP + 32)
		mov	point_254E6.y, (PLAYFIELD_TOP + 32)
		mov	_boss_damage, 0
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128
		mov	byte_255B2, 0
		mov	byte_2558C, 7
		nopcall	sub_10E0A
		call	sub_D376
		push	1
		call	palette_white_out
		call	sigma_158DC
		push	ds
		push	offset aBoss5_m	; "boss5.m"
		nopcall	sub_13ABB
		add	sp, 4
		push	1
		call	palette_white_in
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_PREBOSS
		call	@dialog_post$qv
		pop	bp
		retf
sigma_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sigma_end	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_POSTBOSS
		call	@stage_extra_clear_bonus_animate$qv
		call	@key_delay$qv
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.stage], 7Fh
		mov	eax, _score
		imul	eax, 10
		movzx	edx, es:[bx+mikoconfig_t.continues_used]
		add	eax, edx
		mov	es:[bx+mikoconfig_t.score], eax
		call	sub_1CDD6
		call	@GameExecl$qnxc c, offset aMaine, ds	; "maine"
		pop	bp
		retf
sigma_end	endp

; ---------------------------------------------------------------------------

loc_16A66:
		push	bp
		mov	bp, sp
		pop	bp
		retf

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16A6B	proc far
		push	bp
		mov	bp, sp
		xor	ax, ax
		jmp	short loc_16A7D
; ---------------------------------------------------------------------------

loc_16A72:
		mov	bx, ax
		imul	bx, 26h
		mov	byte ptr [bx+7B5Eh], 0
		inc	ax

loc_16A7D:
		cmp	ax, 19h
		jl	short loc_16A72
		mov	word_1EE50, 0
		pop	bp
		retf
sub_16A6B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16A8A	proc far
		push	bp
		mov	bp, sp
		setfarfp	farfp_26C3C, loc_16A66
		setfarfp	farfp_26C40, loc_16A66
		pop	bp
		retf
sub_16A8A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16AA7	proc near

@@angle		= word ptr  4

		push	bp
		mov	bp, sp
		mov	bx, word_26C48
		mov	ax, [bx+4]
		mov	bx, word_26C4A
		add	ax, [bx]
		push	ax	; left
		mov	bx, word_26C48
		mov	ax, [bx+6]
		mov	bx, word_26C4C
		add	ax, [bx]
		push	ax	; top
		push	[bp+@@angle]	; angle
		mov	bx, word_26C46
		push	word ptr [bx+24h]	; group
		mov	al, [bx+25h]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		pop	bp
		retn	2
sub_16AA7	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16ADD	proc near
		push	bp
		mov	bp, sp
		mov	bx, word_26C52
		mov	al, [bx]
		cbw
		mov	bx, word_26C4A
		add	[bx], ax
		mov	bx, word_26C54
		mov	al, [bx]
		cbw
		mov	bx, word_26C4C
		add	[bx], ax
		pop	bp
		retn
sub_16ADD	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16AFC	proc near

@@vector_y		= word ptr -6
@@vector_x		= word ptr -4
@@y2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 6
		mov	ax, _player_topleft.y
		add	ax, 16
		mov	[bp+@@y2], ax
		mov	bx, word_26C4A
		push	word ptr [bx]
		mov	bx, word_26C4C
		push	word ptr [bx]
		mov	ax, _player_topleft.x
		add	ax, 24
		push	ax
		push	[bp+@@y2]
		push	0
		push	ss
		lea	ax, [bp+@@vector_x]
		push	ax
		push	ss
		lea	ax, [bp+@@vector_y]
		push	ax
		mov	bx, word_26C46
		mov	bx, [bx+8]
		add	bx, word_26C44
		mov	al, [bx+2]
		mov	ah, 0
		push	ax
		call	@vector2_between_plus$qiiiiucmit6i
		mov	bx, word_26C52
		mov	al, byte ptr [bp+@@vector_x]
		mov	[bx], al
		mov	bx, word_26C54
		mov	al, byte ptr [bp+@@vector_y]
		mov	[bx], al
		mov	bx, word_26C4A
		mov	ax, [bp+@@vector_x]
		add	[bx], ax
		mov	bx, word_26C4C
		mov	ax, [bp+var_6]
		add	[bx], ax
		leave
		retn
sub_16AFC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16B69	proc near

@@angle		= byte ptr -5
@@vector_y		= word ptr -4
@@vector_x		= word ptr -2
arg_0		= word ptr  4
arg_2		= word ptr  6

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		mov	bx, word_26C46
		mov	ax, [bx+8]
		add	ax, [bp+arg_2]
		mov	si, ax
		mov	bx, word_26C44
		mov	al, [bx+si+1]
		mov	ah, 0
		mov	bx, word_26C46
		push	ax
		mov	ax, [bx+0Ah]
		cwd
		pop	bx
		idiv	bx
		or	dx, dx
		jnz	short loc_16B9F
		mov	bx, word_26C46
		mov	ax, [bp+arg_0]
		add	[bx+16h], ax

loc_16B9F:
		mov	bx, word_26C44
		mov	al, [bx+si]
		mov	bx, word_26C46
		add	al, [bx+16h]
		mov	[bp+@@angle], al
		push	ss
		lea	ax, [bp+@@vector_x]
		push	ax
		push	ss
		lea	ax, [bp+@@vector_y]
		push	ax
		push	word ptr [bp+@@angle]
		mov	bx, word_26C44
		mov	al, [bx+si+2]
		mov	ah, 0
		push	ax
		call	@vector2$qmit1uci
		mov	bx, word_26C4A
		mov	ax, [bp+@@vector_x]
		add	[bx], ax
		mov	bx, word_26C4C
		mov	ax, [bp+@@vector_y]
		add	[bx], ax
		mov	bx, word_26C52
		mov	al, byte ptr [bp+@@vector_x]
		mov	[bx], al
		mov	bx, word_26C54
		mov	al, byte ptr [bp+@@vector_y]
		mov	[bx], al
		pop	si
		leave
		retn	4
sub_16B69	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16BF4	proc near

@@angle		= byte ptr -0Fh
var_E		= word ptr -0Eh
@@vector_y		= word ptr -0Ch
@@vector_x		= word ptr -0Ah
var_8		= dword	ptr -8
var_4		= dword	ptr -4

		push	bp
		mov	bp, sp
		sub	sp, 10h
		push	si
		mov	ax, word_26C4A
		mov	word ptr [bp+var_4+2], ds
		mov	word ptr [bp+var_4], ax
		mov	ax, word_26C4C
		mov	word ptr [bp+var_8+2], ds
		mov	word ptr [bp+var_8], ax
		mov	bx, word_26C46
		mov	ax, [bx+8]
		add	ax, 2
		mov	si, ax
		mov	bx, si
		inc	si
		add	bx, word_26C44
		cmp	byte ptr [bx], 0
		jnz	short loc_16C2A
		mov	ax, -1
		jmp	short loc_16C2D
; ---------------------------------------------------------------------------

loc_16C2A:
		mov	ax, 1

loc_16C2D:
		mov	[bp+var_E], ax
		mov	bx, word_26C44
		mov	al, [bx+si]
		mov	bx, word_26C46
		add	al, [bx+16h]
		mov	[bp+@@angle], al
		inc	si
		mov	bx, word_26C44
		mov	al, [bx+si]
		mov	ah, 0
		imul	[bp+var_E]
		mov	bx, word_26C46
		add	[bx+16h], ax
		inc	si
		push	ss
		lea	ax, [bp+@@vector_x]
		push	ax
		push	ss
		lea	ax, [bp+@@vector_y]
		push	ax
		push	word ptr [bp+@@angle]
		mov	bx, word_26C44
		mov	al, [bx+si]
		mov	ah, 0
		push	ax
		call	@vector2$qmit1uci
		les	bx, [bp+var_4]
		mov	ax, [bp+@@vector_x]
		add	es:[bx], ax
		les	bx, [bp+var_8]
		mov	ax, [bp+@@vector_y]
		add	es:[bx], ax
		mov	bx, word_26C52
		mov	al, byte ptr [bp+@@vector_x]
		mov	[bx], al
		mov	bx, word_26C54
		mov	al, byte ptr [bp+@@vector_y]
		mov	[bx], al
		pop	si
		leave
		retn
sub_16BF4	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16C96	proc near

arg_0		= word ptr  4
arg_2		= word ptr  6
arg_4		= word ptr  8
arg_6		= word ptr  0Ah

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+arg_6]
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B5Eh], 1
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	[bx+7B50h], si
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, [bp+arg_4]
		mov	[bx+7B52h], ax
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B62h], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B58h], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	ax, [bp+arg_0]
		mov	[bx+7B5Ch], ax
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B5Ah], 0
		call	@randring2_next8$qv
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	[bx+7B5Fh], al
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B66h], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B72h], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B73h], 0
		cmp	si, 0D0h
		jge	short loc_16D3E
		mov	ax, 1
		jmp	short loc_16D40
; ---------------------------------------------------------------------------

loc_16D3E:
		xor	ax, ax

loc_16D40:
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	[bx+7B68h], ax
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B6Ah], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B6Eh], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B64h], 1
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B60h], 0
		mov	bx, [bp+arg_2]
		imul	bx, 26h
		mov	word ptr [bx+7B70h], 0
		mov	al, byte_1EE52
		mov	ah, 0
		cmp	ax, [bp+arg_2]
		jge	short loc_16D96
		mov	al, byte ptr [bp+arg_2]
		inc	al
		mov	byte_1EE52, al

loc_16D96:
		pop	si
		pop	bp
		retn	8
sub_16C96	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16D9B	proc far

var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	ax, word_1EE50
		cmp	ax, word_26C3A
		jge	loc_16E39
		add	ax, ax
		les	bx, dword_26B76
		add	bx, ax
		mov	ax, es:[bx]
		cmp	ax, word_2034A
		jnz	short loc_16E39
		mov	di, 1
		jmp	short loc_16E30
; ---------------------------------------------------------------------------

loc_16DC4:
		mov	bx, di
		shl	bx, 2
		les	bx, [bx-6EFAh]
		mov	ax, word_1EE50
		add	ax, ax
		add	bx, ax
		cmp	word ptr es:[bx], 0FFFFh
		jz	short loc_16E2F
		mov	bx, di
		shl	bx, 2
		mov	bx, [bx-6EFAh]
		mov	ax, word_1EE50
		add	ax, ax
		add	bx, ax
		mov	ax, es:[bx]
		mov	[bp+var_2], ax
		mov	bx, [bp+var_2]
		imul	bx, 24h
		mov	ax, [bx+7F08h]
		mov	[bp+var_4], ax
		cmp	_midboss_active, 0
		jnz	short loc_16E2F
		xor	si, si
		jmp	short loc_16E2A
; ---------------------------------------------------------------------------

loc_16E08:
		mov	bx, si
		imul	bx, 26h
		cmp	byte ptr [bx+7B5Eh], 0
		jnz	short loc_16E29
		mov	ax, di
		shl	ax, 3
		add	ax, 10h
		push	ax
		push	[bp+var_4]
		push	si
		push	[bp+var_2]
		call	sub_16C96
		jmp	short loc_16E2F
; ---------------------------------------------------------------------------

loc_16E29:
		inc	si

loc_16E2A:
		cmp	si, 19h
		jl	short loc_16E08

loc_16E2F:
		inc	di

loc_16E30:
		cmp	di, 31h	; '1'
		jl	short loc_16DC4
		inc	word_1EE50

loc_16E39:
		pop	di
		pop	si
		leave
		retf
sub_16D9B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_16E3D	proc near

var_A		= byte ptr -0Ah
var_9		= byte ptr -9
var_8		= byte ptr -8
var_7		= byte ptr -7
var_6		= byte ptr -6
var_5		= byte ptr -5
var_4		= byte ptr -4
@@angle		= byte ptr -3
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 0Ah
		push	si
		mov	bx, word_26C48
		mov	ax, [bx+20h]
		mov	word_26C44, ax
		mov	bx, word_26C46
		mov	al, [bx+8]
		mov	[bp+var_7], al
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx]
		mov	[bp+var_8], al
		mov	ah, 0
		cmp	ax, 25h	; '%'
		jz	loc_1719F
		jg	short loc_16E80
		mov	bx, ax
		cmp	bx, 24h	; '$'
		ja	loc_174B0
		add	bx, bx
		jmp	cs:off_17518[bx]
; ---------------------------------------------------------------------------

loc_16E80:
		cmp	ax, 0A7h
		jz	loc_17361
		jg	short loc_16EC9
		cmp	ax, 0A2h
		jz	loc_173AB
		jg	short loc_16EB6
		cmp	ax, 0A0h
		jz	loc_172FF
		jg	short loc_16EAC
		cmp	ax, 26h	; '&'
		jz	loc_17226
		cmp	ax, 27h	; '''
		jz	loc_1728A
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16EAC:
		cmp	ax, 0A1h
		jz	loc_1731C
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16EB6:
		sub	ax, 0A3h ; ''
		mov	bx, ax
		cmp	bx, 3
		ja	loc_174B0
		add	bx, bx
		jmp	cs:off_17510[bx]
; ---------------------------------------------------------------------------

loc_16EC9:
		sub	ax, 0A8h ; ''
		mov	bx, ax
		cmp	bx, 7
		ja	loc_174B0
		add	bx, bx
		jmp	cs:off_17500[bx]

loc_16EDC:
		mov	[bp+var_4], 2
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16EE3:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	bx, word_26C52
		mov	[bx], al
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+3]
		mov	[bp+var_6], al
		mov	bx, word_26C54
		jmp	loc_16FAA
; ---------------------------------------------------------------------------

loc_16F0F:
		call	sub_16ADD
		mov	[bp+var_4], 2
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16F19:
		call	@randring2_next8$qv
		mov	[bp+@@angle], al
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	[bp+var_5], al
		mov	ah, 0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		imul	_CosTable8[bx]
		sar	ax, 8
		mov	bx, word_26C52
		mov	[bx], al
		mov	al, [bp+var_5]
		mov	ah, 0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		imul	_SinTable8[bx]
		sar	ax, 8
		mov	bx, word_26C54
		mov	[bx], al
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_16F6A:
		mov	bx, word_26C46
		cmp	word ptr [bx+18h], 0
		jnz	short loc_16F79
		mov	ax, 0FFFFh
		jmp	short loc_16F7C
; ---------------------------------------------------------------------------

loc_16F79:
		mov	ax, 1

loc_16F7C:
		mov	[bp+var_2], ax
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	ah, 0
		imul	[bp+var_2]
		mov	bx, word_26C52
		mov	[bx], al
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+3]
		mov	bx, word_26C54

loc_16FAA:
		mov	[bx], al
		call	sub_16ADD
		mov	[bp+var_4], 4
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16FB6:
		call	sub_16AFC
		mov	[bp+var_4], 3
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16FC0:
		mov	al, byte_1E503
		mov	ah, 0
		mov	bx, word_26C4C
		add	[bx], ax
		mov	[bp+var_4], 2
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16FD2:
		mov	bx, word_26C46
		mov	bx, [bx+8]
		add	bx, word_26C44
		cmp	byte ptr [bx+2], 0
		jnz	short loc_16FE7
		mov	al, -1
		jmp	short loc_16FE9
; ---------------------------------------------------------------------------

loc_16FE7:
		mov	al, 1

loc_16FE9:
		mov	[bp+var_9], al
		push	3
		cbw
		push	ax
		call	sub_16B69
		mov	[bp+var_4], 6
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_16FFA:
		mov	bx, word_26C46
		cmp	word ptr [bx+18h], 1
		jnz	short loc_17008
		mov	al, -1
		jmp	short loc_1700A
; ---------------------------------------------------------------------------

loc_17008:
		mov	al, 1

loc_1700A:
		mov	[bp+var_A], al
		push	2
		cbw
		push	ax
		call	sub_16B69
		mov	[bp+var_4], 5
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_1701B:
		call	sub_16BF4
		mov	[bp+var_4], 6
		jmp	loc_174B0
; ---------------------------------------------------------------------------

loc_17025:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		shl	ax, 3
		mov	bx, word_26C4A
		mov	[bx], ax
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	ah, 0
		shl	ax, 3
		mov	bx, word_26C4C
		mov	[bx], ax
		mov	[bp+var_4], 3
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_1705E:
		call	@randring2_next16$qv
		mov	dl, [bp+var_7]
		mov	dh, 0
		add	dx, word_26C44
		mov	bx, dx
		mov	dl, [bx+2]
		mov	dh, 0
		shl	dx, 3
		push	ax
		push	dx
		xor	dx, dx
		pop	bx
		pop	ax
		div	bx
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		shl	ax, 3
		add	dx, ax
		mov	bx, word_26C4A
		mov	[bx], dx
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+3]
		mov	ah, 0
		shl	ax, 3
		mov	bx, word_26C4C
		mov	[bx], ax
		mov	bx, word_26C4A
		cmp	word ptr [bx], 0D0h
		jge	short loc_170BF
		mov	ax, 1
		jmp	short loc_170C1
; ---------------------------------------------------------------------------

loc_170BF:
		xor	ax, ax

loc_170C1:
		mov	bx, word_26C46
		mov	[bx+18h], ax
		mov	[bp+var_4], 4
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_170CF:
		call	@randring2_next16$qv
		mov	dl, [bp+var_7]
		mov	dh, 0
		add	dx, word_26C44
		mov	bx, dx
		mov	dl, [bx+2]
		mov	dh, 0
		shl	dx, 3
		push	ax
		push	dx
		xor	dx, dx
		pop	bx
		pop	ax
		div	bx
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		shl	ax, 3
		add	dx, ax
		mov	bx, word_26C4C
		mov	[bx], dx
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+3]
		mov	ah, 0
		shl	ax, 3
		mov	bx, word_26C4A
		mov	[bx], ax
		mov	[bp+var_4], 4
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17128:
		mov	bx, word_26C46
		mov	byte ptr [bx+0Eh], 2
		mov	ax, 2
		jmp	loc_174FC
; ---------------------------------------------------------------------------

loc_17136:
		mov	bx, word_26C46
		mov	word ptr [bx+0Ah], 0
		call	_snd_se_play c, 3
		mov	bx, word_26C46
		mov	byte ptr [bx+10h], 1
		mov	ax, 2
		jmp	loc_174FC
; ---------------------------------------------------------------------------

loc_17157:
		call	sub_16AA7 pascal, 00h
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_1715F:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		call	sub_16AA7 pascal, word ptr [bx+1]
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17177:
		mov	bx, word_26C46
		call	sub_16AA7 pascal, word ptr [bx+16h]
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		add	[bx+16h], ax
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_1719F:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	bx, word_26C46
		mov	[bx+24h], al
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	bx, word_26C46
		mov	[bx+25h], al
		mov	[bp+var_4], 3
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_171D0:
		mov	bx, word_26C48
		mov	ax, [bx+4]
		mov	bx, word_26C4A
		add	ax, [bx]
		push	ax	; left
		mov	bx, word_26C48
		mov	ax, [bx+6]
		mov	bx, word_26C4C
		add	ax, [bx]
		push	ax	; top
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		push	word ptr [bx+1]	; angle
		mov	bx, word_26C46
		push	word ptr [bx+24h]	; group
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	ah, 0
		push	ax	; patnum
		mov	bx, word_26C46
		mov	al, [bx+25h]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	[bp+var_4], 3
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17226:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	si, ax
		sub	si, _scroll_line
		or	si, si
		jge	short loc_17244
		add	si, RES_Y

loc_17244:
		mov	bx, word_26C48
		mov	ax, [bx+4]
		mov	bx, word_26C4A
		add	ax, [bx]
		push	ax	; left
		push	si	; top
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		push	word ptr [bx+2]	; angle
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		push	word ptr [bx+3]	; group
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+4]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	[bp+var_4], 5
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_1728A:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	si, ax
		sub	si, _scroll_line
		or	si, si
		jge	short loc_172A8
		add	si, RES_Y

loc_172A8:
		mov	bx, word_26C48
		mov	ax, [bx+4]
		mov	bx, word_26C4A
		add	ax, [bx]
		push	ax	; left
		push	si	; top
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		push	word ptr [bx+2]	; angle
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		push	word ptr [bx+3]	; group
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+4]
		mov	ah, 0
		push	ax	; patnum
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+5]
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	[bp+var_4], 6
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_172FF:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+8],	ax
		mov	ax, 1
		jmp	loc_174FC
; ---------------------------------------------------------------------------

loc_1731C:
		mov	bx, word_26C46
		mov	ax, [bx+16h]
		inc	word ptr [bx+16h]
		mov	dl, [bp+var_7]
		mov	dh, 0
		add	dx, word_26C44
		mov	bx, dx
		mov	dl, [bx+2]
		mov	dh, 0
		cmp	ax, dx
		jge	short loc_17353
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+8],	ax
		jmp	short loc_1735B
; ---------------------------------------------------------------------------

loc_17353:
		mov	bx, word_26C46
		add	word ptr [bx+8], 3

loc_1735B:
		mov	ax, 1
		jmp	loc_174FC
; ---------------------------------------------------------------------------

loc_17361:
		mov	bx, word_26C46
		mov	ax, [bx+1Ah]
		inc	word ptr [bx+1Ah]
		mov	dl, [bp+var_7]
		mov	dh, 0
		add	dx, word_26C44
		mov	bx, dx
		mov	dl, [bx+2]
		mov	dh, 0
		cmp	ax, dx
		jge	short loc_17398
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+8],	ax
		jmp	short loc_173A5
; ---------------------------------------------------------------------------

loc_17398:
		mov	bx, word_26C46
		mov	word ptr [bx+1Ah], 0
		add	word ptr [bx+8], 3

loc_173A5:
		mov	ax, 1
		jmp	loc_174FC
; ---------------------------------------------------------------------------

loc_173AB:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+16h], ax
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_173C9:
		mov	bx, word_26C46
		mov	word ptr [bx+14h], 0
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_173D5:
		mov	bx, word_26C46
		mov	word ptr [bx+14h], 1
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_173E1:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+12h], ax
		mov	word ptr [bx+14h], 0
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17404:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		mov	[bx+12h], ax
		mov	word ptr [bx+14h], 2
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17427:
		mov	bx, word_26C46
		mov	byte ptr [bx+1Eh], 1
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_17432:
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		call	_snd_se_play c, ax
		mov	[bp+var_4], 2
		jmp	loc_174E1
; ---------------------------------------------------------------------------

loc_17452:
		mov	bx, word_26C46
		mov	byte ptr [bx+22h], 1
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_1745D:
		mov	bx, word_26C46
		mov	byte ptr [bx+22h], 0
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_17468:
		mov	bx, word_26C46
		mov	byte ptr [bx+23h], 1
		jmp	loc_174F2
; ---------------------------------------------------------------------------

loc_17473:
		mov	bx, word_26C46
		mov	byte ptr [bx+23h], 0
		jmp	short loc_174F2
; ---------------------------------------------------------------------------

loc_1747D:
		mov	bx, word_26C4A
		push	word ptr [bx]	; left
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		push	ax	; y
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+2]
		mov	ah, 0
		push	ax	; image
		call	@tile_ring_set_and_put_both_8$qiii
		mov	[bp+var_4], 3
		jmp	short loc_174E1
; ---------------------------------------------------------------------------

loc_174B0:
		mov	bx, word_26C46
		inc	word ptr [bx+0Ah]
		mov	al, [bp+var_7]
		mov	ah, 0
		add	ax, word_26C44
		mov	bx, ax
		mov	al, [bx+1]
		mov	ah, 0
		mov	bx, word_26C46
		cmp	ax, [bx+0Ah]
		jg	short loc_174DD
		mov	al, [bp+var_4]
		mov	ah, 0
		add	[bx+8],	ax
		mov	word ptr [bx+0Ah], 0

loc_174DD:
		xor	ax, ax
		jmp	short loc_174FC
; ---------------------------------------------------------------------------

loc_174E1:
		mov	al, [bp+var_4]
		mov	ah, 0
		mov	bx, word_26C46
		add	[bx+8],	ax
		mov	ax, 1
		jmp	short loc_174FC
; ---------------------------------------------------------------------------

loc_174F2:
		mov	bx, word_26C46
		inc	word ptr [bx+8]
		mov	ax, 1

loc_174FC:
		pop	si
		leave
		retn
sub_16E3D	endp

; ---------------------------------------------------------------------------
		db 0
off_17500	dw offset loc_17432
		dw offset loc_17427
		dw offset loc_16F19
		dw offset loc_17452
		dw offset loc_1745D
		dw offset loc_17468
		dw offset loc_17473
		dw offset loc_1747D
off_17510	dw offset loc_173C9
		dw offset loc_173D5
		dw offset loc_173E1
		dw offset loc_17404
off_17518	dw offset loc_16EDC
		dw offset loc_16EE3
		dw offset loc_16FC0
		dw offset loc_16FD2
		dw offset loc_17025
		dw offset loc_1705E
		dw offset loc_170CF
		dw offset loc_16FFA
		dw offset loc_16F6A
		dw offset loc_16FB6
		dw offset loc_16F0F
		dw offset loc_1701B
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_17128
		dw offset loc_17136
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_174B0
		dw offset loc_17157
		dw offset loc_1715F
		dw offset loc_17177
		dw offset loc_174B0
		dw offset loc_171D0

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_17562	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		mov	bx, word_26C48
		cmp	byte ptr [bx+18h], 0
		jnz	short loc_175D1
		mov	bx, word_26C46
		cmp	byte ptr [bx+23h], 0
		jnz	short loc_175D1
		mov	si, word_26C50
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, word_26C4E
		add	dx, 0FFF0h
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jle	short loc_175D1
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, word_26C4E
		add	dx, 10h
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short loc_175D1
		lea	ax, [si-10h]
		cmp	ax, _player_topleft.y
		jge	short loc_175D1
		lea	ax, [si+10h]
		cmp	ax, _player_topleft.y
		jle	short loc_175D1
		mov	bx, word_26C46
		mov	word ptr [bx+0Ah], 0
		mov	_player_is_hit, 1
		mov	byte ptr [bx+10h], 1

loc_175D1:
		push	word_26C4E
		push	word_26C50
		push	200020h
		call	sub_1283C
		mov	[bp+var_2], ax
		pop	si
		leave
		retn
sub_17562	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_175E8	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	bx, word_26C48
		mov	di, [bx+0Eh]
		or	di, di
		jnz	short loc_175FD
		mov	ax, 0Ah
		jmp	short loc_175FF
; ---------------------------------------------------------------------------

loc_175FD:
		xor	ax, ax

loc_175FF:
		mov	di, ax
		mov	bx, word_26C46
		mov	ax, [bx+0Ah]
		mov	bx, 3
		cwd
		idiv	bx
		add	di, ax
		mov	bx, word_26C46
		cmp	word ptr [bx+0Ah], 0
		jnz	short loc_17635
		mov	ax, word_26C4E
		add	ax, 10h
		push	ax
		mov	ax, word_26C50
		add	ax, 10h
		push	ax
		push	140008h
		push	0
		call	sub_4090

loc_17635:
		mov	bx, word_26C46
		inc	word ptr [bx+0Ah]
		cmp	word ptr [bx+0Ah], 18h
		jl	short loc_1764B
		mov	byte ptr [bx+0Eh], 2
		mov	ax, 1
		jmp	short loc_1766A
; ---------------------------------------------------------------------------

loc_1764B:
		mov	si, word_26C50
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1765D
		sub	si, RES_Y

loc_1765D:
		call	super_roll_put pascal, word_26C4E, si, di
		xor	ax, ax

loc_1766A:
		pop	di
		pop	si
		pop	bp
		retn
sub_175E8	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1766E	proc far

var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 8
		push	si
		push	di
		mov	[bp+var_2], 0
		mov	[bp+var_4], 0
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh
		mov	word_26C46, 7B50h
		xor	di, di
		jmp	loc_1796A
; ---------------------------------------------------------------------------

loc_17697:
		mov	bx, word_26C46
		cmp	byte ptr [bx+0Eh], 1
		jnz	loc_17964
		mov	bx, word_26C46
		mov	ax, [bx+0Ch]
		imul	ax, 24h
		add	ax, 7F06h
		mov	word_26C48, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, word_26C46
		mov	word_26C4A, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	ax, word_26C46
		add	ax, 2
		mov	word_26C4C, ax
		mov	ax, word_26C46
		add	ax, 1Ch
		mov	word_26C52, ax
		mov	ax, word_26C46
		add	ax, 1Dh
		mov	word_26C54, ax

loc_176E6:
		mov	bx, word_26C46
		cmp	byte ptr [bx+10h], 0
		jnz	short loc_176F6
		call	sub_16E3D
		mov	[bp+var_2], ax

loc_176F6:
		cmp	[bp+var_2], 2
		jz	loc_17964
		cmp	[bp+var_2], 1
		jz	short loc_176E6
		mov	bx, word_26C4A
		mov	ax, [bx]
		mov	word_26C4E, ax
		mov	bx, word_26C4C
		mov	ax, [bx]
		mov	word_26C50, ax
		mov	si, word_26C50
		cmp	word_26C4E, 0
		jl	short loc_17729
		cmp	word_26C4E, 1A2h
		jle	short loc_17734

loc_17729:
		mov	bx, word_26C46
		mov	byte ptr [bx+0Eh], 2
		jmp	loc_17964
; ---------------------------------------------------------------------------

loc_17734:
		mov	bx, word_26C46
		cmp	byte ptr [bx+1Eh], 0
		jz	short loc_17758
		cmp	word_26C50, 180h
		jge	short loc_1774D
		cmp	word_26C50, 0FFF0h
		jg	short loc_17758

loc_1774D:
		mov	bx, word_26C46
		mov	byte ptr [bx+0Eh], 2
		jmp	loc_17964
; ---------------------------------------------------------------------------

loc_17758:
		mov	bx, word_26C46
		inc	byte ptr [bx+0Fh]
		mov	bx, word_26C48
		cmp	word ptr [bx+0Ah], 0
		jz	short loc_177A0
		mov	bx, word_26C46
		cmp	word ptr [bx+14h], 1
		jnz	short loc_177A0
		mov	al, [bx+0Fh]
		mov	ah, 0
		mov	bx, word_26C48
		cwd
		idiv	word ptr [bx+0Ch]
		or	dx, dx
		jnz	short loc_177A0
		mov	bx, word_26C46
		inc	word ptr [bx+12h]
		mov	ax, [bx+12h]
		mov	bx, word_26C48
		cmp	ax, [bx+0Ah]
		jl	short loc_177A0
		mov	bx, word_26C46
		mov	word ptr [bx+12h], 0

loc_177A0:
		mov	bx, word_26C48
		cmp	word ptr [bx+16h], 0FFFFh
		jz	loc_178E9
		mov	bx, word_26C46
		cmp	byte ptr [bx+22h], 0
		jnz	loc_178E9
		mov	bx, word_26C46
		cmp	byte ptr [bx+10h], 0
		jz	short loc_177CE
		call	sub_175E8
		or	ax, ax
		jz	loc_17964
		jmp	loc_17964
; ---------------------------------------------------------------------------

loc_177CE:
		cmp	si, 168h
		jge	short loc_177EB
		cmp	si, [bp+var_4]
		jle	short loc_177EB
		mov	ax, word_26C4E
		add	ax, 8
		mov	word_205D8, ax
		lea	ax, [si+8]
		mov	word_205DA, ax
		mov	[bp+var_4], si

loc_177EB:
		call	sub_17562
		mov	[bp+var_6], ax
		or	ax, ax
		jz	loc_178E9
		mov	bx, word_26C48
		cmp	word ptr [bx+16h], 0FFFEh
		jnz	short loc_1780E
		call	_snd_se_play c, 4
		jmp	loc_178E9
; ---------------------------------------------------------------------------

loc_1780E:
		mov	bx, word_26C46
		mov	ax, [bp+var_6]
		add	[bx+20h], ax
		mov	ax, [bx+20h]
		mov	bx, word_26C48
		cmp	ax, [bx+16h]
		jl	loc_178A8
		mov	bx, word_26C46
		mov	word ptr [bx+0Ah], 0
		mov	bx, word_26C48
		cmp	byte ptr [bx+10h], 1
		jbe	short loc_17854
		mov	ax, word_26C4E
		add	ax, 0Ch
		push	ax	; left
		push	word_26C50	; top
		mov	al, [bx+10h]
		mov	ah, 0
		add	ax, -IT_BOMB
		push	ax	; type
		call	@items_add$qiii
		jmp	short loc_17864
; ---------------------------------------------------------------------------

loc_17854:
		mov	ax, word_26C4E
		add	ax, 0Ch
		call	@items_add_semirandom$qii pascal, ax, word_26C50

loc_17864:
		call	_snd_se_play c, 3
		mov	bx, word_26C48
		mov	eax, [bx+12h]
		add	_score_delta, eax
		mov	al, _rank
		cbw
		cmp	ax, RANK_LUNATIC
		jnz	short loc_1789D
		mov	ax, [bx+4]
		add	ax, word_26C4E
		push	ax	; left
		mov	ax, [bx+6]
		add	ax, word_26C50
		push	ax	; top
		push	00h	; angle
		push	BG_1_AIMED	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1789D:
		mov	bx, word_26C46
		mov	byte ptr [bx+10h], 1
		jmp	loc_17964
; ---------------------------------------------------------------------------

loc_178A8:
		call	_snd_se_play c, 4
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_178C0
		sub	si, RES_Y

loc_178C0:
		or	si, si
		jge	short loc_178C8
		add	si, RES_Y

loc_178C8:
		push	word_26C4E
		push	si
		mov	bx, word_26C48
		mov	ax, [bx+8]
		mov	bx, word_26C46
		add	ax, [bx+12h]
		push	ax
		pushd	PLANE_PUT or GC_BRGI
		call	super_roll_put_1plane
		jmp	short loc_17964
; ---------------------------------------------------------------------------

loc_178E9:
		mov	si, word_26C50
		mov	bx, word_26C48
		cmp	word ptr [bx+1Ah], 1
		jle	short loc_17913
		mov	ax, [bx+1Ah]
		mov	[bp+var_8], ax
		mov	bx, word_26C46
		mov	al, [bx+0Fh]
		mov	ah, 0
		cwd
		idiv	[bp+var_8]
		or	dx, dx
		jnz	short loc_17913
		call	sub_16AA7 pascal, 00h

loc_17913:
		mov	bx, word_26C48
		cmp	word ptr [bx+8], 0
		jz	short loc_17964
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1792B
		sub	si, RES_Y

loc_1792B:
		or	si, si
		jge	short loc_17933
		add	si, RES_Y

loc_17933:
		mov	bx, word_26C46
		cmp	word ptr [bx+14h], 2
		jz	short loc_17953
		push	word_26C4E
		push	si
		mov	bx, word_26C48
		mov	ax, [bx+8]
		mov	bx, word_26C46
		add	ax, [bx+12h]
		push	ax
		jmp	short loc_1795F
; ---------------------------------------------------------------------------

loc_17953:
		push	word_26C4E
		push	si
		mov	bx, word_26C46
		push	word ptr [bx+12h]

loc_1795F:
		call	super_roll_put

loc_17964:
		inc	di
		add	word_26C46, 26h	; '&'

loc_1796A:
		mov	al, byte_1EE52
		mov	ah, 0
		cmp	ax, di
		jg	loc_17697
		pop	di
		pop	si
		leave
		retf
sub_1766E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_17979	proc far

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	byte_1EE52, 0
		mov	[bp+var_2], 0
		jmp	loc_17A49
; ---------------------------------------------------------------------------

loc_1798E:
		mov	bx, [bp+var_2]
		imul	bx, 26h
		cmp	byte ptr [bx+7B5Eh], 0
		jz	loc_17A46
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	si, [bx+7B50h]
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	di, [bx+7B52h]
		call	@tiles_invalidate_rect$qiiii pascal, si, di, (32 shl 16) or 32
		mov	bx, [bp+var_2]
		imul	bx, 26h
		cmp	byte ptr [bx+7B5Eh], 2
		jnz	short loc_179EC
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	byte ptr [bx+7B5Eh], 0
		jmp	short loc_17A46
; ---------------------------------------------------------------------------

loc_179EC:
		mov	al, byte ptr [bp+var_2]
		inc	al
		mov	byte_1EE52, al
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, [bx+7B50h]
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 2
		add	bx, dx
		mov	[bx+7B50h], ax
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, [bx+7B52h]
		mov	bx, [bp+var_2]
		imul	bx, 26h
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 2
		add	bx, dx
		mov	[bx+7B52h], ax

loc_17A46:
		inc	[bp+var_2]

loc_17A49:
		cmp	[bp+var_2], 19h
		jl	loc_1798E
		pop	di
		pop	si
		leave
		retf
sub_17979	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_17A55	proc far
		push	bp
		mov	bp, sp
		xor	ax, ax
		jmp	short loc_17A73
; ---------------------------------------------------------------------------

loc_17A5C:
		mov	bx, ax
		imul	bx, 26h
		cmp	byte ptr [bx+7B5Eh], 0
		jz	short loc_17A72
		mov	bx, ax
		imul	bx, 26h
		mov	byte ptr [bx+7B5Eh], 2

loc_17A72:
		inc	ax

loc_17A73:
		cmp	ax, 19h
		jl	short loc_17A5C
		mov	byte_1EE52, 0
		pop	bp
		retf
sub_17A55	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_17A7F	proc near

var_4		= byte ptr -4
@@angle		= byte ptr -3
var_2		= word ptr -2
arg_0		= word ptr  4
arg_2		= byte ptr  6
arg_4		= word ptr  8
arg_6		= byte ptr  0Ah
arg_8		= word ptr  0Ch

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	si, [bp+arg_8]
		mov	di, [bp+arg_0]
		mov	al, byte_26CC1
		mov	ah, 0
		sar	ax, 6
		inc	al
		mov	[bp+var_4], al
		call	grcg_setcolor pascal, GC_RMW, si
		mov	[bp+var_2], di
		jmp	loc_17B5F
; ---------------------------------------------------------------------------

loc_17AA9:
		mov	al, byte ptr [bp+var_2]
		mov	[bp+@@angle], al
		movzx	eax, byte_26CC1
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, 0E0h
		mov	word_20164, ax
		mov	al, [bp+arg_6]
		add	[bp+@@angle], al
		movzx	eax, byte_26CC1
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, 0C8h
		mov	word_20166, ax
		cmp	word_20164, 1A0h
		jge	short loc_17B24
		cmp	word_20164, 18h
		jle	short loc_17B24
		cmp	word_20166, 8
		jle	short loc_17B24
		cmp	word_20166, 180h
		jge	short loc_17B24
		mov	al, [bp+var_4]
		mov	ah, 0
		push	ax
		call	sub_3E6A

loc_17B24:
		cmp	[bp+arg_2], 0
		jz	short loc_17B59
		cmp	[bp+var_2], 100h
		jnz	short loc_17B59
		push	GC_RMW
		mov	al, byte_26CC5
		mov	ah, 0
		push	ax
		call	grcg_setcolor
		push	(224 shl 16) or 200
		mov	al, byte_26CC2
		mov	ah, 0
		push	ax
		call	grcg_circlefill
		call	grcg_setcolor pascal, GC_RMW, si

loc_17B59:
		mov	ax, [bp+arg_4]
		add	[bp+var_2], ax

loc_17B5F:
		lea	ax, [di+80h]
		cmp	ax, [bp+var_2]
		ja	loc_17AA9
		call	grcg_off
		pop	di
		pop	si
		leave
		retn	0Ah
mima_17A7F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_bg_render	proc far

var_1		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		call	mima_17E91
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_byteboxfill_x pascal, (PLAYFIELD_VRAM_LEFT shl 16) or PLAYFIELD_TOP, ((PLAYFIELD_VRAM_RIGHT - 1) shl 16) or PLAYFIELD_BOTTOM - 1
		mov	al, _reduce_effects
		mov	ah, 0
		mov	dx, ax
		add	dx, dx
		add	dx, ax
		inc	dl
		mov	[bp+var_1], dl
		mov	al, byte_26CC4
		mov	ah, 0
		push	ax
		mov	al, byte ptr word_1EE54
		add	al, 0F0h
		push	ax
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	0
		push	80h
		call	mima_17A7F
		mov	al, byte_26CC4
		mov	ah, 0
		push	ax
		mov	al, byte ptr word_1EE54
		add	al, 0F8h
		push	ax
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	0
		push	80h
		call	mima_17A7F
		mov	al, byte_26CC3
		mov	ah, 0
		push	ax
		push	word_1EE54
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	0
		push	80h
		call	mima_17A7F
		mov	al, byte_26CC4
		mov	ah, 0
		push	ax
		mov	al, byte ptr word_1EE54
		add	al, 0F0h
		push	ax
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	1
		push	100h
		call	mima_17A7F
		mov	al, byte_26CC4
		mov	ah, 0
		push	ax
		mov	al, byte ptr word_1EE54
		add	al, 0F8h
		push	ax
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	0
		push	100h
		call	mima_17A7F
		mov	al, byte_26CC3
		mov	ah, 0
		push	ax
		mov	al, byte ptr word_1EE54
		inc	byte ptr word_1EE54
		push	ax
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	0
		push	100h
		call	mima_17A7F
		call	grcg_off
		leave
		retf
mima_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_17C92	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	byte_2066A, 0
		jnz	locret_17D57
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 48
		push	ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 32
		push	ax
		push	400040h
		call	sub_1283C
		mov	[bp+var_2], ax
		or	ax, ax
		jz	short loc_17CF9
		mov	byte_2066B, 1
		mov	ax, word_26C66
		imul	[bp+var_2]
		add	_boss_damage, ax
		cmp	_boss_damage, 6000
		jl	short loc_17CF9
		call	_snd_se_play c, 2
		mov	byte_2066A, 1
		add	_score, 500000
		mov	_player_invincibility_time, BOSS_DEFEAT_INVINCIBILITY_FRAMES

loc_17CF9:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, _boss_left_on_back_page
		mov	dx, [bx]
		add	dx, 16
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jle	short locret_17D57
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, _boss_left_on_back_page
		mov	dx, [bx]
		add	dx, 112
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short locret_17D57
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _player_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		cmp	ax, [bx]
		jle	short locret_17D57
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, [bx]
		add	dx, 80
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jge	short locret_17D57
		mov	_player_is_hit, 1

locret_17D57:
		leave
		retn
mima_17C92	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_17D59	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	word_26CBC, 0
		xor	si, si
		jmp	loc_17E87
; ---------------------------------------------------------------------------

loc_17D68:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6DC4h], 1
		jz	short loc_17D7A
		inc	word_26CBC
		jmp	loc_17E86
; ---------------------------------------------------------------------------

loc_17D7A:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6E04h]
		add	ax, 4
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6DE4h]
		push	180020h
		call	sub_1283C
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6E04h]
		add	ax, 0FFF0h
		mov	dl, _page_front
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		cmp	ax, _player_left_on_page[bx]
		jge	short loc_17E50
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6E04h]
		add	ax, 10h
		mov	dl, _page_front
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		cmp	ax, _player_left_on_page[bx]
		jle	short loc_17E50
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6DE4h]
		add	ax, 0FFF0h
		mov	dl, _page_front
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		cmp	ax, _player_top_on_page[bx]
		jge	short loc_17E50
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6DE4h]
		add	ax, 10h
		mov	dl, _page_front
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		cmp	ax, _player_top_on_page[bx]
		jle	short loc_17E50
		mov	_player_is_hit, 1

loc_17E50:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6E04h]
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6DE4h]
		mov	ax, si
		and	ax, 3
		add	ax, 89h
		push	ax
		call	super_put_rect

loc_17E86:
		inc	si

loc_17E87:
		cmp	si, 8
		jl	loc_17D68
		pop	si
		pop	bp
		retn
mima_17D59	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_17E91	proc near
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	loc_17F1D
; ---------------------------------------------------------------------------

loc_17E9A:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6DC4h], 0
		jz	short loc_17F1C
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6DE4h], 0FFF0h
		jle	short loc_17F1C
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6DE4h], 17Eh
		jge	short loc_17F1C
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6E04h]	; left
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6DE4h]	; top
		push	(32 shl 16) or 32	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6DC4h], 2
		jnz	short loc_17F1C
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6DC4h], 0

loc_17F1C:
		inc	si

loc_17F1D:
		cmp	si, 8
		jl	loc_17E9A
		pop	si
		pop	bp
		retn
mima_17E91	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_17F27	proc near

var_12		= word ptr -12h
var_F		= byte ptr -0Fh
var_E		= dword	ptr -0Eh
var_A		= word ptr -0Ah
var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 12h
		push	si
		push	di
		cmp	byte_2066B, 0
		jz	loc_18033
		inc	byte_26CC6
		test	byte_26CC6, 3
		jnz	loc_18033
		mov	bx, _boss_left_on_back_page
		mov	al, [bx]
		and	al, 7
		mov	[bp+var_F], al
		mov	byte_2066B, 0
		mov	ax, [bx]
		sar	ax, 3
		mov	bx, _boss_top_on_back_page
		mov	dx, [bx]
		shl	dx, 6
		add	ax, dx
		mov	dx, [bx]
		shl	dx, 4
		add	ax, dx
		mov	[bp+var_8], ax
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 4
		mov	[bp+var_A], 0
		jmp	loc_18024
; ---------------------------------------------------------------------------

loc_17F82:
		mov	ax, [bp+var_A]
		imul	ax, 6
		add	ax, [bp+var_8]
		mov	[bp+var_6], ax
		mov	bx, patnum_2064E
		add	bx, [bp+var_A]
		add	bx, bx
		mov	ax, [bx+1ADAh]
		mov	word ptr [bp+var_E+2], ax
		mov	word ptr [bp+var_E], 0
		mov	[bp+var_2], 0
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	[bp+var_4], ax
		jmp	short loc_1801A
; ---------------------------------------------------------------------------

loc_17FB3:
		cmp	[bp+var_4], 180h
		jge	short loc_18021
		xor	si, si
		mov	ax, [bp+var_A]
		imul	ax, 48
		mov	bx, _boss_left_on_back_page
		add	ax, [bx]
		mov	di, ax
		jmp	short loc_1800B
; ---------------------------------------------------------------------------

loc_17FCC:
		or	di, di
		jle	short loc_18004
		cmp	di, 1A0h
		jge	short loc_18004
		cmp	[bp+var_4], 10h
		jl	short loc_18004
		les	bx, [bp+var_E]
		mov	al, es:[bx]
		mov	ah, 0
		mov	cl, 10h
		sub	cl, [bp+var_F]
		shl	ax, cl
		mov	dl, es:[bx]
		mov	dh, 0
		mov	cl, [bp+var_F]
		sar	dx, cl
		add	ax, dx
		mov	[bp+var_12], ax
		les	bx, _VRAM_PLANE_B
		add	bx, [bp+var_6]
		mov	es:[bx+si], ax

loc_18004:
		inc	si
		add	di, 8
		inc	word ptr [bp+var_E]

loc_1800B:
		cmp	si, 6
		jl	short loc_17FCC
		inc	[bp+var_2]
		add	[bp+var_6], 50h	; 'P'
		inc	[bp+var_4]

loc_1801A:
		cmp	[bp+var_2], 80h
		jl	short loc_17FB3

loc_18021:
		inc	[bp+var_A]

loc_18024:
		cmp	[bp+var_A], 3
		jl	loc_17F82
		call	grcg_off
		jmp	short loc_180A8
; ---------------------------------------------------------------------------

loc_18033:
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_left_on_page[bx]
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		push	patnum_2064E
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 48
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 96
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		add	ax, 2
		push	ax
		call	super_put_rect

loc_180A8:
		pop	di
		pop	si
		leave
		retn
mima_17F27	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_180AC	proc near
		push	bp
		mov	bp, sp
		cmp	_rank, RANK_EASY
		jz	short loc_180D1
		mov	byte_2066E, 25h
		mov	byte_2066F, 17h
		mov	group_20670, BG_32_RING
		mov	byte_20671, 21h
		mov	byte_20672, 6
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_180D1:
		mov	byte_2066E, 25h
		mov	byte_2066F, 19h
		mov	group_20670, BG_2_SPREAD_MEDIUM_AIMED
		mov	byte_20671, 22h
		mov	byte_20672, 8
		pop	bp
		retn
mima_180AC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_180EC	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	loc_181B1
		cmp	_boss_phase_frame, 10
		jnz	short loc_1810A
		push	0
		call	sub_10E39
		mov	patnum_2064E, 131

loc_1810A:
		cmp	_boss_phase_frame, 66
		jge	short loc_18125
		mov	bx, _boss_left_on_back_page
		sub	word ptr [bx], 2
		cmp	word ptr [bx], 32
		jg	short loc_18170
		mov	_boss_phase_frame, 66
		jmp	short loc_18170
; ---------------------------------------------------------------------------

loc_18125:
		cmp	_boss_phase_frame, 178
		jge	short loc_18142
		mov	bx, _boss_left_on_back_page
		add	word ptr [bx], 2
		cmp	word ptr [bx], 256
		jl	short loc_18170
		mov	_boss_phase_frame, 178
		jmp	short loc_18170
; ---------------------------------------------------------------------------

loc_18142:
		cmp	_boss_phase_frame, 234
		jge	short loc_1815F
		mov	bx, _boss_left_on_back_page
		sub	word ptr [bx], 2
		cmp	word ptr [bx], 144
		jg	short loc_18170
		mov	_boss_phase_frame, 234
		jmp	short loc_18170
; ---------------------------------------------------------------------------

loc_1815F:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128
		push	1
		call	sub_10E39

loc_18170:
		mov	ax, _boss_phase_frame
		mov	bx, 32
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_181B1
		push	word_26C58	; left
		push	word_26C60	; top
		call	@randring2_next8_and$quc pascal, 0Fh
		add	al, 38h
		push	ax	; angle
		push	word ptr byte_2066E	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci
		push	word_26C58	; left
		push	word_26C60	; top
		push	00h	; angle
		mov	al, byte_26CC0
		mov	ah, 0
		mov	bx, ax
		mov	al, byte_2066F[bx]
		push	ax	; group
		push	((2 shl 4) + 8)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_181B1:
		pop	bp
		retn
mima_180EC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_181B3	proc near

var_4		= word ptr -4
var_2		= byte ptr -2
@@angle		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		cmp	_boss_phase_frame, 20
		jl	loc_183CC
		cmp	_boss_phase_frame, 70
		jge	short loc_181F1
		mov	patnum_2064E, 128
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 64
		cmp	ax, _player_topleft.x
		jge	short loc_181E5
		mov	ax, 2
		jmp	short loc_181E8
; ---------------------------------------------------------------------------

loc_181E5:
		mov	ax, -2

loc_181E8:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		jmp	loc_183CC
; ---------------------------------------------------------------------------

loc_181F1:
		cmp	_boss_phase_frame, 70
		jnz	short loc_1821A
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		mov	byte_26CC7, 30h	; '0'
		mov	byte_26CC8, 0
		mov	byte_26CC9, 64h	; 'd'
		jmp	loc_183CC
; ---------------------------------------------------------------------------

loc_1821A:
		cmp	_boss_phase_frame, 170
		jge	loc_182C2
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 13
		mov	al, 40h
		sub	al, byte_26CC8
		mov	[bp+var_2], al
		shr	[bp+var_2], 2
		xor	si, si
		mov	al, byte_26CC8
		mov	[bp+@@angle], al
		jmp	short loc_1829D
; ---------------------------------------------------------------------------

loc_18246:
		mov	al, [bp+@@angle]
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _CosTable8[bx]
		imul	eax, 400
		sar	eax, 8
		add	ax, word_26C58
		mov	di, ax
		mov	al, [bp+@@angle]
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _SinTable8[bx]
		imul	eax, 400
		sar	eax, 8
		add	ax, word_26C60
		mov	[bp+var_4], ax
		call	grcg_line pascal, word_26C58, word_26C60, di, ax
		mov	al, [bp+var_2]
		add	[bp+@@angle], al
		inc	si

loc_1829D:
		cmp	si, 9
		jl	short loc_18246
		cmp	_boss_phase_frame, 36
		jl	short loc_182AD
		inc	byte_26CC8

loc_182AD:
		call	grcg_off
		test	byte ptr _boss_phase_frame, 1
		jz	loc_1835E
		inc	byte_26CC9
		jmp	loc_1835E
; ---------------------------------------------------------------------------

loc_182C2:
		cmp	_boss_phase_frame, 170
		jnz	short loc_182DD
		call	_snd_se_play c, 5
		mov	patnum_2064E, 134
		jmp	loc_183CC
; ---------------------------------------------------------------------------

loc_182DD:
		cmp	_boss_phase_frame, 198
		jg	loc_1836D
		mov	ax, _boss_phase_frame
		and	ax, 3
		imul	ax, 60
		mov	dx, 272
		sub	dx, ax
		mov	bx, _boss_top_on_back_page
		mov	[bx], dx
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 13
		call	@randring2_next8_and$quc pascal, 7Fh
		mov	[bp+@@angle], al
		mov	ah, 0
		mov	bx, _boss_left_on_back_page
		add	ax, [bx]
		add	ax, 8
		mov	di, ax
		call	grcg_line pascal, ax, PLAYFIELD_TOP, ax, PLAYFIELD_BOTTOM - 1
		call	grcg_off
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 16
		cmp	ax, _player_topleft.x
		jge	short loc_1834B
		mov	ax, [bx]
		add	ax, 96
		cmp	ax, _player_topleft.x
		jle	short loc_1834B
		mov	_player_is_hit, 1

loc_1834B:
		test	byte ptr _boss_phase_frame, 0
		jz	short loc_18359
		mov	byte_26CC9, 96h
		jmp	short loc_1835E
; ---------------------------------------------------------------------------

loc_18359:
		mov	byte_26CC9, 64h	; 'd'

loc_1835E:
		mov	al, byte_26CC9
		mov	ah, 0
		mov	PaletteTone, ax
		call	far ptr	palette_show
		jmp	short loc_183CC
; ---------------------------------------------------------------------------

loc_1836D:
		cmp	_boss_phase_frame, 262
		jg	short loc_183C6
		mov	patnum_2064E, 128
		mov	bx, _boss_top_on_back_page
		sub	word ptr [bx], 4
		cmp	word ptr [bx], 64
		jg	short loc_1838D
		mov	_boss_phase_frame, 263

loc_1838D:
		cmp	_rank, RANK_EASY
		jz	short loc_183CC
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_183CC
		cmp	byte_26CC0, 0
		jnz	short loc_183AE
		mov	[bp+@@angle], 25h
		jmp	short loc_183B2
; ---------------------------------------------------------------------------

loc_183AE:
		mov	[bp+@@angle], 27h

loc_183B2:
		call	@bullets_add_pellet$qiiucuci pascal, left_26C56, top_26C5E, 00h	, word ptr [bp+@@angle], ((3 shl 4) + 12)
		jmp	short loc_183CC
; ---------------------------------------------------------------------------

loc_183C6:
		mov	_boss_phase_frame, 0

loc_183CC:
		pop	di
		pop	si
		leave
		retn
mima_181B3	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_183D0	proc near

@@angle		= byte ptr -5
@@speed		= word ptr -4
var_2		= word ptr -2
arg_0		= dword	ptr  4
arg_4		= dword	ptr  8

		push	bp
		mov	bp, sp
		sub	sp, 6
		push	si
		push	di
		cmp	_boss_phase_frame, 40
		jnz	short loc_18424
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 80
		mov	word_26CCC, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 64
		mov	word_26CCE, ax
		shl	word_26CCC, 4
		shl	word_26CCE, 4
		mov	word_26CD0, 4
		mov	byte_26CD3, -1
		mov	byte_26CD4, 0
		jmp	loc_1889C
; ---------------------------------------------------------------------------

loc_18424:
		cmp	_boss_phase_frame, 80
		jl	loc_188A4
		cmp	_boss_phase_frame, 80
		jnz	loc_184E2
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		mov	[bp+var_2], 0
		mov	al, angle_26CD2
		jmp	loc_184D4
; ---------------------------------------------------------------------------

loc_18451:
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCC
		sar	dx, 4
		add	ax, dx
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DF4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6E04h], ax
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCE
		sar	dx, 4
		add	ax, dx
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DD4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DE4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6DC4h], 1
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h

loc_184D4:
		mov	[bp+@@angle], al
		cmp	[bp+var_2], 4
		jl	loc_18451
		jmp	loc_1889C
; ---------------------------------------------------------------------------

loc_184E2:
		cmp	_boss_phase_frame, 96
		jge	loc_18589
		add	word_26CD0, 4
		mov	[bp+var_2], 0
		mov	al, angle_26CD2
		jmp	loc_1857B
; ---------------------------------------------------------------------------

loc_184FB:
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCC
		sar	dx, 4
		add	ax, dx
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6E04h], ax
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCE
		sar	dx, 4
		add	ax, dx
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6DE4h], ax
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h

loc_1857B:
		mov	[bp+@@angle], al
		cmp	[bp+var_2], 4
		jl	loc_184FB
		jmp	loc_1889C
; ---------------------------------------------------------------------------

loc_18589:
		les	bx, [bp+arg_4]
		mov	ax, es:[bx]
		add	word_26CCC, ax
		les	bx, [bp+arg_0]
		mov	ax, es:[bx]
		add	word_26CCE, ax
		mov	al, byte_26CD3
		cbw
		add	word_26CD0, ax
		cmp	byte_26CCA, 0
		jnz	loc_186AD
		cmp	byte_26CC0, 0
		jz	loc_18783
		cmp	word_26CD0, 0C4h
		jnz	short loc_185C5
		mov	_boss_phase_frame, 0

loc_185C5:
		cmp	word_26CD0, 14h
		jge	loc_1879E
		mov	byte_26CD4, 0
		call	_snd_se_play c, 3
		push	0
		call	sub_10E39
		mov	[bp+var_2], 0
		jmp	loc_18691
; ---------------------------------------------------------------------------

loc_185EA:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6E04h]
		add	ax, 12
		mov	si, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6DE4h]
		add	ax, 12
		mov	di, ax
		mov	[bp+@@speed], 0
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		add	al, angle_26CD2
		add	al, -40h
		jmp	short loc_18645
; ---------------------------------------------------------------------------

loc_18631:
		call	@bullets_add_pellet$qiiucuci pascal, si, di, word ptr [bp+@@angle], BG_1, ((2 shl 4) + 3)
		inc	[bp+@@speed]
		mov	al, [bp+@@angle]
		add	al, 08h

loc_18645:
		mov	[bp+@@angle], al
		cmp	[bp+@@speed], (1 shl 4)
		jl	short loc_18631
		mov	[bp+@@speed], 0
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		add	al, angle_26CD2
		add	al, -3Ch
		jmp	short loc_1867A
; ---------------------------------------------------------------------------

loc_18661:
		push	si	; left
		push	di	; top
		push	word ptr [bp+@@angle]	; angle
		push	BG_1	; group
		mov	ax, ((2 shl 4) + 3)
		sub	ax, [bp+@@speed]
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		inc	[bp+@@speed]
		mov	al, [bp+@@angle]
		add	al, 8

loc_1867A:
		mov	[bp+@@angle], al
		cmp	[bp+@@speed], (1 shl 4)
		jl	short loc_18661
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6DC4h], 2
		inc	[bp+var_2]

loc_18691:
		cmp	[bp+var_2], 4
		jl	loc_185EA
		push	1
		call	sub_10E39
		mov	word_26CD0, 140h
		mov	patnum_2064E, 128
		jmp	loc_1879E
; ---------------------------------------------------------------------------

loc_186AD:
		cmp	byte_26CD4, 0
		jz	short loc_186CA
		cmp	byte_26CC0, 0
		jz	short loc_186C2
		mov	al, angle_26CD2
		add	al, -03h
		jmp	short loc_186C7
; ---------------------------------------------------------------------------

loc_186C2:
		mov	al, angle_26CD2
		add	al, -05h

loc_186C7:
		mov	angle_26CD2, al

loc_186CA:
		cmp	word_26CD0, 190h
		jge	loc_187DF
		cmp	word_26CD0, 14h
		jge	loc_1879E
		les	bx, [bp+arg_4]
		mov	word ptr es:[bx], 0
		les	bx, [bp+arg_0]
		mov	word ptr es:[bx], 0
		mov	byte_26CD4, 1
		call	_snd_se_play c, 3
		mov	al, angle_26CD2
		add	al, 08h
		mov	[bp+@@angle], al
		mov	[bp+var_2], 0
		jmp	short loc_18770
; ---------------------------------------------------------------------------

loc_1870B:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6E04h]
		add	ax, 0Ch
		mov	si, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6DE4h]
		add	ax, 0Ch
		mov	di, ax
		mov	[bp+@@speed], 0
		jmp	short loc_1875F
; ---------------------------------------------------------------------------

loc_18746:
		push	si	; left
		push	di	; top
		mov	al, [bp+@@angle]
		add	al, byte ptr [bp+@@speed]
		push	ax	; angle
		push	BG_1	; group
		mov	ax, [bp+@@speed]
		add	ax, ((2 shl 4) + 3)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		add	[bp+@@speed], 12

loc_1875F:
		cmp	[bp+@@speed], (3 shl 4)
		jl	short loc_18746
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h
		mov	[bp+@@angle], al

loc_18770:
		cmp	[bp+var_2], 4
		jl	short loc_1870B
		mov	patnum_2064E, 128
		mov	byte_26CD3, 5
		jmp	short loc_1879E
; ---------------------------------------------------------------------------

loc_18783:
		cmp	word_26CD0, 20h	; ' '
		jge	short loc_18791
		mov	byte_26CD3, 2
		jmp	short loc_1879E
; ---------------------------------------------------------------------------

loc_18791:
		cmp	word_26CD0, 80h
		jle	short loc_1879E
		mov	byte_26CD3, -2

loc_1879E:
		mov	ax, word_26CCC
		sar	ax, 4
		mov	si, ax
		mov	ax, word_26CCE
		sar	ax, 4
		mov	di, ax
		mov	ax, si
		add	ax, word_26CD0
		jl	short loc_187DF
		mov	ax, si
		sub	ax, word_26CD0
		cmp	ax, 1A0h
		jg	short loc_187DF
		mov	ax, di
		add	ax, word_26CD0
		cmp	ax, 0FFF0h
		jl	short loc_187DF
		mov	ax, di
		sub	ax, word_26CD0
		cmp	ax, 182h
		jg	short loc_187DF
		cmp	_boss_phase_frame, 500
		jle	short loc_18806

loc_187DF:
		mov	[bp+var_2], 0
		jmp	short loc_187F4
; ---------------------------------------------------------------------------

loc_187E6:
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6DC4h], 2
		inc	[bp+var_2]

loc_187F4:
		cmp	[bp+var_2], 4
		jl	short loc_187E6
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_18806:
		mov	[bp+var_2], 0
		mov	al, angle_26CD2
		jmp	loc_18891
; ---------------------------------------------------------------------------

loc_18811:
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCC
		sar	dx, 4
		add	ax, dx
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6E04h], ax
		movsx	eax, word_26CD0
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CCE
		sar	dx, 4
		add	ax, dx
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6DE4h], ax
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h

loc_18891:
		mov	[bp+@@angle], al
		cmp	[bp+var_2], 4
		jl	loc_18811

loc_1889C:
		mov	al, angle_26CD2
		add	al, 05h
		mov	angle_26CD2, al

loc_188A4:
		pop	di
		pop	si
		leave
		retn	8
mima_183D0	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_188AA	proc near

@@y1		= word ptr -4
@@x1		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		cmp	_boss_phase_frame, 40
		jl	short locret_18903
		cmp	_boss_phase_frame, 40
		jnz	short loc_188F8
		mov	byte_26CCA, 0
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 80
		mov	[bp+@@x1], ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 64
		mov	[bp+@@y1], ax
		call	@vector2_between_plus$qiiiiucmit6i pascal, [bp+@@x1], ax, _player_topleft.x, _player_topleft.y, 0, ds, offset point_26CD6.x, ds, offset point_26CD6.y, 48

loc_188F8:
		push	ds
		push	offset point_26CD6.x
		push	ds
		push	offset point_26CD6.y
		call	mima_183D0

locret_18903:
		leave
		retn
mima_188AA	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18905	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	loc_18A19
		cmp	_boss_phase_frame, 70
		jge	short loc_1893E
		mov	patnum_2064E, 128
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 64
		cmp	ax, _player_topleft.x
		jge	short loc_18932
		mov	ax, 2
		jmp	short loc_18935
; ---------------------------------------------------------------------------

loc_18932:
		mov	ax, -2

loc_18935:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		jmp	loc_189DC
; ---------------------------------------------------------------------------

loc_1893E:
		cmp	_boss_phase_frame, 70
		jnz	short loc_1895D
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		mov	speed_26CDB, ((1 shl 4) + 4)
		jmp	loc_189DC
; ---------------------------------------------------------------------------

loc_1895D:
		cmp	_boss_phase_frame, 100
		jl	loc_18A19
		cmp	_boss_phase_frame, 100
		jnz	short loc_18985
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		call	@randring2_next8$qv
		mov	angle_26CDA, al
		jmp	short loc_189DC
; ---------------------------------------------------------------------------

loc_18985:
		cmp	_boss_phase_frame, 160
		jg	short loc_18993
		dec	angle_26CDA
		jmp	short loc_189DC
; ---------------------------------------------------------------------------

loc_18993:
		cmp	_boss_phase_frame, 240
		jg	short loc_189A5
		inc	angle_26CDA
		inc	speed_26CDB
		jmp	short loc_189DC
; ---------------------------------------------------------------------------

loc_189A5:
		cmp	byte_26CC0, 0
		jz	short loc_189D0
		cmp	_boss_phase_frame, 320
		jg	short loc_189BE
		inc	angle_26CDA
		dec	speed_26CDB
		jmp	short loc_189DC
; ---------------------------------------------------------------------------

loc_189BE:
		cmp	_boss_phase_frame, 400
		jg	short loc_189D0
		dec	angle_26CDA
		inc	speed_26CDB
		jmp	short loc_189DC
; ---------------------------------------------------------------------------

loc_189D0:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_189DC:
		cmp	_boss_phase_frame, 100
		jle	short loc_18A19
		mov	al, _rank
		cbw
		mov	bx, 8
		sub	bx, ax
		mov	ax, _boss_phase_frame
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_18A19
		push	left_26C5A	; left
		push	top_26C62	; top
		push	word ptr angle_26CDA	; angle
		push	word ptr byte_20671	; group
		mov	al, speed_26CDB
		mov	ah, 0
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		call	_snd_se_play c, 3

loc_18A19:
		pop	bp
		retn
mima_18905	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18A1B	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	loc_18B49
		cmp	_boss_phase_frame, 70
		jge	short loc_18A53
		mov	patnum_2064E, 128
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 64
		cmp	ax, _player_topleft.x
		jge	short loc_18A48
		mov	ax, 2
		jmp	short loc_18A4B
; ---------------------------------------------------------------------------

loc_18A48:
		mov	ax, -2

loc_18A4B:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18A53:
		cmp	_boss_phase_frame, 70
		jnz	short loc_18A71
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		mov	angle_26CDC, -28h
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18A71:
		cmp	_boss_phase_frame, 100
		jl	loc_18B49
		cmp	_boss_phase_frame, 100
		jnz	short loc_18A93
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18A93:
		cmp	_boss_phase_frame, 132
		jg	short loc_18AB8
		call	@bullets_add_pellet$qiiucuci pascal, left_26C5A, top_26C62, word ptr angle_26CDC, BG_2_SPREAD_HORIZONTALLY_SYMMETRIC, ((5 shl 4) + 10)
		mov	al, angle_26CDC
		add	al, 03h
		mov	angle_26CDC, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18AB8:
		cmp	_boss_phase_frame, 150
		jg	short loc_18ADD
		call	@bullets_add_pellet$qiiucuci pascal, left_26C5A, top_26C62, word ptr angle_26CDC, BG_2_SPREAD_HORIZONTALLY_SYMMETRIC, ((5 shl 4) + 10)
		mov	al, angle_26CDC
		add	al, -03h
		mov	angle_26CDC, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18ADD:
		cmp	_boss_phase_frame, 226
		jg	short loc_18B3D
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		cmp	dx, 1
		jnz	short loc_18B49
		cmp	byte_26CC0, 0
		jnz	short loc_18B0D
		call	@bullets_add_pellet$qiiucuci pascal, left_26C5A, top_26C62, 40h, BG_3_SPREAD_NARROW, ((5 shl 4) + 10)
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18B0D:
		push	left_26C5A	; left
		push	top_26C62	; top
		call	@randring2_next8_and$quc pascal, 3Fh
		add	al, 20h
		push	ax	; angle
		push	BG_1	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		push	left_26C5A	; left
		push	top_26C62	; top
		call	@randring2_next8_and$quc pascal, 3Fh
		add	al, 20h
		push	ax	; angle
		push	BG_1	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18B3D:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_18B49:
		pop	bp
		retn
mima_18A1B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18B4B	proc near

var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		cmp	_boss_phase_frame, 40
		jl	short locret_18BA4
		cmp	_boss_phase_frame, 40
		jnz	short loc_18B99
		mov	byte_26CCA, 1
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 80
		mov	[bp+var_2], ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 64
		mov	[bp+var_4], ax
		call	@vector2_between_plus$qiiiiucmit6i pascal, [bp+var_2], ax, _player_topleft.x, _player_topleft.y, 0, ds, offset point_26CDE.x, ds, offset point_26CDE.y, 52

loc_18B99:
		push	ds
		push	offset point_26CDE.x
		push	ds
		push	offset point_26CDE.y
		call	mima_183D0

locret_18BA4:
		leave
		retn
mima_18B4B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18BA6	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	loc_18C48
		cmp	_boss_phase_frame, 10
		jnz	short loc_18BCB
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18BCB:
		cmp	_boss_phase_frame, 40
		jl	short loc_18C48
		cmp	_boss_phase_frame, 40
		jnz	short loc_18BFC
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		cmp	word_26C68, 6
		jnz	short loc_18C39
		push	left_26C5A	; left
		push	top_26C62	; top
		push	IT_BOMB	; type
		jmp	short loc_18C43
; ---------------------------------------------------------------------------

loc_18BFC:
		cmp	_boss_phase_frame, 60
		jnz	short loc_18C0F
		call	_snd_se_play c, 10
		jmp	short loc_18C39
; ---------------------------------------------------------------------------

loc_18C0F:
		cmp	_boss_phase_frame, 80
		jnz	short loc_18C48
		call	_snd_se_play c, 10
		mov	patnum_2064E, 128
		cmp	word_26C68, 2
		jnz	short loc_18C39
		push	left_26C5A	; left
		push	top_26C62	; top
		push	IT_1UP	; type
		jmp	short loc_18C43
; ---------------------------------------------------------------------------

loc_18C39:
		push	left_26C5A	; left
		push	top_26C62	; top
		push	IT_BIGPOWER	; type

loc_18C43:
		call	@items_add$qiii

loc_18C48:
		pop	bp
		retn
mima_18BA6	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18C4A	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 10
		jl	loc_18DDE
		cmp	_boss_phase_frame, 70
		jge	short loc_18C82
		mov	patnum_2064E, 128
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 64
		cmp	ax, _player_topleft.x
		jge	short loc_18C77
		mov	ax, 2
		jmp	short loc_18C7A
; ---------------------------------------------------------------------------

loc_18C77:
		mov	ax, -2

loc_18C7A:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18C82:
		cmp	_boss_phase_frame, 70
		jnz	short loc_18C9B
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18C9B:
		cmp	_boss_phase_frame, 100
		jl	loc_18DDE
		cmp	_boss_phase_frame, 100
		jnz	short loc_18CEE
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		mov	ax, _player_topleft.y
		sub	ax, top_26C62
		push	ax
		mov	ax, _player_topleft.x
		sub	ax, left_26C5A
		push	ax
		call	iatan2
		mov	angle_26CE2, al
		cmp	_player_topleft.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - (PLAYER_W / 2))
		jg	short loc_18CDF
		mov	al, -1
		jmp	short loc_18CE1
; ---------------------------------------------------------------------------

loc_18CDF:
		mov	al, 1

loc_18CE1:
		mov	direction_26CE3, al
		mov	al, byte_26CC0
		mov	ah, 0
		mov	bullet_special_turns_max, ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18CEE:
		cmp	_boss_phase_frame, 300
		jg	loc_18DD2
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_18DA9
		call	_snd_se_play c, 10
		cmp	_rank, RANK_EASY
		jz	short loc_18D75
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, 0Ah
		push	ax	; angle
		push	BSM_BOUNCE_TOP_BOTTOM	; group
		push	(PAT_BULLET16_STAR shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, -0Ah
		push	ax	; angle
		push	BSM_BOUNCE_TOP_BOTTOM	; group
		push	(PAT_BULLET16_STAR shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, 1Eh
		push	ax	; angle
		push	BSM_BOUNCE_TOP_BOTTOM	; group
		push	(PAT_BULLET16_STAR shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, -1Eh
		jmp	short loc_18D9C
; ---------------------------------------------------------------------------

loc_18D75:
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, 0Fh
		push	ax	; angle
		push	BSM_BOUNCE_TOP_BOTTOM	; group
		push	(PAT_BULLET16_STAR shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE2
		add	al, -0Fh

loc_18D9C:
		push	ax	; angle
		push	BSM_BOUNCE_TOP_BOTTOM	; group
		push	(PAT_BULLET16_STAR shl 16) or (5 shl 4)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti

loc_18DA9:
		cmp	_boss_phase_frame, 150
		jl	short loc_18DDE
		test	byte ptr _boss_phase_frame, 1
		jz	short loc_18DDE
		cmp	_boss_phase_frame, 210
		jge	short loc_18DC9
		mov	al, direction_26CE3
		add	angle_26CE2, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18DC9:
		mov	al, direction_26CE3
		sub	angle_26CE2, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18DD2:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_18DDE:
		pop	bp
		retn
mima_18C4A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18DE0	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 30
		jl	loc_18EB6
		cmp	_boss_phase_frame, 70
		jge	short loc_18E18
		mov	patnum_2064E, 128
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 64
		cmp	ax, _player_topleft.x
		jge	short loc_18E0D
		mov	ax, 2
		jmp	short loc_18E10
; ---------------------------------------------------------------------------

loc_18E0D:
		mov	ax, -2

loc_18E10:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18E18:
		cmp	_boss_phase_frame, 70
		jnz	short loc_18E31
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18E31:
		cmp	_boss_phase_frame, 120
		jl	short loc_18EB6
		cmp	_boss_phase_frame, 120
		jnz	short loc_18E89
		call	_snd_se_play c, 3
		mov	patnum_2064E, 134
		mov	angle_26CE4, 04h

loc_18E54:
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, angle_26CE4
		add	al, 08h
		push	ax	; angle
		push	BG_3_SPREAD_NARROW	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		push	left_26C5A	; left
		push	top_26C62	; top
		mov	al, 78h
		sub	al, angle_26CE4
		push	ax	; angle
		push	BG_3_SPREAD_NARROW	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	al, angle_26CE4
		add	al, 0Ah
		mov	angle_26CE4, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_18E89:
		cmp	_boss_phase_frame, 160
		jg	short loc_18EAA
		mov	ax, _boss_phase_frame
		mov	bx, 10
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_18EB6
		call	_snd_se_play c, 3
		jmp	short loc_18E54
; ---------------------------------------------------------------------------

loc_18EAA:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_18EB6:
		pop	bp
		retn
mima_18DE0	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_18EB8	proc near

@@angle		= byte ptr -4
var_3		= byte ptr -3
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		cmp	_boss_phase_frame, 40
		jl	locret_19171
		cmp	_boss_phase_frame, 40
		jnz	short loc_18F05
		call	_snd_se_play c, 9
		mov	patnum_2064E, 131
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 80
		mov	word_26CE6, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 80
		mov	word_26CE8, ax
		mov	word_26CEA, 4
		call	@randring2_next8$qv
		mov	angle_26CEC, al
		jmp	loc_19169
; ---------------------------------------------------------------------------

loc_18F05:
		cmp	_boss_phase_frame, 80
		jl	locret_19171
		cmp	_boss_phase_frame, 80
		jnz	loc_18FC3
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		mov	[bp+var_2], 0
		mov	al, angle_26CEC
		jmp	loc_18FB5
; ---------------------------------------------------------------------------

loc_18F32:
		movsx	eax, word_26CEA
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CE6
		sar	dx, 4
		add	ax, dx
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DF4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6E04h], ax
		movsx	eax, word_26CEA
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		mov	dx, word_26CE8
		sar	dx, 4
		add	ax, dx
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DD4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6DE4h], ax
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6DC4h], 1
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h

loc_18FB5:
		mov	[bp+@@angle], al
		cmp	[bp+var_2], 4
		jl	loc_18F32
		jmp	loc_19169
; ---------------------------------------------------------------------------

loc_18FC3:
		add	word_26CEA, 2
		mov	[bp+var_2], 0
		mov	al, angle_26CEC
		jmp	loc_1912F
; ---------------------------------------------------------------------------

loc_18FD3:
		movsx	eax, word_26CEA
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, word_26CE6
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6E04h], ax
		movsx	eax, word_26CEA
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, word_26CE8
		mov	dl, _page_back
		mov	dh, 0
		shl	dx, 4
		mov	bx, [bp+var_2]
		add	bx, bx
		add	dx, bx
		mov	bx, dx
		mov	[bx-6DE4h], ax
		mov	al, _rank
		cbw
		shl	ax, 4
		mov	dx, 0B4h
		sub	dx, ax
		cmp	dx, word_26CEA
		jge	loc_19127
		test	byte ptr _boss_phase_frame, 3
		jnz	loc_19127
		call	_snd_se_play c, 3
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6E04h], 0
		jle	loc_19127
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6E04h], 1A0h
		jge	loc_19127
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6DE4h], 0
		jle	short loc_19127
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		cmp	word ptr [bx-6DE4h], 190h
		jge	short loc_19127
		cmp	byte_26CC0, 0
		jnz	short loc_190E3
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		add	al, angle_26CEC
		add	al, 40h
		jmp	short loc_190EF
; ---------------------------------------------------------------------------

loc_190E3:
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		add	al, angle_26CEC
		add	al, 60h

loc_190EF:
		mov	[bp+var_3], al
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6E04h]	; left
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 4
		mov	dx, [bp+var_2]
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6DE4h]	; top
		push	word ptr [bp+var_3]	; angle
		push	BG_1	; group
		push	(8 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_19127:
		inc	[bp+var_2]
		mov	al, [bp+@@angle]
		add	al, 40h

loc_1912F:
		mov	[bp+@@angle], al
		cmp	[bp+var_2], 4
		jl	loc_18FD3
		cmp	word_26CEA, 1CCh
		jle	short loc_19169
		mov	[bp+var_2], 0
		jmp	short loc_19157
; ---------------------------------------------------------------------------

loc_19149:
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6DC4h], 0
		inc	[bp+var_2]

loc_19157:
		cmp	[bp+var_2], 4
		jl	short loc_19149
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_19169:
		mov	al, angle_26CEC
		add	al, -03h
		mov	angle_26CEC, al

locret_19171:
		leave
		retn
mima_18EB8	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_19173	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	short loc_191CA
		cmp	_boss_phase_frame, 50
		jnz	short loc_1918B
		mov	angle_26CED, 0
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1918B:
		cmp	_boss_phase_frame, 150
		jge	short loc_191C4
		test	byte ptr _boss_phase_frame, 1
		jz	short loc_191CA
		call	_snd_se_play c, 3
		push	x_26C5C	; left
		push	y_26C64	; top
		push	word ptr angle_26CED	; angle
		push	BG_2_SPREAD_HORIZONTALLY_SYMMETRIC	; group
		push	(PAT_BULLET16_BALL shl 16) or ((3 shl 4) + 2)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	al, byte_20672
		add	angle_26CED, al
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_191C4:
		mov	_boss_phase_frame, 0

loc_191CA:
		pop	bp
		retn
mima_19173	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_191CC	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_19351
		cmp	_boss_phase_frame, 50
		jnz	short loc_1920E
		mov	ax, _player_topleft.y
		add	ax, 12
		sub	ax, y_26C64
		push	ax
		mov	ax, _player_topleft.x
		add	ax, 12
		sub	ax, x_26C5C
		push	ax
		call	iatan2
		mov	angle_26CEE, al
		mov	byte_26CEF, 1Eh
		call	_snd_se_play c, 9
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1920E:
		cmp	_boss_phase_frame, 80
		jg	loc_192CA
		test	byte ptr _boss_phase_frame, 1
		jz	loc_19351
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		push	ax
		call	grcg_circle
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		add	ax, ax
		push	ax
		call	grcg_circle
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		shl	ax, 2
		push	ax
		call	grcg_circle
		mov	al, byte_26CEF
		add	al, 0FEh
		mov	byte_26CEF, al
		cmp	_boss_phase_frame, 80
		jz	loc_19351
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 13
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		push	ax
		call	grcg_circle
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		add	ax, ax
		push	ax
		call	grcg_circle
		push	x_26C5C
		push	y_26C64
		mov	al, byte_26CEF
		mov	ah, 0
		shl	ax, 2
		push	ax
		call	grcg_circle
		call	grcg_off
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_192CA:
		cmp	_boss_phase_frame, 200
		jge	short loc_1934B
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_192FF
		push	x_26C5C	; left
		push	y_26C64	; top
		push	02h	; angle
		push	BG_RANDOM_ANGLE_AND_SPEED	; group
		push	(PAT_BULLET16_BALL shl 16) or ((3 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		call	@bullets_add_pellet$qiiucuci pascal, x_26C5C, y_26C64, 02h, BG_RANDOM_ANGLE_AND_SPEED, ((3 shl 4) + 12)

loc_192FF:
		mov	al, _rank
		cbw
		or	ax, ax
		jle	short loc_19338
		mov	ax, _boss_phase_frame
		and	ax, 7
		cmp	ax, 4
		jnz	short loc_19338
		push	x_26C5C	; left
		push	y_26C64	; top
		push	02h	; angle
		push	BG_RANDOM_ANGLE_AND_SPEED	; group
		push	(PAT_BULLET16_BALL shl 16) or ((3 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		call	@bullets_add_pellet$qiiucuci pascal, x_26C5C, y_26C64, 02h, BG_RANDOM_ANGLE_AND_SPEED, ((3 shl 4) + 12)

loc_19338:
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_19351
		call	_snd_se_play c, 3
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1934B:
		mov	_boss_phase_frame, 0

loc_19351:
		pop	bp
		retn
mima_191CC	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_19353	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	short loc_193A2
		cmp	_boss_phase_frame, 190
		jge	short loc_1939C
		test	byte ptr _boss_phase_frame, 1Fh
		jnz	short loc_1937A
		push	x_26C5C	; left
		push	y_26C64	; top
		push	0	; angle
		push	BG_5_SPREAD_MEDIUM_AIMED	; group
		jmp	short loc_19391
; ---------------------------------------------------------------------------

loc_1937A:
		mov	ax, _boss_phase_frame
		and	ax, 31
		cmp	ax, 16
		jnz	short loc_193A2
		push	x_26C5C	; left
		push	y_26C64	; top
		push	0	; angle
		push	BG_4_SPREAD_MEDIUM_AIMED	; group

loc_19391:
		push	(PAT_BULLET16_BALL shl 16) or ((5 shl 4) + 10)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1939C:
		mov	_boss_phase_frame, 0

loc_193A2:
		pop	bp
		retn
mima_19353	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_193A4	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 0
		jnz	loc_19443
		mov	ax, _boss_damage
		cmp	ax, word_26CF0
		jge	short loc_193C3
		mov	ax, word_26CBE
		cmp	ax, word_26CF2
		jle	short loc_193D5

loc_193C3:
		inc	word_26C68
		mov	word_26C66, 0
		mov	word_26CBE, 0
		jmp	short loc_19443
; ---------------------------------------------------------------------------

loc_193D5:
		inc	word_26CBE
		mov	ax, word_26CBE
		cmp	ax, word_26CF6
		jl	short loc_193E8
		mov	word_26C66, 1

loc_193E8:
		cmp	byte_26CC0, 0
		jnz	short loc_193FD
		mov	ax, word_26C6A
		inc	ax
		mov	si, ax
		cmp	si, word_26CF4
		jl	short loc_1940A
		jmp	short loc_19408
; ---------------------------------------------------------------------------

loc_193FD:
		mov	ax, word_26C6A
		inc	ax
		mov	si, ax
		cmp	si, 7
		jle	short loc_1940A

loc_19408:
		xor	si, si

loc_1940A:
		mov	word_26C6A, si
		mov	bx, _boss_top_on_back_page
		cmp	word ptr [bx], 48
		jge	short loc_1941F
		mov	word_1EE56, 1
		jmp	short loc_19443
; ---------------------------------------------------------------------------

loc_1941F:
		mov	bx, _boss_top_on_back_page
		cmp	word ptr [bx], 64
		jle	short loc_19430
		mov	word_1EE56, 0FFFFh
		jmp	short loc_19443
; ---------------------------------------------------------------------------

loc_19430:
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	ax, 1
		sub	ax, dx
		mov	word_1EE56, ax

loc_19443:
		cmp	_boss_phase_frame, 10
		jge	short loc_19453
		mov	bx, _boss_top_on_back_page
		mov	ax, word_1EE56
		add	[bx], ax

loc_19453:
		pop	si
		pop	bp
		retn
mima_193A4	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_update	proc far

var_1		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		inc	_boss_phase_frame
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 72
		mov	word_205D8, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 56
		mov	word_205DA, ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		add	ax, 32
		mov	left_26C56, ax
		mov	ax, [bx]
		add	ax, 40
		mov	word_26C58, ax
		mov	ax, [bx]
		add	ax, 64
		mov	left_26C5A, ax
		mov	ax, [bx]
		add	ax, 64
		mov	x_26C5C, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 96
		mov	top_26C5E, ax
		mov	ax, [bx]
		add	ax, 16
		mov	word_26C60, ax
		mov	ax, [bx]
		add	ax, 114
		mov	top_26C62, ax
		mov	ax, [bx]
		add	ax, 44
		mov	y_26C64, ax
		test	byte ptr _stage_frame, 1
		jnz	short loc_1953B
		cmp	_reduce_effects, 0
		jnz	short loc_1950F
		mov	al, byte_26CF8
		add	al, 8
		mov	byte_26CF8, al
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 3
		xor	si, si
		mov	al, byte_26CF8
		jmp	short loc_19502
; ---------------------------------------------------------------------------

loc_194E9:
		push	0E000C8h
		mov	al, [bp+var_1]
		mov	ah, 0
		push	ax
		push	10h
		call	sub_1C287
		inc	si
		mov	al, [bp+var_1]
		add	al, 80h

loc_19502:
		mov	[bp+var_1], al
		cmp	si, 2
		jl	short loc_194E9
		call	grcg_off

loc_1950F:
		test	byte ptr word_26C68, 1
		jz	short loc_1953B
		inc	byte_26CFA
		cmp	byte_26CFA, 40h
		jb	short loc_19526
		mov	byte_26CFA, 0

loc_19526:
		mov	al, byte_26CFA
		mov	ah, 0
		mov	bx, 4
		cwd
		idiv	bx
		mov	dl, byte_26CF9
		sub	dl, al
		mov	byte_26CC2, dl

loc_1953B:
		cmp	word_26C68, 0
		jnz	loc_195CB
		mov	ax, _boss_phase_frame
		cwd
		sub	ax, dx
		sar	ax, 1
		mov	byte_26CC1, al
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		mov	byte_26CC2, al
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	Palettes[0 * size rgb_t].r, al
		mov	Palettes[0 * size rgb_t].g, 0
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	Palettes[0 * size rgb_t].b, al
		call	far ptr	palette_show
		cmp	_boss_phase_frame, 100
		jle	loc_198A8
		mov	al, byte_26CC2
		mov	byte_26CF9, al
		mov	byte_26CFA, 0
		mov	word_26C68, 1
		mov	_boss_phase_frame, 0
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	word_26C6A, dx
		mov	word_26CBE, 0
		mov	word_26CF0, 258h
		mov	word_26CF6, 2
		mov	word_26CF2, 0Ah
		mov	word_26CF4, 3
		mov	_boss_damage, 0
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_195CB:
		cmp	word_26C68, 1
		jnz	short loc_195F8
		mov	ax, word_26C6A
		or	ax, ax
		jz	short loc_195E5
		cmp	ax, 1
		jz	short loc_195EA
		cmp	ax, 2
		jz	short loc_195EF
		jmp	short loc_195F2
; ---------------------------------------------------------------------------

loc_195E5:
		call	mima_180EC
		jmp	short loc_195F2
; ---------------------------------------------------------------------------

loc_195EA:
		call	mima_181B3
		jmp	short loc_195F2
; ---------------------------------------------------------------------------

loc_195EF:
		call	mima_188AA

loc_195F2:
		call	mima_193A4
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_195F8:
		cmp	word_26C68, 2
		jnz	short loc_19676
		mov	ax, _boss_phase_frame
		mov	bx, 4
		cwd
		idiv	bx
		add	al, 32h	; '2'
		mov	byte_26CC1, al
		mov	ax, _boss_phase_frame
		mov	bx, 5
		cwd
		idiv	bx
		add	al, 1Eh
		mov	byte_26CC2, al
		call	mima_18BA6
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	dl, 51
		sub	dl, al
		mov	Palettes[0 * size rgb_t].r, dl
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	Palettes[0 * size rgb_t].g, al
		mov	Palettes[0 * size rgb_t].b, 50
		call	far ptr	palette_show
		cmp	_boss_phase_frame, 100
		jle	loc_198A8
		mov	word_26C68, 3
		mov	_boss_phase_frame, 0
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	word_26C6A, dx
		mov	word_26CBE, 0
		mov	al, byte_26CC2
		mov	byte_26CF9, al
		mov	word_26CF0, 2BCh
		jmp	loc_19728
; ---------------------------------------------------------------------------

loc_19676:
		cmp	word_26C68, 3
		jnz	short loc_196A3
		mov	ax, word_26C6A
		or	ax, ax
		jz	short loc_19690
		cmp	ax, 1
		jz	short loc_19695
		cmp	ax, 2
		jz	short loc_1969A
		jmp	short loc_1969D
; ---------------------------------------------------------------------------

loc_19690:
		call	mima_18905
		jmp	short loc_1969D
; ---------------------------------------------------------------------------

loc_19695:
		call	mima_18A1B
		jmp	short loc_1969D
; ---------------------------------------------------------------------------

loc_1969A:
		call	mima_18B4B

loc_1969D:
		call	mima_193A4
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_196A3:
		cmp	word_26C68, 4
		jnz	loc_19743
		mov	ax, _boss_phase_frame
		mov	bx, 4
		cwd
		idiv	bx
		add	al, 4Bh	; 'K'
		mov	byte_26CC1, al
		mov	ax, _boss_phase_frame
		mov	bx, 5
		cwd
		idiv	bx
		add	al, 32h	; '2'
		mov	byte_26CC2, al
		call	mima_18BA6
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	Palettes[0 * size rgb_t].r, al
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	dl, 51
		sub	dl, al
		mov	Palettes[0 * size rgb_t].g, dl
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	dl, 51
		sub	dl, al
		mov	Palettes[0 * size rgb_t].b, dl
		call	far ptr	palette_show
		cmp	_boss_phase_frame, 100
		jle	loc_198A8
		mov	word_26C68, 5
		mov	_boss_phase_frame, 0
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	word_26C6A, dx
		mov	al, byte_26CC2
		mov	byte_26CF9, al
		mov	word_26CBE, 0
		mov	word_26CF0, 320h

loc_19728:
		mov	word_26CF6, 2
		mov	word_26CF2, 0Ch
		mov	word_26CF4, 3
		mov	_boss_damage, 0
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_19743:
		cmp	word_26C68, 5
		jnz	short loc_19770
		mov	ax, word_26C6A
		or	ax, ax
		jz	short loc_1975D
		cmp	ax, 1
		jz	short loc_19762
		cmp	ax, 2
		jz	short loc_19767
		jmp	short loc_1976A
; ---------------------------------------------------------------------------

loc_1975D:
		call	mima_18C4A
		jmp	short loc_1976A
; ---------------------------------------------------------------------------

loc_19762:
		call	mima_18DE0
		jmp	short loc_1976A
; ---------------------------------------------------------------------------

loc_19767:
		call	mima_18EB8

loc_1976A:
		call	mima_193A4
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_19770:
		cmp	word_26C68, 6
		jnz	loc_1980A
		mov	ax, _boss_phase_frame
		mov	bx, 4
		cwd
		idiv	bx
		add	al, 64h	; 'd'
		mov	byte_26CC1, al
		mov	ax, _boss_phase_frame
		mov	bx, 5
		cwd
		idiv	bx
		add	al, 46h	; 'F'
		mov	byte_26CC2, al
		call	mima_18BA6
		mov	ax, _boss_phase_frame
		sar	ax, 1
		mov	dl, 51
		sub	dl, al
		mov	Palettes[0 * size rgb_t].r, dl
		mov	Palettes[0 * size rgb_t].g, 0
		mov	Palettes[0 * size rgb_t].b, 0
		call	far ptr	palette_show
		cmp	_boss_phase_frame, 100
		jle	loc_198A8
		mov	al, byte_26CC2
		mov	byte_26CF9, al
		mov	word_26C68, 7
		mov	_boss_phase_frame, 0
		call	@randring2_next8_and$quc pascal, 7
		mov	ah, 0
		mov	word_26C6A, ax
		mov	word_26CBE, 0
		mov	word_26CF0, 5DCh
		mov	word_26CF6, 3
		mov	word_26CF2, 0C8h
		mov	word_26CF4, 9
		mov	byte_26CC0, 1
		mov	_boss_damage, 0
		mov	byte_26CC4, 2
		jmp	loc_198A8
; ---------------------------------------------------------------------------

loc_1980A:
		cmp	word_26C68, 7
		jnz	short loc_19851
		mov	bx, word_26C6A
		cmp	bx, 8
		ja	short loc_1984C
		add	bx, bx
		jmp	cs:off_19937[bx]

loc_19821:
		call	mima_18C4A
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_19826:
		call	mima_188AA
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_1982B:
		call	mima_18905
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_19830:
		call	mima_181B3
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_19835:
		call	mima_18A1B
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_1983A:
		call	mima_18B4B
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_1983F:
		call	mima_180EC
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_19844:
		call	mima_18DE0
		jmp	short loc_1984C
; ---------------------------------------------------------------------------

loc_19849:
		call	mima_18EB8

loc_1984C:
		call	mima_193A4
		jmp	short loc_198A8
; ---------------------------------------------------------------------------

loc_19851:
		cmp	word_26C68, 9
		jnz	short loc_198A8
		mov	ax, word_26C6A
		or	ax, ax
		jz	short loc_1986B
		cmp	ax, 1
		jz	short loc_19870
		cmp	ax, 2
		jz	short loc_19875
		jmp	short loc_19878
; ---------------------------------------------------------------------------

loc_1986B:
		call	mima_19173
		jmp	short loc_19878
; ---------------------------------------------------------------------------

loc_19870:
		call	mima_191CC
		jmp	short loc_19878
; ---------------------------------------------------------------------------

loc_19875:
		call	mima_19353

loc_19878:
		call	mima_193A4
		cmp	_boss_phase_frame, 1
		jnz	short loc_1988A
		mov	bx, _boss_top_on_back_page
		mov	word ptr [bx], 64

loc_1988A:
		cmp	_boss_phase_frame, 30
		jge	short loc_198A8
		mov	ax, x_26C5C
		cmp	ax, _player_topleft.x
		jge	short loc_1989F
		mov	ax, 1
		jmp	short loc_198A2
; ---------------------------------------------------------------------------

loc_1989F:
		mov	ax, -1

loc_198A2:
		mov	bx, _boss_left_on_back_page
		add	[bx], ax

loc_198A8:
		call	mima_17C92
		call	mima_17F27
		call	mima_17D59
		cmp	word_26C68, 8
		jnz	short loc_19924
		call	mima_19C8D
		or	ax, ax
		jnz	short loc_19930
		inc	word_26C68
		mov	patnum_2064E, 128
		mov	word_26CBE, 0
		mov	_boss_phase_frame, 0
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	word_26C6A, dx
		mov	word_26CBE, 0
		mov	_boss_damage, 0
		mov	word_26CF0, 44Ch
		mov	word_26CF6, 2
		mov	word_26CF2, 0C8h
		mov	word_26CF4, 3
		mov	byte_26CC5, 1
		mov	byte_26CC4, 2
		mov	byte_26CC1, 0C8h
		mov	byte_26CC2, 96h
		mov	al, byte_26CC2
		mov	byte_26CF9, al
		jmp	short loc_19930
; ---------------------------------------------------------------------------

loc_19924:
		cmp	word_26C68, 0Ah
		jnz	short loc_19930
		nopcall	mima_end

loc_19930:
		mov	ax, 1
		pop	si
		leave
		retf
mima_update	endp

; ---------------------------------------------------------------------------
		db 0
off_19937	dw offset loc_19821
		dw offset loc_19826
		dw offset loc_1982B
		dw offset loc_19830
		dw offset loc_19835
		dw offset loc_1983A
		dw offset loc_1983F
		dw offset loc_19844
		dw offset loc_19849

	@skill_calculate$qv procdesc pascal near
BOSS_5_TEXT	ends

main_03__TEXT	segment	byte public 'CODE' use16

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_init	proc far
		push	bp
		mov	bp, sp
		push	si
		call	sub_1A6C5
		call	@dialog_pre$qv
		call	super_clean pascal, (128 shl 16) or 192
		call	super_entry_bfnt pascal, ds, offset aMima_bft ; "mima.bft"
		call	@dialog_script_stage5_pre_intro_a$qv
		mov	vsync_Count1, 0
		call	@frame_delay$qi pascal, 10
		call	sub_1A529
		call	super_clean pascal, (128 shl 16) or 192
		mov	super_patnum, 80h
		call	super_entry_bfnt pascal, ds, offset aMima1_bft ; "mima1.bft"
		call	super_entry_bfnt pascal, ds, offset aStage3_b_btt ; "stage3_b.btt"
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 80)
		mov	ax, _boss_left_on_page[0 * word]
		mov	_boss_left_on_page[1 * word], ax
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP + 48)
		mov	ax, _boss_top_on_page[0 * word]
		mov	_boss_top_on_page[1 * word], ax
		mov	patnum_2064E, 128
		call	@dialog_script_stage5_pre_unseale$qv
		push	1
		call	palette_white_out
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_fill
		call	grcg_off
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_left_on_page[bx]
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		push	patnum_2064E
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 48
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 96
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		add	ax, 2
		push	ax
		call	super_put_rect
		call	super_roll_put pascal, _player_topleft.x, _player_topleft.y, PAT_PLAYCHAR_STILL
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].x
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		add	ax, PLAYER_OPTION_TO_OPTION_DISTANCE
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		call	_snd_se_play stdcall, 10
		call	_snd_se_update
		call	sub_1A46B
		push	3
		call	palette_white_in
		push	ds
		push	offset aMima_m	; "mima.m"
		nopcall	sub_13ABB
		add	sp, 6
		call	@dialog_script_stage5_pre_winged_$qv
		call	@dialog_post$qv
		call	sub_D376
		mov	_boss_damage, 0
		mov	byte_2066A, 0
		mov	_boss_phase_frame, 0
		mov	byte_2066B, 0
		mov	word_26C68, 0
		mov	word_26C66, 0
		mov	word_26CBE, 0
		mov	_tile_mode, TM_NONE
		mov	byte_26CC1, 0
		mov	byte_26CC2, 0
		mov	byte_26CC3, 0Dh
		mov	byte_26CC5, 3
		mov	byte_26CC4, 0Ch
		graph_accesspage _page_front
		call	graph_clear
		graph_accesspage _page_back
		call	graph_clear
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 11
		call	grc_setclip pascal, (PLAYFIELD_RIGHT shl 16) or 0, ((RES_X - 1) shl 16) or (RES_Y - 1)
		graph_accesspage _page_front
		call	grcg_fill
		graph_accesspage _page_back
		call	grcg_fill
		call	grcg_off
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		mov	word_26C6A, 0
		xor	si, si
		jmp	short loc_19C0D
; ---------------------------------------------------------------------------

loc_19C02:
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6DC4h], 0
		inc	si

loc_19C0D:
		cmp	si, 8
		jl	short loc_19C02
		mov	byte_26CC0, 0
		call	mima_180AC
		pop	si
		pop	bp
		retf
mima_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_19C1D	proc near
		push	bp
		mov	bp, sp
		mov	PaletteTone, 0
		call	far ptr	palette_show
		les	bx, _resident
		mov	eax, es:[bx+mikoconfig_t.score_highest]
		cmp	eax, _score
		jnb	short loc_19C41
		mov	eax, _score
		jmp	short loc_19C4A
; ---------------------------------------------------------------------------

loc_19C41:
		les	bx, _resident
		mov	eax, es:[bx+mikoconfig_t.score_highest]

loc_19C4A:
		les	bx, _resident
		mov	es:[bx+mikoconfig_t.score_highest], eax
		mov	eax, _score
		imul	eax, 10
		movzx	edx, es:[bx+mikoconfig_t.continues_used]
		add	eax, edx
		mov	es:[bx+mikoconfig_t.score], eax
		mov	es:[bx+mikoconfig_t.stage], 7Fh
		mov	al, _lives
		mov	es:[bx+mikoconfig_t.rem_lives], al
		mov	al, _bombs
		mov	es:[bx+mikoconfig_t.rem_bombs], al
		call	@skill_calculate$qv
		call	@GameExecl$qnxc c, offset aMaine_0, ds	; "maine"
		pop	bp
		retn
mima_19C1D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_19C8D	proc near
		push	bp
		mov	bp, sp
		call	sub_D376
		nopcall	sub_10E0A
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_left_on_page[bx]
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		push	patnum_2064E
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 48
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 96
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		add	ax, 2
		push	ax
		call	super_put_rect
		call	@dialog_pre$qv
		call	@dialog_script_stage5_form1defeat$qv
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.continues_used], 0
		jz	short loc_19D48
		kajacall	KAJA_SONG_FADE, 10
		pop	cx
		push	0Ah
		call	palette_white_out
		call	@frame_delay$qi pascal, 50
		add	_score, 50000
		call	mima_19C1D
		mov	ax, 1
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_19D48:
		call	super_clean pascal, (128 shl 16) or 192
		mov	super_patnum, 80h
		call	super_entry_bfnt pascal, ds, offset aMima2_bft ; "mima2.bft"
		call	@dialog_post$qv
		graph_accesspage _page_front
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_fill
		graph_accesspage _page_back
		call	grcg_fill
		call	grcg_off
		mov	byte_26CC0, 0
		xor	ax, ax
		pop	bp
		retn
mima_19C8D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

mima_end	proc far
		push	bp
		mov	bp, sp

		; ZUN bug: This renders Mima's sprite to [page_back] on top of the
		; boss background rendered earlier, right before animating the defeat
		; dialog on [page_front] and launching into MAINE.EXE, which means that
		; none of this will ever show up. Given the fact that this code exists,
		; it probably was ZUN's intention to render the defeat dialog on top of
		; what's rendered here - i.e, before rendering any player shot, item,
		; bullet, or spark sprites - rather than blindly printing the text on
		; top of whatever white VRAM pixels that may have been in the text box
		; area in the previous full frame.
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_left_on_page[bx]
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		push	patnum_2064E
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 48
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		add	ax, 96
		push	ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		push	_boss_top_on_page[bx]
		mov	ax, patnum_2064E
		add	ax, 2
		push	ax
		call	super_put_rect
		call	@dialog_script_stage5_post_animat$qv
		add	_score, 100000
		les	bx, _resident
		cmp	es:[bx+mikoconfig_t.continues_used], 0
		jnz	short loc_19E2A
		call	sub_1CD8E

loc_19E2A:
		call	mima_19C1D
		pop	bp
		retf
mima_end	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_19E2F	proc far

@@top       	= word ptr -4
@@tile_image	= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		cmp	_page_back, 0
		jnz	loc_19EEF
		call	egc_on
		outw2	EGC_ACTIVEPLANEREG, 0FFF7h
		outw2	EGC_READPLANEREG, 3FFh
		outw2	EGC_MASKREG, 0FFFFh
		outw2	EGC_ADDRRESSREG, 0
		outw2	EGC_BITLENGTHREG, 0Fh
		outw2	EGC_MODE_ROP_REG, (EGC_WS_PATREG or EGC_RL_MEMREAD)
		call	@tiles_invalidate_rect$qiiii pascal, (176 shl 16) or 156, (96 shl 16) or 96
		call	@tiles_egc_render$qv
		outw2	EGC_MODE_ROP_REG, (EGC_WS_ROP or 0FCh)
		mov	word_26D54, 152
		mov	ax, _scroll_line
		add	word_26D54, ax
		cmp	word_26D54, RES_Y
		jl	short loc_19EA7
		sub	word_26D54, RES_Y

loc_19EA7:
		mov	ax, word_26D54
		mov	[bp+@@top], ax
		mov	[bp+@@tile_image], 0
		jmp	short loc_19EE4
; ---------------------------------------------------------------------------

loc_19EB4:
		mov	si, 176
		mov	di, [bp+@@tile_image]
		jmp	short loc_19ECA
; ---------------------------------------------------------------------------

loc_19EBC:
		call	@tile_egc_roll_copy_8$qiii pascal, si, [bp+@@top], di
		add	si, TILE_W
		inc	di

loc_19ECA:
		cmp	si, 272
		jl	short loc_19EBC
		add	[bp+@@top], TILE_H
		cmp	[bp+@@top], RES_Y
		jl	short loc_19EE0
		sub	[bp+@@top], RES_Y

loc_19EE0:
		add	[bp+@@tile_image], 10h

loc_19EE4:
		cmp	[bp+@@tile_image], 60h
		jl	short loc_19EB4
		call	egc_off

loc_19EEF:
		pop	di
		pop	si
		leave
		retf
sub_19E2F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss4_invalidate$qv
@midboss4_invalidate$qv	proc far
		push	bp
		mov	bp, sp
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		mov	bx, _boss_left_on_back_page
		push	word ptr [bx]	; left
		mov	bx, _boss_top_on_back_page
		push	word ptr [bx]	; top
		push	(64 shl 16) or 64	; (w shl 16) or h
		call	@tiles_invalidate_rect$qiiii
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		mov	ax, word_26D7A
		pop	bp
		retf
@midboss4_invalidate$qv	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_19F52	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	si, point_26D76.y
		add	si, _scroll_line
		or	si, si
		jge	short loc_19F68
		add	si, RES_Y
		jmp	short loc_19F72
; ---------------------------------------------------------------------------

loc_19F68:
		cmp	si, RES_Y
		jl	short loc_19F72
		sub	si, RES_Y

loc_19F72:
		cmp	byte_2066B, 0
		jz	short loc_19F9E
		call	_snd_se_play c, 4
		call	super_roll_put_1plane pascal, point_26D76.x, si, patnum_2064E, large PLANE_PUT or GC_BRGI
		mov	byte_2066B, 0
		jmp	short loc_19FAC
; ---------------------------------------------------------------------------

loc_19F9E:
		call	super_roll_put pascal, point_26D76.x, si, patnum_2064E

loc_19FAC:
		pop	si
		pop	bp
		retn
midboss4_19F52	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_19FAF	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	ax, _boss_phase_frame
		mov	bx, 24
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_19FDA
		mov	ax, point_26D76.x
		add	ax, 32
		push	ax
		mov	ax, point_26D76.y
		add	ax, 32
		push	ax
		push	80h
		push	bx
		push	1
		call	sub_4090

loc_19FDA:
		mov	di, 0Ah
		mov	ax, word_1EE98
		sar	ax, 3
		add	di, ax
		inc	word_1EE98
		cmp	word_1EE98, 40h
		jl	short loc_1A021
		mov	word_1EE98, 0
		mov	_boss_phase_frame, 0
		mov	byte_2066A, 2
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh
		mov	word_26D7A, 0
		mov	word_26CFE, 0FFFFh
		mov	word_20616, 660h
		jmp	short loc_1A040
; ---------------------------------------------------------------------------

loc_1A021:
		mov	si, point_26D76.y
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1A033
		sub	si, RES_Y

loc_1A033:
		call	super_zoom pascal, point_26D76.x, si, di, 2

loc_1A040:
		pop	di
		pop	si
		pop	bp
		retn
midboss4_19FAF	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A044	proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		mov	ax, point_26D76.x
		add	ax, 8
		push	ax
		push	point_26D76.y
		push	300030h
		call	sub_1283C
		mov	di, ax
		or	ax, ax
		jz	short loc_1A0CA
		mov	byte_2066B, 1
		add	_boss_damage, di
		mov	si, point_26D76.y
		add	si, _scroll_line
		cmp	si, RES_Y
		jl	short loc_1A07E
		sub	si, RES_Y

loc_1A07E:
		cmp	_boss_damage, 400
		jl	short loc_1A0CA
		cmp	si, 336
		jge	short loc_1A0CA
		cmp	si, 96
		jle	short loc_1A0CA
		call	_snd_se_play c, 2
		mov	byte_2066A, 1
		add	_score_delta, 50000
		cmp	word_20616, 660h
		jnz	short loc_1A0B6
		mov	di, IT_1UP
		jmp	short loc_1A0B9
; ---------------------------------------------------------------------------

loc_1A0B6:
		mov	di, IT_BOMB

loc_1A0B9:
		mov	ax, point_26D76.x
		add	ax, 24
		call	@items_add$qiii pascal, ax, point_26D76.y, di

loc_1A0CA:
		pop	di
		pop	si
		pop	bp
		retn
midboss4_1A044	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A0CE	proc near
		push	bp
		mov	bp, sp
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1A101
		call	_snd_se_play c, 3
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		call	@bullets_add_pellet$qiiucuci pascal, ax, (PLAYFIELD_TOP + 80), 40h, BG_1, (5 shl 4)

loc_1A101:
		pop	bp
		retn
midboss4_1A0CE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A103	proc near

@@group		= byte ptr -1

		push	bp
		mov	bp, sp
		sub	sp, 2
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	short locret_1A14F
		call	_snd_se_play c, 3
		cmp	_rank, RANK_EASY
		jnz	short loc_1A12B
		mov	al, BG_4_SPREAD_WIDE
		jmp	short loc_1A12D
; ---------------------------------------------------------------------------

loc_1A12B:
		mov	al, BG_5_SPREAD_MEDIUM

loc_1A12D:
		mov	[bp+@@group], al
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		push	ax	; left
		push	(PLAYFIELD_TOP + 80)	; top
		push	40h	; angle
		push	word ptr [bp+@@group]	; group
		mov	ax, _boss_phase_frame
		add	ax, -((1 shl 4) + 4)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci

locret_1A14F:
		leave
		retn
midboss4_1A103	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A151	proc near
		push	bp
		mov	bp, sp
		mov	ax, _boss_phase_frame
		mov	bx, 8
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1A17C
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti pascal, ax, (PLAYFIELD_TOP + 80), 40h, 80h, PAT_BULLET16_OUTLINED_BALL_BEIGE, bx

loc_1A17C:
		pop	bp
		retn
midboss4_1A151	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A17E	proc near
		push	bp
		mov	bp, sp
		mov	al, _rank
		cbw
		add	ax, ax
		mov	bx, 16
		sub	bx, ax
		mov	ax, _boss_phase_frame
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1A1B4
		mov	byte_23A70, 10h
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		push	ax
		push	500006h
		push	6Fh ; 'o'
		call	sub_12A19

loc_1A1B4:
		pop	bp
		retn
midboss4_1A17E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

midboss4_1A1B6	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	ax, _boss_phase_frame
		mov	bx, 16
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1A1FC
		call	_snd_se_play c, 7
		xor	si, si
		jmp	short loc_1A1F7
; ---------------------------------------------------------------------------

loc_1A1D5:
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		push	ax	; left
		push	top_26D00	; top
		call	@randring2_next8_and$quc pascal, 3Fh
		add	al, 20h
		push	ax	; angle
		push	BG_1	; group
		push	((4 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci
		inc	si

loc_1A1F7:
		cmp	si, 4
		jl	short loc_1A1D5

loc_1A1FC:
		pop	si
		pop	bp
		retn
midboss4_1A1B6	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public @midboss4_update_and_render$qv
@midboss4_update_and_render$qv	proc far
		push	bp
		mov	bp, sp
		mov	ax, point_26D76.x
		add	ax, 24
		mov	word_205D8, ax
		mov	ax, point_26D76.y
		add	ax, 24
		mov	word_205DA, ax
		inc	_boss_phase_frame
		cmp	_boss_phase_frame, 1
		jnz	short loc_1A296
		cmp	word_26CFE, 0
		jnz	short loc_1A234
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + 32)
		mov	patnum_2064E, 150
		jmp	short loc_1A240
; ---------------------------------------------------------------------------

loc_1A234:
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_RIGHT - 32 - 64)
		mov	patnum_2064E, 149

loc_1A240:
		mov	ax, _boss_left_on_page[0 * word]
		mov	_boss_left_on_page[1 * word], ax
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_top_on_page[1 * word], (PLAYFIELD_TOP - 32)
		mov	_boss_left_on_back_page, offset _boss_left_on_page
		mov	_boss_top_on_back_page, offset _boss_top_on_page
		mov	_boss_damage, 0
		mov	byte_2066A, 0
		mov	byte_2066B, 0
		mov	word_26CFC, 0
		cmp	word_26CFE, 0
		jnz	short loc_1A280
		mov	ax, 1
		jmp	short loc_1A283
; ---------------------------------------------------------------------------

loc_1A280:
		mov	ax, 0FFFFh

loc_1A283:
		mov	word_26CFE, ax
		mov	byte_26D7D, 0
		mov	byte_26D7C, 0
		mov	word_26D7A, 1

loc_1A296:
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		add	ax, 48
		mov	top_26D00, ax
		mov	ax, [bx]
		mov	point_26D76.y, ax
		cmp	byte_2066A, 0
		jnz	loc_1A405
		cmp	word_26CFC, 0
		jnz	loc_1A341
		mov	ax, word_26CFE
		shl	ax, 3
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		mov	bx, _boss_top_on_back_page
		add	word ptr [bx], 2
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_26D76.x, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	point_26D76.y, ax
		test	byte ptr _boss_phase_frame, 7
		jnz	short loc_1A30A
		call	_snd_se_play c, 7
		mov	ax, word_26CFE
		shl	ax, 4
		add	ax, point_26D76.x
		add	ax, 28
		call	@bullets_add_pellet$qiiucuci pascal, ax, top_26D00, 40h, BG_1, (5 shl 4)

loc_1A30A:
		cmp	_boss_phase_frame, 32
		jl	loc_1A405
		mov	word_26CFC, 1
		mov	_boss_phase_frame, 2 ; Skip the fly-in animation
		mov	patnum_2064E, 148
		mov	ax, 0FFFFh
		imul	word_26CFE
		mov	word_26CFE, ax
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 5
		cwd
		idiv	bx
		mov	byte_26D7C, dl
		jmp	loc_1A405
; ---------------------------------------------------------------------------

loc_1A341:
		cmp	word_26CFC, 1
		jnz	loc_1A405
		cmp	_boss_phase_frame, 50
		jle	loc_1A405
		cmp	word_26CFE, 0FFFFh
		jnz	short loc_1A362
		mov	patnum_2064E, 149
		jmp	short loc_1A368
; ---------------------------------------------------------------------------

loc_1A362:
		mov	patnum_2064E, 150

loc_1A368:
		mov	ax, word_26CFE
		shl	ax, 2
		mov	bx, _boss_left_on_back_page
		add	[bx], ax
		mov	ax, [bx]
		mov	point_26D76.x, ax
		mov	al, byte_26D7C
		mov	ah, 0
		mov	bx, ax
		cmp	bx, 4
		ja	short loc_1A3A3
		add	bx, bx
		jmp	cs:off_1A419[bx]

loc_1A38C:
		call	midboss4_1A0CE
		jmp	short loc_1A3A3
; ---------------------------------------------------------------------------

loc_1A391:
		call	midboss4_1A103
		jmp	short loc_1A3A3
; ---------------------------------------------------------------------------

loc_1A396:
		call	midboss4_1A151
		jmp	short loc_1A3A3
; ---------------------------------------------------------------------------

loc_1A39B:
		call	midboss4_1A17E
		jmp	short loc_1A3A3
; ---------------------------------------------------------------------------

loc_1A3A0:
		call	midboss4_1A1B6

loc_1A3A3:
		cmp	byte_26D7D, 0Ch
		jnb	short loc_1A3DC
		cmp	_boss_phase_frame, 114
		jl	short loc_1A405
		mov	_boss_phase_frame, 2 ; Skip the fly-in animation
		mov	patnum_2064E, 148
		mov	ax, 0FFFFh
		imul	word_26CFE
		mov	word_26CFE, ax
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 5
		cwd
		idiv	bx
		mov	byte_26D7C, dl
		inc	byte_26D7D
		jmp	short loc_1A405
; ---------------------------------------------------------------------------

loc_1A3DC:
		cmp	point_26D76.x, 0
		jle	short loc_1A3EB
		cmp	point_26D76.x, 384
		jl	short loc_1A405

loc_1A3EB:
		mov	_boss_phase_frame, 0
		mov	word_26CFE, 0FFFFh
		mov	word_20616, 660h
		mov	word_26D7A, 0
		pop	bp
		retf
; ---------------------------------------------------------------------------

loc_1A405:
		cmp	byte_2066A, 0
		jz	short loc_1A411
		call	midboss4_19FAF
		pop	bp
		retf
; ---------------------------------------------------------------------------

loc_1A411:
		call	midboss4_1A044
		call	midboss4_19F52
		pop	bp
		retf
@midboss4_update_and_render$qv	endp

; ---------------------------------------------------------------------------
off_1A419	dw offset loc_1A38C
		dw offset loc_1A391
		dw offset loc_1A396
		dw offset loc_1A39B
		dw offset loc_1A3A0

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1A423	proc near

var_2		= word ptr -2
arg_0		= word ptr  4
arg_2		= word ptr  6

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		xor	di, di
		mov	[bp+var_2], 0
		jmp	short loc_1A45F
; ---------------------------------------------------------------------------

loc_1A434:
		xor	si, si
		jmp	short loc_1A457
; ---------------------------------------------------------------------------

loc_1A438:
		mov	ax, si
		shl	ax, 5
		add	ax, [bp+arg_2]
		push	ax
		mov	ax, [bp+var_2]
		shl	ax, 5
		add	ax, [bp+arg_0]
		push	ax
		lea	ax, [di+128]
		push	ax
		call	super_put
		inc	si
		inc	di

loc_1A457:
		cmp	si, 8
		jl	short loc_1A438
		inc	[bp+var_2]

loc_1A45F:
		cmp	[bp+var_2], 8
		jl	short loc_1A434
		pop	di
		pop	si
		leave
		retn	4
sub_1A423	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1A46B	proc near

@@y		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		xor	di, di
		mov	[bp+@@y], 0
		mov	di, 320
		add	di, _scroll_line
		cmp	di, RES_Y
		jl	short loc_1A48B
		sub	di, RES_Y

loc_1A48B:
		lea	ax, [di+32]
		add	[bp+@@y], ax
		cmp	[bp+@@y], RES_Y
		jl	short loc_1A49D
		sub	[bp+@@y], RES_Y

loc_1A49D:
		call	super_roll_put pascal, 32, di, 34
		call	super_roll_put pascal, 32, [bp+@@y], 42
		call	super_roll_put pascal, 64, di, 35
		call	super_roll_put pascal, 64, [bp+@@y], 43
		call	super_roll_put pascal, 96, di, 36
		call	super_roll_put pascal, 96, [bp+@@y], 44
		xor	si, si
		jmp	short loc_1A508
; ---------------------------------------------------------------------------

loc_1A4E3:
		mov	ax, si
		shl	ax, 5
		add	ax, 128
		call	super_roll_put pascal, ax, di, 37
		mov	ax, si
		shl	ax, 5
		add	ax, 128
		call	super_roll_put pascal, ax, [bp+@@y], 45
		inc	si

loc_1A508:
		cmp	si, 8
		jl	short loc_1A4E3
		call	super_roll_put pascal, 384, di, 38
		call	super_roll_put pascal, 384, [bp+@@y], 46
		pop	di
		pop	si
		leave
		retn
sub_1A46B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1A529	proc near
		push	bp
		mov	bp, sp
		push	si
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or PLAYFIELD_TOP, (PLAYFIELD_RIGHT shl 16) or 320
		call	_snd_se_play c, 9
		mov	si, 96h
		jmp	loc_1A613
; ---------------------------------------------------------------------------

loc_1A54E:
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 10
		call	grcg_circlefill pascal, (224 shl 16) or 144, si
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 13
		push	(224 shl 16) or 144
		mov	ax, si
		mov	bx, 50
		cwd
		idiv	bx
		shl	dx, 2
		push	dx
		call	grcg_circle
		call	grcg_setcolor pascal, (GC_RMW shl 16) + V_WHITE
		push	(224 shl 16) or 144
		mov	ax, si
		mov	bx, 30
		cwd
		idiv	bx
		imul	dx, 7
		push	dx
		call	grcg_circle
		call	@frame_delay$qi pascal, 1
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_circlefill pascal, (224 shl 16) or 144, si
		push	(224 shl 16) or 144
		mov	ax, si
		mov	bx, 50
		cwd
		idiv	bx
		shl	dx, 2
		push	dx
		call	grcg_circle
		push	(224 shl 16) or 144
		mov	ax, si
		mov	bx, 30
		cwd
		idiv	bx
		imul	dx, 7
		push	dx
		call	grcg_circle
		mov	ax, 150
		sub	ax, si
		mov	bx, 3
		cwd
		idiv	bx
		add	ax, ax
		add	ax, 100
		mov	PaletteTone, ax
		call	far ptr	palette_show
		call	_snd_se_update
		dec	si

loc_1A613:
		or	si, si
		jg	loc_1A54E
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_fill
		call	grcg_off
		push	600000h
		call	sub_1A423
		call	super_roll_put pascal, _player_topleft.x, _player_topleft.y, PAT_PLAYCHAR_STILL
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].x
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		add	ax, PLAYER_OPTION_TO_OPTION_DISTANCE
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		call	sub_1A46B
		xor	si, si
		jmp	short loc_1A6B2
; ---------------------------------------------------------------------------

loc_1A697:
		mov	ax, si
		imul	ax, 10
		mov	dx, 200
		sub	dx, ax
		mov	PaletteTone, dx
		call	far ptr	palette_show
		call	@frame_delay$qi pascal, 3
		inc	si

loc_1A6B2:
		cmp	si, 10
		jl	short loc_1A697
		mov	PaletteTone, 100
		call	far ptr	palette_show
		pop	si
		pop	bp
		retn
sub_1A529	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1A6C5	proc near
		push	bp
		mov	bp, sp
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, _player_topleft.y
		mov	bx, ax
		mov	_player_top_on_page[bx], dx
		mov	_scroll_line, 0
		mov	word_20348, 0
		graph_accesspage 0
		call	graph_clear
		graph_accesspage 1
		call	graph_clear
		mov	vsync_Count1, 0
		call	@frame_delay$qi pascal, 1
		call	graph_scrollup pascal, 0
		graph_accesspage _page_front
		call	super_roll_put pascal, _player_topleft.x, _player_topleft.y, PAT_PLAYCHAR_STILL
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	dx, _player_topleft.x
		add	dx, -PLAYER_LEFT_TO_OPTION_LEFT_LEFT
		mov	bx, ax
		mov	_player_option_left_topleft[bx].x, dx
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	dx, _player_topleft.y
		add	dx, ((PLAYER_H / 2) - (PLAYER_OPTION_H / 2))
		mov	bx, ax
		mov	_player_option_left_topleft[bx].y, dx
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		mov	dl, _page_front
		mov	dh, 0
		shl	dx, 2
		mov	bx, dx
		mov	_player_option_left_topleft[bx].x, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].y
		mov	dl, _page_front
		mov	dh, 0
		shl	dx, 2
		mov	bx, dx
		mov	_player_option_left_topleft[bx].y, ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].x
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		add	ax, PLAYER_OPTION_TO_OPTION_DISTANCE
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		pop	bp
		retn
sub_1A6C5	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_init	proc far
		push	bp
		mov	bp, sp
		push	si
		call	sub_1A6C5
		call	@dialog_pre$qv
		call	super_clean pascal, (128 shl 16) or 192
		mov	super_patnum, 80h
		call	super_entry_bfnt pascal, ds, offset aMima_bft_0 ; "mima.bft"
		call	@dialog_script_stage4_pre_intro_a$qv
		mov	vsync_Count1, 0
		call	@frame_delay$qi pascal, 10
		call	sub_1A529
		call	@dialog_script_generic_part_anima$q17dialog_sequence_t pascal, DS_PREBOSS
		call	super_clean pascal, (128 shl 16) or 511
		mov	super_patnum, 80h
		call	super_entry_bfnt pascal, ds, offset aStage3_b_bft ; "stage3_b.bft"
		call	super_entry_bfnt pascal, ds, offset aStage3_b_btt_0 ; "stage3_b.btt"
		mov	_boss_left_on_page[0 * word], (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 48)
		mov	ax, _boss_left_on_page[0 * word]
		mov	_boss_left_on_page[1 * word], ax
		mov	_boss_top_on_page[0 * word], (PLAYFIELD_TOP + 48)
		mov	ax, _boss_top_on_page[0 * word]
		mov	_boss_top_on_page[1 * word], ax
		mov	point_26D76.x, (PLAYFIELD_LEFT + (PLAYFIELD_W / 2) - 48)
		mov	point_26D76.y, (PLAYFIELD_TOP + 48)
		mov	patnum_2064E, 128
		push	1
		call	palette_white_out
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_fill
		call	grcg_off
		call	grc_setclip pascal, (PLAYFIELD_LEFT shl 16) or 0, (PLAYFIELD_RIGHT shl 16) or (RES_Y - 1)
		call	super_put_rect pascal, point_26D76.x, point_26D76.y, patnum_2064E
		mov	ax, point_26D76.x
		add	ax, 48
		push	ax
		push	point_26D76.y
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		call	super_roll_put pascal, _player_topleft.x, _player_topleft.y, PAT_PLAYCHAR_STILL
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].x
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		add	ax, PLAYER_OPTION_TO_OPTION_DISTANCE
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		call	_snd_se_play stdcall, 10
		call	_snd_se_update
		call	sub_1A46B
		push	1
		call	palette_white_in
		push	ds
		push	offset aBoss3_m	; "boss3.m"
		nopcall	sub_13ABB
		add	sp, 6
		call	@dialog_script_stage4_pre_marisa_$qv
		call	graph_clear
		call	super_put_rect pascal, point_26D76.x, point_26D76.y, patnum_2064E
		mov	ax, point_26D76.x
		add	ax, 48
		push	ax
		push	point_26D76.y
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		call	super_roll_put pascal, _player_topleft.x, _player_topleft.y, PAT_PLAYCHAR_STILL
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].x
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		mov	ax, _player_option_left_topleft[bx].x
		add	ax, PLAYER_OPTION_TO_OPTION_DISTANCE
		push	ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 2
		mov	bx, ax
		push	_player_option_left_topleft[bx].y
		push	PAT_OPTION_A
		call	super_roll_put_tiny
		mov	al, _page_front
		mov	ah, 0
		call	graph_copy_page pascal, ax
		graph_accesspage _page_back
		graph_showpage _page_front
		mov	_tile_mode, TM_NONE
		call	sub_D376
		mov	_boss_damage, 0
		mov	byte_2066A, 0
		mov	_boss_phase_frame, 0
		mov	byte_2066B, 0
		mov	word_26CFC, 0
		mov	byte_1EE96, 0
		xor	si, si
		jmp	short loc_1AA1A
; ---------------------------------------------------------------------------

loc_1A9FB:
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D4Eh], 0
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D46h], 2
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D3Eh], 0
		inc	si

loc_1AA1A:
		cmp	si, 4
		jl	short loc_1A9FB
		mov	byte_26D7E, 1
		mov	byte_1FFF8, 9
		mov	word_1FFF6, 18h
		mov	word_1FFF0, 18h
		mov	word_1FFF2, 4
		mov	word_26CFE, 0
		mov	byte_26D4C, 0
		mov	byte_26D4D, 0
		mov	byte_26D4E, 0
		mov	byte_26D4F, 0
		mov	angle_1E510, -20h
		call	marisa_1B214
		pop	si
		pop	bp
		retf
marisa_init	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1AA60	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		cmp	byte_2066A, 0
		jnz	locret_1AB33
		mov	ax, point_26D76.x
		add	ax, 24
		push	ax
		mov	ax, point_26D76.y
		add	ax, 24
		push	ax
		push	300030h
		call	sub_1283C
		mov	[bp+var_2], ax
		or	ax, ax
		jz	short loc_1AAD6
		cmp	word_26D4A, 8
		jl	short loc_1AAB1
		call	_snd_se_play c, 4
		mov	byte_2066B, 1
		mov	al, byte_1EE96
		mov	ah, 0
		imul	[bp+var_2]
		add	_boss_damage, ax
		jmp	short loc_1AABB
; ---------------------------------------------------------------------------

loc_1AAB1:
		call	_snd_se_play c, 11

loc_1AABB:
		cmp	_boss_damage, 900
		jl	short loc_1AAD6
		mov	byte_2066A, 1
		add	_score_delta, 20000
		mov	_player_invincibility_time, BOSS_DEFEAT_INVINCIBILITY_FRAMES

loc_1AAD6:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_26D76.x
		add	dx, -16
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jle	short locret_1AB33
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_26D76.x
		add	dx, 48
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short locret_1AB33
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_26D76.y
		add	dx, -16
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jle	short locret_1AB33
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	dx, point_26D76.y
		add	dx, 48
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jge	short locret_1AB33
		mov	_player_is_hit, 1

locret_1AB33:
		leave
		retn
marisa_1AA60	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1AB35	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	byte_1EB88, 3
		xor	si, si
		jmp	loc_1AC6C
; ---------------------------------------------------------------------------

loc_1AB43:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	loc_1AC6B
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 4
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		push	word ptr es:[bx]
		push	180020h
		call	sub_1283C
		or	ax, ax
		jz	short loc_1ABEE
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D3Eh], 1
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx-6D4Eh]
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D4Eh], 6Eh ; 'n'
		jl	short loc_1ABEE
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 50h	; 'P'
		cwd
		idiv	bx
		mov	al, _power
		mov	ah, 0
		cmp	dx, ax
		jl	short loc_1ABD1
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 8
		push	ax	; left
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 8
		push	ax	; top
		push	IT_BIGPOWER	; type
		call	@items_add$qiii

loc_1ABD1:
		call	_snd_se_play c, 2
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D46h], 1
		add	_score_delta, 5000

loc_1ABEE:
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	dx, es:[bx]
		add	dx, 0FFF0h
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jle	short loc_1AC6B
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx-6D1Ah]
		mov	dx, es:[bx]
		add	dx, 10h
		mov	bx, ax
		cmp	_player_left_on_page[bx], dx
		jge	short loc_1AC6B
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	dx, es:[bx]
		add	dx, 0FFF0h
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jle	short loc_1AC6B
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx-6D0Ah]
		mov	dx, es:[bx]
		add	dx, 10h
		mov	bx, ax
		cmp	_player_top_on_page[bx], dx
		jge	short loc_1AC6B
		mov	_player_is_hit, 1

loc_1AC6B:
		inc	si

loc_1AC6C:
		cmp	si, 4
		jl	loc_1AB43
		mov	byte_1EB88, 1
		pop	si
		pop	bp
		retn
marisa_1AB35	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1AC7B	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	si, 0Ah
		mov	ax, point_26D76.x
		add	ax, 40
		push	ax
		mov	ax, point_26D76.y
		add	ax, 40
		push	ax
		push	word_1EE9A
		call	sub_FFF8
		cmp	word_1EE9A, 18h
		jl	short loc_1AD16
		cmp	word_1EE9A, 38h	; '8'
		jnz	short loc_1ACAA
		mov	angle_1E510, 20h

loc_1ACAA:
		mov	ax, point_26D76.x
		add	ax, 40
		push	ax
		mov	ax, point_26D76.y
		add	ax, 40
		push	ax
		mov	ax, word_1EE9A
		add	ax, 0FFE8h
		push	ax
		call	sub_FFF8
		cmp	word_1EE9A, 30h	; '0'
		jl	short loc_1AD16
		cmp	word_1EE9A, 50h	; 'P'
		jnz	short loc_1ACD5
		mov	angle_1E510, 0

loc_1ACD5:
		mov	ax, point_26D76.x
		add	ax, 40
		push	ax
		mov	ax, point_26D76.y
		add	ax, 40
		push	ax
		mov	ax, word_1EE9A
		add	ax, 0FFD0h
		push	ax
		call	sub_FFF8
		cmp	word_1EE9A, 40h
		jl	short loc_1AD16
		test	byte ptr word_1EE9A, 0Fh
		jnz	short loc_1AD16
		mov	ax, point_26D76.x
		add	ax, 48
		push	ax
		mov	ax, point_26D76.y
		add	ax, 48
		push	ax
		push	880018h
		push	1
		call	sub_4090

loc_1AD16:
		mov	ax, word_1EE9A
		add	ax, 0FFE0h
		sar	ax, 4
		add	si, ax
		inc	word_1EE9A
		cmp	word_1EE9A, 20h	; ' '
		jge	short loc_1AD54
		call	super_put_rect pascal, point_26D76.x, point_26D76.y, patnum_2064E
		mov	ax, point_26D76.x
		add	ax, 48
		push	ax
		push	point_26D76.y
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect
		jmp	short loc_1AD64
; ---------------------------------------------------------------------------

loc_1AD54:
		call	super_zoom pascal, point_26D76.x, point_26D76.y, si, 3

loc_1AD64:
		cmp	word_1EE9A, 64h	; 'd'
		jl	short loc_1AD7B
		mov	word_1EE9A, 0
		mov	byte_2066A, 3
		mov	ax, 1
		jmp	short loc_1AD7D
; ---------------------------------------------------------------------------

loc_1AD7B:
		xor	ax, ax

loc_1AD7D:
		pop	si
		pop	bp
		retn
marisa_1AC7B	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1AD80	proc near

var_2		= word ptr -2
arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		mov	si, [bp+arg_0]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 10h
		push	ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 10h
		push	ax
		push	3C0002h
		push	0
		call	sub_4090
		mov	di, 0Ah
		mov	bx, si
		add	bx, bx
		mov	ax, [bx+142Ch]
		mov	bx, 6
		cwd
		idiv	bx
		add	di, ax
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx+142Ch]
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx+142Ch], 30h ; '0'
		jl	loc_1AE74
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx+142Ch], 0
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D46h], 2
		graph_accesspage _page_front
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6D6Eh]
		sar	ax, 3
		mov	[bp+var_2], ax
		push	ax
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		push	word ptr [bx-6D5Eh]
		mov	ax, [bp+var_2]
		add	ax, 5
		push	ax
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6D5Eh]
		add	ax, 20h	; ' '
		push	ax
		call	grcg_byteboxfill_x
		call	grcg_off
		graph_accesspage _page_back
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D4Eh], 0
		mov	ax, 1
		jmp	short loc_1AE94
; ---------------------------------------------------------------------------

loc_1AE74:
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		push	word ptr es:[bx]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		push	word ptr es:[bx]
		push	di
		call	super_put_rect
		xor	ax, ax

loc_1AE94:
		pop	di
		pop	si
		leave
		retn
marisa_1AD80	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1AE98	proc near

var_12		= word ptr -12h
var_F		= byte ptr -0Fh
var_E		= dword	ptr -0Eh
var_9		= byte ptr -9
var_8		= word ptr -8
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 12h
		push	si
		push	di
		cmp	byte_2066B, 0
		jz	loc_1AFFB
		mov	al, byte ptr point_26D76.x
		and	al, 7
		mov	[bp+var_9], al
		mov	al, 10h
		sub	al, [bp+var_9]
		mov	[bp+var_F], al
		mov	byte_2066B, 0
		mov	ax, point_26D76.x
		sar	ax, 3
		mov	dx, point_26D76.y
		shl	dx, 6
		add	ax, dx
		mov	dx, point_26D76.y
		shl	dx, 4
		add	ax, dx
		mov	[bp+var_6], ax
		mov	[bp+var_4], ax
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 4
		mov	bx, patnum_2064E
		add	bx, bx
		mov	ax, [bx+1ADAh]
		mov	word ptr [bp+var_E+2], ax
		mov	word ptr [bp+var_E], 0
		mov	[bp+var_2], 0
		mov	ax, point_26D76.y
		mov	[bp+var_8], ax
		jmp	short loc_1AF61
; ---------------------------------------------------------------------------

loc_1AF06:
		cmp	[bp+var_8], 180h
		jge	short loc_1AF67
		xor	si, si
		mov	di, point_26D76.x
		jmp	short loc_1AF52
; ---------------------------------------------------------------------------

loc_1AF15:
		or	di, di
		jle	short loc_1AF4B
		cmp	di, 1A0h
		jge	short loc_1AF4B
		cmp	[bp+var_8], 10h
		jl	short loc_1AF4B
		les	bx, [bp+var_E]
		mov	al, es:[bx]
		mov	ah, 0
		mov	cl, [bp+var_9]
		sar	ax, cl
		mov	dl, es:[bx]
		mov	dh, 0
		mov	cl, [bp+var_F]
		shl	dx, cl
		add	ax, dx
		mov	[bp+var_12], ax
		les	bx, _VRAM_PLANE_B
		add	bx, [bp+var_4]
		mov	es:[bx+si], ax

loc_1AF4B:
		inc	si
		add	di, 8
		inc	word ptr [bp+var_E]

loc_1AF52:
		cmp	si, 6
		jl	short loc_1AF15
		inc	[bp+var_2]
		add	[bp+var_4], 50h	; 'P'
		inc	[bp+var_8]

loc_1AF61:
		cmp	[bp+var_2], 60h
		jl	short loc_1AF06

loc_1AF67:
		mov	bx, patnum_2064E
		add	bx, bx
		mov	ax, [bx+1ADCh]
		mov	word ptr [bp+var_E+2], ax
		mov	word ptr [bp+var_E], 0
		mov	ax, [bp+var_6]
		add	ax, 6
		mov	[bp+var_4], ax
		mov	[bp+var_2], 0
		mov	ax, point_26D76.y
		mov	[bp+var_8], ax
		jmp	short loc_1AFEE
; ---------------------------------------------------------------------------

loc_1AF8F:
		cmp	[bp+var_8], 180h
		jge	short loc_1AFF4
		xor	si, si
		mov	ax, point_26D76.x
		add	ax, 48
		mov	di, ax
		jmp	short loc_1AFDF
; ---------------------------------------------------------------------------

loc_1AFA2:
		or	di, di
		jle	short loc_1AFD8
		cmp	di, 1A0h
		jge	short loc_1AFD8
		cmp	[bp+var_8], 10h
		jl	short loc_1AFD8
		les	bx, [bp+var_E]
		mov	al, es:[bx]
		mov	ah, 0
		mov	cl, [bp+var_9]
		sar	ax, cl
		mov	dl, es:[bx]
		mov	dh, 0
		mov	cl, [bp+var_F]
		shl	dx, cl
		add	ax, dx
		mov	[bp+var_12], ax
		les	bx, _VRAM_PLANE_B
		add	bx, [bp+var_4]
		mov	es:[bx+si], ax

loc_1AFD8:
		inc	si
		add	di, 8
		inc	word ptr [bp+var_E]

loc_1AFDF:
		cmp	si, 6
		jl	short loc_1AFA2
		inc	[bp+var_2]
		add	[bp+var_4], 50h	; 'P'
		inc	[bp+var_8]

loc_1AFEE:
		cmp	[bp+var_2], 60h
		jl	short loc_1AF8F

loc_1AFF4:
		call	grcg_off
		jmp	short loc_1B021
; ---------------------------------------------------------------------------

loc_1AFFB:
		call	super_put_rect pascal, point_26D76.x, point_26D76.y, patnum_2064E
		mov	ax, point_26D76.x
		add	ax, 48
		push	ax
		push	point_26D76.y
		mov	ax, patnum_2064E
		inc	ax
		push	ax
		call	super_put_rect

loc_1B021:
		pop	di
		pop	si
		leave
		retn
marisa_1AE98	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B025	proc near

var_E		= word ptr -0Eh
var_C		= word ptr -0Ch
var_A		= word ptr -0Ah
var_8		= byte ptr -8

		push	bp
		mov	bp, sp
		sub	sp, 0Eh
		push	si
		push	di
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 3
		xor	si, si
		xor	di, di
		jmp	short loc_1B057
; ---------------------------------------------------------------------------

loc_1B03E:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1B056
		mov	bx, di
		add	bx, bx
		lea	ax, [bp+var_A]
		add	bx, ax
		mov	ss:[bx], si
		inc	di

loc_1B056:
		inc	si

loc_1B057:
		cmp	si, 4
		jl	short loc_1B03E
		mov	bx, di
		add	bx, bx
		lea	ax, [bp+var_A]
		add	bx, ax
		mov	ax, [bp+var_A]
		mov	ss:[bx], ax
		xor	si, si
		jmp	short loc_1B0D7
; ---------------------------------------------------------------------------

loc_1B06F:
		mov	bx, si
		add	bx, bx
		lea	ax, [bp+var_A]
		add	bx, ax
		mov	ax, ss:[bx]
		mov	[bp+var_C], ax
		mov	bx, si
		add	bx, bx
		lea	ax, [bp+var_8]
		add	bx, ax
		mov	ax, ss:[bx]
		mov	[bp+var_E], ax
		mov	bx, [bp+var_C]
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 16
		push	ax
		mov	bx, [bp+var_C]
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 16
		push	ax
		mov	bx, [bp+var_E]
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 16
		push	ax
		mov	bx, [bp+var_E]
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 16
		push	ax
		call	grcg_line
		inc	si

loc_1B0D7:
		cmp	si, di
		jl	short loc_1B06F
		call	grcg_off
		xor	si, si
		jmp	loc_1B192
; ---------------------------------------------------------------------------

loc_1B0E5:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 1
		jge	loc_1B191
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D3Eh], 0
		jz	short loc_1B16F
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		cmp	word ptr es:[bx], 0
		jle	short loc_1B163
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx-6D1Ah]
		cmp	word ptr es:[bx], 1A0h
		jge	short loc_1B163
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		cmp	word ptr es:[bx], 0
		jl	short loc_1B163
		mov	bx, si
		shl	bx, 2
		mov	bx, [bx-6D0Ah]
		cmp	word ptr es:[bx], 170h
		jg	short loc_1B163
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		push	word ptr es:[bx]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		push	word ptr es:[bx]
		lea	ax, [si+138]
		push	ax
		pushd	PLANE_PUT or GC_BRGI
		call	super_put_1plane

loc_1B163:
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D3Eh], 0
		jmp	short loc_1B191
; ---------------------------------------------------------------------------

loc_1B16F:
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		push	word ptr es:[bx]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		push	word ptr es:[bx]
		lea	ax, [si+138]
		push	ax
		call	super_put_rect

loc_1B191:
		inc	si

loc_1B192:
		cmp	si, 4
		jl	loc_1B0E5
		pop	di
		pop	si
		leave
		retn
marisa_1B025	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B19D	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jnz	short loc_1B1B9
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1B1B9:
		cmp	_boss_phase_frame, 100
		jnz	short loc_1B1D2
		call	_snd_se_play c, 10
		mov	patnum_2064E, 132
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1B1D2:
		cmp	_boss_phase_frame, 108
		jnz	short loc_1B1EB
		call	_snd_se_play c, 10
		mov	patnum_2064E, 134
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1B1EB:
		cmp	_boss_phase_frame, 116
		jnz	short loc_1B204
		call	_snd_se_play c, 10
		mov	patnum_2064E, 136
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1B204:
		cmp	_boss_phase_frame, 130
		jnz	short loc_1B212
		mov	patnum_2064E, 128

loc_1B212:
		pop	bp
		retn
marisa_1B19D	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B214	proc near
		push	bp
		mov	bp, sp
		cmp	_rank, RANK_EASY
		jz	short loc_1B234
		mov	byte_2066E, 17h
		mov	byte_2066F, 11h
		mov	group_20670, BG_2_SPREAD_MEDIUM
		mov	byte_20671, 4
		pop	bp
		retn
; ---------------------------------------------------------------------------

loc_1B234:
		mov	byte_2066E, 18h
		mov	byte_2066F, 12h
		mov	group_20670, BG_1
		mov	byte_20671, 2
		pop	bp
		retn
marisa_1B214	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B24A	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	loc_1B2E7
		call	marisa_1B19D
		cmp	_boss_phase_frame, 50
		jnz	short loc_1B267
		mov	angle_26D7F, 18h
		jmp	short loc_1B27A
; ---------------------------------------------------------------------------

loc_1B267:
		cmp	_boss_phase_frame, 130
		jnz	short loc_1B27A
		mov	_boss_phase_frame, 0
		mov	byte_26D7E, 0

loc_1B27A:
		cmp	_boss_phase_frame, 100
		jle	short loc_1B2E7
		mov	ax, _boss_phase_frame
		mov	bx, 3
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1B2E7
		cmp	byte_26D7E, 0
		jz	short loc_1B2C6
		mov	ax, point_26D76.x
		add	ax, 36
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 64
		push	ax	; top
		push	word ptr angle_26D7F	; angle
		push	BG_1	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	ax, point_26D76.x
		add	ax, 52
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 64
		push	ax
		push	word ptr angle_26D7F
		push	BG_1	; group
		push	((3 shl 4) + 12)	; speed
		jmp	short loc_1B2DC
; ---------------------------------------------------------------------------

loc_1B2C6:
		mov	ax, point_26D76.x
		add	ax, 44
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 64
		push	ax	; top
		push	word ptr angle_26D7F	; angle
		push	BG_1	; group
		push	((3 shl 4) + 2)	; speed

loc_1B2DC:
		call	@bullets_add_pellet$qiiucuci
		mov	al, angle_26D7F
		add	al, 0Ah
		mov	angle_26D7F, al

loc_1B2E7:
		pop	bp
		retn
marisa_1B24A	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B2E9	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	short loc_1B35D
		cmp	_boss_phase_frame, 50
		jnz	short loc_1B30A
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130

loc_1B30A:
		mov	ax, _boss_phase_frame
		mov	bx, 24
		cwd
		idiv	bx
		or	dx, dx
		jnz	short loc_1B349
		mov	ax, point_26D76.x
		add	ax, 64
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 16
		push	ax	; top
		push	00h	; angle
		push	word ptr byte_2066E	; group
		push	((3 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	ax, point_26D76.x
		add	ax, 64
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 16
		push	ax	; top
		push	00h	; angle
		push	word ptr byte_2066F	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1B349:
		cmp	_boss_phase_frame, 192
		jle	short loc_1B35D
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_1B35D:
		pop	bp
		retn
marisa_1B2E9	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B35F	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 50
		jl	short loc_1B3DC
		call	marisa_1B19D
		cmp	_boss_phase_frame, 50
		jnz	short loc_1B39A
		call	@randring2_next8$qv
		mov	angle_26D80, al
		mov	al, byte_1EEA4
		mov	ah, 0
		mov	bullet_special_drift_angle, ax
		mov	bullet_special_drift_speed, 2
		mov	bullet_special_drift_duration, 128
		mov	al, byte_1EEA4
		mov	ah, 0
		imul	ax, -1
		mov	byte_1EEA4, al
		jmp	short loc_1B3A8
; ---------------------------------------------------------------------------

loc_1B39A:
		cmp	_boss_phase_frame, 130
		jnz	short loc_1B3A8
		mov	_boss_phase_frame, 0

loc_1B3A8:
		cmp	_boss_phase_frame, 100
		jl	short loc_1B3DC
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_1B3DC
		mov	ax, point_26D76.x
		add	ax, 44
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 64
		push	ax	; top
		push	word ptr angle_26D80	; angle
		push	BSM_DRIFT_ANGLE_AND_SPEED	; group
		push	(PAT_BULLET16_STAR shl 16) or ((2 shl 4) + 8)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		mov	al, angle_26D80
		add	al, 2Bh
		mov	angle_26D80, al

loc_1B3DC:
		pop	bp
		retn
marisa_1B35F	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B3DE	proc near
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	loc_1B46D
; ---------------------------------------------------------------------------

loc_1B3E7:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1B46C
		mov	al, [si-6D20h]
		mov	bx, si
		add	bx, bx
		add	al, [bx-6D2Eh]
		mov	[si-6D20h], al
		mov	bx, si
		add	bx, bx
		movsx	eax, word ptr [bx-6D36h]
		mov	dl, [si-6D20h]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, point_26D76.x
		add	ax, 32
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	es:[bx], ax
		mov	bx, si
		add	bx, bx
		movsx	eax, word ptr [bx-6D36h]
		mov	dl, [si-6D20h]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, point_26D76.y
		add	ax, 32
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	es:[bx], ax

loc_1B46C:
		inc	si

loc_1B46D:
		cmp	si, 4
		jl	loc_1B3E7
		pop	si
		pop	bp
		retn
marisa_1B3DE	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B477	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		cmp	_boss_phase_frame, 100
		jl	loc_1B551
		cmp	_boss_phase_frame, 100
		jnz	short loc_1B4A2
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130
		jmp	loc_1B52F
; ---------------------------------------------------------------------------

loc_1B4A2:
		cmp	_boss_phase_frame, 130
		jnz	short loc_1B51B
		mov	ax, point_26D76.x
		add	ax, 32
		mov	si, ax
		mov	ax, point_26D76.y
		add	ax, 32
		mov	di, ax
		mov	[bp+var_2], 0
		jmp	short loc_1B513
; ---------------------------------------------------------------------------

loc_1B4C1:
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6D46h], 0
		mov	bx, [bp+var_2]
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		mov	[bx-6D20h], al
		add	bx, bx
		mov	word ptr [bx-6D36h], 8
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	word ptr [bx-6D2Eh], 2
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6D6Eh], si
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6D66h], si
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6D5Eh], di
		mov	bx, [bp+var_2]
		add	bx, bx
		mov	[bx-6D56h], di
		inc	[bp+var_2]

loc_1B513:
		cmp	[bp+var_2], 4
		jl	short loc_1B4C1
		jmp	short loc_1B52F
; ---------------------------------------------------------------------------

loc_1B51B:
		cmp	_boss_phase_frame, 154
		jnz	short loc_1B52F
		mov	patnum_2064E, 128
		mov	_boss_phase_frame, 0

loc_1B52F:
		cmp	_boss_phase_frame, 130
		jle	short loc_1B551
		mov	[bp+var_2], 0
		jmp	short loc_1B54B
; ---------------------------------------------------------------------------

loc_1B53E:
		mov	bx, [bp+var_2]
		add	bx, bx
		add	word ptr [bx-6D36h], 2
		inc	[bp+var_2]

loc_1B54B:
		cmp	[bp+var_2], 4
		jl	short loc_1B53E

loc_1B551:
		pop	di
		pop	si
		leave
		retn
marisa_1B477	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B555	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 10
		jl	loc_1B662
		cmp	_boss_phase_frame, 10
		jnz	short loc_1B592
		mov	ax, point_26D76.x
		add	ax, 32
		cmp	ax, _player_topleft.x
		jge	short loc_1B579
		mov	al, 1
		jmp	short loc_1B57B
; ---------------------------------------------------------------------------

loc_1B579:
		mov	al, -1

loc_1B57B:
		mov	byte_26D81, al
		mov	ax, point_26D76.x
		mov	word_26D82, ax
		mov	ax, point_26D76.y
		add	ax, 112
		mov	word_26D84, ax
		mov	angle_26D86, -40h

loc_1B592:
		mov	al, byte_26D81
		add	angle_26D86, al
		mov	al, angle_26D86
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _CosTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_26D82
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, angle_26D86
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		movsx	eax, _SinTable8[bx]
		imul	eax, 70h
		sar	eax, 8
		add	ax, word_26D84
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_26D76.x, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	point_26D76.y, ax
		test	byte ptr _boss_phase_frame, 0Fh
		jnz	short loc_1B654
		call	@randring2_next8_and$quc pascal, 3
		mov	ah, 0
		mov	si, ax
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1B631
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 12
		push	ax	; left
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 12
		push	ax	; top
		push	00h	; angle
		push	BG_1_AIMED	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1B631:
		cmp	word_26D4A, 8
		jnz	short loc_1B654
		cmp	si, 1
		jge	short loc_1B654
		mov	ax, point_26D76.x
		add	ax, 64
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 16
		push	ax	; top
		push	00h	; angle
		push	BG_3_SPREAD_NARROW_AIMED	; group
		push	(5 shl 4)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1B654:
		cmp	_boss_phase_frame, 266
		jl	short loc_1B662
		mov	_boss_phase_frame, 0

loc_1B662:
		pop	si
		pop	bp
		retn
marisa_1B555	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B665	proc near

@@frame	= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+@@frame]
		cmp	_boss_phase_frame, si
		jl	short loc_1B6D5
		cmp	_boss_phase_frame, si
		jnz	short loc_1B68A
		call	_snd_se_play c, 9

loc_1B682:
		mov	patnum_2064E, 130
		jmp	short loc_1B6D5
; ---------------------------------------------------------------------------

loc_1B68A:
		lea	ax, [si+30]
		cmp	ax, _boss_phase_frame
		jz	short loc_1B682
		lea	ax, [si+36]
		cmp	ax, _boss_phase_frame
		jnz	short loc_1B6A4
		mov	patnum_2064E, 132
		jmp	short loc_1B6D5
; ---------------------------------------------------------------------------

loc_1B6A4:
		lea	ax, [si+42]
		cmp	ax, _boss_phase_frame
		jnz	short loc_1B6B5
		mov	patnum_2064E, 134
		jmp	short loc_1B6D5
; ---------------------------------------------------------------------------

loc_1B6B5:
		lea	ax, [si+50]
		cmp	ax, _boss_phase_frame
		jnz	short loc_1B6C6
		mov	patnum_2064E, 136
		jmp	short loc_1B6D5
; ---------------------------------------------------------------------------

loc_1B6C6:
		lea	ax, [si+60]
		cmp	ax, _boss_phase_frame
		jnz	short loc_1B6D5
		mov	patnum_2064E, 128

loc_1B6D5:
		pop	si
		pop	bp
		retn	2
marisa_1B665	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B6DA	proc near
		push	bp
		mov	bp, sp
		push	si
		cmp	_boss_phase_frame, 50
		jl	loc_1B7D0
		cmp	_boss_phase_frame, 280
		jge	short loc_1B703
		xor	si, si
		jmp	short loc_1B6FC
; ---------------------------------------------------------------------------

loc_1B6F3:
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx-6D36h]
		inc	si

loc_1B6FC:
		cmp	si, 4
		jl	short loc_1B6F3
		jmp	short loc_1B72B
; ---------------------------------------------------------------------------

loc_1B703:
		cmp	_boss_phase_frame, 510
		jge	short loc_1B71F
		xor	si, si
		jmp	short loc_1B718
; ---------------------------------------------------------------------------

loc_1B70F:
		mov	bx, si
		add	bx, bx
		dec	word ptr [bx-6D36h]
		inc	si

loc_1B718:
		cmp	si, 4
		jl	short loc_1B70F
		jmp	short loc_1B72B
; ---------------------------------------------------------------------------

loc_1B71F:
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_1B72B:
		push	0DCh
		call	marisa_1B665
		cmp	_boss_phase_frame, 220
		jnz	short loc_1B73E
		mov	angle_26D87, 0

loc_1B73E:
		cmp	word_26D4A, 8
		jnz	short loc_1B74B
		mov	patnum_2064E, 130

loc_1B74B:
		cmp	_boss_phase_frame, 250
		jl	short loc_1B75B
		cmp	_boss_phase_frame, 270
		jl	short loc_1B762

loc_1B75B:
		cmp	word_26D4A, 8
		jnz	short loc_1B7D0

loc_1B762:
		cmp	word_26D4A, 8
		jz	short loc_1B79B
		mov	al, angle_26D87
		add	al, 0Dh
		mov	angle_26D87, al
		mov	al, _rank
		cbw
		mov	dx, _boss_phase_frame
		and	dx, 1
		cmp	ax, dx
		jl	short loc_1B7D0
		mov	ax, point_26D76.x
		add	ax, 44
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 64
		push	ax	; top
		push	word ptr angle_26D87	; angle
		push	BG_1	; group
		push	((3 shl 4) + 2)	; speed
		call	@bullets_add_pellet$qiiucuci
		jmp	short loc_1B7D0
; ---------------------------------------------------------------------------

loc_1B79B:
		mov	al, angle_26D87
		add	al, 0Ah
		mov	angle_26D87, al
		mov	ax, point_26D76.x
		add	ax, 64
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 16
		push	ax	; top
		push	word ptr angle_26D87	; angle
		push	BG_1	; group
		push	((3 shl 4) + 12)	; speed
		call	@bullets_add_pellet$qiiucuci
		cmp	_boss_phase_frame, 270
		jle	short loc_1B7D0
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_1B7D0:
		pop	si
		pop	bp
		retn
marisa_1B6DA	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B7D3	proc near

var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 2
		push	si
		push	di
		cmp	_boss_phase_frame, 10
		jnz	short loc_1B7FA
		mov	word_26D42, 3
		mov	word_26D46, 3
		mov	word_26D44, 0FFFEh
		mov	word_26D48, 0FFFEh

loc_1B7FA:
		cmp	_boss_phase_frame, 50
		jl	loc_1B992
		cmp	_boss_phase_frame, 130
		jge	short loc_1B823
		xor	si, si
		jmp	short loc_1B81B
; ---------------------------------------------------------------------------

loc_1B80F:
		mov	bx, si
		add	bx, bx
		add	word ptr [bx-6D36h], 2
		add	si, 2

loc_1B81B:
		cmp	si, 4
		jl	short loc_1B80F
		jmp	loc_1B8B2
; ---------------------------------------------------------------------------

loc_1B823:
		cmp	_boss_phase_frame, 260
		jl	loc_1B8B2
		cmp	_boss_phase_frame, 340
		jge	short loc_1B868
		xor	si, si
		jmp	short loc_1B845
; ---------------------------------------------------------------------------

loc_1B839:
		mov	bx, si
		add	bx, bx
		sub	word ptr [bx-6D36h], 2
		add	si, 2

loc_1B845:
		cmp	si, 4
		jl	short loc_1B839
		cmp	_rank, RANK_EASY
		jz	short loc_1B8B2
		mov	si, 1
		jmp	short loc_1B861
; ---------------------------------------------------------------------------

loc_1B856:
		mov	bx, si
		add	bx, bx
		inc	word ptr [bx-6D36h]
		add	si, 2

loc_1B861:
		cmp	si, 4
		jl	short loc_1B856
		jmp	short loc_1B8B2
; ---------------------------------------------------------------------------

loc_1B868:
		cmp	_boss_phase_frame, 420
		jge	short loc_1B88E
		cmp	_rank, RANK_EASY
		jz	short loc_1B8B2
		mov	si, 1
		jmp	short loc_1B887
; ---------------------------------------------------------------------------

loc_1B87C:
		mov	bx, si
		add	bx, bx
		dec	word ptr [bx-6D36h]
		add	si, 2

loc_1B887:
		cmp	si, 4
		jl	short loc_1B87C
		jmp	short loc_1B8B2
; ---------------------------------------------------------------------------

loc_1B88E:
		mov	word_26D42, 2
		mov	word_26D46, 2
		mov	word_26D44, 0FFFEh
		mov	word_26D48, 0FFFEh
		mov	_boss_phase_frame, 0
		mov	patnum_2064E, 128

loc_1B8B2:
		push	8Ch
		call	marisa_1B665
		cmp	_boss_phase_frame, 140
		jnz	short loc_1B8C5
		mov	angle_26D88, 0

loc_1B8C5:
		cmp	word_26D4A, 8
		jnz	short loc_1B903
		mov	patnum_2064E, 130
		mov	al, 18h
		sub	al, _rank
		mov	dl, angle_26D88
		sub	dl, al
		mov	angle_26D88, dl
		mov	ax, point_26D76.x
		add	ax, 64
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 16
		push	ax	; top
		push	word ptr angle_26D88	; angle
		push	BSM_1	; group
		push	(PAT_BULLET16_STAR shl 16) or ((3 shl 4) + 12)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		jmp	loc_1B992
; ---------------------------------------------------------------------------

loc_1B903:
		cmp	_boss_phase_frame, 150
		jl	loc_1B992
		cmp	_boss_phase_frame, 250
		jge	short loc_1B992
		test	byte ptr _boss_phase_frame, 3
		jnz	short loc_1B992
		mov	al, angle_26D88
		add	al, 3
		mov	angle_26D88, al
		call	_snd_se_play c, 10
		xor	si, si
		jmp	short loc_1B98D
; ---------------------------------------------------------------------------

loc_1B932:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1B98A
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	di, es:[bx]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		mov	[bp+var_2], ax
		or	di, di
		jle	short loc_1B98A
		cmp	di, 1A0h
		jge	short loc_1B98A
		cmp	[bp+var_2], 0
		jl	short loc_1B98A
		cmp	[bp+var_2], 170h
		jg	short loc_1B98A
		lea	ax, [di+0Ch]
		push	ax	; left
		mov	ax, [bp+var_2]
		add	ax, 12
		push	ax	; top
		mov	al, [si-6D20h]
		add	al, angle_26D88
		push	ax	; angle
		push	BG_1	; group
		push	((4 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1B98A:
		add	si, 2

loc_1B98D:
		cmp	si, 4
		jl	short loc_1B932

loc_1B992:
		pop	di
		pop	si
		leave
		retn
marisa_1B7D3	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1B996	proc near

@@angle = word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		cmp	_boss_phase_frame, 10
		jnz	short loc_1B9BD
		mov	word_26D42, 0FFFDh
		mov	word_26D46, 0FFFDh
		mov	word_26D44, 0FFFDh
		mov	word_26D48, 0FFFDh

loc_1B9BD:
		cmp	word_26D4A, 8
		jnz	short loc_1B9D0
		mov	patnum_2064E, 128
		mov	_boss_phase_frame, 0

loc_1B9D0:
		cmp	_boss_phase_frame, 50
		jl	loc_1BAFB
		cmp	_boss_phase_frame, 50
		jnz	short loc_1BA0B
		mov	word_26D42, 0FFFCh
		mov	word_26D46, 0FFFCh
		mov	word_26D44, 0FFFCh
		mov	word_26D48, 0FFFCh
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130
		jmp	loc_1BAFB
; ---------------------------------------------------------------------------

loc_1BA0B:
		cmp	_boss_phase_frame, 100
		jnz	short loc_1BA7B
		call	_snd_se_play c, 3
		xor	si, si
		jmp	short loc_1BA73
; ---------------------------------------------------------------------------

loc_1BA20:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1BA72
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 0Ch
		mov	di, ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 12
		mov	[bp+var_2], ax
		mov	[bp+@@angle], -40h
		jmp	short loc_1BA6C
; ---------------------------------------------------------------------------

loc_1BA55:
		push	di	; left
		push	[bp+var_2]	; top
		mov	al, [si-6D20h]
		add	al, byte ptr [bp+@@angle]
		push	ax	; angle
		push	BG_1	; group
		push	((4 shl 4) + 6)	; speed
		call	@bullets_add_pellet$qiiucuci
		add	[bp+@@angle], 10h

loc_1BA6C:
		cmp	[bp+@@angle], 40h
		jl	short loc_1BA55

loc_1BA72:
		inc	si

loc_1BA73:
		cmp	si, 4
		jl	short loc_1BA20
		jmp	loc_1BAFB
; ---------------------------------------------------------------------------

loc_1BA7B:
		cmp	_boss_phase_frame, 110
		jnz	short loc_1BAFB
		call	_snd_se_play c, 3
		xor	si, si
		jmp	short loc_1BAF6
; ---------------------------------------------------------------------------

loc_1BA90:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1BAF5
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 0Ch
		mov	di, ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 0Ch
		mov	[bp+var_2], ax
		mov	[bp+var_4], 0FFBAh
		jmp	short loc_1BAE5
; ---------------------------------------------------------------------------

loc_1BAC5:
		push	di	; left
		push	[bp+var_2]	; top
		mov	al, [si-6D20h]
		add	al, byte ptr [bp+var_4]
		push	ax	; angle
		push	BG_1	; group
		call	@randring2_next8_and$quc pascal, 1Fh
		mov	ah, 0
		add	ax, (1 shl 4)
		push	ax	; speed
		call	@bullets_add_pellet$qiiucuci
		add	[bp+var_4], 0Ch

loc_1BAE5:
		cmp	[bp+var_4], 46h	; 'F'
		jl	short loc_1BAC5
		mov	bx, si
		add	bx, bx
		mov	word ptr [bx-6D46h], 1

loc_1BAF5:
		inc	si

loc_1BAF6:
		cmp	si, 4
		jl	short loc_1BA90

loc_1BAFB:
		pop	di
		pop	si
		leave
		retn
marisa_1B996	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1BAFF	proc near

@@speed		= word ptr -4
var_2		= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		cmp	_boss_phase_frame, 50
		jl	loc_1BC3F
		cmp	_boss_phase_frame, 150
		jl	short loc_1BB1D
		push	78h ; 'x'
		call	marisa_1B665

loc_1BB1D:
		cmp	_boss_phase_frame, 50
		jnz	short loc_1BB4F
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130
		mov	byte_26D89, 0
		mov	byte_26D8A, 0
		mov	byte_26D8B, 0
		mov	byte_26D8C, 0
		mov	byte_26D8D, 0
		jmp	short loc_1BB85
; ---------------------------------------------------------------------------

loc_1BB4F:
		cmp	_boss_phase_frame, 300
		jnz	short loc_1BB85
		mov	_boss_phase_frame, 0
		mov	ax, -1
		imul	word_26D42
		mov	word_26D42, ax
		mov	ax, -1
		imul	word_26D44
		mov	word_26D44, ax
		mov	ax, -1
		imul	word_26D46
		mov	word_26D46, ax
		mov	ax, -1
		imul	word_26D48
		mov	word_26D48, ax

loc_1BB85:
		cmp	_boss_phase_frame, 70
		jle	loc_1BC3F
		mov	ax, _boss_phase_frame
		mov	bx, 5
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_1BC3F
		call	_snd_se_play c, 10
		xor	si, si
		jmp	short loc_1BC0F
; ---------------------------------------------------------------------------

loc_1BBAB:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1BC0E
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 0Ch
		mov	di, ax
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 0Ch
		mov	[bp+var_2], ax
		mov	ax, _boss_phase_frame
		sar	ax, 2
		add	ax, ((1 shl 4) + 9)
		mov	[bp+@@speed], ax
		push	di	; left
		push	[bp+var_2]	; top
		mov	al, [si-6D20h]
		add	al, [si-6CE6h]
		push	ax	; angle
		push	BG_1	; group
		push	[bp+@@speed]	; speed
		call	@bullets_add_pellet$qiiucuci
		mov	al, [si-6CE6h]
		mov	bx, si
		add	bx, bx
		mov	dl, [bx-6D2Eh]
		add	dl, dl
		add	al, dl
		mov	[si-6CE6h], al

loc_1BC0E:
		inc	si

loc_1BC0F:
		cmp	si, 4
		jl	short loc_1BBAB
		cmp	word_26D4A, 8
		jnz	short loc_1BC3B
		test	byte_26D89, 1
		jnz	short loc_1BC3B
		mov	ax, point_26D76.x
		add	ax, 44
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 44
		push	ax	; top
		push	_boss_phase_frame	; angle
		push	BG_16_RING	; group
		push	((3 shl 4) + 2)	; speed
		call	@bullets_add_pellet$qiiucuci

loc_1BC3B:
		inc	byte_26D89

loc_1BC3F:
		pop	di
		pop	si
		leave
		retn
marisa_1BAFF	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1BC43	proc near

@@angle	= byte ptr -3
var_2	= word ptr -2

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		cmp	_boss_phase_frame, 50
		jl	loc_1BE6F
		cmp	_boss_phase_frame, 150
		jl	short loc_1BC60
		push	78h ; 'x'
		call	marisa_1B665

loc_1BC60:
		cmp	_boss_phase_frame, 50
		jnz	short loc_1BCAE
		call	_snd_se_play c, 9
		mov	patnum_2064E, 130
		mov	al, byte_1EEA5
		cbw
		mov	bullet_special_drift_angle, ax
		mov	bullet_special_drift_speed, 0
		mov	bullet_special_drift_duration, 64
		mov	al, byte_1EEA5
		cbw
		imul	ax, -1
		mov	byte_1EEA5, al
		mov	word_26D42, 2
		mov	word_26D46, 2
		mov	word_26D44, 0FFFEh
		mov	word_26D48, 0FFFEh
		jmp	short loc_1BD16
; ---------------------------------------------------------------------------

loc_1BCAE:
		cmp	_boss_phase_frame, 70
		jnz	short loc_1BCCF
		mov	word_26D42, 3
		mov	word_26D46, 3
		mov	word_26D44, 0FFFDh
		mov	word_26D48, 0FFFDh
		jmp	short loc_1BD16
; ---------------------------------------------------------------------------

loc_1BCCF:
		cmp	_boss_phase_frame, 80
		jnz	short loc_1BCF0
		mov	word_26D42, 4
		mov	word_26D46, 4
		mov	word_26D44, 0FFFCh
		mov	word_26D48, 0FFFCh
		jmp	short loc_1BD16
; ---------------------------------------------------------------------------

loc_1BCF0:
		cmp	_boss_phase_frame, 200
		jnz	short loc_1BD16
		mov	word_26D42, 2
		mov	word_26D46, 2
		mov	word_26D44, 0FFFEh
		mov	word_26D48, 0FFFEh
		mov	_boss_phase_frame, 0

loc_1BD16:
		cmp	_boss_phase_frame, 70
		jle	loc_1BE6F
		mov	ax, _boss_phase_frame
		mov	bx, 14
		cwd
		idiv	bx
		or	dx, dx
		jnz	loc_1BE6F
		call	_snd_se_play c, 10
		cmp	_boss_phase_frame, 120
		jg	short loc_1BDAC
		mov	[bp+var_2], 0
		jmp	short loc_1BD86
; ---------------------------------------------------------------------------

loc_1BD46:
		mov	bx, [bp+var_2]
		add	bx, bx
		cmp	word ptr [bx-6D46h], 0
		jnz	short loc_1BD83
		mov	bx, [bp+var_2]
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	ax, es:[bx]
		add	ax, 8
		push	ax	; left
		mov	bx, [bp+var_2]
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	ax, es:[bx]
		add	ax, 8
		push	ax	; top
		push	(-40h and 0FFh)	; angle
		push	BSM_1	; group
		push	(PAT_BULLET16_STAR shl 16) or ((4 shl 4) + 6)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti

loc_1BD83:
		inc	[bp+var_2]

loc_1BD86:
		cmp	[bp+var_2], 4
		jl	short loc_1BD46
		mov	ax, point_26D76.x
		add	ax, 40
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 40
		push	ax	; top
		push	(-40h and 0FFh)	; angle
		push	BSM_1	; group
		push	(PAT_BULLET16_STAR shl 16) or ((4 shl 4) + 6)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		jmp	loc_1BE2F
; ---------------------------------------------------------------------------

loc_1BDAC:
		mov	al, byte_1EEA5
		cbw
		cmp	ax, 1
		jnz	short loc_1BDBA
		mov	si, 190h
		jmp	short loc_1BDBD
; ---------------------------------------------------------------------------

loc_1BDBA:
		mov	si, 20h	; ' '

loc_1BDBD:
		mov	[bp+var_2], 0
		jmp	short loc_1BE25
; ---------------------------------------------------------------------------

loc_1BDC4:
		call	@randring2_next8_and$quc pascal, 7
		mov	dl, byte_1EEA5
		shl	dl, 4
		add	al, dl
		add	al, 40h
		mov	[bp+@@angle], al
		call	@randring2_next16$qv
		mov	bx, (PLAYFIELD_W - BULLET16_W)
		xor	dx, dx
		div	bx
		add	dx, PLAYFIELD_LEFT
		push	dx	; left
		push	PLAYFIELD_TOP	; top
		push	word ptr [bp+@@angle]	; angle
		push	BSM_1	; group
		push	PAT_BULLET16_STAR	; patnum
		call	@randring2_next8_and$quc pascal, 1Fh
		mov	ah, 0
		add	ax, 10h
		push	ax	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		push	si	; left
		call	@randring2_next16$qv
		mov	bx, 320
		xor	dx, dx
		div	bx
		add	dx, PLAYFIELD_TOP
		push	dx	; top
		push	word ptr [bp+@@angle]	; angle
		push	BSM_1	; group
		push	PAT_BULLET16_STAR	; patnum
		call	@randring2_next8_and$quc pascal, 1Fh
		mov	ah, 0
		add	ax, 10h
		push	ax	; speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	[bp+var_2]

loc_1BE25:
		mov	al, byte_20671
		mov	ah, 0
		cmp	ax, [bp+var_2]
		jg	short loc_1BDC4

loc_1BE2F:
		cmp	word_26D4A, 8
		jnz	short loc_1BE6F
		mov	[bp+var_2], 0
		jmp	short loc_1BE69
; ---------------------------------------------------------------------------

loc_1BE3D:
		mov	ax, point_26D76.x
		add	ax, 40
		push	ax	; left
		mov	ax, point_26D76.y
		add	ax, 40
		push	ax	; top
		mov	al, byte ptr [bp+var_2]
		shl	al, 6
		mov	dl, byte ptr _boss_phase_frame
		add	dl, dl
		add	al, dl
		push	ax	; angle
		push	BSM_DRIFT_ANGLE_CHASE	; group
		push	(PAT_BULLET16_STAR shl 16) or ((4 shl 4) + 6)	; (patnum shl 16) or speed
		call	@bullets_add_16x16$qiiuc32bullet_group_or_special_motion_t13main_patnum_ti
		inc	[bp+var_2]

loc_1BE69:
		cmp	[bp+var_2], 4
		jl	short loc_1BE3D

loc_1BE6F:
		pop	si
		leave
		retn
marisa_1BC43	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_1BE72	proc near
		push	bp
		mov	bp, sp
		cmp	_boss_phase_frame, 1
		jz	short loc_1BEF0
		cmp	_boss_phase_frame, 2
		jnz	short loc_1BEC5
		mov	ax, point_26D76.x
		add	ax, 32
		cmp	ax, _player_topleft.x
		jge	short loc_1BE94
		mov	ax, 1
		jmp	short loc_1BE97
; ---------------------------------------------------------------------------

loc_1BE94:
		mov	ax, 0FFFFh

loc_1BE97:
		mov	word_26D8E, ax
		cmp	point_26D76.y, 72
		jge	short loc_1BEA6
		mov	ax, 1
		jmp	short loc_1BEC2
; ---------------------------------------------------------------------------

loc_1BEA6:
		cmp	point_26D76.y, 108
		jle	short loc_1BEB2
		mov	ax, 0FFFFh
		jmp	short loc_1BEC2
; ---------------------------------------------------------------------------

loc_1BEB2:
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	ax, 1
		sub	ax, dx

loc_1BEC2:
		mov	word_26D90, ax

loc_1BEC5:
		cmp	_boss_phase_frame, 50
		jge	short loc_1BEF0
		mov	bx, _boss_left_on_back_page
		mov	ax, word_26D8E
		add	[bx], ax
		mov	bx, _boss_top_on_back_page
		mov	ax, word_26D90
		add	[bx], ax
		mov	bx, _boss_left_on_back_page
		mov	ax, [bx]
		mov	point_26D76.x, ax
		mov	bx, _boss_top_on_back_page
		mov	ax, [bx]
		mov	point_26D76.y, ax

loc_1BEF0:
		pop	bp
		retn
marisa_1BE72	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_update	proc far
		push	bp
		mov	bp, sp
		push	si
		push	di
		xor	si, si
		mov	word_26D4A, 0
		jmp	short loc_1BF0E
; ---------------------------------------------------------------------------

loc_1BF01:
		mov	bx, si
		add	bx, bx
		mov	ax, [bx-6D46h]
		add	word_26D4A, ax
		inc	si

loc_1BF0E:
		cmp	si, 4
		jl	short loc_1BF01
		cmp	word_26D4A, 8
		jnz	short loc_1BF2E
		mov	ax, point_26D76.x
		add	ax, 40
		mov	word_205D8, ax
		mov	ax, point_26D76.y
		add	ax, 40
		mov	word_205DA, ax
		jmp	short loc_1BF3A
; ---------------------------------------------------------------------------

loc_1BF2E:
		mov	word_205D8, 0FFFFh
		mov	word_205DA, 0FFFFh

loc_1BF3A:
		inc	_boss_phase_frame
		test	byte ptr _stage_frame, 1
		jz	short loc_1BF78
		cmp	_reduce_effects, 0
		jz	short loc_1BF53
		test	byte ptr _stage_frame, 3
		jz	short loc_1BF78

loc_1BF53:
		call	@randring2_next16$qv
		mov	bx, 384
		xor	dx, dx
		div	bx
		add	dx, 20h	; ' '
		mov	di, dx
		push	dx
		push	10h
		mov	ax, 0E0h
		sub	ax, di
		mov	bx, 3
		cwd
		idiv	bx
		add	al, 40h
		push	ax
		call	sub_3E1C

loc_1BF78:
		test	byte ptr _stage_frame, 1Fh
		jnz	short loc_1BF9E
		inc	byte_26D4C
		mov	al, byte_26D4C
		cbw
		cmp	ax, 6
		jl	short loc_1BF91
		mov	byte_26D4C, 0

loc_1BF91:
		mov	al, byte_26D4C
		cbw
		mov	bx, ax
		mov	al, [bx+1420h]
		mov	byte_1FFF8, al

loc_1BF9E:
		call	sub_3F8A
		cmp	byte_2066A, 0
		jnz	loc_1C11A
		cmp	word_26CFC, 0
		jnz	short loc_1BFC6
		call	marisa_1B24A
		cmp	_boss_phase_frame, 0
		jnz	loc_1C11A
		inc	word_26CFC
		jmp	loc_1C11A
; ---------------------------------------------------------------------------

loc_1BFC6:
		cmp	word_26CFC, 1
		jnz	short loc_1BFEA
		call	marisa_1B477
		cmp	_boss_phase_frame, 0
		jnz	loc_1C11A
		inc	word_26CFC
		mov	byte_26D4D, 1
		mov	byte_26D92, 0
		jmp	loc_1C11A
; ---------------------------------------------------------------------------

loc_1BFEA:
		cmp	word_26CFC, 2
		jnz	loc_1C11A
		mov	al, byte_26D4D
		cbw
		cmp	ax, 2
		jz	short loc_1C059
		jg	short loc_1C011
		sub	ax, 0FFFDh
		mov	bx, ax
		cmp	bx, 4
		ja	loc_1C10E
		add	bx, bx
		jmp	cs:off_1C160[bx]
; ---------------------------------------------------------------------------

loc_1C011:
		cmp	ax, 5
		jz	short loc_1C074
		jg	short loc_1C025
		cmp	ax, 3
		jz	short loc_1C062
		cmp	ax, 4
		jz	short loc_1C06B
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C025:
		cmp	ax, 6
		jz	short loc_1C07D
		cmp	ax, 7Fh
		jz	short loc_1C086
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C032:
		call	marisa_1B35F
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C03B:
		call	marisa_1B2E9
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C044:
		call	marisa_1B24A
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C04D:
		call	marisa_1B477
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C053:
		call	marisa_1B555
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C059:
		call	marisa_1B6DA
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C062:
		call	marisa_1BAFF
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C06B:
		call	marisa_1BC43
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C074:
		call	marisa_1B7D3
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C07D:
		call	marisa_1B996
		call	marisa_1BE72
		jmp	loc_1C10E
; ---------------------------------------------------------------------------

loc_1C086:
		call	marisa_1BE72
		cmp	_boss_phase_frame, 30
		jle	short loc_1C10E
		cmp	word_26D4A, 8
		jge	short loc_1C0BC
		cmp	byte_26D92, 4
		jb	short loc_1C0A5
		mov	byte_26D4D, 6
		jmp	short loc_1C108
; ---------------------------------------------------------------------------

loc_1C0A5:
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 5
		cwd
		idiv	bx
		inc	dl
		mov	byte_26D4D, dl
		inc	byte_26D92
		jmp	short loc_1C108
; ---------------------------------------------------------------------------

loc_1C0BC:
		mov	al, byte_26D4E
		cbw
		cmp	ax, 2
		jl	short loc_1C0F2
		mov	byte_26D92, 0
		mov	byte_26D4D, 0
		mov	byte_26D4E, 0
		inc	byte_26D4F
		cmp	byte_26D4F, 2
		jb	short loc_1C0E4
		mov	byte_1EE96, 1

loc_1C0E4:
		cmp	byte_26D4F, 7
		jb	short loc_1C108
		mov	byte_2066A, 1
		jmp	short loc_1C108
; ---------------------------------------------------------------------------

loc_1C0F2:
		inc	byte_26D4E
		call	@randring2_next8$qv
		mov	ah, 0
		mov	bx, 3
		cwd
		idiv	bx
		mov	al, 255
		sub	al, dl
		mov	byte_26D4D, al

loc_1C108:
		mov	_boss_phase_frame, 1 ; Skip the initial movement

loc_1C10E:
		cmp	_boss_phase_frame, 0
		jnz	short loc_1C11A
		mov	byte_26D4D, 7Fh

loc_1C11A:
		call	marisa_1AA60
		call	marisa_1AB35
		cmp	byte_2066A, 0
		jz	short loc_1C133
		call	marisa_1AC7B
		or	ax, ax
		jz	short loc_1C136
		mov	ax, 2
		jmp	short loc_1C15B
; ---------------------------------------------------------------------------

loc_1C133:
		call	marisa_1AE98

loc_1C136:
		xor	si, si
		jmp	short loc_1C14D
; ---------------------------------------------------------------------------

loc_1C13A:
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 1
		jnz	short loc_1C14C
		push	si
		call	marisa_1AD80
		add	sp, 2

loc_1C14C:
		inc	si

loc_1C14D:
		cmp	si, 4
		jl	short loc_1C13A
		call	marisa_1B3DE
		call	marisa_1B025
		mov	ax, 1

loc_1C15B:
		pop	di
		pop	si
		pop	bp
		retf
marisa_update	endp

; ---------------------------------------------------------------------------
		db 0
off_1C160	dw offset loc_1C032
		dw offset loc_1C03B
		dw offset loc_1C044
		dw offset loc_1C04D
		dw offset loc_1C053

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_bg_render	proc far
		push	bp
		mov	bp, sp
		push	si
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_left_on_page
		mov	_boss_left_on_back_page, ax
		mov	al, _page_back
		mov	ah, 0
		add	ax, ax
		add	ax, offset _boss_top_on_page
		mov	_boss_top_on_back_page, ax
		call	egc_off
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 0
		call	grcg_byteboxfill_x pascal, (PLAYFIELD_VRAM_LEFT shl 16) or PLAYFIELD_TOP, ((PLAYFIELD_VRAM_RIGHT - 1) shl 16) or PLAYFIELD_BOTTOM - 1
		call	sub_3EF4
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_left_on_page[bx]
		mov	bx, _boss_left_on_back_page
		mov	[bx], ax
		mov	al, _page_front
		mov	ah, 0
		add	ax, ax
		mov	bx, ax
		mov	ax, _boss_top_on_page[bx]
		mov	bx, _boss_top_on_back_page
		mov	[bx], ax
		xor	si, si
		jmp	loc_1C261
; ---------------------------------------------------------------------------

loc_1C1D9:
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		add	ax, 9292h
		mov	bx, si
		shl	bx, 2
		mov	word ptr [bx-6D18h], ds
		mov	[bx-6D1Ah], ax
		mov	al, _page_back
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		add	ax, 92A2h
		mov	bx, si
		shl	bx, 2
		mov	word ptr [bx-6D08h], ds
		mov	[bx-6D0Ah], ax
		mov	bx, si
		add	bx, bx
		cmp	word ptr [bx-6D46h], 2
		jge	short loc_1C260
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6D6Eh]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D1Ah]
		mov	es:[bx], ax
		mov	al, _page_front
		mov	ah, 0
		shl	ax, 3
		mov	dx, si
		add	dx, dx
		add	ax, dx
		mov	bx, ax
		mov	ax, [bx-6D5Eh]
		mov	bx, si
		shl	bx, 2
		les	bx, [bx-6D0Ah]
		mov	es:[bx], ax

loc_1C260:
		inc	si

loc_1C261:
		cmp	si, 4
		jl	loc_1C1D9
		call	grcg_off
		pop	si
		pop	bp
		retf
marisa_bg_render	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

marisa_end	proc far
		push	bp
		mov	bp, sp
		call	@dialog_pre$qv
		call	@dialog_script_stage4_post_animat$qv
		call	@stage_clear_bonus_animate$qv

loc_1C27C:
		call	@overlay_stage_leave_animate$qv
		inc	_stage_id
		pop	bp

locret_1C286:
		retf
marisa_end	endp

main_03__TEXT	ends

; ===========================================================================

; Segment type:	Pure code
main_04_TEXT	segment	byte public 'CODE' use16
		assume cs:main_04_TEXT
		;org 7
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1C287	proc far

var_4		= byte ptr -4
@@angle		= byte ptr -3
var_2		= word ptr -2
arg_0		= word ptr  6
arg_2		= word ptr  8
arg_4		= word ptr  0Ah
arg_6		= word ptr  0Ch

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	di, [bp+arg_6]
		mov	si, [bp+arg_2]
		mov	ax, si
		sar	ax, 6
		inc	al
		mov	[bp+var_4], al
		mov	[bp+var_2], 0
		jmp	loc_1C332
; ---------------------------------------------------------------------------

loc_1C2A7:
		mov	al, byte ptr [bp+var_2]
		mov	[bp+@@angle], al
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, di
		mov	word_20164, ax
		movsx	eax, si
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_4]
		mov	word_20166, ax
		cmp	word_20164, 1A0h
		jge	short loc_1C32C
		cmp	word_20164, 18h
		jle	short loc_1C32C
		cmp	word_20166, 8
		jle	short loc_1C32C
		cmp	word_20166, 180h
		jge	short loc_1C32C
		mov	ax, _scroll_line
		add	word_20166, ax
		cmp	word_20166, RES_Y
		jl	short loc_1C321
		sub	word_20166, RES_Y

loc_1C321:
		mov	al, [bp+var_4]
		mov	ah, 0
		push	ax
		call	sub_3E6A

loc_1C32C:
		mov	ax, [bp+arg_0]
		add	[bp+var_2], ax

loc_1C332:
		cmp	[bp+var_2], 100h
		jb	loc_1C2A7
		pop	di
		pop	si
		leave
		retf	8
sub_1C287	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1C341	proc far

var_4		= byte ptr -4
@@angle		= byte ptr -3
var_2		= word ptr -2
arg_0		= word ptr  6
arg_2		= word ptr  8
arg_4		= word ptr  0Ah
arg_6		= word ptr  0Ch

		push	bp
		mov	bp, sp
		sub	sp, 4
		push	si
		push	di
		mov	ax, [bp+arg_2]
		sar	ax, 6
		inc	al
		mov	[bp+var_4], al
		mov	[bp+var_2], 0
		jmp	short loc_1C3D2
; ---------------------------------------------------------------------------

loc_1C35B:
		mov	al, byte ptr [bp+var_2]
		mov	[bp+@@angle], al
		movsx	eax, [bp+arg_2]
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _CosTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_6]
		mov	si, ax
		movsx	eax, [bp+arg_2]
		mov	dl, [bp+@@angle]
		mov	dh, 0
		add	dx, dx
		mov	bx, dx
		movsx	edx, _SinTable8[bx]
		imul	eax, edx
		sar	eax, 8
		add	ax, [bp+arg_4]
		mov	di, ax
		cmp	si, 1A0h
		jge	short loc_1C3CC
		cmp	si, 18h
		jle	short loc_1C3CC
		cmp	di, 8
		jle	short loc_1C3CC
		cmp	di, 180h
		jge	short loc_1C3CC
		push	si	; left
		push	ax	; top
		mov	al, [bp+var_4]
		mov	ah, 0
		push	ax	; w
		mov	al, [bp+var_4]
		mov	ah, 0
		push	ax	; h
		call	@tiles_invalidate_rect$qiiii

loc_1C3CC:
		mov	ax, [bp+arg_0]

loc_1C3CF:
		add	[bp+var_2], ax

loc_1C3D2:
		cmp	[bp+var_2], 100h
		jb	short loc_1C35B
		pop	di
		pop	si
		leave
		retf	8
sub_1C341	endp

main_04_TEXT	ends

; ===========================================================================

; Segment type:	Pure code
main_05_TEXT	segment	byte public 'CODE' use16
		assume cs:main_05_TEXT
		;org 0Fh
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1C3DF	proc far

src		= dword	ptr -14h
dest		= dword	ptr -10h
var_A		= word ptr -0Ah
var_6		= word ptr -6
var_4		= word ptr -4
var_2		= word ptr -2

		enter	14h, 0
		push	si
		push	di
		mov	word ptr [bp-0Ch], ds
		mov	word ptr [bp+dest+2], 111Ah
		les	bx, [bp+dest+2]
		mov	al, _stage_id
		add	al, '0'
		mov	es:[bx+5], al
		push	word ptr [bp-0Ch]
		push	bx
		call	file_ropen
		push	ss
		lea	ax, [bp+var_A]
		push	ax
		push	4
		call	file_read
		push	[bp+var_A]
		call	hmem_allocbyte
		mov	[bp+var_6], ax
		mov	word ptr [bp+src+2], ax
		mov	word ptr [bp+src], 0
		push	ax
		push	word ptr [bp+src]
		push	[bp+var_A]
		call	file_read
		call	file_close
		les	bx, [bp+src]
		mov	ax, es:[bx]
		mov	_map_length, ax
		add	word ptr [bp+src], 2
		xor	di, di
		jmp	short loc_1C451
; ---------------------------------------------------------------------------

loc_1C443:
		les	bx, [bp+src]
		mov	al, es:[bx]
		mov	_map[di], al
		inc	word ptr [bp+src]
		inc	di

loc_1C451:
		cmp	di, _map_length
		jl	short loc_1C443
		les	bx, [bp+src]
		mov	ax, es:[bx]
		mov	[bp+var_2], ax
		add	word ptr [bp+src], 2
		mov	byte_22FDB, 0
		mov	word ptr [bp+dest], 7F06h
		xor	di, di
		jmp	loc_1C55E
; ---------------------------------------------------------------------------

loc_1C473:
		push	1Ch		; n
		pushd	[bp+src]	; src
		push	ds
		push	word ptr [bp+dest] ; dest
		call	_memcpy
		add	sp, 0Ah
		add	word ptr [bp+src], 1Ch
		mov	bx, di
		imul	bx, 24h
		mov	bx, [bx+7F0Eh]
		add	bx, bx
		mov	ax, [bx+1EDAh]
		shr	ax, 8
		shl	ax, 3
		mov	bx, word ptr [bp+dest]
		mov	[bx+1Ch], ax
		mov	bx, di
		imul	bx, 24h
		mov	bx, [bx+7F0Eh]
		add	bx, bx
		mov	ax, [bx+1EDAh]
		and	ax, 255
		mov	bx, word ptr [bp+dest]
		mov	[bx+1Eh], ax
		mov	ax, [bx+1Ah]
		mov	[bp+var_4], ax
		cmp	_rank, RANK_EASY
		jnz	short loc_1C4CE
		shl	[bp+var_4], 1
		jmp	short loc_1C4DF
; ---------------------------------------------------------------------------

loc_1C4CE:
		cmp	_rank, RANK_HARD
		jz	short loc_1C4DC
		cmp	_rank, RANK_LUNATIC
		jnz	short loc_1C4DF

loc_1C4DC:
		sar	[bp+var_4], 1

loc_1C4DF:
		mov	bx, word ptr [bp+dest]
		mov	ax, [bp+var_4]
		mov	[bx+1Ah], ax
		les	bx, [bp+src]
		cmp	byte ptr es:[bx], 0FEh
		jnz	short loc_1C513
		inc	word ptr [bp+src]
		les	bx, [bp+src]
		mov	al, es:[bx]
		mov	ah, 0
		shl	ax, 6
		add	ax, 556Ch
		mov	bx, word ptr [bp+dest]
		mov	word ptr [bx+22h], ds
		mov	[bx+20h], ax
		inc	word ptr [bp+src]
		inc	word ptr [bp+src]
		jmp	short loc_1C559
; ---------------------------------------------------------------------------

loc_1C513:
		mov	[bp+var_4], 0

loc_1C518:
		mov	al, byte_22FDB
		mov	ah, 0
		shl	ax, 6
		add	ax, [bp+var_4]
		les	bx, [bp+src]
		mov	dl, es:[bx]
		mov	bx, ax
		mov	[bx+556Ch], dl
		inc	word ptr [bp+src]
		inc	[bp+var_4]
		les	bx, [bp+src]
		cmp	byte ptr es:[bx], -1
		jnz	short loc_1C518
		inc	word ptr [bp+src]
		mov	al, byte_22FDB
		mov	ah, 0
		shl	ax, 6
		add	ax, 556Ch
		mov	bx, word ptr [bp+dest]
		mov	word ptr [bx+22h], ds
		mov	[bx+20h], ax
		inc	byte_22FDB

loc_1C559:
		inc	di
		add	word ptr [bp+dest], 24h	; '$'

loc_1C55E:
		cmp	di, [bp+var_2]
		jl	loc_1C473
		les	bx, [bp+src]
		mov	ax, es:[bx]
		mov	[bp+var_2], ax
		add	word ptr [bp+src], 2
		mov	word_26C3A, ax
		xor	di, di
		jmp	short loc_1C594
; ---------------------------------------------------------------------------

loc_1C579:
		mov	ax, [bp+var_2]
		add	ax, ax
		push	ax
		call	hmem_allocbyte
		mov	bx, di
		shl	bx, 2
		mov	[bx-6EF8h], ax
		mov	word ptr [bx-6EFAh], 0
		inc	di

loc_1C594:
		cmp	di, 31h	; '1'
		jl	short loc_1C579
		xor	di, di
		jmp	short loc_1C5F7
; ---------------------------------------------------------------------------

loc_1C59D:
		mov	ax, di
		add	ax, ax
		les	bx, dword_26B76
		add	bx, ax
		push	es
		les	si, [bp+src]
		mov	ax, es:[si]
		pop	es
		mov	es:[bx], ax
		add	word ptr [bp+src], 2
		mov	[bp+var_4], 1
		jmp	short loc_1C5F0
; ---------------------------------------------------------------------------

loc_1C5BD:
		mov	bx, [bp+var_4]
		shl	bx, 2
		les	bx, [bx-6EFAh]
		mov	ax, di
		add	ax, ax
		add	bx, ax
		push	es
		push	bx
		les	bx, [bp+src]
		cmp	byte ptr es:[bx], -1
		jnz	short loc_1C5DD
		mov	ax, 0FFFFh
		jmp	short loc_1C5E5
; ---------------------------------------------------------------------------

loc_1C5DD:
		les	bx, [bp+src]
		mov	al, es:[bx]
		mov	ah, 0

loc_1C5E5:
		pop	bx
		pop	es
		mov	es:[bx], ax
		inc	word ptr [bp+src]
		inc	[bp+var_4]

loc_1C5F0:
		cmp	[bp+var_4], 31h	; '1'
		jl	short loc_1C5BD
		inc	di

loc_1C5F7:
		cmp	di, [bp+var_2]
		jl	short loc_1C59D
		push	[bp+var_6]
		call	hmem_free
		pop	di
		pop	si
		leave
		retf
sub_1C3DF	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1C608	proc far
		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	short loc_1C63F
; ---------------------------------------------------------------------------

loc_1C610:
		mov	bx, si
		shl	bx, 2
		mov	ax, [bx-6EFAh]
		or	ax, [bx-6EF8h]
		jz	short loc_1C63E
		mov	bx, si
		shl	bx, 2
		push	word ptr [bx-6EF8h]
		call	hmem_free
		mov	bx, si
		shl	bx, 2
		mov	word ptr [bx-6EF8h], 0
		mov	word ptr [bx-6EFAh], 0

loc_1C63E:
		inc	si

loc_1C63F:
		cmp	si, 31h	; '1'
		jl	short loc_1C610
		pop	si
		pop	bp

locret_1C646:
		retf
sub_1C608	endp

main_05_TEXT	ends

REGIST_M_TEXT segment	byte public 'CODE' use16
	extern @scoredat_defaults_set$qv:proc
	@scoredat_load$qv procdesc near
	extern @scoredat_save$qv:proc
	extern @regist_menu$qv:proc
REGIST_M_TEXT ends

; ===========================================================================

; Segment type:	Pure code
main_06_TEXT	segment	byte public 'CODE' use16
		assume cs:main_06
		;org 7
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1CD36	proc far
		push	bp
		mov	bp, sp
		pushd	[_SCOREDAT_FN]
		call	file_exist
		or	ax, ax
		jnz	short loc_1CD4D
		call	@scoredat_defaults_set$qv
		jmp	short loc_1CD50
; ---------------------------------------------------------------------------

loc_1CD4D:
		call	@scoredat_load$qv

loc_1CD50:
		mov	eax, _hi.SCOREDAT_score[(0 * SCOREDAT_PLACES) * dword]
		mov	ebx, 10
		cdq
		idiv	ebx
		cmp	eax, _score
		jl	short loc_1CD71
		mov	eax, _hi.SCOREDAT_score[(0 * SCOREDAT_PLACES) * dword]
		cdq
		idiv	ebx
		jmp	short loc_1CD75
; ---------------------------------------------------------------------------

loc_1CD71:
		mov	eax, _score

loc_1CD75:
		mov	_hiscore, eax
		mov	eax, _hi.SCOREDAT_score[(0 * SCOREDAT_PLACES) * dword]
		mov	ebx, 0Ah
		cdq
		idiv	ebx
		mov	_hiscore_continues, dl
		pop	bp
		retf
sub_1CD36	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1CD8E	proc far

@@rank		= byte ptr -7
var_6		= byte ptr -6

		enter	8, 0
		lea	ax, [bp+var_6]
		push	ss
		push	ax
		push	ds
		push	offset _GAME_CLEAR_CONSTANTS
		mov	cx, (SHOTTYPE_COUNT * word)
		call	SCOPY@
		mov	al, _rank
		mov	[bp+@@rank], al
		les	bx, _resident
		mov	al, es:[bx+mikoconfig_t.shottype]
		mov	_rank, al
		call	@scoredat_load$qv
		mov	al, _rank
		cbw
		add	ax, ax
		lea	dx, [bp+var_6]
		add	ax, dx
		mov	bx, ax
		mov	ax, ss:[bx]
		mov	_hi.SCOREDAT_cleared, ax
		call	@scoredat_save$qv
		mov	al, [bp+@@rank]
		mov	_rank, al
		leave
		retf
sub_1CD8E	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_1CDD6	proc far

@@rank		= byte ptr -5
var_4		= byte ptr -4

		enter	6, 0
		lea	ax, [bp+var_4]
		push	ss
		push	ax
		push	ds
		push	offset _EXTRA_CLEAR_FLAGS
		mov	cx, SHOTTYPE_COUNT
		call	SCOPY@
		mov	al, _rank
		mov	[bp+@@rank], al
		mov	_rank, RANK_LUNATIC
		call	@scoredat_load$qv
		les	bx, _resident
		mov	al, es:[bx+mikoconfig_t.shottype]
		mov	ah, 0
		lea	dx, [bp+var_4]
		add	ax, dx
		mov	bx, ax
		mov	al, ss:[bx]
		mov	ah, 0

loc_1CE0F:
		or	_hi.SCOREDAT_cleared, ax
		push	cs

loc_1CE14:
		call	near ptr @scoredat_save$qv
		mov	al, [bp+@@rank]
		mov	_rank, al
		leave
		retf
sub_1CDD6	endp

main_06_TEXT	ends

	.data

gStage1		db 0BCh, 0BDh, 0AAh, 0B0h, 0AEh, 0A1h, 0, 0
		db 0, 0, 0, 0, 0, 0, 0, 0
gEXTRA_STAGE	db 0AEh, 0C1h, 0BDh, 0BBh, 0AAh, 0CFh, 0CFh, 0BCh, 0BDh
		db	0AAh, 0B0h, 0AEh, 0, 0, 0, 0
public _BGM_TITLES, _STAGE_TITLES, _STAGE_TITLE_HALFLENGTHS
_BGM_TITLES	label word
		dw offset aTH02_02
		dw offset aTH02_03
		dw offset aTH02_04
		dw offset aTH02_05
		dw offset aTH02_06
		dw offset aTH02_07
		dw offset aTH02_08
		dw offset aTH02_09
		dw offset aTH02_10
		dw offset aTH02_11
		dw offset aTH02_12
		dw offset aTH02_13
_STAGE_TITLES	label word
		dw offset aSTAGE1_TITLE
		dw offset aSTAGE2_TITLE
		dw offset aSTAGE3_TITLE
		dw offset aSTAGE4_TITLE
		dw offset aSTAGE5_TITLE
		dw offset aEXTRA_TITLE
_STAGE_TITLE_HALFLENGTHS	label byte
		db  0Ah
		db  0Dh
		db  0Bh
		db  0Ch
		db  0Dh
		db  0Dh
gDEMO_PLAY	db 0ADh, 0AEh, 0B7h, 0B8h, 0CFh, 0B9h, 0B5h, 0AAh, 0C2h, 0
gPAUSE_MENU	db 0B9h, 0AAh, 0BEh, 0BCh, 0AEh, 0CFh, 0B7h, 0AEh, 0B6h, 0BEh, 0
g11SPACES	db 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0CFh, 0
		db 0
off_1DB6C	dd aGqbGapic
					; "Q[I"
off_1DB70	dd aGqbGanKj
					; "Q[J"
byte_1DB74	db 0
		db 0
off_1DB76	dd aVV2
					; "I"
off_1DB7A	dd aVdvVVBbvVVVV
					; "BB"
off_1DB7E	dd aB@b@vVvbavtvVV
					; "@@AB@"
dword_1DB82	dd 0
include th02/main/demo[data].asm
aTH02_02	db '@ @`Eastern Wind ',0
aTH02_03	db '@  She',27h,'s in a temper!! ',0
aTH02_04	db '@   End of Daylight@  ',0
aTH02_05	db '   @ @@  ',0
aTH02_06	db '@@@@@E@@@@',0
aTH02_07	db ' @@@q@@@ ',0
aTH02_08	db 'A',0
aTH02_09		db '   @ F}WbN @   ',0
aTH02_10		db '@^@`H',0
aTH02_11	db '   Complete Darkness    ',0
aTH02_12	db '   @ GLXgu    ',0
aTH02_13	db '    ',0
aSTAGE1_TITLE	db '@` Purple Dawn',0
aSTAGE2_TITLE	db 'b@`Midnight Rainstorm',0
aSTAGE3_TITLE	db 'g@` Scarlet Dream',0
aSTAGE4_TITLE	db '@`Revengeful Ghost',0
aSTAGE5_TITLE	db '@`^ and ...',0
aEXTRA_TITLE		db '@`for Lunatic Gamers',0
; char arg0[3]
arg0		db 'op',0
aHuuma_efc	db 'huuma.efc',0
aEye_pi		db 'EYE.PI',0
aMiko_bft	db 'miko.bft',0
aMiko32_bft	db 'miko32.bft',0
aMiko16_bft	db 'miko16.bft',0
aBmt		db 'bmt',0
aBbt		db 'bbt',0
aMap		db 'map',0
aMpn		db 'mpn',0
aM		db 'm',0
		db    0
		db    0
aMiko_k_mpn	db 'miko_k.mpn',0
aGqbGapic	db 'Q[I',0
aGqbGanKj	db 'Q[J',0
aVV2		db 'I',0
aVdvVVBbvVVVV	db 'BB',0
aB@b@vVvbavtvVV	db '@@AB@',0
aEMPTY	db '                                                ',0
aDemo1_rec	db 'DEMO1.REC',0
aDemo2_rec	db 'DEMO2.REC',0
aDemo3_rec	db 'DEMO3.REC',0
include libs/master.lib/atan8[data].asm
include libs/master.lib/bfnt_id[data].asm
include libs/master.lib/clip[data].asm
include libs/master.lib/edges[data].asm
include libs/master.lib/fil[data].asm
include libs/master.lib/dos_ropen[data].asm
include libs/master.lib/gaiji_backup[data].asm
include libs/master.lib/gaiji_entry_bfnt[data].asm
include libs/master.lib/grp[data].asm
include libs/master.lib/pal[data].asm
include libs/master.lib/pf[data].asm
include libs/master.lib/rand[data].asm
include libs/master.lib/sin8[data].asm
include libs/master.lib/tx[data].asm
include libs/master.lib/version[data].asm
include libs/master.lib/vs[data].asm
include libs/master.lib/wordmask[data].asm
include libs/master.lib/mem[data].asm
include libs/master.lib/super_entry_bfnt[data].asm
include libs/master.lib/superpa[data].asm
public _key_delay_groups
_key_delay_groups	db 5, 3, 0
		db 0
include th02/formats/pfopen[data].asm
public _snd_active
_snd_active	db 0
		db 0
public _mpn_show_palette_on_load, _mpn_count
_mpn_show_palette_on_load	db 1
_mpn_count	db 0
public _pf_fn
_pf_fn		db '.^',0
include th02/snd/se[data].asm
		db    0
		db  80h
		db 0C0h
		db 0E0h
		db 0F0h
		db 0F8h
public _rank, _stage_id
_rank	db RANK_NORMAL
_stage_id	db 0
aHuuma_cfg	db 'huuma.cfg',0
include th02/sprites/pellet.asp
public _gBONUS_0, _gBONUS_1
_gBONUS_0	db 0ABh, 0B8h, 0B6h, 0BEh, 0BCh, 0
_gBONUS_1	db 0ABh, 0B8h, 0B6h, 0BEh, 0BCh, 0
public _BONUS_RANK, _BONUS_PLAYPERF, _BONUS_BOMBS, _BONUS_LIVES
public _BONUS_START_BOMBS, _BONUS_START_LIVES, _BONUS_POINT, _BONUS_TIMES
public _BONUS_EQUALS, _BONUS_EXTRA_CLEAR, _BONUS_EXTRA_LIVES
public _BONUS_EXTRA_BOMBS, _BONUS_EXTRA_SIGMA_FRAMES

; ZUN bug: Why is that space here? None of the other labels even attempt to be
; centered.
_BONUS_RANK       	db ' x',0

_BONUS_PLAYPERF   	db 'Xe[W',0
_BONUS_BOMBS      	db '{',0
_BONUS_LIVES      	db '~X',0
_BONUS_START_BOMBS	db '',0
_BONUS_START_LIVES	db '',0
_BONUS_POINT 	db '_',0
_BONUS_TIMES 	db '~',0
_BONUS_EQUALS	db '',0
_BONUS_EXTRA_CLEAR       	db 'NA',0
_BONUS_EXTRA_LIVES       	db '~X',0
_BONUS_EXTRA_BOMBS       	db '{',0
_BONUS_EXTRA_SIGMA_FRAMES	db 'NA^C',0
include th02/gaiji/gameover[data].asm
asc_1E47E	db '                ',0
		db 0
public _FOUR_DIGIT_POWERS_OF_10
_FOUR_DIGIT_POWERS_OF_10 dw 1000, 100, 10, 1
include th02/sprites/pointnum.asp
public _scroll_interval, _scroll_done
_scroll_interval	db 4
_scroll_done	db 0
byte_1E502	db 0
byte_1E503	db 0
		db  27h	; '
		db    0
		db  27h	; '
		db    0
		db  27h	; '
		db    0
		db  28h	; (
		db    0
		db  29h	; )
		db    0
		db  2Fh	; /
		db    0
angle_1E510	db 20h
		db 0
public _player_patnum
_player_patnum	dw PAT_PLAYCHAR_STILL
		db    0
		db    0
public _power
_power	db 1
byte_1E517	db 0
byte_1E518	db 4
byte_1E519	db 40h
byte_1E51A	db 4Ch
public _player_option_patnum, _power_overflow
_player_option_patnum	db PAT_OPTION_A
_power_overflow	dw 0

public _item_bigpower_override, _ITEM_SEMIRANDOM_RING, _ITEM_PATNUM
public _ITEM_MISS_VELOCITY_Y_SIDES, _ITEM_MISS_VELOCITY_X_CENTER
public _ITEM_MISS_VELOCITY_Y_CENTER, _item_skill, _item_drop_cycle
_item_bigpower_override	dw 0
_ITEM_SEMIRANDOM_RING label byte
	db IT_POWER
	db IT_POINT
	db IT_POWER
	db IT_POINT
	db IT_POINT
	db IT_POWER
	db IT_POWER
	db IT_POINT
	db IT_POINT
	db IT_POWER
_ITEM_PATNUM label byte
	db PAT_ITEM_POWER
	db PAT_ITEM_POINT
	db PAT_ITEM_BOMB
	db PAT_ITEM_BIGPOWER
	db PAT_ITEM_1UP
	evendata
include th02/main/power_overflow[data].asm
_item_skill	dw 0

public _ITEM_MISS_VELOCITY_Y_CENTER
_ITEM_MISS_VELOCITY_Y_SIDES 	db 0B0h, 0BCh, 0C8h, 0D4h, 0E0h
_ITEM_MISS_VELOCITY_X_CENTER	db -2, -1, 0, 1, 2
_ITEM_MISS_VELOCITY_Y_CENTER	db 0C8h, 0BCh, 0B0h, 0BCh, 0C8h

_item_drop_cycle	db 0

public _score, _lives, _bombs, _EXTEND_SCORES, _extends_gained
public _score_reset_unknown_40000
_score	dd 0
_lives	db 3
_bombs	db 3
_EXTEND_SCORES	dd 100000, 200000, 300000, 500000, 800000, 99999999
_extends_gained	dw 0
_score_reset_unknown_40000	dd 40000
include th02/main/hud/score_put[data].asm

public _gHUD_BAR_MAX, _HUD_POWER_COLORS, _gHUD_BAR_BLANK
_gHUD_BAR_MAX label byte
	db g_BAR_MAX_0, g_BAR_MAX_1, g_BAR_MAX_2, g_BAR_MAX_3, g_BAR_MAX_4, 0

include th02/main/hud/power[data].asm

_gHUD_BAR_BLANK	db gb_SP, gb_SP, gb_SP, gb_SP, gb_SP, 0

public _gRANKS, _gsSCORE, _gsHISCORE, _gsREIMU, _gsREIGEKI, _gsREIRYOKU
_gRANKS label byte
_gEASY     	db gb_E_, gb_A_, gb_S_, gb_Y_, gb_SP, gb_SP, gb_SP, 0
_gNORMAL   	db gb_N_, gb_O_, gb_R_, gb_M_, gb_A_, gb_L_, gb_SP, 0
_gHARD     	db gb_H_, gb_A_, gb_R_, gb_D_, gb_SP, gb_SP, gb_SP, 0
_gLUNATIC  	db gb_L_, gb_U_, gb_N_, gb_A_, gb_T_, gb_I_, gb_C_, 0
_gEXTRA    	db gb_E_, gb_X_, gb_T_, gb_R_, gb_A_, gb_SP, gb_SP, 0

_gsSCORE   	db gs_Sc, gs_cor, gs_e, 0, 0
_gsHISCORE 	db gs_Hi, gs_Sc, gs_cor, gs_e, 0
_gsREIMU   	db gs_REIMU_REI, gs_REIMU_MU, 0, 0, 0
_gsREIGEKI 	db gs_REIGEKI_REI, gs_REIGEKI_GEKI, 0, 0, 0
_gsREIRYOKU	db gs_REIRYOKU_REI, gs_REIRYOKU_RYOKU, 0, 0, 0
public _GAIJI_FN, _POWER_TO_SHOT_LEVEL
_GAIJI_FN	db 'MIKOFT.bft',0
_POWER_TO_SHOT_LEVEL	db 0, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 8, 9
public _total_bombs_used
_total_bombs_used	db 0
		db 0
		db    4
		db    0
		db    3
		db    0
		db    3
		db    0
		db    2
		db    0
		db    2
		db    0
		db    1
		db    0
		db    1
		db    0
		db    0
		db    0
		db    0
		db    0
		db    2
		db    0
		db    3
		db    0
		db    2
		db    0
		db    1
		db    0
		db    0
		db    0
		db    1
		db    0
		db    2
		db    0
		db    1
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    2
		db    0
		db    3
		db    0
		db    3
		db    0
		db    2
		db    0
		db    3
		db    0
		db    1
		db    0
		db    2
		db    0
		db    0
		db    0
		db    0
		db    0
		db    1
		db    0
		db    1
		db    0
		db    2
		db    0
		db    2
		db    0
		db    3
		db    0
		db    1
		db    0
		db    2
		db    0
		db    3
		db    0
		db    2
		db    0
		db    1
		db    0
		db    0
		db    0
		db    1
		db    0
		db    1
		db    0
		db    2
		db    0
		db    2
		db    0
		db    3
		db    0
		db    3
		db    0
		db    4
		db    0
		db    4
		db    0
aBombs_bft	db 'bombs.bft',0
aBomb1_pi	db 'bomb1.pi',0
aBomb3_pi	db 'bomb3.pi',0
aBomb2_pi	db 'bomb2.pi',0
aBomb1_bft	db 'bomb1.bft',0
asc_1E6DF	db '  ',0
include th02/sprites/bombpart.asp
include th02/sprites/sparks.asp
public _spark_accel_x, _total_miss_count
_spark_accel_x	dw 0
_total_miss_count	db 0
byte_1EB0D	db -1
byte_1EB0E	db -1
		db    1
		db    1
		db    4
		db    8
		db  10h
		db  18h
		db  20h
		db  28h	; (
		db  34h	; 4
		db  40h
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
word_1EB26	dw 0
angle_1EB28	db 0
		db    0
		db    1
		db    2
		db    3
		db    4
		db    5
		db    6
		db    7
		db    8
		db    9
		db  0Ah
		db  0Bh
		db  17h
		db  16h
		db  15h
		db  14h
		db  13h
		db  12h
		db  11h
		db  10h
		db  0Fh
		db  0Eh
		db  0Dh
		db  0Ch
aBoss2_m	db 'boss2.m',0
		db 0
		db    5
		db    0
		db    5
		db    0
		db    4
		db    0
		db    4
		db    0
		db    3
		db    0
		db    3
		db    0
		db    3
		db    0
		db    2
		db    0
		db    2
		db    0
		db    1
		db    0
		db    2
		db    0
		db    2
		db    0
		db    2
		db    0
		db    2
		db    0
		db    2
		db    0
		db    1
		db    0
		db    1
		db    0
		db    1
		db    0
		db    1
		db    0
		db    1
		db    0
		db    0
		db    0
		db    0
		db    0
		db    8
		db    0
		db    8
		db    0
		db    7
		db    0
		db    7
		db    0
		db    6
		db    0
		db    5
		db    0
		db    4
		db    0
		db    3
		db    0
		db    0
		db    0
byte_1EB88	db 1
		db 0
aStage_dt1	db 'STAGE .DT1',0
		db 0
public _LINE_BLANK, _clear_bytes
_LINE_BLANK 	dw aLINE_BLANK
_clear_bytes	db DIALOG_LINE_SIZE dup(0)

public _GENERIC_BOX_COUNTS
_GENERIC_BOX_COUNTS label byte
	db  16,  8	; Stage 1
	db  22, 11	; Stage 2
	db   8,  3	; Stage 3
	db  16,  4	; Stage 4
	db   0,  0	; Stage 5 (unused, not generic)
	db  22,  6	; Extra Stage

BOX_COUNT_MAX = 22

public _GENERIC_FACES
_GENERIC_FACES label byte
	; Stage	1, pre-boss
	db FACE_REIMU_NEUTRAL	;  0
	db FACE_GENJII       	;  1
	db FACE_REIMU_CRY    	;  2
	db FACE_GENJII       	;  3
	db FACE_REIMU_JOY    	;  4
	db FACE_GENJII       	;  5
	db FACE_REIMU_NEUTRAL	;  6
	db FACE_GENJII       	;  7
	db FACE_RIKA         	;  8
	db FACE_RIKA         	;  9
	db FACE_REIMU_FALL   	; 10
	db FACE_REIMU_FROWN  	; 11
	db FACE_RIKA         	; 12
	db FACE_RIKA         	; 13
	db FACE_REIMU_ANGRY  	; 14
	db FACE_RIKA         	; 15
	db (BOX_COUNT_MAX - 16) dup(0)

	; Stage	1, post-boss
	db FACE_RIKA        	; 0
	db FACE_RIKA        	; 1
	db FACE_REIMU_SWEAT 	; 2
	db FACE_GENJII      	; 3
	db FACE_REIMU_HUSHED	; 4
	db FACE_RIKA        	; 5
	db FACE_REIMU_JOY   	; 6
	db FACE_GENJII      	; 7
	db (BOX_COUNT_MAX - 8) dup(0)

	; Stage	2, pre-boss
	db FACE_MEIRA_NEUTRAL 	;  0
	db FACE_MEIRA_NEUTRAL 	;  1
	db FACE_REIMU_SWEAT   	;  2
	db FACE_REIMU_FLIRTY  	;  3
	db FACE_MEIRA_NEUTRAL 	;  4
	db FACE_MEIRA_NEUTRAL 	;  5
	db FACE_REIMU_FLIRTY  	;  6
	db FACE_REIMU_JOY     	;  7
	db FACE_MEIRA_SWEAT   	;  8
	db FACE_REIMU_QUESTION	;  9
	db FACE_MEIRA_NEUTRAL 	; 10
	db FACE_MEIRA_NEUTRAL 	; 11
	db FACE_GENJII        	; 12
	db FACE_REIMU_QUESTION	; 13
	db FACE_MEIRA_NEUTRAL 	; 14
	db FACE_REIMU_FLIRTY  	; 15
	db FACE_REIMU_JOY     	; 16
	db FACE_MEIRA_NEUTRAL 	; 17
	db FACE_REIMU_JOY     	; 18
	db FACE_MEIRA_SWEAT   	; 19
	db FACE_REIMU_SWEAT   	; 20
	db FACE_MEIRA_SWEAT   	; 21

	; Stage	2, post-boss
	db FACE_REIMU_JOY     	;  0
	db FACE_REIMU_QUESTION	;  1
	db FACE_REIMU_SWEAT   	;  2
	db FACE_REIMU_JOY     	;  3
	db FACE_GENJII        	;  4
	db FACE_MEIRA_SWEAT   	;  5
	db FACE_REIMU_SWEAT   	;  6
	db FACE_GENJII        	;  7
	db FACE_REIMU_QUESTION	;  8
	db FACE_GENJII        	;  9
	db FACE_REIMU_FROWN   	; 10
	db (BOX_COUNT_MAX - 11) dup(0)

	; Stage	3, pre-boss
	db FACE_REIMU_ANGRY  	; 0
	db FACE_GENJII       	; 1
	db FACE_GENJII       	; 2
	db FACE_REIMU_FROWN  	; 3
	db FACE_GENJII       	; 4
	db FACE_REIMU_CRY    	; 5
	db FACE_GENJII       	; 6
	db FACE_REIMU_NEUTRAL	; 7
	db (BOX_COUNT_MAX - 8) dup(0)

	; Stage	3, post-boss
	db FACE_REIMU_FROWN	; 0
	db FACE_GENJII     	; 1
	db FACE_REIMU_FROWN	; 2
	db (BOX_COUNT_MAX - 3) dup(0)

	; Stage	4, pre-boss
	db FACE_MIMA_SMILE 	;  0
	db FACE_REIMU_ANGRY	;  1
	db FACE_GENJII     	;  2
	db FACE_REIMU_FROWN	;  3
	db FACE_REIMU_ANGRY	;  4
	db FACE_REIMU_ANGRY	;  5
	db FACE_MIMA_SMILE 	;  6
	db FACE_MIMA_SMILE 	;  7
	db FACE_REIMU_FROWN	;  8
	db FACE_GENJII     	;  9
	db FACE_REIMU_ANGRY	; 10
	db FACE_REIMU_ANGRY	; 11
	db FACE_MIMA_SMILE 	; 12
	db FACE_MIMA_SMILE 	; 13
	db FACE_MIMA_SMILE 	; 14
	db FACE_MIMA_SMILE 	; 15
	db (BOX_COUNT_MAX - 16) dup(0)

	; Stage	4, post-boss
	db FACE_MARISA_FROWN 	; 0
	db FACE_REIMU_NEUTRAL	; 1
	db FACE_GENJII       	; 2
	db FACE_REIMU_NEUTRAL	; 3
	db (BOX_COUNT_MAX - 4) dup(0)

	; Stage	5, pre-boss (unused)
	db BOX_COUNT_MAX dup(0)

	; Stage	5, post-boss (unused)
	db BOX_COUNT_MAX dup(0)

	; Extra	Stage, pre-boss
	db FACE_EXRIKA_SMILE 	;  0
	db FACE_REIMU_NEUTRAL	;  1
	db FACE_EXRIKA_SMILE 	;  2
	db FACE_REIMU_HUSHED 	;  3
	db FACE_EXRIKA_SMILE 	;  4
	db FACE_REIMU_ANGRY  	;  5
	db FACE_EXRIKA_SMILE 	;  6
	db FACE_EXRIKA_SMILE 	;  7
	db FACE_EXRIKA_SMILE 	;  8
	db FACE_REIMU_SWEAT  	;  9
	db FACE_EXRIKA_SMILE 	; 10
	db FACE_REIMU_SWEAT  	; 11
	db FACE_EXRIKA_SMILE 	; 12
	db FACE_REIMU_SWEAT  	; 13
	db FACE_EXRIKA_SMILE 	; 14
	db FACE_EXRIKA_SMILE 	; 15
	db FACE_REIMU_SWEAT  	; 16
	db FACE_EXRIKA_SMILE 	; 17
	db FACE_REIMU_FROWN  	; 18
	db FACE_GENJII       	; 19
	db FACE_REIMU_FROWN  	; 20
	db FACE_EXRIKA_SMILE 	; 21

	; Extra	Stage, post-boss
	db FACE_REIMU_JOY   	; 0
	db FACE_EXRIKA_FROWN	; 1
	db FACE_REIMU_JOY   	; 2
	db FACE_GENJII      	; 3
	db FACE_GENJII      	; 4
	db FACE_REIMU_FROWN 	; 5
	db (BOX_COUNT_MAX - 6) dup(0)

public _STAGE4_PREBOSS_INTRO_FACES
_STAGE4_PREBOSS_INTRO_FACES label byte
	db FACE_REIMU_SWEAT	; 0
	db FACE_GENJII     	; 1
	db FACE_GENJII     	; 2
	db FACE_REIMU_SWEAT	; 3
	db FACE_GENJII     	; 4
	db FACE_REIMU_SWEAT	; 5
	db FACE_GENJII     	; 6
	db FACE_REIMU_SWEAT	; 7

public _STAGE4_PREBOSS_MARISA_FACES
_STAGE4_PREBOSS_MARISA_FACES label byte
	db FACE_REIMU_SWEAT 	;  0
	db FACE_MARISA_SMILE	;  1
	db FACE_REIMU_ANGRY 	;  2
	db FACE_MARISA_SMILE	;  3
	db FACE_MARISA_SMILE	;  4
	db FACE_MARISA_SMILE	;  5
	db FACE_REIMU_ANGRY 	;  6
	db FACE_MARISA_SMILE	;  7
	db FACE_GENJII      	;  8
	db FACE_REIMU_NEUTRAL	;  9
	db FACE_GENJII      	; 10
	db FACE_REIMU_NEUTRAL	; 11

public _STAGE4_POSTBOSS_CONTINUED_NUMERA
_STAGE4_POSTBOSS_CONTINUED_NUMERA label word
	dw offset aFW_0
	dw offset aFW_1
	dw offset aFW_2
	dw offset aFW_3
	dw offset aFW_4
	dw offset aFW_5
	dw offset aFW_6
	dw offset aFW_7
	dw offset aFW_8
	dw offset aFW_9

public _STAGE4_POSTBOSS_CONTINUED_BEFORE
_STAGE4_POSTBOSS_CONTINUED_BEFORE label word
	dw FACE_GENJII        	; 0
	dw FACE_REIMU_QUESTION	; 1
	dw FACE_MARISA_SMILE  	; 2

public _STAGE4_POSTBOSS_CONTINUED_AFTER_
_STAGE4_POSTBOSS_CONTINUED_AFTER_ label word
	dw FACE_MARISA_SMILE	; 0
	dw FACE_REIMU_FROWN 	; 1
	dw FACE_GENJII      	; 2
	dw FACE_REIMU_SWEAT 	; 3
	dw FACE_MARISA_SMILE	; 4

public _STAGE4_POSTBOSS_NOTCONTINUED_FAC
_STAGE4_POSTBOSS_NOTCONTINUED_FAC label word
	dw FACE_GENJII     	; 0
	dw FACE_GENJII     	; 1
	dw FACE_REIMU_SWEAT	; 2
	dw FACE_GENJII     	; 3
	dw FACE_REIMU_SWEAT	; 4

public _STAGE5_PREBOSS_CONTINUED_FACES
_STAGE5_PREBOSS_CONTINUED_FACES label byte
	db FACE_MIMA_SMILE   	;  0
	db FACE_REIMU_SWEAT  	;  1
	db FACE_MIMA_SMILE   	;  2
	db FACE_REIMU_ANGRY  	;  3
	db FACE_REIMU_ANGRY  	;  4
	db FACE_MIMA_SMILE   	;  5
	db FACE_MIMA_SMILE   	;  6
	db FACE_REIMU_ANGRY  	;  7
	db FACE_MIMA_SMILE   	;  8
	db FACE_REIMU_ANGRY  	;  9
	db FACE_REIMU_ANGRY  	; 10
	db FACE_GENJII       	; 11
	db FACE_REIMU_ANGRY  	; 12
	db FACE_MIMA_SMILE   	; 13
	db FACE_REIMU_SWEAT  	; 14
	db FACE_MIMA_SMILE   	; 15
	db FACE_REIMU_NEUTRAL	; 16
	db FACE_GENJII       	; 17
	db FACE_REIMU_ANGRY  	; 18
	db FACE_REIMU_ANGRY  	; 19
	db FACE_MIMA_SMILE   	; 20
	db FACE_MIMA_SMILE   	; 21

public _STAGE5_PREBOSS_NOTCONTINUED_FACE
_STAGE5_PREBOSS_NOTCONTINUED_FACE label byte
	db FACE_MIMA_SMILE   	;  0
	db FACE_REIMU_NEUTRAL	;  1
	db FACE_MIMA_SMILE   	;  2
	db FACE_REIMU_ANGRY  	;  3
	db FACE_MIMA_SMILE   	;  4
	db FACE_MIMA_SMILE   	;  5
	db FACE_MIMA_SMILE   	;  6
	db FACE_MIMA_SMILE   	;  7
	db FACE_MIMA_SMILE   	;  8
	db FACE_REIMU_ANGRY  	;  9
	db FACE_MIMA_SMILE   	; 10
	db FACE_MIMA_SMILE   	; 11
	db FACE_MIMA_SMILE   	; 12
	db FACE_REIMU_ANGRY  	; 13
	db FACE_REIMU_ANGRY  	; 14
	db FACE_MIMA_SMILE   	; 15
	db FACE_MIMA_SMILE   	; 16

public _STAGE5_FORM1DEFEAT_CONTINUED_FAC
_STAGE5_FORM1DEFEAT_CONTINUED_FAC label byte
	db FACE_MIMA_SMILE 	; 0
	db FACE_MIMA_SMILE 	; 1
	db FACE_REIMU_ANGRY	; 2
	db FACE_MIMA_SMILE 	; 3
	db FACE_REIMU_SWEAT	; 4

public _STAGE5_FORM1DEFEAT_NOTCONTINUED_
_STAGE5_FORM1DEFEAT_NOTCONTINUED_ label byte
	db FACE_MIMA_FROWN 	; 0
	db FACE_REIMU_ANGRY	; 1
	db FACE_MIMA_FROWN 	; 2
	db FACE_REIMU_FROWN	; 3

aLINE_BLANK	db '@@@@@@@@@@@@@@@@@@', 0
public _dialog_fn
_dialog_fn	db 'stage .txt',0
aFW_0	db 'O', 0
aFW_1	db 'P', 0
aFW_2	db 'Q', 0
aFW_3	db 'R', 0
aFW_4	db 'S', 0
aFW_5	db 'T', 0
aFW_6	db 'U', 0
aFW_7	db 'V', 0
aFW_8	db 'W', 0
aFW_9	db 'X', 0
word_1ED94	dw 0
word_1ED96	dw 0
word_1ED98	dw 0
aBoss1_m	db 'boss1.m',0
word_1EDA2	dw 0
word_1EDA4	dw 0
byte_1EDA6	db 1
		db 0
word_1EDA8	dw 0
word_1EDAA	dw 0
aBoss4_m	db 'boss4.m',0
public _SCOREDAT_FN
_SCOREDAT_FN	dd aHuuhi_dat
include th02/gaiji/hiscore[data].asm
public _GAME_CLEAR_CONSTANTS, _EXTRA_CLEAR_FLAGS
_GAME_CLEAR_CONSTANTS	dw 318, 118, 218
_EXTRA_CLEAR_FLAGS   	db 1, 2, 4
aHuuhi_dat	db 'huuhi.dat',0
		db 0
word_1EE16	dw 100h
word_1EE18	dw 1002h
word_1EE1A	dw 1211h
byte_1EE1C	db 9
		db 0
		db  3Ch	; <
		db    0
		db  2Ch	; ,
		db    0
		db  4Ch	; L
		db    0
		db  1Ch
		db    0
		db  5Ch
		db    0
aStage5b1_bft	db 'stage5b1.bft',0
aStage5b2_bft	db 'stage5b2.bft',0
aBoss5_m	db 'boss5.m',0
; char aMaine[]
aMaine		db 'maine',0
word_1EE50	dw 0
byte_1EE52	db 0
		db 0
word_1EE54	dw 0
word_1EE56	dw 0
aMima_bft	db 'mima.bft',0
aMima1_bft	db 'mima1.bft',0
aStage3_b_btt	db 'stage3_b.btt',0
aMima_m		db 'mima.m',0
; char aMaine_0[]
aMaine_0	db 'maine',0
aMima2_bft	db 'mima2.bft',0
		db 0
		db  0Ah
		db  0Ch
		db  0Dh
		db  0Dh
		db  0Ch
		db  0Ah
byte_1EE96	db 0
		db 0
word_1EE98	dw 0
word_1EE9A	dw 0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
		db    0
byte_1EEA4	db 2
byte_1EEA5	db 1
aMima_bft_0	db 'mima.bft',0
aStage3_b_bft	db 'stage3_b.bft',0
aStage3_b_btt_0	db 'stage3_b.btt',0
aBoss3_m	db 'boss3.m',0
		db 0
	.data?

public _stage_progression
_stage_progression	db ?
stage1_gaiji_halflen	db ?
public _stage_title, _stage_title_halflen, _bgm_title_id
_stage_title_halflen	db ?
	evendata
_stage_title	dw ?
bgm_show_timer	db ?
_bgm_title_id	db ?
byte_1F46E	db ?
		db ?
public _midboss_update_and_render, _midboss_invalidate
_midboss_update_and_render	dd ?
_midboss_invalidate	dd ?
include th02/main/boss/funcs[bss].asm
farfp_1F48C	dd ?
farfp_1F490	dd ?
farfp_1F494	dd ?
farfp_1F498	dd ?
_boss_bg_render_func	dd ?
farfp_1F4A0	dd ?
farfp_1F4A4	dd ?
include th02/main/demo[bss].asm
public _playperf_max
_playperf_max	db ?
unk_1F4AD	db    ?	;
		db 47 dup(?)
byte_1F4DD	db ?
byte_1F4DE	db ?
		db ?
include libs/master.lib/clip[bss].asm
include libs/master.lib/fil[bss].asm
include libs/master.lib/grcg_circle[bss].asm
include libs/master.lib/pal[bss].asm
include libs/master.lib/vs[bss].asm
include libs/master.lib/vsync[bss].asm
include libs/master.lib/mem[bss].asm
include libs/master.lib/superpa[bss].asm
include libs/master.lib/super_put_rect[bss].asm
include th01/hardware/vram_planes[bss].asm
include th02/formats/pi_slots[bss].asm
include libs/master.lib/pfint21[bss].asm
include th02/hardware/input_sense[bss].asm
include th02/snd/snd[bss].asm
include th02/snd/load[bss].asm
public _mpn_images, _mpn_palette
_mpn_images	dd ?
_mpn_palette	palette_t <?>
word_1FFF0	dw ?
word_1FFF2	dw ?
word_1FFF4	dw ?
word_1FFF6	dw ?
byte_1FFF8	db ?
byte_1FFF9	db ?
byte_1FFFA	db ?
		db 361 dup(?)
word_20164	dw ?
word_20166	dw ?
byte_20168	db ?
byte_20169	db ?
include th02/math/randring[bss].asm
public _resident, _playperf
_resident	dd ?
		db 2 dup(?)
_playperf	dw ?
public _spark_ring_i
_spark_ring_i	dw ?

POINTNUM_W = 8
POINTNUM_H = 8

POINTNUM = 0
POINTNUM_MUL = 10
POINTNUM_EMPTY = 12
POINTNUM_COUNT = 20

public _pointnums
CPointnums struc
	PN_col    	db ?
	          	db ?
	PN_left   	dw POINTNUM_COUNT dup(?)
	PN_top    	dw POINTNUM_COUNT dup(2 dup(?))
	PN_points 	dw POINTNUM_COUNT dup(?)
	PN_flag   	db POINTNUM_COUNT dup(?)
	PN_age    	db POINTNUM_COUNT dup(?)
	PN_op     	db ?
	PN_operand	db ?
CPointnums ends
_pointnums	CPointnums <?>

public _scroll_speed, _scroll_cycle, _scroll_line, _scroll_unused
_scroll_speed	db ?
_scroll_cycle	db ?
_scroll_line	dw ?
_scroll_unused	dw ?
word_20348	dw ?
word_2034A	dw ?
word_2034C	dw ?
byte_2034E	db ?
		db ?
byte_20350	db ?
		db 647 dup(?)
word_205D8	dw ?
word_205DA	dw ?
word_205DC	dw ?
byte_205DE	db ?
byte_205DF	db ?
byte_205E0	db ?
		db ?
word_205E2	dw ?
word_205E4	dw ?
public _player_left_on_page, _player_top_on_page
public _player_left_on_back_page, _player_top_on_back_page
_player_left_on_page	dw 2 dup(?)
_player_top_on_page 	dw 2 dup(?)
_player_left_on_back_page	dw ?
_player_top_on_back_page 	dw ?
_player_option_left_left_on_back_page	dw ?
_player_option_left_top_on_back_page	dw ?
public _player_topleft, _player_option_left_topleft
_player_topleft	Point <?>
_player_option_left_topleft	Point 2 dup(<?>)
playchar_shot_func	dw ?
include th01/main/player_is_hit[bss].asm
public _player_invincibility_time, _player_invincible_via_bomb
_player_invincibility_time	db ?
_player_invincible_via_bomb	db ?
byte_20607	db ?
public _stage_miss_count
_stage_miss_count	db ?
byte_20609	db ?
include th02/main/player/speed[bss].asm
byte_2060E	db ?
byte_2060F	db ?
byte_20610	db ?
byte_20611	db ?
public _stage_frame
_stage_frame	dd ?
word_20616	dw ?
include th02/hardware/pages[bss].asm
public _midboss_active
_midboss_active	db ?
	evendata
word_2061C	dw ?
word_2061E	dw ?
word_20620	dw ?
word_20622	dw ?
		db 12 dup(?)
word_20630	dw ?
word_20632	dw ?
word_20634	dw ?
word_20636	dw ?
		db 12 dup(?)
word_20644	dw ?
word_20646	dw ?
		db 4 dup(?)
word_2064C	dw ?
patnum_2064E	dw ?
_boss_phase_frame	dw ?

public _boss_left_on_page, _boss_top_on_page
_boss_left_on_page	dw 2 dup(?)
_boss_top_on_page	dw 2 dup(?)

public _boss_damage
_boss_damage	dw ?

public _boss_left_on_back_page, _boss_top_on_back_page
_boss_left_on_back_page	dw ?
_boss_top_on_back_page	dw ?

byte_20660	db ?
byte_20661	db ?
byte_20662	db ?
byte_20663	db ?
byte_20664	db ?
		db 5 dup(?)
byte_2066A	db ?
byte_2066B	db ?
public _reduce_effects, _slowdown_factor
_reduce_effects	db ?
_slowdown_factor	db ?
byte_2066E	db ?
byte_2066F	db ?
group_20670	db ?
byte_20671	db ?
byte_20672	db ?
		db 15 dup(?)
public _sigma_frames
_sigma_frames	dd ?
word_20686	dw ?

BULLET_COUNT = 150

bullet_t struc
	BULLET_flag          	db ?
	BULLET_size_type     	db ?
	BULLET_screen_topleft	Point 2 dup(<?>)
	BULLET_velocity      	Point ?
	BULLET_patnum        	db ?
	BULLET_group         	db ?
	BULLET_angle         	db ?
	BULLET_speed         	db ?
	BULLET_u1            	db ?
		db ?
bullet_t ends

public _bullets
_bullets bullet_t BULLET_COUNT dup(<?>)

SRA_DOT = 0
SRA_SPRITE = 14

SPARK_COUNT = 64

spark_t struc
	SPARK_flag             	db ?
	SPARK_age              	db ?
	SPARK_screen_topleft   	Point 2 dup(<?>)
	SPARK_velocity         	Point <?>
	SPARK_render_as        	db ?
	                       	db ?
	SPARK_angle            	db ?
	SPARK_speed_base       	db ?
	                       	db ?
	SPARK_default_render_as	db ?
spark_t ends

public _sparks
_sparks	spark_t SPARK_COUNT dup(<?>)

public _bullet_screen_left, _bullet_screen_top, _bullet_special
public _rank_base_speed, _spark_sprite_interval, _spark_age_max
public _bullet_cur_left, _bullet_cur_top, _rank_base_stack
public _easy_slow_skip_cycle, _bullet_stack
_bullet_screen_left	dw ?
_bullet_screen_top 	dw ?

_bullet_special label word
bullet_special_chase_speed label word
bullet_special_gravity_speed label word
bullet_special_drift_angle label word
	dw ?

bullet_special_homing_duration label word
bullet_special_drift_speed label word
	dw ?

bullet_special_turns_max label word
bullet_special_drift_duration label word
	dw ?

_rank_base_speed	db ?
_spark_sprite_interval	db ?
_spark_age_max	db ?
	evendata
_bullet_cur_left	dw ?
_bullet_cur_top 	dw ?
_rank_base_stack	db ?
_easy_slow_skip_cycle	db ?
_bullet_stack	db ?
	evendata

ITEM_COUNT = 20

IT_POWER = 0
IT_POINT = 1
IT_BOMB = 2
IT_BIGPOWER = 3
IT_1UP = 4

ITEM_W = 16
ITEM_H = 16

item_pos_t struc
	ITEM_screen_left	dw ?
	ITEM_screen_top 	dw ?
item_pos_t ends

item_t struc
	ITEM_flag                    	db ?
	ITEM_type                    	db ?
	ITEM_pos                     	item_pos_t 2 dup(<?>)
	ITEM_velocity_y              	dw ?
	ITEM_velocity_x_during_bounce	dw ?
	ITEM_age                     	dw ?
item_t ends

public _items, _item_p_left_ptr, _item_p_top_ptr, _item_p_left, _item_p_top
_items	item_t ITEM_COUNT dup(<?>)

_item_p_left_ptr	dw ?
_item_p_top_ptr 	dw ?
_item_p_left    	dw ?
_item_p_top     	dw ?

public _point_items_collected, _item_semirandom_ring_p, _items_miss_add_gameover
public _item_semirandom_cycle, _item_score_this_frame, _item_collect_skill
public _item_frames_unused
_point_items_collected	dw ?
_item_semirandom_ring_p	db ?
_items_miss_add_gameover	db ?
_item_semirandom_cycle	db ?
	evendata
_item_score_this_frame	dd ?
_item_collect_skill	db ?
		db ?
_item_frames_unused	dw ?

public _score_delta, _score_delta_transferred_prev, _shot_level
_score_delta      	dd ?
_score_delta_transferred_prev	dw ?
_shot_level	db ?
		db ?
include th02/main/player/bomb[bss].asm
dword_218BA	dd ?
word_218BE	dw ?
word_218C0	dw ?
public _stage_bombs_used
_stage_bombs_used	db ?
	evendata
public _bomb_circle_center, _bomb_circle_frame, _bomb_circle_done
_bomb_circle_center	Point <?>
_bomb_circle_frame	dw ?
_bomb_circle_done	dw ?
		db 254 dup(?)
public _playchar_bomb_func
_playchar_bomb_func	dw ?
		db 128 dup(?)
tilemode_21A4C	db ?
rgb_21A4D	rgb_t <?>
rgb_21A50	rgb_t <?>
tilemode_21A53	db ?
tilemode_21A54	db ?
byte_21A55	db ?
public _map_section_tiles, _map, _map_full_row_at_top_of_screen
_map_section_tiles	db (MAP_SECTION_COUNT * MAP_ROWS_PER_SECTION * TILES_X) dup (?)
_map              	db MAP_LENGTH_MAX dup(?)
_map_full_row_at_top_of_screen	dw ?

TILE_COUNT = TILES_X * TILES_Y
TM_COL_0 = 0
TM_TILES = 1
TM_NONE = 2

public _tile_line_at_top, _tile_image_vos, _tile_copy_lines_top
public _tile_copy_lines_h, _tiles_for_new_row, _tile_ring, _tile_dirty
public _tile_column_dirty, _tile_mode, _tiles_egc_render_all
_tile_line_at_top	db ?
	evendata
_tile_image_vos	dw TILE_IMAGE_COUNT dup(?)
_tile_copy_lines_top	dw ?
_tile_copy_lines_h  	dw ?
_tiles_for_new_row  	db TILES_X dup(?)
_tile_mode	db ?
_tile_ring	db TILE_COUNT dup(?)
	evendata
_tile_dirty	db TILE_COUNT dup(?)
_tile_column_dirty	db TILES_X dup(?)
_tiles_egc_render_all	db ?
	evendata
byte_22D4A	db ?
byte_22D4B	db ?
word_22D4C	dw ?
word_22D4E	dw ?
		db 4 dup(?)
patnum_22D54	dw ?
byte_22D56	db ?
byte_22D57	db ?
dword_22D58	dd ?
		db 40 dup(?)

STONE_INNER_WEST = 0
STONE_INNER_EAST = 1
STONE_OUTER_WEST = 2
STONE_OUTER_EAST = 3
STONE_NORTH = 4
STONE_COUNT = 5

STONE_W = 32

public _stone_left, _stone_top
_stone_left	dw STONE_COUNT dup(?)
_stone_top 	dw STONE_COUNT dup(?)

left_22D98	dw ?
top_22D9A	dw ?
y_22D9C	dw ?
word_22D9E	dw ?
word_22DA0	dw ?
word_22DA2	dw ?
byte_22DA4	db ?
		db 513 dup(?)
byte_22FA6	db ?
byte_22FA7	db ?
byte_22FA8	db ?
		db ?
word_22FAA	dw ?
word_22FAC	dw ?
byte_22FAE	db ?
angle_22FAF	db ?
angle_22FB0	db ?
angle_22FB1 db 5 dup(?)
		db 24 dup(?)
byte_22FCE	db ?
byte_22FCF	db ?
byte_22FD0	db ?
		db ?
tile_image_22FD2	dw ?
tile_image_22FD4	dw ?
tile_image_22FD6	dw ?
public _map_length
_map_length	dw ?
		db    ?	;
byte_22FDB	db ?
		db 2704 dup(?)
point_23A6C	Point <?>
byte_23A70	db ?
		db ?
farfp_23A72	dd ?
farfp_23A76	dd ?
public _dialog_text, _dialog_box_cur, _restore_tile_mode_none_at_post
_dialog_text	db (64 * DIALOG_BOX_LINES * DIALOG_LINE_SIZE) dup(?)
_dialog_box_cur	db ?
_restore_tile_mode_none_at_post	db ?
point_24E7C	Point <?>
word_24E80	dw ?
word_24E82	dw ?
word_24E84	dw ?
		db 600 dup(?)
angle_250DE	db ?
		db ?
word_250E0	dw ?
word_250E2	dw ?
word_250E4	dw ?
		db 24 dup(?)
word_250FE	dw ?
		db 480 dup(?)
byte_252E0	db ?
byte_252E1	db ?
word_252E2	dw ?
word_252E4	dw ?
word_252E6	dw ?
speed_252E8	dw ?
speed_252EA	dw ?
word_252EC	dw ?
word_252EE	dw ?
word_252F0	dw ?
word_252F2	dw ?
word_252F4	dw ?
byte_252F6	db ?
byte_252F7	db ?
public _hiscore, _hiscore_continues
_hiscore	dd ?
_hiscore_continues	db ?
		db ?

SCOREDAT_PLACES = 10
SCOREDAT_NAME_LEN = 6

date struc
	da_year	dw ?
	da_day 	db ?
	da_mon 	db ?
date ends

scoredat_t struc
	SCOREDAT_cleared         	dw ?
	SCOREDAT_score           	dd SCOREDAT_PLACES dup(?)
	SCOREDAT_score_sum       	dd ?
	SCOREDAT_g_name          	db SCOREDAT_PLACES dup((SCOREDAT_NAME_LEN + 1) dup(?))
	SCOREDAT_g_name_first_sum	db ?
	SCOREDAT_stage           	db SCOREDAT_PLACES dup(?)
	SCOREDAT_stage_sum       	db ?
	SCOREDAT_date            	date SCOREDAT_PLACES dup(<?>)
	SCOREDAT_shottype        	db SCOREDAT_PLACES dup(?)
scoredat_t ends

scoredat_section_t struc
	SCORESECT_score      	scoredat_t <?>
	SCORESECT_section_sum	dd ?
scoredat_section_t ends

public _hi
_hi	scoredat_section_t <?>
byte_253B4	db ?
		db ?
left_253B6	dw ?
top_253B8	dw ?
		db 300 dup(?)
point_254E6	Point <?>
byte_254EA	db ?
		db 161 dup(?)
byte_2558C	db ?
byte_2558D	db ?
byte_2558E	db ?
byte_2558F	db ?
byte_25590	db ?
		db ?
word_25592	dw ?
word_25594	dw ?
byte_25596	db ?
byte_25597	db ?
byte_25598	db ?
		db ?
word_2559A	dw ?
word_2559C	dw ?
angle_2559E	db ?
		db ?
left_255A0	dw ?
byte_255A2	db ?
byte_255A3	db ?
point_255A4	Point <?>
word_255A8	dw ?
word_255AA	dw ?
word_255AC	dw ?
word_255AE	dw ?
byte_255B0	db ?
angle_255B1	db ?
byte_255B2	db ?
byte_255B3	db ?
byte_255B4	db ?
		db ?
fp_255B6	dw ?
fp_255B8	dw ?
fp_255BA	dw ?
word_255BC	dw ?
byte_255BE	db ?
		db 5559 dup(?)
dword_26B76	dd ?
		db 192 dup(?)
word_26C3A	dw ?
farfp_26C3C	dd ?
farfp_26C40	dd ?
word_26C44	dw ?
word_26C46	dw ?
word_26C48	dw ?
word_26C4A	dw ?
word_26C4C	dw ?
word_26C4E	dw ?
word_26C50	dw ?
word_26C52	dw ?
word_26C54	dw ?
left_26C56	dw ?
word_26C58	dw ?
left_26C5A	dw ?
x_26C5C	dw ?
top_26C5E	dw ?
word_26C60	dw ?
top_26C62	dw ?
y_26C64	dw ?
word_26C66	dw ?
word_26C68	dw ?
word_26C6A	dw ?
		db 80 dup(?)
word_26CBC	dw ?
word_26CBE	dw ?
byte_26CC0	db ?
byte_26CC1	db ?
byte_26CC2	db ?
byte_26CC3	db ?
byte_26CC4	db ?
byte_26CC5	db ?
byte_26CC6	db ?
byte_26CC7	db ?
byte_26CC8	db ?
byte_26CC9	db ?
byte_26CCA	db ?
		db ?
word_26CCC	dw ?
word_26CCE	dw ?
word_26CD0	dw ?
angle_26CD2	db ?
byte_26CD3	db ?
byte_26CD4	db ?
		db ?
point_26CD6	Point <?>
angle_26CDA	db ?
speed_26CDB	db ?
angle_26CDC	db ?
		db ?
point_26CDE	Point <?>
angle_26CE2	db ?
direction_26CE3	db ?
angle_26CE4	db ?
		db ?
word_26CE6	dw ?
word_26CE8	dw ?
word_26CEA	dw ?
angle_26CEC	db ?
angle_26CED	db ?
angle_26CEE	db ?
byte_26CEF	db ?
word_26CF0	dw ?
word_26CF2	dw ?
word_26CF4	dw ?
word_26CF6	dw ?
byte_26CF8	db ?
byte_26CF9	db ?
byte_26CFA	db ?
		db ?
word_26CFC	dw ?
word_26CFE	dw ?
top_26D00	dw ?
		db 64 dup(?)
word_26D42	dw ?
word_26D44	dw ?
word_26D46	dw ?
word_26D48	dw ?
word_26D4A	dw ?
byte_26D4C	db ?
byte_26D4D	db ?
byte_26D4E	db ?
byte_26D4F	db ?
		db 4 dup(?)
word_26D54	dw ?
		db 32 dup(?)
point_26D76	Point <?>
word_26D7A	dw ?
byte_26D7C	db ?
byte_26D7D	db ?
byte_26D7E	db ?
angle_26D7F	db ?
angle_26D80	db ?
byte_26D81	db ?
word_26D82	dw ?
word_26D84	dw ?
angle_26D86	db ?
angle_26D87	db ?
angle_26D88	db ?
byte_26D89	db ?
byte_26D8A	db ?
byte_26D8B	db ?
byte_26D8C	db ?
byte_26D8D	db ?
word_26D8E	dw ?
word_26D90	dw ?
byte_26D92	db ?
		db    ?	;

		end

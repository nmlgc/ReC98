;
; +-------------------------------------------------------------------------+
; |   This file has been generated by The Interactive Disassembler (IDA)    |
; |        Copyright (c) 2009 by Hex-Rays, <support@hex-rays.com>           |
; +-------------------------------------------------------------------------+
;
; Input	MD5   :	F97D1B72F01476639E9D33E361F57330

; File Name   :	th05/OP.EXE
; Format      :	MS-DOS executable (EXE)
; Base Address:	0h Range: 0h-14240h Loaded length: 1280Ah
; Entry	Point :	0:0
; OS type	  :  MS	DOS
; Application type:  Executable	16bit

		.386
		.model use16 large _TEXT

BINARY = 'O'

include ReC98.inc
include th05/th05.inc
include th04/hardware/grppsafx.inc
include th04/sprites/op_cdg.inc
include th05/op/music.inc
include th05/op/piano.inc

op_01 group CFG_TEXT, op_01_TEXT, HI_VIEW_TEXT

; ===========================================================================

_TEXT	segment	word public 'CODE' use16
	extern PALETTE_BLACK_IN:proc
	extern PALETTE_BLACK_OUT:proc
	extern FILE_CLOSE:proc
	extern FILE_CREATE:proc
	extern FILE_EXIST:proc
	extern FILE_READ:proc
	extern FILE_ROPEN:proc
	extern FILE_SEEK:proc
	extern FILE_WRITE:proc
	extern GRCG_BYTEBOXFILL_X:proc
	extern GRCG_HLINE:proc
	extern GRCG_POLYGON_C:proc
	extern GRCG_SETCOLOR:proc
	extern GRCG_VLINE:proc
	extern GRAPH_CLEAR:proc
	extern GRAPH_COPY_PAGE:proc
	extern PALETTE_SHOW:proc
	extern IRAND:proc
	extern TEXT_CLEAR:proc
	extern HMEM_ALLOCBYTE:proc
	extern HMEM_FREE:proc
	extern SUPER_FREE:proc
	extern SUPER_ENTRY_BFNT:proc
	extern SUPER_PUT_RECT:proc
	extern SUPER_PUT:proc
	extern GRAPH_GAIJI_PUTS:proc
	extern GRAPH_GAIJI_PUTC:proc
	extern PFSTART:proc
	extern PFEND:proc
_TEXT	ends

; ===========================================================================

; Segment type:	Pure code
CFG_TEXT segment byte public 'CODE' use16
		assume cs:op_01
		assume es:nothing, ss:nothing, ds:_DATA, fs:nothing, gs:nothing

include th04/setup.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B36C	proc near

var_2		= word ptr -2

		enter	2, 0
		mov	_window_tiles.x, (448 / WINDOW_TILE_W)
		call	@singleline$qii pascal, (96 shl 16) or 80
		call	graph_putsa_fx pascal, (112 shl 16) or 88, V_WHITE, ds, offset aSETUP_BGM_HEAD
		mov	_window_tiles.x, (160 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 3
		call	@dropdown$qii pascal, ( 32 shl 16) or 128
		mov	[bp+var_2], 0
		jmp	short loc_B3C3
; ---------------------------------------------------------------------------

loc_B3AC:
		push	[bp+var_2]
		cmp	[bp+var_2], 2
		jnz	short loc_B3BA
		mov	ax, V_WHITE
		jmp	short loc_B3BC
; ---------------------------------------------------------------------------

loc_B3BA:
		xor	ax, ax

loc_B3BC:
		push	ax
		call	setup_bgm_choice_put
		inc	[bp+var_2]

loc_B3C3:
		cmp	[bp+var_2], 3
		jl	short loc_B3AC
		mov	_window_tiles.x, (400 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 9
		call	@dropdown$qii pascal, (192 shl 16) or 128
		call	setup_bgm_help_put
		mov	[bp+var_2], 2

loc_B3E6:
		call	input_wait_for_change pascal, 0
		push	1
		call	frame_delay
		test	_key_det.hi, high INPUT_OK
		jnz	short loc_B452
		test	_key_det.lo, low INPUT_SHOT
		jnz	short loc_B452
		test	_key_det.lo, low INPUT_UP
		jz	short loc_B429
		call	setup_bgm_choice_put pascal, [bp+var_2], 0
		cmp	[bp+var_2], 2
		jnz	short loc_B41E
		mov	[bp+var_2], 0
		jmp	short loc_B421
; ---------------------------------------------------------------------------

loc_B41E:
		inc	[bp+var_2]

loc_B421:
		call	setup_bgm_choice_put pascal, [bp+var_2], V_WHITE

loc_B429:
		test	_key_det.lo, low INPUT_DOWN
		jz	short loc_B3E6
		call	setup_bgm_choice_put pascal, [bp+var_2], 0
		cmp	[bp+var_2], 0
		jnz	short loc_B445
		mov	[bp+var_2], 2
		jmp	short loc_B448
; ---------------------------------------------------------------------------

loc_B445:
		dec	[bp+var_2]

loc_B448:
		call	setup_bgm_choice_put pascal, [bp+var_2], V_WHITE
		jmp	short loc_B3E6
; ---------------------------------------------------------------------------

loc_B452:
		mov	_window_tiles.x, (400 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 9
		call	window_rollup_animate pascal, (192 shl 16) or 128
		mov	_window_tiles.x, (160 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 3
		call	window_rollup_animate pascal, ( 32 shl 16) or 128
		les	bx, _resident
		mov	al, byte ptr [bp+var_2]
		mov	es:[bx+resident_t.bgm_mode], al
		leave
		retn
sub_B36C	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_B489	proc near

var_2		= word ptr -2

		enter	2, 0
		mov	_window_tiles.x, (448 / WINDOW_TILE_W)
		call	@singleline$qii pascal, (96 shl 16) or 80
		call	graph_putsa_fx pascal, (112 shl 16) or 88, V_WHITE, ds, offset aSETUP_SE_HEAD
		mov	_window_tiles.x, (160 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 3
		call	@dropdown$qii pascal, ( 32 shl 16) or 128
		mov	[bp+var_2], 0
		jmp	short loc_B4E0
; ---------------------------------------------------------------------------

loc_B4C9:
		push	[bp+var_2]
		cmp	[bp+var_2], 1
		jnz	short loc_B4D7
		mov	ax, V_WHITE
		jmp	short loc_B4D9
; ---------------------------------------------------------------------------

loc_B4D7:
		xor	ax, ax

loc_B4D9:
		push	ax
		call	setup_se_choice_put
		inc	[bp+var_2]

loc_B4E0:
		cmp	[bp+var_2], 3
		jl	short loc_B4C9
		mov	_window_tiles.x, (400 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 9
		call	@dropdown$qii pascal, (192 shl 16) or 128
		call	setup_se_help_put
		mov	[bp+var_2], 1

loc_B503:
		call	input_wait_for_change pascal, 0
		push	1
		call	frame_delay
		test	_key_det.hi, high INPUT_OK
		jnz	short loc_B56F
		test	_key_det.lo, low INPUT_SHOT
		jnz	short loc_B56F
		test	_key_det.lo, low INPUT_DOWN
		jz	short loc_B546
		call	setup_se_choice_put pascal, [bp+var_2], 0
		cmp	[bp+var_2], 2
		jnz	short loc_B53B
		mov	[bp+var_2], 0
		jmp	short loc_B53E
; ---------------------------------------------------------------------------

loc_B53B:
		inc	[bp+var_2]

loc_B53E:
		call	setup_se_choice_put pascal, [bp+var_2], V_WHITE

loc_B546:
		test	_key_det.lo, low INPUT_UP
		jz	short loc_B503
		call	setup_se_choice_put pascal, [bp+var_2], 0
		cmp	[bp+var_2], 0
		jnz	short loc_B562
		mov	[bp+var_2], 2
		jmp	short loc_B565
; ---------------------------------------------------------------------------

loc_B562:
		dec	[bp+var_2]

loc_B565:
		call	setup_se_choice_put pascal, [bp+var_2], V_WHITE
		jmp	short loc_B503
; ---------------------------------------------------------------------------

loc_B56F:
		mov	_window_tiles.x, (400 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 9
		call	window_rollup_animate pascal, (192 shl 16) or 128
		mov	_window_tiles.x, (160 / WINDOW_TILE_W)
		mov	_window_tiles.y, 1 + 3
		call	window_rollup_animate pascal, ( 32 shl 16) or 128
		les	bx, _resident
		mov	al, byte ptr [bp+var_2]
		mov	es:[bx+resident_t.se_mode], al
		leave
		retn
sub_B489	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _setup_menu
_setup_menu proc near
		push	bp
		mov	bp, sp
		mov	PaletteTone, 0
		call	far ptr	palette_show
		call	super_entry_bfnt pascal, ds, offset aMswin_bft ; "mswin.bft"
		graph_accesspage 1
		call	pi_load pascal, 0, ds, offset aMs_pi
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		call	pi_free pascal, 0
		call	graph_copy_page pascal, 0
		push	1
		call	palette_black_in
		call	sub_B36C
		push	1
		call	frame_delay
		call	graph_copy_page pascal, 0
		call	sub_B489
		push	1
		call	palette_black_out
		call	super_free
		pop	bp
		retn
_setup_menu endp

include th04/zunsoft.asm
CFG_TEXT ends

op_01_TEXT segment byte public 'CODE' use16

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _main_cdg_load
_main_cdg_load	proc near
		push	bp
		mov	bp, sp
		call	cdg_load_all pascal, CDG_NUMERAL, ds, offset aSft1_cd2
		call	cdg_load_all pascal, CDG_MAIN, ds, offset aSft2_cd2
		call	cdg_load_all pascal, CDG_CURSOR, ds, offset aCar_cd2
		call	cdg_load_single_noalpha pascal, 40, ds, offset aSl00_cdg, 0
		call	cdg_load_single_noalpha pascal, 41, ds, offset aSl01_cdg, 0
		call	cdg_load_single_noalpha pascal, 42, ds, offset aSl02_cdg, 0
		call	cdg_load_single_noalpha pascal, 43, ds, offset aSl03_cdg, 0
		call	cdg_load_single pascal, 44, ds, offset aSlcl_cdg, 0
		call	cdg_load_single_noalpha pascal, 45, ds, offset aSl04_cdg, 0
		pop	bp
		retn
_main_cdg_load	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _main_cdg_free
_main_cdg_free	proc near
		push	bp
		mov	bp, sp
		call	cdg_free_all
		pop	bp
		retn
_main_cdg_free	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _op_animate
_op_animate	proc near

@@page_show  	= byte ptr -2
@@page_access	= byte ptr -1

		enter	2, 0
		push	si
		mov	PaletteTone, 0
		call	far ptr	palette_show
		call	pi_load pascal, 0, ds, offset aOp2a_pi
		call	pi_load pascal, 1, ds, offset aOp2b_pi
		call	pi_load pascal, 2, ds, offset aOp2c_pi
		call	pi_load pascal, 3, ds, offset aOp2d_pi
		call	pi_load pascal, 4, ds, offset aOp2e_pi
		call	pi_load pascal, 5, ds, offset aOp2f_pi
		call	pi_load pascal, 6, ds, offset aOp2g_pi
		call	pi_load pascal, 7, ds, offset aOp2h_pi
		graph_accesspage 0
		graph_showpage al
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 1
		graph_accesspage 1
		call	grcg_byteboxfill_x pascal, large 0, (((RES_X - 1) / 8) shl 16) or (RES_Y - 1)
		graph_accesspage 0
		call	grcg_byteboxfill_x pascal, large 0, (((RES_X - 1) / 8) shl 16) or (RES_Y - 1)
		GRCG_OFF_CLOBBERING dx
		call	graph_copy_page pascal, 1
		mov	[bp+@@page_access], 1
		mov	[bp+@@page_show], 0
		graph_accesspage 0
		graph_showpage al
		xor	si, si
		jmp	short loc_BDAD
; ---------------------------------------------------------------------------

loc_BD55:
		mov	ax, si
		mov	bx, 8
		cwd
		idiv	bx
		cmp	dx, 1
		jg	short loc_BD81
		mov	ax, si
		cwd
		idiv	bx
		call	pi_palette_apply pascal, ax
		pushd	(0 shl 16) or 278
		mov	ax, si
		mov	bx, 8
		cwd
		idiv	bx
		push	ax
		call	pi_put_8

loc_BD81:
		push	1
		call	frame_delay
		graph_accesspage [bp+@@page_access]
		graph_showpage [bp+@@page_show]
		mov	[bp+@@page_access], al
		mov	al, 1
		sub	al, [bp+@@page_show]
		mov	[bp+@@page_show], al
		lea	ax, [si+36]
		mov	PaletteTone, ax
		call	far ptr	palette_show
		inc	si

loc_BDAD:
		cmp	si, 40h
		jl	short loc_BD55
		mov	si, 1
		jmp	short loc_BDBE
; ---------------------------------------------------------------------------

loc_BDB7:
		call	pi_free pascal, si
		inc	si

loc_BDBE:
		cmp	si, 8
		jl	short loc_BDB7
		call	graph_copy_page pascal, 1
		les	bx, _resident
		cmp	es:[bx+resident_t.demo_num], 0
		jnz	short loc_BDE8
		call	snd_load pascal, ds, offset aOp_0, SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY

loc_BDE8:
		call	pi_load pascal, 0, ds, offset aOp1_pi_0
		graph_accesspage 0
		graph_showpage al
		push	16
		call	frame_delay
		xor	si, si
		jmp	short loc_BE46
; ---------------------------------------------------------------------------

loc_BE08:
		mov	ax, si
		mov	bx, 4
		cwd
		idiv	bx
		cmp	dx, 1
		jg	short loc_BE25
		pushd	0
		push	0
		mov	ax, si
		cwd
		idiv	bx
		push	ax
		call	pi_put_masked_8

loc_BE25:
		push	1
		call	frame_delay
		graph_accesspage [bp+@@page_access]
		graph_showpage [bp+@@page_show]
		mov	[bp+@@page_access], al
		mov	al, 1
		sub	al, [bp+@@page_show]
		mov	[bp+@@page_show], al
		inc	si

loc_BE46:
		cmp	si, 10h
		jl	short loc_BE08
		graph_accesspage 1
		graph_showpage 0
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		call	pi_free pascal, 0
		call	graph_copy_page pascal, 0
		pop	si
		leave
		retn
_op_animate	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public DRAW_TRACK
draw_track	proc near

var_5		= byte ptr -5
var_4		= word ptr -4
var_2		= word ptr -2
arg_0		= word ptr  4
arg_2		= byte ptr  6

		enter	6, 0
		push	si
		mov	[bp+var_5], 5
		mov	al, [bp+arg_2]
		mov	ah, 0
		sub	ax, word_1403A
		shl	ax, 4
		mov	si, ax
		or	si, si
		jl	loc_BF48
		cmp	si, 192
		jge	loc_BF48
		cmp	[bp+arg_0], 0
		jz	short loc_BEF4
		call	grcg_setcolor pascal, (GC_RMW shl 16) + 5
		push	(12 shl 16) or 300
		lea	ax, [si+96]
		push	ax
		call	grcg_hline
		push	(12 shl 16) or 300
		lea	ax, [si+111]
		push	ax
		call	grcg_hline
		push	12
		lea	ax, [si+96]
		push	ax
		lea	ax, [si+111]
		push	ax
		call	grcg_vline
		push	300
		lea	ax, [si+96]
		push	ax
		lea	ax, [si+111]
		push	ax
		call	grcg_vline
		GRCG_OFF_CLOBBERING dx
		jmp	short loc_BF05
; ---------------------------------------------------------------------------

loc_BEF4:
		push	0
		lea	ax, [si+96]
		push	ax
		push	(320 shl 16) or 16
		call	bgimage_put_rect

loc_BF05:
		mov	al, [bp+arg_2]
		mov	ah, 0
		cmp	ax, word_1403C
		jnz	short loc_BF14
		mov	[bp+var_5], 3

loc_BF14:
		mov	bx, music_game
		imul	bx, 78h
		mov	al, [bp+arg_2]
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		mov	ax, word ptr _MUSIC_TITLES+2[bx]
		mov	dx, word ptr _MUSIC_TITLES[bx]
		mov	[bp+var_2], ax
		mov	[bp+var_4], dx
		add	si, 96
		push	12
		push	si
		mov	al, [bp+var_5]
		mov	ah, 0
		push	ax
		push	[bp+var_2]
		push	dx
		call	graph_putsa_fx

loc_BF48:
		pop	si
		leave
		retn	4
draw_track	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public DRAW_TRACKS
draw_tracks	proc near

@@sel		= byte ptr  4

		push	bp
		mov	bp, sp
		push	si
		xor	si, si
		jmp	short loc_BF6B
; ---------------------------------------------------------------------------

loc_BF55:
		push	si
		mov	al, [bp+@@sel]
		mov	ah, 0
		cmp	ax, si
		jnz	short loc_BF64
		mov	ax, 1
		jmp	short loc_BF66
; ---------------------------------------------------------------------------

loc_BF64:
		xor	ax, ax

loc_BF66:
		push	ax
		call	draw_track
		inc	si

loc_BF6B:
		mov	ax, musicroom_trackcount
		add	ax, 2
		cmp	ax, si
		jg	short loc_BF55
		call	graph_putsa_fx pascal, (12 shl 16) or 80, 5, large [MUSICROOM_UP]
		call	graph_putsa_fx pascal, (12 shl 16) or 288, 5, large [MUSICROOM_DOWN]
		push	(12 shl 16) or 32
		push	3
		mov	bx, music_game
		shl	bx, 2
		pushd	dword ptr MUSICROOM_GAME[bx]
		call	graph_putsa_fx
		pop	si
		pop	bp
		retn	2
draw_tracks	endp

include th02/op/music.asm
include th05/op/music_cmt_load.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public DRAW_CMT_LINES
draw_cmt_lines	proc pascal near
		local @@y:word

		push	si
		push	di
		call	graph_putsa_fx pascal, (320 shl 16) or 32, 7, ds, offset _music_cmt
		mov	si, offset _music_cmt + MUSIC_CMT_LINE_LEN
		mov	di, 1
		mov	@@y, 180
		jmp	short loc_C36D
; ---------------------------------------------------------------------------

loc_C351:
		cmp	byte ptr [si], ';'
		jz	short loc_C365
		call	graph_putsa_fx pascal, 320, @@y, 7, ds, si

loc_C365:
		inc	di
		add	@@y, 16
		add	si, MUSIC_CMT_LINE_LEN

loc_C36D:
		cmp	di, MUSIC_CMT_LINE_COUNT
		jl	short loc_C351
		pop	di
		pop	si
		ret
draw_cmt_lines	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C376	proc near
		push	bp
		mov	bp, sp
		push	si
		mov	si, FX_MASK
		jmp	short loc_C390
; ---------------------------------------------------------------------------

loc_C37F:
		mov	_graph_putsa_fx_func, si
		call	draw_cmt_lines
		call	music_flip
		call	draw_cmt_lines
		call	music_flip
		inc	si

loc_C390:
		cmp	si, FX_MASK_END
		jl	short loc_C37F
		mov	_graph_putsa_fx_func, FX_WEIGHT_BOLD
		call	draw_cmt_lines
		call	music_flip
		call	draw_cmt_lines
		pop	si
		pop	bp
		retn
sub_C376	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C3A7	proc near
		push	bp
		mov	bp, sp
		mov	_graph_putsa_fx_func, FX_WEIGHT_BOLD
		call	bgimage_put_rect pascal, (320 shl 16) or  32, (320 shl 16) or  16
		call	bgimage_put_rect pascal, (320 shl 16) or 180, (320 shl 16) or 144
		call	music_flip
		call	bgimage_put_rect pascal, (320 shl 16) or  32, (320 shl 16) or  16
		call	bgimage_put_rect pascal, (320 shl 16) or 180, (320 shl 16) or 144
		pop	bp
		retn
sub_C3A7	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public DRAW_CMT
draw_cmt	proc near

@@track		= word ptr  4

		push	bp
		mov	bp, sp
		cmp	byte_13E96, 0
		jz	short loc_C406
		call	sub_C3A7

loc_C406:
		call	music_cmt_load pascal, [bp+@@track]
		call	screen_back_B_put
		call	bgimage_put_rect pascal, (320 shl 16) or 64, (320 shl 16) or 256
		cmp	byte_13E96, 0
		jz	short loc_C42C
		call	sub_C376
		jmp	short loc_C43A
; ---------------------------------------------------------------------------

loc_C42C:
		mov	byte_13E96, 1
		call	draw_cmt_lines
		call	music_flip
		call	draw_cmt_lines

loc_C43A:
		call	screen_back_B_put
		pop	bp
		retn	2
draw_cmt	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_C441	proc near

arg_0		= word ptr  4

		push	bp
		mov	bp, sp
		push	si
		mov	si, [bp+arg_0]
		call	bgimage_put_rect pascal, large (0 shl 16) or 32, (320 shl 16) or  16
		call	bgimage_put_rect pascal, large (0 shl 16) or 96, (320 shl 16) or 192
		call	draw_tracks pascal, si
		call	music_flip
		call	bgimage_put_rect pascal, large (0 shl 16) or 32, (320 shl 16) or  16
		call	bgimage_put_rect pascal, large (0 shl 16) or 96, (320 shl 16) or 192
		call	draw_tracks pascal, si
		pop	si
		pop	bp
		retn	2
sub_C441	endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _musicroom
_musicroom	proc near

@@sel		= byte ptr -1

		enter	2, 0
		push	si
		xor	si, si
		mov	word_1403A, 0
		mov	word_1403C, 0
		mov	_music_sel, 0
		mov	bx, music_game
		add	bx, bx
		mov	ax, MUSICROOM_TRACKCOUNTS[bx]
		mov	musicroom_trackcount, ax
		mov	byte_13E96, 0
		call	cdg_free_all
		call	text_clear
		mov	_music_page, 1
		mov	PaletteTone, 0
		call	far ptr	palette_show
		graph_showpage 0
		graph_accesspage al
		call	graph_clear
		graph_accesspage 1
		call	pi_load pascal, 0, ds, offset aMusic_pi
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		call	pi_free pascal, 0
		call	_piano_setup_and_put_initial
		call	screen_back_B_snap
		call	_bgimage_snap
		call	draw_tracks pascal, word ptr _music_sel
		call	graph_copy_page pascal, 0
		graph_accesspage 1
		graph_showpage 0
		call	pfend
		call	pfstart pascal, ds, offset aMusic_dat ; "music.dat"
		mov	al, _music_sel
		mov	ah, 0
		call	draw_cmt pascal, ax
		mov	PaletteTone, 100
		call	far ptr	palette_show

loc_C555:
		call	_input_reset_sense_held
		cmp	_key_det, INPUT_NONE
		jz	short loc_C57F
		cmp	si, 18h
		jl	short loc_C579
		cmp	_key_det, INPUT_UP
		jz	short loc_C574
		cmp	_key_det, INPUT_DOWN
		jnz	short loc_C579

loc_C574:
		mov	si, 14h
		jmp	short loc_C57F
; ---------------------------------------------------------------------------

loc_C579:
		inc	si
		call	music_flip
		jmp	short loc_C555
; ---------------------------------------------------------------------------

loc_C57F:
		call	_input_reset_sense_held
		test	_key_det.lo, low INPUT_UP
		jz	short loc_C5EB
		mov	al, _music_sel
		mov	[bp+@@sel], al
		cmp	_music_sel, 0
		jbe	short loc_C5D5
		dec	_music_sel
		mov	al, _music_sel
		mov	ah, 0
		cmp	ax, word_1403A
		jge	short loc_C5AE
		mov	al, _music_sel
		mov	ah, 0
		jmp	short loc_C61C
; ---------------------------------------------------------------------------

loc_C5AE:
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		call	music_flip
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		jmp	short loc_C5EB
; ---------------------------------------------------------------------------

loc_C5D5:
		mov	al, byte ptr musicroom_trackcount
		mov	_music_sel, al
		mov	ax, musicroom_trackcount
		add	ax, 0FFF5h
		mov	word_1403A, ax
		push	musicroom_trackcount
		call	sub_C441

loc_C5EB:
		test	_key_det.lo, low INPUT_DOWN
		jz	short loc_C666
		mov	al, _music_sel
		mov	[bp+@@sel], al
		mov	ah, 0
		cmp	ax, musicroom_trackcount
		jge	short loc_C652
		inc	_music_sel
		mov	al, _music_sel
		mov	ah, 0
		mov	dx, word_1403A
		add	dx, 0Ch
		cmp	ax, dx
		jl	short loc_C62B
		mov	al, _music_sel
		mov	ah, 0
		add	ax, 0FFF5h

loc_C61C:
		mov	word_1403A, ax
		mov	al, _music_sel
		mov	ah, 0
		push	ax
		call	sub_C441
		jmp	loc_C6E3
; ---------------------------------------------------------------------------

loc_C62B:
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		call	music_flip
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		jmp	short loc_C666
; ---------------------------------------------------------------------------

loc_C652:
		mov	_music_sel, 0
		mov	word_1403A, 0
		mov	al, _music_sel
		mov	ah, 0
		push	ax
		call	sub_C441

loc_C666:
		test	_key_det.lo, low INPUT_LEFT
		jz	short loc_C680
		dec	music_game
		cmp	music_game, 0
		jge	short loc_C698
		mov	music_game, 4
		jmp	short loc_C698
; ---------------------------------------------------------------------------

loc_C680:
		test	_key_det.lo, low INPUT_RIGHT
		jz	short loc_C6E3
		inc	music_game
		cmp	music_game, 5
		jl	short loc_C698
		mov	music_game, 0

loc_C698:
		mov	_music_sel, 0
		mov	word_1403C, 0
		mov	word_1403A, 0
		mov	bx, music_game
		add	bx, bx
		mov	ax, MUSICROOM_TRACKCOUNTS[bx]
		mov	musicroom_trackcount, ax
		push	0
		call	sub_C441
		kajacall	KAJA_SONG_FADE, 32
		call	draw_cmt pascal, 0
		mov	bx, music_game
		imul	bx, 78h
		call	snd_load pascal, dword ptr _MUSIC_FILES[bx], SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY

loc_C6E3:
		test	_key_det.lo, low INPUT_SHOT
		jnz	short loc_C6F1
		test	_key_det.hi, high INPUT_OK
		jz	short loc_C767

loc_C6F1:
		mov	al, _music_sel
		mov	ah, 0
		cmp	ax, musicroom_trackcount
		jz	loc_C77F
		kajacall	KAJA_SONG_FADE, 32
		mov	al, byte ptr word_1403C
		mov	[bp+@@sel], al
		mov	al, _music_sel
		mov	ah, 0
		mov	word_1403C, ax
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		call	music_flip
		call	draw_track pascal, word ptr [bp+@@sel], 0
		call	draw_track pascal, word ptr _music_sel, 1
		mov	al, _music_sel
		mov	ah, 0
		call	draw_cmt pascal, ax
		mov	bx, music_game
		imul	bx, 78h
		mov	al, _music_sel
		mov	ah, 0
		shl	ax, 2
		add	bx, ax
		call	snd_load pascal, dword ptr _MUSIC_FILES[bx], SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY

loc_C767:
		test	_key_det.hi, high INPUT_CANCEL
		jnz	short loc_C77F
		cmp	_key_det, INPUT_NONE
		jnz	loc_C555
		xor	si, si
		call	music_flip
		jmp	loc_C57F
; ---------------------------------------------------------------------------

loc_C77F:
		call	_input_reset_sense_held
		cmp	_key_det, INPUT_NONE
		jz	short loc_C790
		call	music_flip
		jmp	short loc_C77F
; ---------------------------------------------------------------------------

loc_C790:
		call	pfend
		call	pfstart pascal, ds, offset aKaikidan1_dat1
		kajacall	KAJA_SONG_FADE, 16
		call	screen_back_B_free
		graph_showpage 0
		graph_accesspage al
		push	1
		call	palette_black_out
		call	_bgimage_free
		call	snd_load pascal, ds, offset aH_op+2, SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY
		pop	si
		leave
		retn
_musicroom	endp

include th04/formats/scoredat_decode_both.asm
include th04/formats/scoredat_encode.asm
include th05/formats/scoredat_recreate_op.asm
include th05/formats/scoredat_load_for.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_CA1B	proc near

var_2		= word ptr -2
arg_0		= word ptr  4
@@y		= word ptr  6
arg_4		= word ptr  8

		enter	2, 0
		push	si
		push	di
		mov	si, [bp+arg_4]
		mov	di, [bp+arg_0]
		mov	bx, di
		shl	bx, 3
		mov	al, _hi.score.g_score[bx][SCORE_DIGITS - 1]
		mov	ah, 0
		add	ax, -gb_0_
		cmp	ax, 10
		jl	short loc_CA5B
		lea	ax, [si-16]
		push	ax
		push	[bp+@@y]
		mov	bx, di
		shl	bx, 3
		mov	al, _hi.score.g_score[bx][SCORE_DIGITS - 1]
		mov	ah, 0
		add	ax, -gb_0_
		mov	bx, 10
		cwd
		idiv	bx
		push	ax
		call	super_put

loc_CA5B:
		push	si
		push	[bp+@@y]
		mov	bx, di
		shl	bx, 3
		mov	al, _hi.score.g_score[bx][SCORE_DIGITS - 1]
		mov	ah, 0
		add	ax, -gb_0_
		mov	bx, 10
		cwd
		idiv	bx
		push	dx
		call	super_put
		add	si, 16
		mov	[bp+var_2], 6
		jmp	short loc_CAA4
; ---------------------------------------------------------------------------

loc_CA83:
		push	si
		push	[bp+@@y]
		mov	bx, di
		shl	bx, 3
		add	bx, [bp+var_2]
		mov	al, _hi.score.g_score[bx]
		mov	ah, 0
		add	ax, -gb_0_
		push	ax
		call	super_put
		dec	[bp+var_2]
		add	si, 16

loc_CAA4:
		cmp	[bp+var_2], 0
		jge	short loc_CA83
		pop	di
		pop	si
		leave
		retn	6
sub_CA1B	endp

include th04/hiscore/hiscore_stage_put.asm

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame

sub_CB00	proc near

@@color		= word ptr -2
arg_0		= word ptr  4
arg_2		= word ptr  6

		enter	2, 0
		push	si
		push	di
		cmp	[bp+arg_0], 0
		jnz	short loc_CB3A
		mov	bx, [bp+arg_2]
		cmp	bx, 3
		ja	short loc_CB33
		add	bx, bx
		jmp	cs:off_CBD4[bx]

loc_CB1B:
		mov	si, 8
		jmp	short loc_CB23
; ---------------------------------------------------------------------------

loc_CB20:
		mov	si, 328

loc_CB23:
		mov	di, 88
		jmp	short loc_CB33
; ---------------------------------------------------------------------------

loc_CB28:
		mov	si, 8
		jmp	short loc_CB30
; ---------------------------------------------------------------------------

loc_CB2D:
		mov	si, 328

loc_CB30:
		mov	di, 224

loc_CB33:
		mov	[bp+@@color], 7
		jmp	short loc_CB74
; ---------------------------------------------------------------------------

loc_CB3A:
		mov	bx, [bp+arg_2]
		cmp	bx, 3
		ja	short loc_CB6F
		add	bx, bx
		jmp	cs:off_CBCC[bx]

loc_CB49:
		mov	si, 8
		jmp	short loc_CB51
; ---------------------------------------------------------------------------

loc_CB4E:
		mov	si, 328

loc_CB51:
		mov	ax, [bp+arg_0]
		shl	ax, 4
		add	ax, 96
		jmp	short loc_CB6D
; ---------------------------------------------------------------------------

loc_CB5C:
		mov	si, 8
		jmp	short loc_CB64
; ---------------------------------------------------------------------------

loc_CB61:
		mov	si, 328

loc_CB64:
		mov	ax, [bp+arg_0]
		shl	ax, 4
		add	ax, 232

loc_CB6D:
		mov	di, ax

loc_CB6F:
		mov	[bp+@@color], 2

loc_CB74:
		lea	ax, [si+2]
		push	ax
		lea	ax, [di+2]
		push	ax
		push	GAIJI_W
		mov	ax, [bp+arg_0]
		imul	ax, (SCOREDAT_NAME_LEN + 1)
		add	ax, offset _hi.score.g_name
		push	ds
		push	ax
		push	14
		call	graph_gaiji_puts
		push	si
		push	di
		push	GAIJI_W
		mov	ax, [bp+arg_0]
		imul	ax, (SCOREDAT_NAME_LEN + 1)
		add	ax, offset _hi.score.g_name
		push	ds
		push	ax
		push	[bp+@@color]
		call	graph_gaiji_puts
		lea	ax, [si+150]
		call	sub_CA1B pascal, ax, di, [bp+arg_0]
		lea	ax, [si+286]
		push	ax
		push	di
		mov	bx, [bp+arg_0]
		mov	al, _hi.score.g_stage[bx]
		mov	ah, 0
		push	ax
		call	hiscore_stage_put
		pop	di
		pop	si
		leave
		retn	4
sub_CB00	endp

; ---------------------------------------------------------------------------
off_CBCC	dw offset loc_CB49
		dw offset loc_CB4E
		dw offset loc_CB5C
		dw offset loc_CB61
off_CBD4	dw offset loc_CB1B
		dw offset loc_CB20
		dw offset loc_CB28
		dw offset loc_CB2D

; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _score_render
_score_render proc near
		push	bp
		mov	bp, sp
		push	si
		push	di
		graph_accesspage 1
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		graph_accesspage 0
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		xor	si, si
		jmp	short loc_CC27
; ---------------------------------------------------------------------------

loc_CC13:
		call	scoredat_load_for pascal, si
		xor	di, di
		jmp	short loc_CC21
; ---------------------------------------------------------------------------

loc_CC1B:
		push	si
		push	di
		call	sub_CB00
		inc	di

loc_CC21:
		cmp	di, 5
		jl	short loc_CC1B
		inc	si

loc_CC27:
		cmp	si, 4
		jl	short loc_CC13
		push	(496 shl 16) or 376
		mov	al, _rank
		mov	ah, 0
		add	ax, ax
		add	ax, 20
		push	ax
		call	super_put
		push	(560 shl 16) or 376
		mov	al, _rank
		mov	ah, 0
		add	ax, ax
		add	ax, 21
		push	ax
		call	super_put
		pop	di
		pop	si
		pop	bp
		retn
_score_render endp


; =============== S U B	R O U T	I N E =======================================

; Attributes: bp-based frame
public _regist_view_menu
_regist_view_menu proc near
		push	bp
		mov	bp, sp
		kajacall	KAJA_SONG_STOP
		call	snd_load pascal, ds, offset aName, SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY
		kajacall	KAJA_SONG_FADE, -128
		push	1
		call	palette_black_out
		les	bx, _resident
		mov	al, es:[bx+resident_t.rank]
		mov	_rank, al
		call	pi_load pascal, 0, ds, offset aHi01_pi

loc_CC9F:
		call	_score_render
		call	palette_black_in pascal, 1

loc_CCA9:
		call	_input_reset_sense_held
		call	frame_delay pascal, 1
		test	_key_det.hi, high INPUT_OK
		jnz	short loc_CD17
		test	_key_det.lo, low INPUT_SHOT
		jnz	short loc_CD17
		test	_key_det.hi, high INPUT_CANCEL
		jnz	short loc_CD17
		test	_key_det.hi, high INPUT_OK
		jnz	short loc_CD17
		test	_key_det.lo, low INPUT_LEFT
		jz	short loc_CCF8
		cmp	_rank, RANK_EASY
		jz	short loc_CCF8
		dec	_rank
		mov	PaletteTone, 0
		call	far ptr	palette_show
		call	_score_render
		call	palette_black_in pascal, 1

loc_CCF8:
		test	_key_det.lo, low INPUT_RIGHT
		jz	short loc_CCA9
		cmp	_rank, RANK_EXTRA
		jnb	short loc_CCA9
		inc	_rank
		mov	PaletteTone, 0
		call	far ptr	palette_show
		jmp	short loc_CC9F
; ---------------------------------------------------------------------------

loc_CD17:
		kajacall	KAJA_SONG_FADE, 1
		call	palette_black_out pascal, 1
		call	pi_free pascal, 0
		graph_accesspage 1
		call	pi_load pascal, 0, ds, offset aOp1_pi_1
		call	pi_palette_apply pascal, 0
		call	pi_put_8 pascal, large 0, 0
		call	pi_free pascal, 0
		call	graph_copy_page pascal, 0
		call	palette_black_in pascal, 1

loc_CD64:
		call	_input_reset_sense_held
		call	frame_delay pascal, 1
		cmp	_key_det, INPUT_NONE
		jnz	short loc_CD64
		kajacall	KAJA_SONG_STOP
		call	snd_load pascal, ds, offset aOp_1, SND_LOAD_SONG
		kajacall	KAJA_SONG_PLAY
		pop	bp
		retn
_regist_view_menu endp
op_01_TEXT ends

HI_VIEW_TEXT segment byte public 'CODE' use16
	_cleardata_and_regist_view_sprite procdesc near
HI_VIEW_TEXT ends

; ===========================================================================

SHARED	segment	word public 'CODE' use16
include th02/snd/snd.inc
	extern GRAPH_PUTSA_FX:proc
	extern SND_SE_PLAY:proc
	extern _snd_se_update:proc
	extern _bgimage_snap:proc
	extern _bgimage_put:proc
	extern _bgimage_free:proc
	extern @POLAR$QIII:proc
	extern _piano_render:proc
	extern _piano_setup_and_put_initial:proc
	extern BGIMAGE_PUT_RECT:proc
	extern SND_LOAD:proc
	extern SND_KAJA_INTERRUPT:proc
	extern PI_PUT_MASKED_8:proc
	extern PI_LOAD:proc
	extern PI_PUT_8:proc
	extern PI_PALETTE_APPLY:proc
	extern PI_FREE:proc
	extern _input_reset_sense_held:proc
	extern INPUT_WAIT_FOR_CHANGE:proc
	extern SND_DELAY_UNTIL_MEASURE:proc
	extern FRAME_DELAY:proc
	extern CDG_LOAD_SINGLE_NOALPHA:proc
	extern CDG_LOAD_SINGLE:proc
	extern CDG_LOAD_ALL:proc
	extern CDG_FREE_ALL:proc
SHARED	ends

	.data

	; libs/master.lib/pal[data].asm
	extern PaletteTone:word

	; libs/master.lib/sin8[data].asm
	extern _SinTable8:word:256
	extern _CosTable8:word:256

	; th04/hardware/grppsafx[data].asm
	extern _graph_putsa_fx_func:word

	; th05/hardware/vram_planes[data].asm
	extern _VRAM_PLANE_B:dword

include th04/setup[data].asm
include th04/zunsoft[data].asm
include th05/formats/cfg[data].asm
		db 0
aSft1_cd2	db 'sft1.cd2',0
aSft2_cd2	db 'sft2.cd2',0
aCar_cd2	db 'car.cd2',0
aSl00_cdg	db 'sl00.cdg',0
aSl01_cdg	db 'sl01.cdg',0
aSl02_cdg	db 'sl02.cdg',0
aSl03_cdg	db 'sl03.cdg',0
aSlcl_cdg	db 'slcl.cdg',0
aSl04_cdg	db 'sl04.cdg',0
aOp2a_pi	db 'op2a.pi',0
aOp2b_pi	db 'op2b.pi',0
aOp2c_pi	db 'op2c.pi',0
aOp2d_pi	db 'op2d.pi',0
aOp2e_pi	db 'op2e.pi',0
aOp2f_pi	db 'op2f.pi',0
aOp2g_pi	db 'op2g.pi',0
aOp2h_pi	db 'op2h.pi',0
aOp_0		db 'op',0
aOp1_pi_0	db 'op1.pi',0
MUSICROOM_UP	dd aMUSICROOM_UP
					; "		------ ▲ ------       "
MUSICROOM_DOWN	dd aMUSICROOM_DOWN
					; "		------ ▼ ------       "
		dd asc_104D5		; "		----------------       "
MUSICROOM_GAME		dd aMUSICROOM_TH01
		dd aMUSICROOM_TH02
		dd aMUSICROOM_TH03
		dd aMUSICROOM_TH04
		dd aMUSICROOM_TH05
public _MUSIC_TITLES
_MUSIC_TITLES	label dword
		dd aTH01_01	; "No.1		  A Sacred Lot	       "
		dd aTH01_02	; "No.2		   永遠の巫女	       "
		dd aTH01_03	; "No.3	   The Positive	and Negative   "
		dd aTH01_04	; "No.4	  Highly Responsive to Prayers "
		dd aTH01_05
		dd aTH01_06		; "No.6		    天使伝説	       "
		dd aTH01_07	; "No.7	       Oriental	Magician       "
		dd aTH01_08	; "No.8		  破邪の小太刀	       "
		dd aTH01_09		; "No.9		      魔鏡	       "
		dd aTH01_10	; "No.10       the Legend of KAGE      "
		dd aTH01_11	; "No.11    いざ、倒れ逝くその時まで   "
		dd aTH01_12	; "No.12      Civilization of Magic    "
		dd aTH01_13	; "No.13	    星幽天使	       "
		dd aTH01_14	; "No.14	    アイリス	       "
		dd aMUSICROOM_QUIT1		; "	       タイトルに戻る	       "
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aTH02_01
		dd aTH02_02	; "No.2	     　	博麗　〜Eastern	Wind   "
		dd aTH02_03	; "No.3	     　	 She's in a temper!!   "
		dd aTH02_04	; "No.4	     　	  End of Daylight　    "
		dd aTH02_05	; "No.5	     　	 　 やみのちから　　   "
		dd aTH02_06	; "No.6	     　　　　　幻夢界　　　　  "
		dd aTH02_07
		dd aTH02_08	; "No.8	     ひもろぎ、むらさきにもえ  "
		dd aTH02_09
		dd aTH02_10
		dd aTH02_11	; "No.11	 Complete Darkness     "
		dd aTH02_12	; "No.12	　 エキストララブ      "
		dd aTH02_13	; "No.13	戦車むすめのみるゆめ   "
		dd aTH02_14	; "No.14	  　　遠野の森　　　   "
		dd aTH02_15
		dd aTH02_16	; "未使用.1	    博麗神社境内       "
		dd aTH02_17	; "未使用.2	    　陽落ちて	　     "
		dd aTH02_18	; "未使用.3	    　封魔終演	　     "
		dd aMUSICROOM_QUIT1		; "	       タイトルに戻る	       "
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aTH03_01
		dd aTH03_02	; "No.2	     　	　 Selection	       "
		dd aTH03_03
		dd aTH03_04	; "No.4		 Reincarnation	       "
		dd aTH03_05	; "No.5		   Dim.	Dream	       "
		dd aTH03_06
		dd aTH03_07	; "No.7	    　	Maniacal Princess      "
		dd aTH03_08	; "No.8	       夢消失  〜Lost Dream    "
		dd aTH03_09	; "No.9	      夢幻遊戯	〜Dream	War    "
		dd aTH03_10	; "No.10    魔法決戦！〜Fight it out!  "
		dd aTH03_11	; "No.11      　 Sailor	of Time	       "
		dd aTH03_12	; "No.12       Strawberry Crisis!!     "
		dd aTH03_13
		dd aTH03_14	; "No.14	  　魔法鐘愛	       "
		dd aTH03_15	; "No.15	  　久遠の夢	       "
		dd aTH03_16
		dd aTH03_17	; "No.17	   永遠の満月	       "
		dd aTH03_18	; "No.18	 Maple Dream...	       "
		dd aTH03_19
		dd aTH03_20	; "No.20	    勝利デモ	       "
		dd aTH03_21	; "No.21	 ゲームオーバー	       "
		dd aTH03_22	; "未使用.1	     時の風	       "
		dd aTH03_23	; "未使用.2	スターボウドリーム     "
		dd aTH03_24	; "未使用.3	  Phantasmagoria       "
		dd aMUSICROOM_QUIT2	; "		 タイトルに戻る	       "
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aTH04_01	; "No.1	   幻想郷  〜 Lotus Land Story "
		dd aTH04_02	; "No.2		 Witching Dream	       "
		dd aTH04_03	; "No.3		 Selene's light        "
		dd aTH04_04
		dd aTH04_05	; "No.5		Break the Sabbath      "
		dd aTH04_06	; "No.6	   紅響曲  〜 Scarlet Phoneme  "
		dd aTH04_07	; "No.7		   Bad Apple!!	       "
		dd aTH04_08	; "No.8	    霊戦　〜 Perdition crisis  "
		dd aTH04_09	; "No.9		アリスマエステラ       "
		dd aTH04_10	; "No.10    少女綺想曲　〜 Capriccio   "
		dd aTH04_11	; "No.11   星の器　〜 Casket of	Star   "
		dd aTH04_12	; "No.12	   Lotus Love	       "
		dd aTH04_13	; "No.13  眠れる恐怖 〜Sleeping	Terror "
		dd aTH04_14	; "No.14	   Dream Land	       "
		dd aTH04_15	; "No.15    幽夢　〜 Inanimate Dream   "
		dd aTH04_16
		dd aTH04_17	; "No.17  メイド幻想　〜 Icemilk Magic "
		dd aTH04_18	; "No.18   かわいい悪魔　〜 Innocence  "
		dd aTH04_19		; "No.19	      Days	       "
		dd aTH04_20	; "No.20	    Peaceful	       "
		dd aTH04_21	; "No.21	 Arcadian Dream	       "
		dd aTH04_22	; "No.22	   幻想の住人	       "
		dd aTH04_23	; "未使用.1	   Lotus Road	       "
		dd aTH04_24	; "未使用.2	  Dreamy pilot	       "
		dd aTH04_25	; "未使用.3	 Incomplete Plot       "
		dd aTH04_26	; "未使用.4	   Border Land	       "
		dd aTH04_27	; "未使用.5   Magic Shop of Raspberry  "
		dd aTH04_28	; "未使用.6	  Crescent Dream       "
		dd aMUSICROOM_QUIT1		; "	       タイトルに戻る	       "
		dd    0
		dd aTH05_01
		dd aTH05_02	; "No.2		  Dream	Express	       "
		dd aTH05_03	; "No.3	     魔法陣　〜	Magic Square   "
		dd aTH05_04
		dd aTH05_05	; "No.5	    霊天　〜 Spiritual Heaven  "
		dd aTH05_06	; "No.6		Romantic Children      "
		dd aTH05_07	; "No.7	      プラスチックマインド     "
		dd aTH05_08	; "No.8		 メイプルワイズ	       "
		dd aTH05_09	; "No.9	 禁断の魔法  〜	Forbidden Magic"
		dd aTH05_10	; "No.10  真紅の少女　〜 Crimson Dead!!"
		dd aTH05_11	; "No.11  裏切りの少女　〜 Judas Kiss  "
		dd aTH05_12	; "No.12       the Last	Judgement      "
		dd aTH05_13	; "No.13  悲しき人形　〜 Doll of Misery"
		dd aTH05_14	; "No.14   世界の果て　〜 World's End  "
		dd aTH05_15	; "No.15   神話幻想　〜	Infinite Being "
		dd aTH05_16	; "No.16       不思議の国のアリス      "
		dd aTH05_17	; "No.17     the Grimoire of Alice     "
		dd aTH05_18	; "No.18	      神社	       "
		dd aTH05_19	; "No.19	    Endless	       "
		dd aTH05_20	; "No.20	  久遠の楽園	       "
		dd aTH05_21	; "No.21	 Mystic	Dream	       "
		dd aTH05_22	; "No.22       Peaceful	Romancer       "
		dd aTH05_23	; "No.23	 魂の休らむ所	       "
		dd aMUSICROOM_QUIT1		; "	       タイトルに戻る	       "
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
public _MUSIC_FILES
_MUSIC_FILES	label dword
		dd aR_00		; "r_00"
		dd aR_01		; "r_01"
		dd aR_02		; "r_02"
		dd aR_03		; "r_03"
		dd aR_04		; "r_04"
		dd aR_05		; "r_05"
		dd aR_06		; "r_06"
		dd aR_07		; "r_07"
		dd aR_08		; "r_08"
		dd aR_09		; "r_09"
		dd aR_10		; "r_10"
		dd aR_11		; "r_11"
		dd aR_12		; "r_12"
		dd aR_13		; "r_13"
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aH_op		; "h_op"
		dd aH_st00		; "h_st00"
		dd aH_st00b		; "h_st00b"
		dd aH_st01		; "h_st01"
		dd aH_st01b		; "h_st01b"
		dd aH_st02		; "h_st02"
		dd aH_st02b		; "h_st02b"
		dd aH_st03		; "h_st03"
		dd aH_st03b		; "h_st03b"
		dd aH_st04		; "h_st04"
		dd aH_st04b		; "h_st04b"
		dd aH_st05		; "h_st05"
		dd aH_st05b		; "h_st05b"
		dd aH_end		; "h_end"
		dd aH_staff		; "h_staff"
		dd aH_ng00		; "h_ng00"
		dd aH_ng01		; "h_ng01"
		dd aH_ng02		; "h_ng02"
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aY_op		; "y_op"
		dd aY_select		; "y_select"
		dd aY_00mm		; "y_00mm"
		dd aY_01mm		; "y_01mm"
		dd aY_02mm		; "y_02mm"
		dd aY_03mm		; "y_03mm"
		dd aY_04mm		; "y_04mm"
		dd aY_05mm		; "y_05mm"
		dd aY_06mm		; "y_06mm"
		dd aY_dec		; "y_dec"
		dd aY_07mm		; "y_07mm"
		dd aY_08mm		; "y_08mm"
		dd aY_demo1		; "y_demo1"
		dd aY_demo2		; "y_demo2"
		dd aY_demo3		; "y_demo3"
		dd aY_demo4		; "y_demo4"
		dd aY_demo5		; "y_demo5"
		dd aY_ed		; "y_ed"
		dd aY_score		; "y_score"
		dd aY_win		; "y_win"
		dd aY_over		; "y_over"
		dd aY_ng00		; "y_ng00"
		dd aY_ng01		; "y_ng01"
		dd aY_ng02		; "y_ng02"
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd aG_op		; "g_op"
		dd aG_st00		; "g_st00"
		dd aG_st10		; "g_st10"
		dd aG_st00b		; "g_st00b"
		dd aG_st01		; "g_st01"
		dd aG_st01b		; "g_st01b"
		dd aG_st02		; "g_st02"
		dd aG_st02b		; "g_st02b"
		dd aG_st03		; "g_st03"
		dd aG_st03c		; "g_st03c"
		dd aG_st03b		; "g_st03b"
		dd aG_st04		; "g_st04"
		dd aG_st04b		; "g_st04b"
		dd aG_st05		; "g_st05"
		dd aG_st05b		; "g_st05b"
		dd aG_st06		; "g_st06"
		dd aG_st06b		; "g_st06b"
		dd aG_st06c		; "g_st06c"
		dd aG_end1		; "g_end1"
		dd aG_end2		; "g_end2"
		dd aG_staff		; "g_staff"
		dd aG_name		; "g_name"
		dd aG_ng00		; "g_ng00"
		dd aG_ng01		; "g_ng01"
		dd aG_ng02		; "g_ng02"
		dd aG_ng03		; "g_ng03"
		dd aG_ng04		; "g_ng04"
		dd aG_ng05		; "g_ng05"
		dd    0
		dd    0
		dd aH_op+2
		dd aH_st00+2
		dd aH_st00b+2
		dd aH_st01+2
		dd aH_st01b+2
		dd aH_st02+2
		dd aH_st02b+2
		dd aH_st03+2
		dd aH_st03b+2
		dd aG_st03c+2
		dd aSt03d		; "st03d"
		dd aH_st04+2
		dd aH_st04b+2
		dd aH_st05+2
		dd aH_st05b+2
		dd aG_st06+2
		dd aG_st06b+2
		dd aEd00		; "ed00"
		dd aEd01		; "ed01"
		dd aEd02		; "ed02"
		dd aH_staff+2
		dd aExed		; "exed"
		dd aG_name+2
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
		dd    0
music_game	dw 4
MUSICROOM_TRACKCOUNTS dw 14,18,24,28,23
include th02/op/polygons[data].asm
aMUSICROOM_UP		db '             ------ ▲ ------       ',0
aMUSICROOM_DOWN		db '             ------ ▼ ------       ',0
asc_104D5	db '             ----------------       ',0
aMUSICROOM_TH01	db '   第１弾　東方靈異伝  Arrange ver  ',0
aMUSICROOM_TH02	db '   第２弾　東方封魔録  Special MIX  ',0
aMUSICROOM_TH03	db '   第３弾　東方夢時空  Special MIX  ',0
aMUSICROOM_TH04	db '   第４弾　東方幻想郷  Special MIX  ',0
aMUSICROOM_TH05	db '   第５弾　東方怪綺談 MysticSquare  ',0
aTH01_01	db 'No.1           A Sacred Lot         ',0
aTH01_02	db 'No.2            永遠の巫女          ',0
aTH01_03	db 'No.3    The Positive and Negative   ',0
aTH01_04	db 'No.4   Highly Responsive to Prayers ',0
aTH01_05	db 'No.5            東方怪奇談          ',0
aTH01_06	db 'No.6             天使伝説           ',0
aTH01_07	db 'No.7        Oriental Magician       ',0
aTH01_08	db 'No.8           破邪の小太刀         ',0
aTH01_09	db 'No.9               魔鏡             ',0
aTH01_10	db 'No.10       the Legend of KAGE      ',0
aTH01_11	db 'No.11    いざ、倒れ逝くその時まで   ',0
aTH01_12	db 'No.12      Civilization of Magic    ',0
aTH01_13	db 'No.13            星幽天使           ',0
aTH01_14	db 'No.14            アイリス           ',0
aMUSICROOM_QUIT1	db '            タイトルに戻る          ',0
aTH02_01	db 'No.1      東方封魔録　〜浄土曼荼羅  ',0
aTH02_02	db 'No.2      　 博麗　〜Eastern Wind   ',0
aTH02_03	db 'No.3      　  She',27h,'s in a temper!!   ',0
aTH02_04	db 'No.4      　   End of Daylight　    ',0
aTH02_05	db 'No.5      　  　 やみのちから　　   ',0
aTH02_06	db 'No.6      　　　　　幻夢界　　　　  ',0
aTH02_07	db 'No.7      　　　　死を賭して　　　  ',0
aTH02_08	db 'No.8      ひもろぎ、むらさきにもえ  ',0
aTH02_09	db 'No.9      　  　 恋色マジック 　    ',0
aTH02_10	db 'No.10     　東方封魔録　〜幽幻乱舞  ',0
aTH02_11	db 'No.11         Complete Darkness     ',0
aTH02_12	db 'No.12        　 エキストララブ      ',0
aTH02_13	db 'No.13        戦車むすめのみるゆめ   ',0
aTH02_14	db 'No.14          　　遠野の森　　　   ',0
aTH02_15	db 'No.15         昔話わんだーらんど    ',0
aTH02_16	db '未使用.1         博麗神社境内       ',0
aTH02_17	db '未使用.2         　陽落ちて  　     ',0
aTH02_18	db '未使用.3         　封魔終演  　     ',0
aTH03_01	db 'No.1       　夢は時空を越えて       ',0
aTH03_02	db 'No.2      　 　 Selection           ',0
aTH03_03	db 'No.3            東方妖恋談          ',0
aTH03_04	db 'No.4          Reincarnation         ',0
aTH03_05	db 'No.5            Dim. Dream          ',0
aTH03_06	db 'No.6     Tabula rasa　〜空白少女    ',0
aTH03_07	db 'No.7     　  Maniacal Princess      ',0
aTH03_08	db 'No.8        夢消失  〜Lost Dream    ',0
aTH03_09	db 'No.9       夢幻遊戯  〜Dream War    ',0
aTH03_10	db 'No.10    魔法決戦！〜Fight it out!  ',0
aTH03_11	db 'No.11      　 Sailor of Time        ',0
aTH03_12	db 'No.12       Strawberry Crisis!!     ',0
aTH03_13	db 'No.13        非統一魔法世界論       ',0
aTH03_14	db 'No.14          　魔法鐘愛           ',0
aTH03_15	db 'No.15          　久遠の夢           ',0
aTH03_16	db 'No.16          東方の青い空         ',0
aTH03_17	db 'No.17           永遠の満月          ',0
aTH03_18	db 'No.18         Maple Dream...        ',0
aTH03_19	db 'No.19           霊人の休日          ',0
aTH03_20	db 'No.20            勝利デモ           ',0
aTH03_21	db 'No.21         ゲームオーバー        ',0
aTH03_22	db '未使用.1          時の風            ',0
aTH03_23	db '未使用.2     スターボウドリーム     ',0
aTH03_24	db '未使用.3       Phantasmagoria       ',0
aMUSICROOM_QUIT2	db '              タイトルに戻る        ',0
aTH04_01	db 'No.1    幻想郷  〜 Lotus Land Story ',0
aTH04_02	db 'No.2          Witching Dream        ',0
aTH04_03	db 'No.3          Selene',27h,'s light        ',0
aTH04_04	db 'No.4   装飾戦　〜 Decoration Battle ',0
aTH04_05	db 'No.5         Break the Sabbath      ',0
aTH04_06	db 'No.6    紅響曲  〜 Scarlet Phoneme  ',0
aTH04_07	db 'No.7            Bad Apple!!         ',0
aTH04_08	db 'No.8     霊戦　〜 Perdition crisis  ',0
aTH04_09	db 'No.9         アリスマエステラ       ',0
aTH04_10	db 'No.10    少女綺想曲　〜 Capriccio   ',0
aTH04_11	db 'No.11   星の器　〜 Casket of Star   ',0
aTH04_12	db 'No.12           Lotus Love          ',0
aTH04_13	db 'No.13  眠れる恐怖 〜Sleeping Terror ',0
aTH04_14	db 'No.14           Dream Land          ',0
aTH04_15	db 'No.15    幽夢　〜 Inanimate Dream   ',0
aTH04_16	db 'No.16      禁じざるをえない遊戯     ',0
aTH04_17	db 'No.17  メイド幻想　〜 Icemilk Magic ',0
aTH04_18	db 'No.18   かわいい悪魔　〜 Innocence  ',0
aTH04_19	db 'No.19              Days             ',0
aTH04_20	db 'No.20            Peaceful           ',0
aTH04_21	db 'No.21         Arcadian Dream        ',0
aTH04_22	db 'No.22           幻想の住人          ',0
aTH04_23	db '未使用.1        Lotus Road          ',0
aTH04_24	db '未使用.2       Dreamy pilot         ',0
aTH04_25	db '未使用.3      Incomplete Plot       ',0
aTH04_26	db '未使用.4        Border Land         ',0
aTH04_27	db '未使用.5   Magic Shop of Raspberry  ',0
aTH04_28	db '未使用.6       Crescent Dream       ',0
aTH05_01	db 'No.1     怪綺談　〜 Mystic Square   ',0
aTH05_02	db 'No.2           Dream Express        ',0
aTH05_03	db 'No.3      魔法陣　〜 Magic Square   ',0
aTH05_04	db 'No.4             夢想時空           ',0
aTH05_05	db 'No.5     霊天　〜 Spiritual Heaven  ',0
aTH05_06	db 'No.6         Romantic Children      ',0
aTH05_07	db 'No.7       プラスチックマインド     ',0
aTH05_08	db 'No.8          メイプルワイズ        ',0
aTH05_09	db 'No.9  禁断の魔法  〜 Forbidden Magic',0
aTH05_10	db 'No.10  真紅の少女　〜 Crimson Dead!!',0
aTH05_11	db 'No.11  裏切りの少女　〜 Judas Kiss  ',0
aTH05_12	db 'No.12       the Last Judgement      ',0
aTH05_13	db 'No.13  悲しき人形　〜 Doll of Misery',0
aTH05_14	db 'No.14   世界の果て　〜 World',27h,'s End  ',0
aTH05_15	db 'No.15   神話幻想　〜 Infinite Being ',0
aTH05_16	db 'No.16       不思議の国のアリス      ',0
aTH05_17	db 'No.17     the Grimoire of Alice     ',0
aTH05_18	db 'No.18              神社             ',0
aTH05_19	db 'No.19            Endless            ',0
aTH05_20	db 'No.20          久遠の楽園           ',0
aTH05_21	db 'No.21         Mystic Dream          ',0
aTH05_22	db 'No.22       Peaceful Romancer       ',0
aTH05_23	db 'No.23         魂の休らむ所          ',0
aR_00		db 'r_00',0
aR_01		db 'r_01',0
aR_02		db 'r_02',0
aR_03		db 'r_03',0
aR_04		db 'r_04',0
aR_05		db 'r_05',0
aR_06		db 'r_06',0
aR_07		db 'r_07',0
aR_08		db 'r_08',0
aR_09		db 'r_09',0
aR_10		db 'r_10',0
aR_11		db 'r_11',0
aR_12		db 'r_12',0
aR_13		db 'r_13',0
aH_op		db 'h_op',0
aH_st00		db 'h_st00',0
aH_st00b	db 'h_st00b',0
aH_st01		db 'h_st01',0
aH_st01b	db 'h_st01b',0
aH_st02		db 'h_st02',0
aH_st02b	db 'h_st02b',0
aH_st03		db 'h_st03',0
aH_st03b	db 'h_st03b',0
aH_st04		db 'h_st04',0
aH_st04b	db 'h_st04b',0
aH_st05		db 'h_st05',0
aH_st05b	db 'h_st05b',0
aH_end		db 'h_end',0
aH_staff	db 'h_staff',0
aH_ng00		db 'h_ng00',0
aH_ng01		db 'h_ng01',0
aH_ng02		db 'h_ng02',0
aY_op		db 'y_op',0
aY_select	db 'y_select',0
aY_00mm		db 'y_00mm',0
aY_01mm		db 'y_01mm',0
aY_02mm		db 'y_02mm',0
aY_03mm		db 'y_03mm',0
aY_04mm		db 'y_04mm',0
aY_05mm		db 'y_05mm',0
aY_06mm		db 'y_06mm',0
aY_dec		db 'y_dec',0
aY_07mm		db 'y_07mm',0
aY_08mm		db 'y_08mm',0
aY_demo1	db 'y_demo1',0
aY_demo2	db 'y_demo2',0
aY_demo3	db 'y_demo3',0
aY_demo4	db 'y_demo4',0
aY_demo5	db 'y_demo5',0
aY_ed		db 'y_ed',0
aY_score	db 'y_score',0
aY_win		db 'y_win',0
aY_over		db 'y_over',0
aY_ng00		db 'y_ng00',0
aY_ng01		db 'y_ng01',0
aY_ng02		db 'y_ng02',0
aG_op		db 'g_op',0
aG_st00		db 'g_st00',0
aG_st10		db 'g_st10',0
aG_st00b	db 'g_st00b',0
aG_st01		db 'g_st01',0
aG_st01b	db 'g_st01b',0
aG_st02		db 'g_st02',0
aG_st02b	db 'g_st02b',0
aG_st03		db 'g_st03',0
aG_st03c	db 'g_st03c',0
aG_st03b	db 'g_st03b',0
aG_st04		db 'g_st04',0
aG_st04b	db 'g_st04b',0
aG_st05		db 'g_st05',0
aG_st05b	db 'g_st05b',0
aG_st06		db 'g_st06',0
aG_st06b	db 'g_st06b',0
aG_st06c	db 'g_st06c',0
aG_end1		db 'g_end1',0
aG_end2		db 'g_end2',0
aG_staff	db 'g_staff',0
aG_name		db 'g_name',0
aG_ng00		db 'g_ng00',0
aG_ng01		db 'g_ng01',0
aG_ng02		db 'g_ng02',0
aG_ng03		db 'g_ng03',0
aG_ng04		db 'g_ng04',0
aG_ng05		db 'g_ng05',0
aSt03d		db 'st03d',0
aEd00		db 'ed00',0
aEd01		db 'ed01',0
aEd02		db 'ed02',0
aExed		db 'exed',0
include th05/op/music_cmt_load[data].asm
aMusic_pi	db 'music.pi',0
aMusic_dat	db 'music.dat',0
aKaikidan1_dat1	db '怪綺談1.dat',0
		db 0
include th05/formats/scoredat_load_for[data].asm
aName		db 'name',0
aHi01_pi	db 'hi01.pi',0
aOp1_pi_1	db 'op1.pi',0
aOp_1		db 'op',0

	.data?

	extern _resident:dword

	; libs/master.lib/pal[bss].asm
	extern Palettes:byte:48

	; libs/master.lib/vs[bss].asm
	extern vsync_Count1:word

	; th02/hardware/input_sense[bss].asm
	extern _key_det:word

	extern _window_tiles:Point
include th04/zunsoft[bss].asm
		db 104 dup(?)
include th02/op/music[bss].asm
byte_13E96	db ?
		db ?
include th03/op/cmt_back[bss].asm
include th02/op/music_cmt[bss].asm
word_1403A	dw ?
word_1403C	dw ?
musicroom_trackcount	dw ?
	extern _hi:scoredat_section_t
	extern _hi2:scoredat_section_t
	extern _rank:byte

		end
